<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Metrics.m</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">Metrics.m&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="Metrics.m">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
/*
 * Copyright (c) 2016-2019 Apple Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may <span class="enscript-type">not</span> use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>
 *
 * Unless required by applicable law <span class="enscript-type">or</span> agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express <span class="enscript-type">or</span> implied.
 * See the License <span class="enscript-keyword">for</span> the specific language governing permissions <span class="enscript-type">and</span>
 * limitations under the License.
 */

#import &quot;Metrics.h&quot;

#<span class="enscript-keyword">if</span> MDNSRESPONDER_SUPPORTS(APPLE, METRICS)
#import &lt;CoreUtils/SoftLinking.h&gt;
#import &lt;WirelessDiagnostics/AWDDNSDomainStats.h&gt;
#import &lt;WirelessDiagnostics/AWDMDNSResponderDNSMessageSizeStats.h&gt;
#import &lt;WirelessDiagnostics/AWDMDNSResponderDNSStatistics.h&gt;
#import &lt;WirelessDiagnostics/AWDMDNSResponderServicesStats.h&gt;
#import &lt;WirelessDiagnostics/AWDMetricIds_MDNSResponder.h&gt;
#import &lt;WirelessDiagnostics/WirelessDiagnostics.h&gt;

#import &quot;DNSCommon.h&quot;
#import &quot;mDNSMacOSX.h&quot;
#import &quot;DebugServices.h&quot;

//===========================================================================================================================
//  External Frameworks
//===========================================================================================================================

SOFT_LINK_FRAMEWORK(PrivateFrameworks, WirelessDiagnostics)

// AWDServerConnection <span class="enscript-type">class</span>

SOFT_LINK_CLASS(WirelessDiagnostics, AWDServerConnection)

#define AWDServerConnectionSoft     getAWDServerConnectionClass()

// Classes <span class="enscript-keyword">for</span> query stats

SOFT_LINK_CLASS(WirelessDiagnostics, AWDMDNSResponderDNSStatistics)
SOFT_LINK_CLASS(WirelessDiagnostics, AWDDNSDomainStats)

#define AWDMDNSResponderDNSStatisticsSoft       getAWDMDNSResponderDNSStatisticsClass()
#define AWDDNSDomainStatsSoft                   getAWDDNSDomainStatsClass()

// Classes <span class="enscript-keyword">for</span> services stats

SOFT_LINK_CLASS(WirelessDiagnostics, AWDMetricManager)

#define AWDMetricManagerSoft        getAWDMetricManagerClass()

// Classes <span class="enscript-keyword">for</span> DNS message <span class="enscript-type">size</span> stats

SOFT_LINK_CLASS(WirelessDiagnostics, AWDMDNSResponderDNSMessageSizeStats)

#define AWDMDNSResponderDNSMessageSizeStatsSoft     getAWDMDNSResponderDNSMessageSizeStatsClass()

//===========================================================================================================================
//  Macros
//===========================================================================================================================

#define countof(X)                      (sizeof(X) / sizeof(X<span class="enscript-type">[</span>0<span class="enscript-type">]</span>))
#define countof_field(TYPE, FIELD)      countof(((TYPE *)0)-&gt;FIELD)
#define ForgetMem(X)                    do {<span class="enscript-keyword">if</span>(*(X)) {free(*(X)); *(X) = NULL;}} <span class="enscript-keyword">while</span>(0)

//===========================================================================================================================
//  Constants
//===========================================================================================================================

#define kQueryStatsMaxQuerySendCount        10
#define kQueryStatsSendCountBinCount        (kQueryStatsMaxQuerySendCount + 1)
#define kQueryStatsLatencyBinCount          55
#define kQueryStatsExpiredAnswerStateCount  (ExpiredAnswer_EnumCount)
#define kQueryStatsDNSOverTCPStateCount     (DNSOverTCP_EnumCount)

//===========================================================================================================================
//  Data structures
//===========================================================================================================================

// Data structures <span class="enscript-keyword">for</span> query stats.

typedef struct QueryStats       QueryStats;
typedef struct DNSHistSet       DNSHistSet;
typedef mDNSBool                (*QueryNameTest_f)(const QueryStats *inStats, const domainname *inQueryName);

struct QueryStats
{
    QueryStats *        next;           // Pointer to next domain stats in list.
    const <span class="enscript-type">char</span> *        domainStr;      // Domain (see below) as a C string.
    uint8_t *           domain;         // Domain <span class="enscript-keyword">for</span> <span class="enscript-type">which</span> these stats are collected.
    const <span class="enscript-type">char</span> *        altDomainStr;   // Alt domain string to use in the AWD <span class="enscript-type">version</span> of the stats instead of domainStr.
    DNSHistSet *        nonCellular;    // Query stats <span class="enscript-keyword">for</span> queries sent over non-cellular interfaces.
    DNSHistSet *        cellular;       // Query stats <span class="enscript-keyword">for</span> queries sent over cellular interfaces.
    QueryNameTest_f     test;           // Function that tests whether a given query<span class="enscript-keyword">'</span>s stats belong based on the query name.
    int                 labelCount;     // Number of labels in domain name. Used <span class="enscript-keyword">for</span> domain name comparisons.
    mDNSBool            <span class="enscript-type">terminal</span>;       // If true <span class="enscript-type">and</span> test passes, then no other QueryStats on the list should be visited.
};

check_compile_time(sizeof(QueryStats) &lt;= 64);

// DNSHist contains the per domain per network <span class="enscript-type">type</span> histogram data that goes in a DNSDomainStats protobuf message. See
// &lt;rdar://problem/23980546&gt; MDNSResponder.proto update.
//
// answeredQuerySendCountBins
//
// An array of 11 histogram bins. The value at index <span class="enscript-type">i</span>, <span class="enscript-keyword">for</span> 0 &lt;= <span class="enscript-type">i</span> &lt;= 9, is the number of <span class="enscript-type">times</span> that an answered DNS query
// was sent <span class="enscript-type">i</span> <span class="enscript-type">times</span>. The value at index 10 is the number of <span class="enscript-type">times</span> that an answered query was sent 10+ <span class="enscript-type">times</span>.
//
// unansweredQuerySendCountBins
//
// An array of 11 histogram bins. The value at index <span class="enscript-type">i</span>, <span class="enscript-keyword">for</span> 0 &lt;= <span class="enscript-type">i</span> &lt;= 9, is the number of <span class="enscript-type">times</span> that an unanswered DNS query
// was sent <span class="enscript-type">i</span> <span class="enscript-type">times</span>. The value at index 10 is the number of <span class="enscript-type">times</span> that an unanswered query was sent 10+ <span class="enscript-type">times</span>.
//
// responseLatencyBins
//
// An array of 55 histogram bins. Each array value is the number of DNS queries that were answered in a paricular time
// interval. The 55 consecutive non-overlapping time intervals have the following non-inclusive <span class="enscript-type">upper</span> bounds (<span class="enscript-type">all</span> values are
// in milliseconds): 1, 2, 3, 4, 5, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190,
// 200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000, 1500, 2000, 2500, 3000, 3500, 4000,
// 4500, 5000, 6000, 7000, 8000, 9000, 10000, âˆž.

typedef struct
{
    uint16_t    unansweredQuerySendCountBins<span class="enscript-type">[</span>kQueryStatsSendCountBinCount<span class="enscript-type">]</span>;
    uint16_t    unansweredQueryDurationBins<span class="enscript-type">[</span>kQueryStatsLatencyBinCount<span class="enscript-type">]</span>;
    uint16_t    answeredQuerySendCountBins<span class="enscript-type">[</span>kQueryStatsSendCountBinCount<span class="enscript-type">]</span>;
    uint16_t    responseLatencyBins<span class="enscript-type">[</span>kQueryStatsLatencyBinCount<span class="enscript-type">]</span>;
    uint16_t    negAnsweredQuerySendCountBins<span class="enscript-type">[</span>kQueryStatsSendCountBinCount<span class="enscript-type">]</span>;
    uint16_t    negResponseLatencyBins<span class="enscript-type">[</span>kQueryStatsLatencyBinCount<span class="enscript-type">]</span>;
    uint32_t    expiredAnswerStateBins<span class="enscript-type">[</span>kQueryStatsExpiredAnswerStateCount<span class="enscript-type">]</span>;
    uint32_t    dnsOverTCPStateBins<span class="enscript-type">[</span>kQueryStatsDNSOverTCPStateCount<span class="enscript-type">]</span>;

}   DNSHist;

check_compile_time(sizeof(DNSHist) &lt;= 512);
check_compile_time(countof_field(DNSHist, unansweredQuerySendCountBins)  == (kQueryStatsMaxQuerySendCount + 1));
check_compile_time(countof_field(DNSHist, answeredQuerySendCountBins)    == (kQueryStatsMaxQuerySendCount + 1));
check_compile_time(countof_field(DNSHist, negAnsweredQuerySendCountBins) == (kQueryStatsMaxQuerySendCount + 1));
check_compile_time(countof_field(DNSHist, expiredAnswerStateBins)        == (kQueryStatsExpiredAnswerStateCount));
check_compile_time(countof_field(DNSHist, dnsOverTCPStateBins)           == (kQueryStatsDNSOverTCPStateCount));

// Important: Do <span class="enscript-type">not</span> modify kResponseLatencyMsLimits because the code used to generate AWD reports expects the response
// latency histogram bins to observe these time interval <span class="enscript-type">upper</span> bounds.

static const mDNSu32        kResponseLatencyMsLimits<span class="enscript-type">[</span><span class="enscript-type">]</span> =
{
        1,     2,     3,     4,     5,
       10,    20,    30,    40,    50,    60,    70,    80,    90,
      100,   110,   120,   130,   140,   150,   160,   170,   180,   190,
      200,   250,   300,   350,   400,   450,   500,   550,   600,   650,   700,   750,   800,   850,   900,   950,
     1000,  1500,  2000,  2500,  3000,  3500,  4000,  4500,
     5000,  6000,  7000,  8000,  9000,
    10000
};

check_compile_time(countof(kResponseLatencyMsLimits) == 54);
check_compile_time(countof_field(DNSHist, unansweredQueryDurationBins) == (countof(kResponseLatencyMsLimits) + 1));
check_compile_time(countof_field(DNSHist, responseLatencyBins)         == (countof(kResponseLatencyMsLimits) + 1));
check_compile_time(countof_field(DNSHist, negResponseLatencyBins)      == (countof(kResponseLatencyMsLimits) + 1));

struct DNSHistSet
{
    DNSHist *       histA;      // Histogram data <span class="enscript-keyword">for</span> queries <span class="enscript-keyword">for</span> A resource records.
    DNSHist *       histAAAA;   // Histogram data <span class="enscript-keyword">for</span> queries <span class="enscript-keyword">for</span> AAAA resource records.
};

typedef struct
{
    const <span class="enscript-type">char</span> *        domainStr;
    const <span class="enscript-type">char</span> *        altDomainStr;
    QueryNameTest_f     test;
    mDNSBool            <span class="enscript-type">terminal</span>;

}   QueryStatsArgs;

// Data structures <span class="enscript-keyword">for</span> DNS message <span class="enscript-type">size</span> stats.

#define kQuerySizeBinWidth      16
#define kQuerySizeBinMax        512
#define kQuerySizeBinCount      ((kQuerySizeBinMax / kQuerySizeBinWidth) + 1)

check_compile_time(kQuerySizeBinWidth &gt; 0);
check_compile_time(kQuerySizeBinCount &gt; 0);
check_compile_time((kQuerySizeBinMax <span class="enscript-comment">% kQuerySizeBinWidth) == 0);
</span>
#define kResponseSizeBinWidth       16
#define kResponseSizeBinMax         512
#define kResponseSizeBinCount       ((kResponseSizeBinMax / kResponseSizeBinWidth) + 1)

check_compile_time(kResponseSizeBinWidth &gt; 0);
check_compile_time(kResponseSizeBinCount &gt; 0);
check_compile_time((kResponseSizeBinMax <span class="enscript-comment">% kResponseSizeBinWidth) == 0);
</span>
typedef struct
{
    uint32_t    querySizeBins<span class="enscript-type">[</span>kQuerySizeBinCount<span class="enscript-type">]</span>;
    uint32_t    responseSizeBins<span class="enscript-type">[</span>kResponseSizeBinCount<span class="enscript-type">]</span>;

}   DNSMessageSizeStats;

check_compile_time(sizeof(DNSMessageSizeStats) &lt;= 264);

//===========================================================================================================================
//  Local Prototypes
//===========================================================================================================================

// Query stats

mDNSlocal mStatus       QueryStatsCreate(const <span class="enscript-type">char</span> *inDomainStr, const <span class="enscript-type">char</span> *inAltDomainStr, QueryNameTest_f inTest, mDNSBool inTerminal, QueryStats **outStats);
mDNSlocal void          QueryStatsFree(QueryStats *inStats);
mDNSlocal void          QueryStatsFreeList(QueryStats *inList);
mDNSlocal mStatus       QueryStatsUpdate(QueryStats *inStats, int inType, const ResourceRecord *inRR, mDNSu32 inQuerySendCount, ExpiredAnswerMetric inExpiredAnswerState, DNSOverTCPMetric inDNSOverTCPState, mDNSu32 inLatencyMs, mDNSBool inForCell);
mDNSlocal const <span class="enscript-type">char</span> *  QueryStatsGetDomainString(const QueryStats *inStats);
mDNSlocal mDNSBool      QueryStatsDomainTest(const QueryStats *inStats, const domainname *inQueryName);
mDNSlocal mDNSBool      QueryStatsHostnameTest(const QueryStats *inStats, const domainname *inQueryName);
mDNSlocal mDNSBool      QueryStatsContentiCloudTest(const QueryStats *inStats, const domainname *inQueryName);
mDNSlocal mDNSBool      QueryStatsCourierPushTest(const QueryStats *inStats, const domainname *inQueryName);

// DNS message <span class="enscript-type">size</span> stats

mDNSlocal mStatus   DNSMessageSizeStatsCreate(DNSMessageSizeStats **outStats);
mDNSlocal void      DNSMessageSizeStatsFree(DNSMessageSizeStats *inStats);

mDNSlocal mStatus   CreateQueryStatsList(QueryStats **outList);
mDNSlocal mStatus   SubmitAWDMetric(UInt32 inMetricID);
mDNSlocal mStatus   SubmitAWDMetricQueryStats(void);
mDNSlocal mStatus   SubmitAWDMetricDNSMessageSizeStats(void);
mDNSlocal mStatus   CreateAWDDNSDomainStats(DNSHist *inHist, const <span class="enscript-type">char</span> *inDomain, mDNSBool inForCell, AWDDNSDomainStats_RecordType inType, AWDDNSDomainStats **outStats);
mDNSlocal void      LogDNSHistSetToFD(int fd, const DNSHistSet *inSet, const <span class="enscript-type">char</span> *inDomain, mDNSBool inForCell);
mDNSlocal void      LogDNSHistToFD(int fd, const DNSHist *inHist, const <span class="enscript-type">char</span> *inDomain, mDNSBool inForCell, const <span class="enscript-type">char</span> *inType);
mDNSlocal void      LogDNSHistSendCountsToFD(int fd, const uint16_t inSendCountBins<span class="enscript-type">[</span>kQueryStatsSendCountBinCount<span class="enscript-type">]</span>);
mDNSlocal void      LogDNSHistLatenciesToFD(int fd, const uint16_t inLatencyBins<span class="enscript-type">[</span>kQueryStatsLatencyBinCount<span class="enscript-type">]</span>);
mDNSlocal void      LogDNSMessageSizeStatsToFD(int fd, const uint32_t *inBins, size_t inBinCount, unsigned int inBinWidth);

//===========================================================================================================================
//  Histogram Bin Helpers
//===========================================================================================================================

#define INCREMENT_BIN_DEFINITION(BIN_SIZE) \
    mDNSlocal void IncrementBin ## BIN_SIZE (uint ## BIN_SIZE ## _t *inBin) \
    { \
        <span class="enscript-keyword">if</span> (*inBin &lt; UINT ## BIN_SIZE ## _MAX) ++(*inBin); \
    } \
    extern int _MetricsDummyVariable

INCREMENT_BIN_DEFINITION(16);
INCREMENT_BIN_DEFINITION(32);

//  Note: The <span class="enscript-keyword">return</span> value is the <span class="enscript-type">size</span> (in number of elements) of the smallest contiguous sub-array that contains the first
//  bin <span class="enscript-type">and</span> <span class="enscript-type">all</span> bins with non-zero values.

#define COPY_BINS_DEFINITION(BIN_SIZE) \
    mDNSlocal size_t CopyBins ## BIN_SIZE (uint32_t *inDstBins, uint ## BIN_SIZE ## _t *inSrcBins, size_t inBinCount) \
    { \
        <span class="enscript-keyword">if</span> (inBinCount == 0) <span class="enscript-keyword">return</span> (0); \
        size_t minCount = 1; \
        <span class="enscript-keyword">for</span> (size_t <span class="enscript-type">i</span> = 0; <span class="enscript-type">i</span> &lt; inBinCount; ++<span class="enscript-type">i</span>) \
        { \
            inDstBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span> = inSrcBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>; \
            <span class="enscript-keyword">if</span> (inDstBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span> &gt; 0) minCount = <span class="enscript-type">i</span> + 1; \
        } \
        <span class="enscript-keyword">return</span> (minCount); \
    } \
    extern int _MetricsDummyVariable

COPY_BINS_DEFINITION(16);
COPY_BINS_DEFINITION(32);

//===========================================================================================================================
//  Globals
//===========================================================================================================================

static AWDServerConnection *        gAWDServerConnection    = nil;
static QueryStats *                 gQueryStatsList         = NULL;
static DNSMessageSizeStats *        gDNSMessageSizeStats    = NULL;

// Important: Do <span class="enscript-type">not</span> add to this list without getting privacy approval. See &lt;rdar://problem/24155761&amp;26397203&amp;34763471&gt;.

static const QueryStatsArgs     kQueryStatsArgs<span class="enscript-type">[</span><span class="enscript-type">]</span> =
{
    { &quot;.&quot;,                      NULL,                               QueryStatsDomainTest,           mDNSfalse },
    { &quot;&quot;,                       &quot;alt:*-courier.push.apple.com.&quot;,    QueryStatsCourierPushTest,      mDNSfalse },
    { &quot;apple.com.&quot;,             NULL,                               QueryStatsDomainTest,           mDNStrue  },
    { &quot;gateway.icloud.com.&quot;,    &quot;alt:gateway.icloud.com&quot;,           QueryStatsHostnameTest,         mDNSfalse },
    { &quot;&quot;,                       &quot;alt:*-content.icloud.com.&quot;,        QueryStatsContentiCloudTest,    mDNSfalse },
    { &quot;icloud.com.&quot;,            NULL,                               QueryStatsDomainTest,           mDNStrue  },
    { &quot;mzstatic.com.&quot;,          NULL,                               QueryStatsDomainTest,           mDNStrue  },
    { &quot;google.com.&quot;,            NULL,                               QueryStatsDomainTest,           mDNStrue  },
    { &quot;baidu.com.&quot;,             NULL,                               QueryStatsDomainTest,           mDNStrue  },
    { &quot;yahoo.com.&quot;,             NULL,                               QueryStatsDomainTest,           mDNStrue  },
    { &quot;qq.com.&quot;,                NULL,                               QueryStatsDomainTest,           mDNStrue  }
};

check_compile_time(countof(kQueryStatsArgs) == 11);

//===========================================================================================================================
//  MetricsInit
//===========================================================================================================================

mStatus MetricsInit(void)
{
    @autoreleasepool
    {
        gAWDServerConnection = <span class="enscript-type">[</span><span class="enscript-type">[</span>AWDServerConnectionSoft alloc<span class="enscript-type">]</span>
            initWithComponentId:     AWDComponentId_MDNSResponder
            andBlockOnConfiguration: NO<span class="enscript-type">]</span>;

        <span class="enscript-keyword">if</span> (gAWDServerConnection)
        {
            <span class="enscript-type">[</span>gAWDServerConnection
                registerQueriableMetricCallback: ^(UInt32 inMetricID)
                {
                    SubmitAWDMetric(inMetricID);
                }
                forIdentifier: (UInt32)AWDMetricId_MDNSResponder_DNSStatistics<span class="enscript-type">]</span>;

            <span class="enscript-type">[</span>gAWDServerConnection
                registerQueriableMetricCallback: ^(UInt32 inMetricID)
                {
                    SubmitAWDMetric(inMetricID);
                }
                forIdentifier: (UInt32)AWDMetricId_MDNSResponder_ServicesStats<span class="enscript-type">]</span>;

            <span class="enscript-type">[</span>gAWDServerConnection
                registerQueriableMetricCallback: ^(UInt32 inMetricID)
                {
                    SubmitAWDMetric(inMetricID);
                }
                forIdentifier: (UInt32)AWDMetricId_MDNSResponder_DNSMessageSizeStats<span class="enscript-type">]</span>;
        }
        <span class="enscript-keyword">else</span>
        {
            LogMsg(&quot;MetricsInit: failed to create AWD server connection.&quot;);
        }
    }

    <span class="enscript-keyword">if</span>( gAWDServerConnection )
    {
        CreateQueryStatsList(&amp;gQueryStatsList);
        DNSMessageSizeStatsCreate(&amp;gDNSMessageSizeStats);
    }

    <span class="enscript-keyword">return</span> (mStatus_NoError);
}

//===========================================================================================================================
//  MetricsUpdateDNSQueryStats
//===========================================================================================================================

mDNSexport void MetricsUpdateDNSQueryStats(const domainname *inQueryName, mDNSu16 inType, const ResourceRecord *inRR, mDNSu32 inSendCount, ExpiredAnswerMetric inExpiredAnswerState, DNSOverTCPMetric inDNSOverTCPState, mDNSu32 inLatencyMs, mDNSBool inForCell)
{
    QueryStats *        stats;
    mDNSBool            match;

    require_quiet(gAWDServerConnection, exit);
    require_quiet((inType == kDNSType_A) || (inType == kDNSType_AAAA), exit);

    <span class="enscript-keyword">for</span> (stats = gQueryStatsList; stats; stats = stats-&gt;next)
    {
        match = stats-&gt;test(stats, inQueryName);
        <span class="enscript-keyword">if</span> (match)
        {
            QueryStatsUpdate(stats, inType, inRR, inSendCount, inExpiredAnswerState, inDNSOverTCPState, inLatencyMs, inForCell);
            <span class="enscript-keyword">if</span> (stats-&gt;<span class="enscript-type">terminal</span>) <span class="enscript-keyword">break</span>;
        }
    }

exit:
    <span class="enscript-keyword">return</span>;
}

//===========================================================================================================================
//  MetricsUpdateDNSQuerySize
//===========================================================================================================================

mDNSlocal void UpdateMessageSizeCounts(uint32_t *inBins, size_t inBinCount, unsigned int inBinWidth, uint32_t inSize);

mDNSexport void MetricsUpdateDNSQuerySize(mDNSu32 inSize)
{
    <span class="enscript-keyword">if</span> (!gDNSMessageSizeStats) <span class="enscript-keyword">return</span>;
    UpdateMessageSizeCounts(gDNSMessageSizeStats-&gt;querySizeBins, kQuerySizeBinCount, kQuerySizeBinWidth, inSize);
}

mDNSlocal void UpdateMessageSizeCounts(uint32_t *inBins, size_t inBinCount, unsigned int inBinWidth, uint32_t inSize)
{
    size_t      <span class="enscript-type">i</span>;

    <span class="enscript-keyword">if</span> (inSize == 0) <span class="enscript-keyword">return</span>;
    <span class="enscript-type">i</span> = (inSize - 1) / inBinWidth;
    <span class="enscript-keyword">if</span> (<span class="enscript-type">i</span> &gt;= inBinCount) <span class="enscript-type">i</span> = inBinCount - 1;
    IncrementBin32(&amp;inBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>);
}

//===========================================================================================================================
//  MetricsUpdateDNSResponseSize
//===========================================================================================================================

mDNSexport void MetricsUpdateDNSResponseSize(mDNSu32 inSize)
{
    <span class="enscript-keyword">if</span> (!gDNSMessageSizeStats) <span class="enscript-keyword">return</span>;
    UpdateMessageSizeCounts(gDNSMessageSizeStats-&gt;responseSizeBins, kResponseSizeBinCount, kResponseSizeBinWidth, inSize);
}

//===========================================================================================================================
//  LogMetrics
//===========================================================================================================================

mDNSexport void LogMetricsToFD(int fd)
{
    QueryStats *        stats;

    LogToFD(fd, &quot;gAWDServerConnection <span class="enscript-comment">%p&quot;, gAWDServerConnection);
</span>    LogToFD(fd, &quot;---- DNS query stats by domain -----&quot;);

    <span class="enscript-keyword">for</span> (stats = gQueryStatsList; stats; stats = stats-&gt;next)
    {
        <span class="enscript-keyword">if</span> (!stats-&gt;nonCellular &amp;&amp; !stats-&gt;cellular)
        {
            LogToFD(fd, &quot;No data <span class="enscript-keyword">for</span> <span class="enscript-comment">%s&quot;, QueryStatsGetDomainString(stats));
</span>            continue;
        }
        <span class="enscript-keyword">if</span> (stats-&gt;nonCellular) LogDNSHistSetToFD(fd, stats-&gt;nonCellular, QueryStatsGetDomainString(stats), mDNSfalse);
        <span class="enscript-keyword">if</span> (stats-&gt;cellular)    LogDNSHistSetToFD(fd, stats-&gt;cellular,    QueryStatsGetDomainString(stats), mDNStrue);
    }

    LogToFD(fd, &quot;---- Num of Services Registered -----&quot;);
    LogToFD(fd, &quot;Current_number_of_services_registered :<span class="enscript-type">[</span><span class="enscript-comment">%d], Max_number_of_services_registered :[%d]&quot;,
</span>              curr_num_regservices, max_num_regservices);

    <span class="enscript-keyword">if</span> (gDNSMessageSizeStats)
    {
        LogToFD(fd, &quot;---- DNS query <span class="enscript-type">size</span> stats ---&quot;);
        LogDNSMessageSizeStatsToFD(fd, gDNSMessageSizeStats-&gt;querySizeBins, kQuerySizeBinCount, kQuerySizeBinWidth);

        LogToFD(fd, &quot;-- DNS response <span class="enscript-type">size</span> stats --&quot;);
        LogDNSMessageSizeStatsToFD(fd, gDNSMessageSizeStats-&gt;responseSizeBins, kResponseSizeBinCount, kResponseSizeBinWidth);
    }
    <span class="enscript-keyword">else</span>
    {
        LogToFD(fd, &quot;No DNS message <span class="enscript-type">size</span> stats.&quot;);
    }
}

//===========================================================================================================================
//  QueryStatsCreate
//===========================================================================================================================

mDNSlocal mStatus StringToDomainName(const <span class="enscript-type">char</span> *inString, uint8_t **outDomainName);

mDNSlocal mStatus QueryStatsCreate(const <span class="enscript-type">char</span> *inDomainStr, const <span class="enscript-type">char</span> *inAltDomainStr, QueryNameTest_f inTest, mDNSBool inTerminal, QueryStats **outStats)
{
    mStatus             err;
    QueryStats *        obj;

    obj = (QueryStats *)calloc(1, sizeof(*obj));
    require_action_quiet(obj, exit, err = mStatus_NoMemoryErr);

    obj-&gt;domainStr = inDomainStr;
    err = StringToDomainName(obj-&gt;domainStr, &amp;obj-&gt;domain);
    require_noerr_quiet(err, exit);

    obj-&gt;altDomainStr   = inAltDomainStr;
    obj-&gt;test           = inTest;
    obj-&gt;labelCount     = CountLabels((const domainname *)obj-&gt;domain);
    obj-&gt;<span class="enscript-type">terminal</span>       = inTerminal;

    *outStats = obj;
    obj = NULL;
    err = mStatus_NoError;

exit:
    <span class="enscript-keyword">if</span> (obj) QueryStatsFree(obj);
    <span class="enscript-keyword">return</span> (err);
}

mDNSlocal mStatus StringToDomainName(const <span class="enscript-type">char</span> *inString, uint8_t **outDomainName)
{
    mStatus             err;
    uint8_t *           domainPtr = NULL;
    size_t              domainLen;
    const mDNSu8 *      ptr;
    domainname          domain;

    <span class="enscript-keyword">if</span> (<span class="enscript-type">strcmp</span>(inString, &quot;.&quot;) == 0)
    {
        domain.c<span class="enscript-type">[</span>0<span class="enscript-type">]</span> = 0;
    }
    <span class="enscript-keyword">else</span>
    {
        ptr = MakeDomainNameFromDNSNameString(&amp;domain, inString);
        require_action_quiet(ptr, exit, err = mStatus_BadParamErr);
    }
    domainLen = DomainNameLength(&amp;domain);

    domainPtr = (uint8_t *)malloc(domainLen);
    require_action_quiet(domainPtr, exit, err = mStatus_NoMemoryErr);

    memcpy(domainPtr, domain.c, domainLen);

    *outDomainName = domainPtr;
    domainPtr = NULL;
    err = mStatus_NoError;

exit:
    <span class="enscript-keyword">return</span>(err);
}

//===========================================================================================================================
//  QueryStatsFree
//===========================================================================================================================

mDNSlocal void QueryStatsFree(QueryStats *inStats)
{
    ForgetMem(&amp;inStats-&gt;domain);
    <span class="enscript-keyword">if</span> (inStats-&gt;nonCellular)
    {
        ForgetMem(&amp;inStats-&gt;nonCellular-&gt;histA);
        ForgetMem(&amp;inStats-&gt;nonCellular-&gt;histAAAA);
        free(inStats-&gt;nonCellular);
        inStats-&gt;nonCellular = NULL;
    }
    <span class="enscript-keyword">if</span> (inStats-&gt;cellular)
    {
        ForgetMem(&amp;inStats-&gt;cellular-&gt;histA);
        ForgetMem(&amp;inStats-&gt;cellular-&gt;histAAAA);
        free(inStats-&gt;cellular);
        inStats-&gt;cellular = NULL;
    }
    free(inStats);
}

//===========================================================================================================================
//  QueryStatsFreeList
//===========================================================================================================================

mDNSlocal void QueryStatsFreeList(QueryStats *inList)
{
    QueryStats *        stats;

    <span class="enscript-keyword">while</span> ((stats = inList) != NULL)
    {
        inList = stats-&gt;next;
        QueryStatsFree(stats);
    }
}

//===========================================================================================================================
//  QueryStatsUpdate
//===========================================================================================================================

mDNSlocal mStatus QueryStatsUpdate(QueryStats *inStats, int inType, const ResourceRecord *inRR, mDNSu32 inQuerySendCount, ExpiredAnswerMetric inExpiredAnswerState, DNSOverTCPMetric inDNSOverTCPState, mDNSu32 inLatencyMs, mDNSBool inForCell)
{
    mStatus             err;
    DNSHistSet *        <span class="enscript-type">set</span>;
    DNSHistSet **       pSet;
    DNSHist *           <span class="enscript-type">hist</span>;
    DNSHist **          pHist;
    int                 <span class="enscript-type">i</span>;

    require_action_quiet(inRR || (inQuerySendCount &gt; 0), exit, err = mStatus_NoError);
    require_action_quiet((inType == kDNSType_A) || (inType == kDNSType_AAAA), exit, err = mStatus_NoError);

    pSet = inForCell ? &amp;inStats-&gt;cellular : &amp;inStats-&gt;nonCellular;
    <span class="enscript-keyword">if</span> ((<span class="enscript-type">set</span> = *pSet) == NULL)
    {
        <span class="enscript-type">set</span> = (DNSHistSet *)calloc(1, sizeof(*<span class="enscript-type">set</span>));
        require_action_quiet(<span class="enscript-type">set</span>, exit, err = mStatus_NoMemoryErr);
        *pSet = <span class="enscript-type">set</span>;
    }
    pHist = (inType == kDNSType_A) ? &amp;<span class="enscript-type">set</span>-&gt;histA : &amp;<span class="enscript-type">set</span>-&gt;histAAAA;
    <span class="enscript-keyword">if</span> ((<span class="enscript-type">hist</span> = *pHist) == NULL)
    {
        <span class="enscript-type">hist</span> = (DNSHist *)calloc(1, sizeof(*<span class="enscript-type">hist</span>));
        require_action_quiet(<span class="enscript-type">hist</span>, exit, err = mStatus_NoMemoryErr);
        *pHist = <span class="enscript-type">hist</span>;
    }

    <span class="enscript-keyword">if</span> (inRR)
    {
        uint16_t *          sendCountBins;
        uint16_t *          latencyBins;
        const mDNSBool      isNegative = (inRR-&gt;RecordType == kDNSRecordTypePacketNegative);

        <span class="enscript-type">i</span> = Min(inQuerySendCount, kQueryStatsMaxQuerySendCount);

        sendCountBins = isNegative ? <span class="enscript-type">hist</span>-&gt;negAnsweredQuerySendCountBins : <span class="enscript-type">hist</span>-&gt;answeredQuerySendCountBins;
        IncrementBin16(&amp;sendCountBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>);

        <span class="enscript-keyword">if</span> (inQuerySendCount &gt; 0)
        {
            <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; (<span class="enscript-type">i</span> &lt; (int)countof(kResponseLatencyMsLimits)) &amp;&amp; (inLatencyMs &gt;= kResponseLatencyMsLimits<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>); ++<span class="enscript-type">i</span>) {}
            latencyBins = isNegative ? <span class="enscript-type">hist</span>-&gt;negResponseLatencyBins : <span class="enscript-type">hist</span>-&gt;responseLatencyBins;
            IncrementBin16(&amp;latencyBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>);
        }
    }
    <span class="enscript-keyword">else</span>
    {
        <span class="enscript-type">i</span> = Min(inQuerySendCount, kQueryStatsMaxQuerySendCount);
        IncrementBin16(&amp;<span class="enscript-type">hist</span>-&gt;unansweredQuerySendCountBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>);

        <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; (<span class="enscript-type">i</span> &lt; (int)countof(kResponseLatencyMsLimits)) &amp;&amp; (inLatencyMs &gt;= kResponseLatencyMsLimits<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>); ++<span class="enscript-type">i</span>) {}
        IncrementBin16(&amp;<span class="enscript-type">hist</span>-&gt;unansweredQueryDurationBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>);
    }
    IncrementBin32(&amp;<span class="enscript-type">hist</span>-&gt;expiredAnswerStateBins<span class="enscript-type">[</span>Min(inExpiredAnswerState, (kQueryStatsExpiredAnswerStateCount - 1))<span class="enscript-type">]</span>);
    IncrementBin32(&amp;<span class="enscript-type">hist</span>-&gt;dnsOverTCPStateBins<span class="enscript-type">[</span>Min(inDNSOverTCPState, (kQueryStatsDNSOverTCPStateCount - 1))<span class="enscript-type">]</span>);
    err = mStatus_NoError;

exit:
    <span class="enscript-keyword">return</span> (err);
}

//===========================================================================================================================
//  QueryStatsGetDomainString
//===========================================================================================================================

mDNSlocal const <span class="enscript-type">char</span> * QueryStatsGetDomainString(const QueryStats *inStats)
{
    <span class="enscript-keyword">return</span> (inStats-&gt;altDomainStr ? inStats-&gt;altDomainStr : inStats-&gt;domainStr);
}

//===========================================================================================================================
//  QueryStatsDomainTest
//===========================================================================================================================

mDNSlocal mDNSBool QueryStatsDomainTest(const QueryStats *inStats, const domainname *inQueryName)
{
    const domainname *      parentDomain;
    int                     labelCount;

    <span class="enscript-keyword">if</span> (inStats-&gt;domain<span class="enscript-type">[</span>0<span class="enscript-type">]</span> == 0) <span class="enscript-keyword">return</span> (mDNStrue);

    labelCount = CountLabels(inQueryName);
    <span class="enscript-keyword">if</span> (labelCount &lt; inStats-&gt;labelCount) <span class="enscript-keyword">return</span> (mDNSfalse);

    parentDomain = SkipLeadingLabels(inQueryName, labelCount - inStats-&gt;labelCount);
    <span class="enscript-keyword">return</span> (SameDomainName(parentDomain, (const domainname *)inStats-&gt;domain));
}

//===========================================================================================================================
//  QueryStatsHostnameTest
//===========================================================================================================================

mDNSlocal mDNSBool QueryStatsHostnameTest(const QueryStats *inStats, const domainname *inQueryName)
{
    <span class="enscript-keyword">return</span> (SameDomainName(inQueryName, (const domainname *)inStats-&gt;domain));
}

//===========================================================================================================================
//  QueryStatsContentiCloudTest
//===========================================================================================================================

mDNSlocal const uint8_t *LocateLabelSuffix(const uint8_t *inLabel, const uint8_t *inSuffixPtr, size_t inSuffixLen);

#define kContentSuffixStr       &quot;-content&quot;

mDNSlocal mDNSBool QueryStatsContentiCloudTest(const QueryStats *inStats, const domainname *inQueryName)
{
    const mDNSu8 * const    firstLabel = inQueryName-&gt;c;
    const uint8_t *         suffix;
    const domainname *      parentDomain;
    int                     labelCount;

    (void) inStats; // Unused.

    labelCount = CountLabels(inQueryName);
    <span class="enscript-keyword">if</span> (labelCount != 3) <span class="enscript-keyword">return</span> (mDNSfalse);

    suffix = LocateLabelSuffix(firstLabel, (const uint8_t *)kContentSuffixStr, sizeof_string(kContentSuffixStr));
    <span class="enscript-keyword">if</span> (suffix &amp;&amp; (suffix &gt; &amp;firstLabel<span class="enscript-type">[</span>1<span class="enscript-type">]</span>))
    {
        parentDomain = SkipLeadingLabels(inQueryName, 1);
        <span class="enscript-keyword">if</span> (SameDomainName(parentDomain, (const domainname *)&quot;\x6&quot; &quot;icloud&quot; &quot;\x3&quot; &quot;com&quot;))
        {
            <span class="enscript-keyword">return</span> (mDNStrue);
        }
    }

    <span class="enscript-keyword">return</span> (mDNSfalse);
}

mDNSlocal const uint8_t *LocateLabelSuffix(const uint8_t *inLabel, const uint8_t *inSuffixPtr, size_t inSuffixLen)
{
    const uint8_t *     ptr;
    const uint8_t *     lp;
    const uint8_t *     sp;
    size_t              len;
    const size_t        labelLen = inLabel<span class="enscript-type">[</span>0<span class="enscript-type">]</span>;

    <span class="enscript-keyword">if</span> (labelLen &lt; inSuffixLen) <span class="enscript-keyword">return</span> (NULL);

    ptr = &amp;inLabel<span class="enscript-type">[</span>1 + labelLen - inSuffixLen<span class="enscript-type">]</span>;
    lp  = ptr;
    sp  = inSuffixPtr;
    <span class="enscript-keyword">for</span> (len = inSuffixLen; len &gt; 0; --len)
    {
        <span class="enscript-keyword">if</span> (tolower(*lp) != tolower(*sp)) <span class="enscript-keyword">return</span> (NULL);
        ++lp;
        ++sp;
    }

    <span class="enscript-keyword">return</span> (ptr);
}

//===========================================================================================================================
//  QueryStatsCourierPushTest
//===========================================================================================================================

#define kCourierSuffixStr       &quot;-courier&quot;

mDNSlocal mDNSBool QueryStatsCourierPushTest(const QueryStats *inStats, const domainname *inQueryName)
{
    const mDNSu8 * const    firstLabel = inQueryName-&gt;c;
    const uint8_t *         suffix;
    const uint8_t *         ptr;
    const domainname *      parentDomain;
    int                     labelCount;

    (void) inStats; // Unused.

    labelCount = CountLabels(inQueryName);
    <span class="enscript-keyword">if</span> (labelCount != 4) <span class="enscript-keyword">return</span> (mDNSfalse);

    suffix = LocateLabelSuffix(firstLabel, (const mDNSu8 *)kCourierSuffixStr, sizeof_string(kCourierSuffixStr));
    <span class="enscript-keyword">if</span> (suffix &amp;&amp; (suffix &gt; &amp;firstLabel<span class="enscript-type">[</span>1<span class="enscript-type">]</span>))
    {
        <span class="enscript-keyword">for</span> (ptr = &amp;firstLabel<span class="enscript-type">[</span>1<span class="enscript-type">]</span>; ptr &lt; suffix; ++ptr)
        {
            <span class="enscript-keyword">if</span> (!isdigit(*ptr)) <span class="enscript-keyword">break</span>;
        }
        <span class="enscript-keyword">if</span> (ptr == suffix)
        {
            parentDomain = SkipLeadingLabels(inQueryName, 1);
            <span class="enscript-keyword">if</span> (SameDomainName(parentDomain, (const domainname *)&quot;\x4&quot; &quot;push&quot; &quot;\x5&quot; &quot;apple&quot; &quot;\x3&quot; &quot;com&quot;))
            {
                <span class="enscript-keyword">return</span> (mDNStrue);
            }
        }
    }

    <span class="enscript-keyword">return</span> (mDNSfalse);
}

//===========================================================================================================================
//  DNSMessageSizeStatsCreate
//===========================================================================================================================

mDNSlocal mStatus DNSMessageSizeStatsCreate(DNSMessageSizeStats **outStats)
{
    mStatus                     err;
    DNSMessageSizeStats *       stats;

    stats = (DNSMessageSizeStats *)calloc(1, sizeof(*stats));
    require_action_quiet(stats, exit, err = mStatus_NoMemoryErr);

    *outStats = stats;
    err = mStatus_NoError;

exit:
    <span class="enscript-keyword">return</span> (err);
}

//===========================================================================================================================
//  DNSMessageSizeStatsFree
//===========================================================================================================================

mDNSlocal void DNSMessageSizeStatsFree(DNSMessageSizeStats *inStats)
{
    free(inStats);
}

//===========================================================================================================================
//  CreateQueryStatsList
//===========================================================================================================================

mDNSlocal mStatus CreateQueryStatsList(QueryStats **outList)
{
    mStatus                             err;
    QueryStats **                       p;
    QueryStats *                        stats;
    const QueryStatsArgs *              args;
    const QueryStatsArgs * const        <span class="enscript-keyword">end</span>     = kQueryStatsArgs + countof(kQueryStatsArgs);
    QueryStats *                        list    = NULL;

    p = &amp;list;
    <span class="enscript-keyword">for</span> (args = kQueryStatsArgs; args &lt; <span class="enscript-keyword">end</span>; ++args)
    {
        err = QueryStatsCreate(args-&gt;domainStr, args-&gt;altDomainStr, args-&gt;test, args-&gt;<span class="enscript-type">terminal</span>, &amp;stats);
        require_noerr_quiet(err, exit);

        *p = stats;
        p = &amp;stats-&gt;next;
    }

    *outList = list;
    list = NULL;
    err = mStatus_NoError;

exit:
    QueryStatsFreeList(list);
    <span class="enscript-keyword">return</span> (err);
}

//===========================================================================================================================
//  SubmitAWDMetric
//===========================================================================================================================

mDNSlocal mStatus SubmitAWDMetric(UInt32 inMetricID)
{
    mStatus     err;

    <span class="enscript-keyword">switch</span> (inMetricID)
    {
        <span class="enscript-type">case</span> AWDMetricId_MDNSResponder_DNSStatistics:
            err = SubmitAWDMetricQueryStats();
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> AWDMetricId_MDNSResponder_ServicesStats:
            <span class="enscript-type">[</span>AWDMetricManagerSoft postMetricWithId:AWDMetricId_MDNSResponder_ServicesStats unsignedIntegerValue:max_num_regservices<span class="enscript-type">]</span>;
            KQueueLock();
            // <span class="enscript-type">reset</span> the no of <span class="enscript-type">max</span> services since we want to collect the <span class="enscript-type">max</span> no of services registered per AWD submission period
            max_num_regservices = curr_num_regservices;
            KQueueUnlock(&quot;SubmitAWDSimpleMetricServiceStats&quot;);
            err = mStatus_NoError;
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> AWDMetricId_MDNSResponder_DNSMessageSizeStats:
            err = SubmitAWDMetricDNSMessageSizeStats();
            <span class="enscript-keyword">break</span>;

        default:
            err = mStatus_UnsupportedErr;
            <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">if</span> (err) LogMsg(&quot;SubmitAWDMetric <span class="enscript-keyword">for</span> metric ID 0x<span class="enscript-comment">%08X failed with error %d&quot;, inMetricID, err);
</span>    <span class="enscript-keyword">return</span> (err);
}

//===========================================================================================================================
//  SubmitAWDMetricQueryStats
//===========================================================================================================================

mDNSlocal mStatus   AddQueryStats(AWDMDNSResponderDNSStatistics *inMetric, const QueryStats *inStats);
mDNSlocal mStatus   AddDNSHistSet(AWDMDNSResponderDNSStatistics *inMetric, DNSHistSet *inSet, const <span class="enscript-type">char</span> *inDomain, mDNSBool inForCell);

mDNSlocal mStatus SubmitAWDMetricQueryStats(void)
{
    mStatus                             err;
    BOOL                                success;
    QueryStats *                        stats;
    QueryStats *                        statsList;
    QueryStats *                        newStatsList;
    AWDMetricContainer *                container   = nil;
    AWDMDNSResponderDNSStatistics *     metric      = nil;

    newStatsList = NULL;
    CreateQueryStatsList(&amp;newStatsList);

    KQueueLock();
    statsList       = gQueryStatsList;
    gQueryStatsList = newStatsList;
    KQueueUnlock(&quot;SubmitAWDMetricQueryStats&quot;);

    container = <span class="enscript-type">[</span>gAWDServerConnection newMetricContainerWithIdentifier:AWDMetricId_MDNSResponder_DNSStatistics<span class="enscript-type">]</span>;
    require_action_quiet(container, exit, err = mStatus_UnknownErr);

    metric = <span class="enscript-type">[</span><span class="enscript-type">[</span>AWDMDNSResponderDNSStatisticsSoft alloc<span class="enscript-type">]</span> init<span class="enscript-type">]</span>;
    require_action_quiet(metric, exit, err = mStatus_UnknownErr);

    <span class="enscript-keyword">while</span> ((stats = statsList) != NULL)
    {
        err = AddQueryStats(metric, stats);
        require_noerr_quiet(err, exit);

        statsList = stats-&gt;next;
        QueryStatsFree(stats);
    }

    container.metric = metric;
    success = <span class="enscript-type">[</span>gAWDServerConnection submitMetric:container<span class="enscript-type">]</span>;
    LogMsg(&quot;SubmitAWDMetricQueryStats: metric submission <span class="enscript-comment">%s.&quot;, success ? &quot;succeeded&quot; : &quot;failed&quot;);
</span>    err = success ? mStatus_NoError : mStatus_UnknownErr;

exit:
    QueryStatsFreeList(statsList);
    <span class="enscript-keyword">return</span> (err);
}

mDNSlocal mStatus AddQueryStats(AWDMDNSResponderDNSStatistics *inMetric, const QueryStats *inStats)
{
    mStatus     err;

    <span class="enscript-keyword">if</span> (inStats-&gt;nonCellular)
    {
        err = AddDNSHistSet(inMetric, inStats-&gt;nonCellular, QueryStatsGetDomainString(inStats), mDNSfalse);
        require_noerr_quiet(err, exit);
    }
    <span class="enscript-keyword">if</span> (inStats-&gt;cellular)
    {
        err = AddDNSHistSet(inMetric, inStats-&gt;cellular, QueryStatsGetDomainString(inStats), mDNStrue);
        require_noerr_quiet(err, exit);
    }
    err = mStatus_NoError;

exit:
    <span class="enscript-keyword">return</span> (err);
}

mDNSlocal mStatus AddDNSHistSet(AWDMDNSResponderDNSStatistics *inMetric, DNSHistSet *inSet, const <span class="enscript-type">char</span> *inDomain, mDNSBool inForCell)
{
    mStatus                 err;
    AWDDNSDomainStats *     awdStats;

    <span class="enscript-keyword">if</span> (inSet-&gt;histA)
    {
        err = CreateAWDDNSDomainStats(inSet-&gt;histA, inDomain, inForCell, AWDDNSDomainStats_RecordType_A, &amp;awdStats);
        require_noerr_quiet(err, exit);

        <span class="enscript-type">[</span>inMetric addStats:awdStats<span class="enscript-type">]</span>;
    }
    <span class="enscript-keyword">if</span> (inSet-&gt;histAAAA)
    {
        err = CreateAWDDNSDomainStats(inSet-&gt;histAAAA, inDomain, inForCell, AWDDNSDomainStats_RecordType_AAAA, &amp;awdStats);
        require_noerr_quiet(err, exit);

        <span class="enscript-type">[</span>inMetric addStats:awdStats<span class="enscript-type">]</span>;
    }
    err = mStatus_NoError;

exit:
    <span class="enscript-keyword">return</span> (err);
}

//===========================================================================================================================
//  SubmitAWDMetricDNSMessageSizeStats
//===========================================================================================================================

mDNSlocal mStatus SubmitAWDMetricDNSMessageSizeStats(void)
{
    mStatus                                     err;
    DNSMessageSizeStats *                       stats;
    DNSMessageSizeStats *                       newStats;
    AWDMetricContainer *                        container;
    AWDMDNSResponderDNSMessageSizeStats *       metric = nil;
    BOOL                                        success;

    newStats = NULL;
    DNSMessageSizeStatsCreate(&amp;newStats);

    KQueueLock();
    stats                   = gDNSMessageSizeStats;
    gDNSMessageSizeStats    = newStats;
    KQueueUnlock(&quot;SubmitAWDMetricDNSMessageSizeStats&quot;);

    container = <span class="enscript-type">[</span>gAWDServerConnection newMetricContainerWithIdentifier:AWDMetricId_MDNSResponder_DNSMessageSizeStats<span class="enscript-type">]</span>;
    require_action_quiet(container, exit, err = mStatus_UnknownErr);

    metric = <span class="enscript-type">[</span><span class="enscript-type">[</span>AWDMDNSResponderDNSMessageSizeStatsSoft alloc<span class="enscript-type">]</span> init<span class="enscript-type">]</span>;
    require_action_quiet(metric, exit, err = mStatus_UnknownErr);

    <span class="enscript-keyword">if</span> (stats)
    {
        size_t          binCount;
        uint32_t        bins<span class="enscript-type">[</span>Max(kQuerySizeBinCount, kResponseSizeBinCount)<span class="enscript-type">]</span>;

        // Set query <span class="enscript-type">size</span> counts.

        binCount = CopyBins32(bins, stats-&gt;querySizeBins, kQuerySizeBinCount);
        <span class="enscript-type">[</span>metric setQuerySizeCounts:bins count:(NSUInteger)binCount<span class="enscript-type">]</span>;

        // Set response <span class="enscript-type">size</span> counts.

        binCount = CopyBins32(bins, stats-&gt;responseSizeBins, kResponseSizeBinCount);
        <span class="enscript-type">[</span>metric setResponseSizeCounts:bins count:(NSUInteger)binCount<span class="enscript-type">]</span>;
    }

    container.metric = metric;
    success = <span class="enscript-type">[</span>gAWDServerConnection submitMetric:container<span class="enscript-type">]</span>;
    LogMsg(&quot;SubmitAWDMetricDNSMessageSizeStats: metric submission <span class="enscript-comment">%s.&quot;, success ? &quot;succeeded&quot; : &quot;failed&quot;);
</span>    err = success ? mStatus_NoError : mStatus_UnknownErr;

exit:
    <span class="enscript-keyword">if</span> (stats) DNSMessageSizeStatsFree(stats);
    <span class="enscript-keyword">return</span> (err);
}

//===========================================================================================================================
//  CreateAWDDNSDomainStats
//===========================================================================================================================

mDNSlocal mStatus CreateAWDDNSDomainStats(DNSHist *inHist, const <span class="enscript-type">char</span> *inDomain, mDNSBool inForCell, AWDDNSDomainStats_RecordType inType, AWDDNSDomainStats **outStats)
{
    mStatus                 err;
    AWDDNSDomainStats *     awdStats    = nil;
    NSString *              domain      = nil;
    size_t                  binCount;
    uint32_t                sendCountBins<span class="enscript-type">[</span>kQueryStatsSendCountBinCount<span class="enscript-type">]</span>;
    uint32_t                latencyBins<span class="enscript-type">[</span>kQueryStatsLatencyBinCount<span class="enscript-type">]</span>;
    uint32_t                expiredAnswerBins<span class="enscript-type">[</span>kQueryStatsExpiredAnswerStateCount<span class="enscript-type">]</span>;
    uint32_t                dnsOverTCPBins<span class="enscript-type">[</span>kQueryStatsDNSOverTCPStateCount<span class="enscript-type">]</span>;

    awdStats = <span class="enscript-type">[</span><span class="enscript-type">[</span>AWDDNSDomainStatsSoft alloc<span class="enscript-type">]</span> init<span class="enscript-type">]</span>;
    require_action_quiet(awdStats, exit, err = mStatus_UnknownErr);

    domain = <span class="enscript-type">[</span><span class="enscript-type">[</span>NSString alloc<span class="enscript-type">]</span> initWithUTF8String:inDomain<span class="enscript-type">]</span>;
    require_action_quiet(domain, exit, err = mStatus_UnknownErr);

    awdStats.domain      = domain;
    awdStats.networkType = inForCell ? AWDDNSDomainStats_NetworkType_Cellular : AWDDNSDomainStats_NetworkType_NonCellular;
    awdStats.recordType  = inType;

    // Positively answered query send counts

    binCount = CopyBins16(sendCountBins, inHist-&gt;answeredQuerySendCountBins, kQueryStatsSendCountBinCount);
    <span class="enscript-type">[</span>awdStats setAnsweredQuerySendCounts:sendCountBins count:(NSUInteger)binCount<span class="enscript-type">]</span>;

    // binCount &gt; 1 means that at least one of the non-zero send count bins had a non-zero count, <span class="enscript-type">i</span>.e., at least one query
    // was sent out on the wire. In that <span class="enscript-type">case</span>, include the associated latency bins as well.

    <span class="enscript-keyword">if</span> (binCount &gt; 1)
    {
        binCount = CopyBins16(latencyBins, inHist-&gt;responseLatencyBins, kQueryStatsLatencyBinCount);
        <span class="enscript-type">[</span>awdStats setResponseLatencyMs:latencyBins count:(NSUInteger)binCount<span class="enscript-type">]</span>;
    }

    // Negatively answered query send counts

    binCount = CopyBins16(sendCountBins, inHist-&gt;negAnsweredQuerySendCountBins, kQueryStatsSendCountBinCount);
    <span class="enscript-type">[</span>awdStats setNegAnsweredQuerySendCounts:sendCountBins count:(NSUInteger)binCount<span class="enscript-type">]</span>;

    <span class="enscript-keyword">if</span> (binCount &gt; 1)
    {
        binCount = CopyBins16(latencyBins, inHist-&gt;negResponseLatencyBins, kQueryStatsLatencyBinCount);
        <span class="enscript-type">[</span>awdStats setNegResponseLatencyMs:latencyBins count:(NSUInteger)binCount<span class="enscript-type">]</span>;
    }

    // Unanswered query send counts

    binCount = CopyBins16(sendCountBins, inHist-&gt;unansweredQuerySendCountBins, kQueryStatsSendCountBinCount);
    <span class="enscript-type">[</span>awdStats setUnansweredQuerySendCounts:sendCountBins count:(NSUInteger)binCount<span class="enscript-type">]</span>;

    <span class="enscript-keyword">if</span> (binCount &gt; 1)
    {
        binCount = CopyBins16(latencyBins, inHist-&gt;unansweredQueryDurationBins, kQueryStatsLatencyBinCount);
        <span class="enscript-type">[</span>awdStats setUnansweredQueryDurationMs:latencyBins count:(NSUInteger)binCount<span class="enscript-type">]</span>;
    }
    
    // Expired answers states
    
    binCount = CopyBins32(expiredAnswerBins, inHist-&gt;expiredAnswerStateBins, kQueryStatsExpiredAnswerStateCount);
    <span class="enscript-type">[</span>awdStats setExpiredAnswerStates:expiredAnswerBins count:(NSUInteger)binCount<span class="enscript-type">]</span>;

    // DNS Over TCP states

    binCount = CopyBins32(dnsOverTCPBins, inHist-&gt;dnsOverTCPStateBins, kQueryStatsDNSOverTCPStateCount);
    <span class="enscript-type">[</span>awdStats setDnsOverTCPStates:dnsOverTCPBins count:(NSUInteger)binCount<span class="enscript-type">]</span>;

   *outStats = awdStats;
    err = mStatus_NoError;

exit:
    <span class="enscript-keyword">return</span> (err);
}

//===========================================================================================================================
//  LogDNSHistSetToFD
//===========================================================================================================================

mDNSlocal void LogDNSHistSetToFD(int fd, const DNSHistSet *inSet, const <span class="enscript-type">char</span> *inDomain, mDNSBool inForCell)
{
    <span class="enscript-keyword">if</span> (inSet-&gt;histA)       LogDNSHistToFD(fd, inSet-&gt;histA,    inDomain, inForCell, &quot;A&quot;);
    <span class="enscript-keyword">if</span> (inSet-&gt;histAAAA)    LogDNSHistToFD(fd, inSet-&gt;histAAAA, inDomain, inForCell, &quot;AAAA&quot;);
}

//===========================================================================================================================
//  LogDNSHistToFD
//===========================================================================================================================

#define Percent(N, D)       (((N) * 100) / (D)), ((((N) * 10000) / (D)) <span class="enscript-comment">% 100)
</span>#define PercentFmt          &quot;<span class="enscript-comment">%3u.%02u&quot;
</span>#define LogStatToFD(FILE_DESCRIPTOR, LABEL, COUNT, ACCUMULATOR, TOTAL) \
    LogToFD((FILE_DESCRIPTOR), &quot;<span class="enscript-comment">%s %5u &quot; PercentFmt &quot; &quot; PercentFmt, (LABEL), (COUNT), Percent(COUNT, TOTAL), Percent(ACCUMULATOR, TOTAL))
</span>
mDNSlocal void LogDNSHistToFD(int fd, const DNSHist *inHist, const <span class="enscript-type">char</span> *inDomain, mDNSBool inForCell, const <span class="enscript-type">char</span> *inType)
{
    unsigned int        totalAnswered;
    unsigned int        totalNegAnswered;
    unsigned int        totalUnanswered;
    int                 <span class="enscript-type">i</span>;

    totalAnswered = 0;
    <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; <span class="enscript-type">i</span> &lt; kQueryStatsSendCountBinCount; ++<span class="enscript-type">i</span>)
    {
        totalAnswered += inHist-&gt;answeredQuerySendCountBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>;
    }

    totalNegAnswered = 0;
    <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; <span class="enscript-type">i</span> &lt; kQueryStatsSendCountBinCount; ++<span class="enscript-type">i</span>)
    {
        totalNegAnswered += inHist-&gt;negAnsweredQuerySendCountBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>;
    }

    totalUnanswered = 0;
    <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; <span class="enscript-type">i</span> &lt; kQueryStatsSendCountBinCount; ++<span class="enscript-type">i</span>)
    {
        totalUnanswered += inHist-&gt;unansweredQuerySendCountBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>;
    }

    LogToFD(fd, &quot;Domain: <span class="enscript-comment">%s (%s, %s)&quot;, inDomain, inForCell ? &quot;C&quot; : &quot;NC&quot;, inType);
</span>    LogToFD(fd, &quot;Answered questions            <span class="enscript-comment">%10u&quot;, totalAnswered);
</span>    LogToFD(fd, &quot;Negatively answered questions <span class="enscript-comment">%10u&quot;, totalNegAnswered);
</span>    LogToFD(fd, &quot;Unanswered questions          <span class="enscript-comment">%10u&quot;, totalUnanswered);
</span>    LogToFD(fd, &quot;Expired - no cached answer    <span class="enscript-comment">%10u&quot;, inHist-&gt;expiredAnswerStateBins[ExpiredAnswer_Allowed]);
</span>    LogToFD(fd, &quot;Expired - answered from cache <span class="enscript-comment">%10u&quot;, inHist-&gt;expiredAnswerStateBins[ExpiredAnswer_AnsweredWithCache]);
</span>    LogToFD(fd, &quot;Expired - answered expired    <span class="enscript-comment">%10u&quot;, inHist-&gt;expiredAnswerStateBins[ExpiredAnswer_AnsweredWithExpired]);
</span>    LogToFD(fd, &quot;Expired - cache changed       <span class="enscript-comment">%10u&quot;, inHist-&gt;expiredAnswerStateBins[ExpiredAnswer_ExpiredAnswerChanged]);
</span>    LogToFD(fd, &quot;DNSoTCP - truncated           <span class="enscript-comment">%10u&quot;, inHist-&gt;dnsOverTCPStateBins[DNSOverTCP_Truncated]);
</span>    LogToFD(fd, &quot;DNSoTCP - suspicious          <span class="enscript-comment">%10u&quot;, inHist-&gt;dnsOverTCPStateBins[DNSOverTCP_Suspicious]);
</span>    LogToFD(fd, &quot;DNSoTCP - suspicious defense  <span class="enscript-comment">%10u&quot;, inHist-&gt;dnsOverTCPStateBins[DNSOverTCP_SuspiciousDefense]);
</span>    LogToFD(fd, &quot;-- Query send counts ---------&quot;);
    LogDNSHistSendCountsToFD(fd, inHist-&gt;answeredQuerySendCountBins);
    LogToFD(fd, &quot;-- Query send counts (NAQs) --&quot;);
    LogDNSHistSendCountsToFD(fd, inHist-&gt;negAnsweredQuerySendCountBins);

    <span class="enscript-keyword">if</span> (totalAnswered &gt; inHist-&gt;answeredQuerySendCountBins<span class="enscript-type">[</span>0<span class="enscript-type">]</span>)
    {
        LogToFD(fd, &quot;--- Response <span class="enscript-type">times</span> -----------&quot;);
        LogDNSHistLatenciesToFD(fd, inHist-&gt;responseLatencyBins);
    }

    <span class="enscript-keyword">if</span> (totalNegAnswered &gt; inHist-&gt;negAnsweredQuerySendCountBins<span class="enscript-type">[</span>0<span class="enscript-type">]</span>)
    {
        LogToFD(fd, &quot;--- Response <span class="enscript-type">times</span> (NAQs) ----&quot;);
        LogDNSHistLatenciesToFD(fd, inHist-&gt;negResponseLatencyBins);
    }

    <span class="enscript-keyword">if</span> (totalUnanswered &gt; 0)
    {
        LogToFD(fd, &quot;--- Unanswered query <span class="enscript-type">times</span> ---&quot;);
        LogDNSHistLatenciesToFD(fd, inHist-&gt;unansweredQueryDurationBins);
    }
}

//===========================================================================================================================
//  LogDNSHistSendCountsToFD
//===========================================================================================================================

mDNSlocal void LogDNSHistSendCountsToFD(int fd, const uint16_t inSendCountBins<span class="enscript-type">[</span>kQueryStatsSendCountBinCount<span class="enscript-type">]</span>)
{
    uint32_t        total;
    <span class="enscript-type">char</span>            label<span class="enscript-type">[</span>16<span class="enscript-type">]</span>;
    int             <span class="enscript-type">i</span>;

    total = 0;
    <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; <span class="enscript-type">i</span> &lt; kQueryStatsSendCountBinCount; ++<span class="enscript-type">i</span>)
    {
        total += inSendCountBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>;
    }

    <span class="enscript-keyword">if</span> (total &gt; 0)
    {
        uint32_t        accumulator = 0;

        <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; <span class="enscript-type">i</span> &lt; kQueryStatsSendCountBinCount; ++<span class="enscript-type">i</span>)
        {
            accumulator += inSendCountBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>;
            <span class="enscript-keyword">if</span> (<span class="enscript-type">i</span> &lt; (kQueryStatsSendCountBinCount - 1))
            {
                snprintf(label, sizeof(label), &quot;<span class="enscript-comment">%2d &quot;, i);
</span>            }
            <span class="enscript-keyword">else</span>
            {
                snprintf(label, sizeof(label), &quot;<span class="enscript-comment">%2d+&quot;, i);
</span>            }
            LogStatToFD(fd, label, inSendCountBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>, accumulator, total);
            <span class="enscript-keyword">if</span> (accumulator == total) <span class="enscript-keyword">break</span>;
        }
    }
    <span class="enscript-keyword">else</span>
    {
        LogToFD(fd, &quot;No data.&quot;);
    }
}

//===========================================================================================================================
//  LogDNSHistLatenciesToFD
//===========================================================================================================================

mDNSlocal void LogDNSHistLatenciesToFD(int fd,
                                         const uint16_t inLatencyBins<span class="enscript-type">[</span>kQueryStatsLatencyBinCount<span class="enscript-type">]</span>)
{
    uint32_t        total;
    int             <span class="enscript-type">i</span>;
    <span class="enscript-type">char</span>            label<span class="enscript-type">[</span>16<span class="enscript-type">]</span>;

    total = 0;
    <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; <span class="enscript-type">i</span> &lt; kQueryStatsLatencyBinCount; ++<span class="enscript-type">i</span>)
    {
        total += inLatencyBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>;
    }

    <span class="enscript-keyword">if</span> (total &gt; 0)
    {
        uint32_t        accumulator = 0;

        <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; <span class="enscript-type">i</span> &lt; kQueryStatsLatencyBinCount; ++<span class="enscript-type">i</span>)
        {
            accumulator += inLatencyBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>;
            <span class="enscript-keyword">if</span> (<span class="enscript-type">i</span> &lt; (int)countof(kResponseLatencyMsLimits))
            {
                snprintf(label, sizeof(label), &quot;&lt; <span class="enscript-comment">%5u ms&quot;, kResponseLatencyMsLimits[i]);
</span>            }
            <span class="enscript-keyword">else</span>
            {
                snprintf(label, sizeof(label), &quot;&lt;     âˆž ms&quot;);
            }
            LogStatToFD(fd, label, inLatencyBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>, accumulator, total);
            <span class="enscript-keyword">if</span> (accumulator == total) <span class="enscript-keyword">break</span>;
        }
    }
    <span class="enscript-keyword">else</span>
    {
        LogToFD(fd, &quot;No data.&quot;);
    }
}

//===========================================================================================================================
//  LogDNSMessageSizeStatsToFD
//===========================================================================================================================

mDNSlocal void LogDNSMessageSizeStatsToFD(int fd, const uint32_t *inBins, size_t inBinCount, unsigned int inBinWidth)
{
    size_t          <span class="enscript-type">i</span>;
    uint32_t        total;

    total = 0;
    <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; <span class="enscript-type">i</span> &lt; inBinCount; ++<span class="enscript-type">i</span>)
    {
        total += inBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>;
    }

    <span class="enscript-keyword">if</span> (total &gt; 0)
    {
        uint32_t            accumulator;
        unsigned int        <span class="enscript-type">lower</span>, <span class="enscript-type">upper</span>;
        <span class="enscript-type">char</span>                label<span class="enscript-type">[</span>16<span class="enscript-type">]</span>;

        accumulator = 0;
        <span class="enscript-type">upper</span>       = 0;
        <span class="enscript-keyword">for</span> (<span class="enscript-type">i</span> = 0; <span class="enscript-type">i</span> &lt; inBinCount; ++<span class="enscript-type">i</span>)
        {
            accumulator += inBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>;
            <span class="enscript-type">lower</span> = <span class="enscript-type">upper</span> + 1;
            <span class="enscript-keyword">if</span> (<span class="enscript-type">i</span> &lt; (inBinCount - 1))
            {
                <span class="enscript-type">upper</span> += inBinWidth;
                snprintf(label, sizeof(label), &quot;<span class="enscript-comment">%3u - %-3u&quot;, lower, upper);
</span>            }
            <span class="enscript-keyword">else</span>
            {
                snprintf(label, sizeof(label), &quot;<span class="enscript-comment">%3u+     &quot;, lower);
</span>            }
            LogStatToFD(fd, label, inBins<span class="enscript-type">[</span><span class="enscript-type">i</span><span class="enscript-type">]</span>, accumulator, total);
            <span class="enscript-keyword">if</span> (accumulator == total) <span class="enscript-keyword">break</span>;
        }
    }
    <span class="enscript-keyword">else</span>
    {
        LogToFD(fd, &quot;No data.&quot;);
    }
}

#endif  // MDNSRESPONDER_SUPPORTS(APPLE, METRICS)
</pre>
<hr />
</body></html>