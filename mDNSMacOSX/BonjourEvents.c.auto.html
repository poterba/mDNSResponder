<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>BonjourEvents.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">BonjourEvents.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="BonjourEvents.c">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* -*- Mode: C; tab-width: 4 -*-
 *
 * Copyright (c) 2010-2015 Apple Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;CoreFoundation/CoreFoundation.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;CoreFoundation/CFXPCBridge.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;dns_sd.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;UserEventAgentInterface.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;os/log.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;xpc/xpc.h&gt;</span>


#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Types</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span>*          sPluginIdentifier       = <span class="enscript-string">&quot;com.apple.bonjour.events&quot;</span>;

<span class="enscript-comment">// PLIST Keys
</span><span class="enscript-type">static</span> <span class="enscript-type">const</span> CFStringRef sServiceNameKey         = CFSTR(<span class="enscript-string">&quot;ServiceName&quot;</span>);
<span class="enscript-type">static</span> <span class="enscript-type">const</span> CFStringRef sServiceTypeKey         = CFSTR(<span class="enscript-string">&quot;ServiceType&quot;</span>);
<span class="enscript-type">static</span> <span class="enscript-type">const</span> CFStringRef sServiceDomainKey       = CFSTR(<span class="enscript-string">&quot;ServiceDomain&quot;</span>);

<span class="enscript-type">static</span> <span class="enscript-type">const</span> CFStringRef sOnServiceAddKey        = CFSTR(<span class="enscript-string">&quot;OnServiceAdd&quot;</span>);
<span class="enscript-type">static</span> <span class="enscript-type">const</span> CFStringRef sOnServiceRemoveKey     = CFSTR(<span class="enscript-string">&quot;OnServiceRemove&quot;</span>);

<span class="enscript-type">static</span> <span class="enscript-type">const</span> CFStringRef sLaunchdTokenKey        = CFSTR(<span class="enscript-string">&quot;LaunchdToken&quot;</span>);
<span class="enscript-type">static</span> <span class="enscript-type">const</span> CFStringRef sLaunchdDictKey         = CFSTR(<span class="enscript-string">&quot;LaunchdDict&quot;</span>);


<span class="enscript-comment">/************************************************
* Launch Event Dictionary (input from launchd)
* Passed To: ManageEventsCallback
*-----------------------------------------------
* Typing in this dictionary is not enforced
* above us. So this may not be true. Type check
* all input before using it.
*-----------------------------------------------
* sServiceNameKey		- CFString (Optional)
* sServiceTypeKey		- CFString
* sServiceDomainKey	- CFString
*
* One or more of the following.
*-----------------------------------
* sOnServiceAddKey			- CFBoolean
* sOnServiceRemoveKey		- CFBoolean
* sWhileServiceExistsKey	- CFBoolean
************************************************/</span>

<span class="enscript-comment">/************************************************
* Browser Dictionary
*-----------------------------------------------
* sServiceDomainKey - CFString
* sServiceTypeKey   - CFString
************************************************/</span>

<span class="enscript-comment">/************************************************
* Event Dictionary
*-----------------------------------------------
* sServiceNameKey	 - CFString (Optional)
* sLaunchdTokenKey	 - CFNumber
************************************************/</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
    UserEventAgentInterfaceStruct*      _UserEventAgentInterface;
    CFUUIDRef _factoryID;
    UInt32 _refCount;

    <span class="enscript-type">void</span>*                               _pluginContext;

    CFMutableDictionaryRef _tokenToBrowserMap;                  <span class="enscript-comment">// Maps a token to a browser that can be used to scan the remaining dictionaries.
</span>    CFMutableDictionaryRef _browsers;                           <span class="enscript-comment">// A Dictionary of Browser Dictionaries where the resposible browser is the key.
</span>    CFMutableDictionaryRef _onAddEvents;                        <span class="enscript-comment">// A Dictionary of Event Dictionaries that describe events to trigger on a service appearing.
</span>    CFMutableDictionaryRef _onRemoveEvents;                     <span class="enscript-comment">// A Dictionary of Event Dictionaries that describe events to trigger on a service disappearing.
</span>} BonjourUserEventsPlugin;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
    CFIndex refCount;
    DNSServiceRef browserRef;
} NetBrowserInfo;

#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Prototypes</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
<span class="enscript-comment">// COM Stuff
</span><span class="enscript-type">static</span> HRESULT  <span class="enscript-function-name">QueryInterface</span>(<span class="enscript-type">void</span> *myInstance, REFIID iid, LPVOID *ppv);
<span class="enscript-type">static</span> ULONG    <span class="enscript-function-name">AddRef</span>(<span class="enscript-type">void</span>* instance);
<span class="enscript-type">static</span> ULONG    <span class="enscript-function-name">Release</span>(<span class="enscript-type">void</span>* instance);

<span class="enscript-type">static</span> BonjourUserEventsPlugin* <span class="enscript-function-name">Alloc</span>(CFUUIDRef factoryID);
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">Dealloc</span>(BonjourUserEventsPlugin* plugin);

<span class="enscript-type">void</span> * <span class="enscript-function-name">UserEventAgentFactory</span>(CFAllocatorRef allocator, CFUUIDRef typeID);

<span class="enscript-comment">// Plugin Management
</span><span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">Install</span>(<span class="enscript-type">void</span>* instance);
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ManageEventsCallback</span>(
    UserEventAgentLaunchdAction action,
    CFNumberRef token,
    CFTypeRef eventMatchDict,
    <span class="enscript-type">void</span>                      * vContext);


<span class="enscript-comment">// Plugin Guts
</span><span class="enscript-type">void</span> <span class="enscript-function-name">AddEventToPlugin</span>(BonjourUserEventsPlugin* plugin, CFNumberRef launchdToken, CFDictionaryRef eventParameters);
<span class="enscript-type">void</span> <span class="enscript-function-name">RemoveEventFromPlugin</span>(BonjourUserEventsPlugin* plugin, CFNumberRef launchToken);

NetBrowserInfo* <span class="enscript-function-name">CreateBrowser</span>(BonjourUserEventsPlugin* plugin, CFStringRef type, CFStringRef domain);
NetBrowserInfo* <span class="enscript-function-name">BrowserForSDRef</span>(BonjourUserEventsPlugin* plugin, DNSServiceRef sdRef);
<span class="enscript-type">void</span> <span class="enscript-function-name">AddEventDictionary</span>(CFDictionaryRef eventDict, CFMutableDictionaryRef allEventsDictionary, NetBrowserInfo* key);
<span class="enscript-type">void</span> <span class="enscript-function-name">RemoveEventFromArray</span>(CFMutableArrayRef array, CFNumberRef launchdToken);

<span class="enscript-comment">// Net Service Browser Stuff
</span><span class="enscript-type">void</span> <span class="enscript-function-name">ServiceBrowserCallback</span> (DNSServiceRef sdRef, DNSServiceFlags flags, uint32_t interfaceIndex, DNSServiceErrorType errorCode, <span class="enscript-type">const</span> <span class="enscript-type">char</span>* serviceName, <span class="enscript-type">const</span> <span class="enscript-type">char</span>* regtype, <span class="enscript-type">const</span> <span class="enscript-type">char</span>* replyDomain, <span class="enscript-type">void</span>* context);
<span class="enscript-type">void</span> <span class="enscript-function-name">HandleTemporaryEventsForService</span>(BonjourUserEventsPlugin* plugin, NetBrowserInfo* browser, CFStringRef serviceName, CFMutableDictionaryRef eventsDictionary);

<span class="enscript-comment">// Convence Stuff
</span><span class="enscript-type">const</span> <span class="enscript-type">char</span>* <span class="enscript-function-name">CStringFromCFString</span>(CFStringRef string);

<span class="enscript-comment">// NetBrowserInfo &quot;Object&quot;
</span>NetBrowserInfo* <span class="enscript-function-name">NetBrowserInfoCreate</span>(CFStringRef serviceType, CFStringRef domain, <span class="enscript-type">void</span>* context);
<span class="enscript-type">const</span> <span class="enscript-type">void</span>* <span class="enscript-function-name">NetBrowserInfoRetain</span>(CFAllocatorRef allocator, <span class="enscript-type">const</span> <span class="enscript-type">void</span>* info);
<span class="enscript-type">void</span> <span class="enscript-function-name">NetBrowserInfoRelease</span>(CFAllocatorRef allocator, <span class="enscript-type">const</span> <span class="enscript-type">void</span>* info);
Boolean <span class="enscript-function-name">NetBrowserInfoEqual</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *value1, <span class="enscript-type">const</span> <span class="enscript-type">void</span> *value2);
CFHashCode  <span class="enscript-function-name">NetBrowserInfoHash</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *value);
CFStringRef <span class="enscript-function-name">NetBrowserInfoCopyDescription</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *value);

<span class="enscript-type">static</span> <span class="enscript-type">const</span> CFDictionaryKeyCallBacks kNetBrowserInfoDictionaryKeyCallbacks = {
    0,
    NetBrowserInfoRetain,
    NetBrowserInfoRelease,
    NetBrowserInfoCopyDescription,
    NetBrowserInfoEqual,
    NetBrowserInfoHash
};

<span class="enscript-type">static</span> <span class="enscript-type">const</span> CFDictionaryValueCallBacks kNetBrowserInfoDictionaryValueCallbacks = {
    0,
    NetBrowserInfoRetain,
    NetBrowserInfoRelease,
    NetBrowserInfoCopyDescription,
    NetBrowserInfoEqual
};

<span class="enscript-comment">// COM type definition goop.
</span><span class="enscript-type">static</span> UserEventAgentInterfaceStruct UserEventAgentInterfaceFtbl = {
    NULL,                   <span class="enscript-comment">// Required padding for COM
</span>    QueryInterface,         <span class="enscript-comment">// Query Interface
</span>    AddRef,                 <span class="enscript-comment">// AddRef()
</span>    Release,                <span class="enscript-comment">// Release()
</span>    Install                 <span class="enscript-comment">// Install
</span>};

#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">COM</span> <span class="enscript-variable-name">Management</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -

<span class="enscript-comment">/*****************************************************************************
*****************************************************************************/</span>
<span class="enscript-type">static</span> HRESULT <span class="enscript-function-name">QueryInterface</span>(<span class="enscript-type">void</span> *myInstance, REFIID iid, LPVOID *ppv)
{
    CFUUIDRef interfaceID = CFUUIDCreateFromUUIDBytes(NULL, iid);

    <span class="enscript-comment">// Test the requested ID against the valid interfaces.
</span>    <span class="enscript-keyword">if</span>(CFEqual(interfaceID, kUserEventAgentInterfaceID))
    {
        ((BonjourUserEventsPlugin *) myInstance)-&gt;_UserEventAgentInterface-&gt;AddRef(myInstance);
        *ppv = myInstance;
        CFRelease(interfaceID);
        <span class="enscript-keyword">return</span> S_OK;
    }
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span>(CFEqual(interfaceID, IUnknownUUID))
    {
        ((BonjourUserEventsPlugin *) myInstance)-&gt;_UserEventAgentInterface-&gt;AddRef(myInstance);
        *ppv = myInstance;
        CFRelease(interfaceID);
        <span class="enscript-keyword">return</span> S_OK;
    }
    <span class="enscript-keyword">else</span> <span class="enscript-comment">//  Requested interface unknown, bail with error.
</span>    {
        *ppv = NULL;
        CFRelease(interfaceID);
        <span class="enscript-keyword">return</span> E_NOINTERFACE;
    }
}

<span class="enscript-comment">/*****************************************************************************
*****************************************************************************/</span>
<span class="enscript-type">static</span> ULONG <span class="enscript-function-name">AddRef</span>(<span class="enscript-type">void</span>* instance)
{
    BonjourUserEventsPlugin* plugin = (BonjourUserEventsPlugin*)instance;
    <span class="enscript-keyword">return</span> ++plugin-&gt;_refCount;
}

<span class="enscript-comment">/*****************************************************************************
*****************************************************************************/</span>
<span class="enscript-type">static</span> ULONG <span class="enscript-function-name">Release</span>(<span class="enscript-type">void</span>* instance)
{
    BonjourUserEventsPlugin* plugin = (BonjourUserEventsPlugin*)instance;

    <span class="enscript-keyword">if</span> (plugin-&gt;_refCount != 0)
        --plugin-&gt;_refCount;

    <span class="enscript-keyword">if</span> (plugin-&gt;_refCount == 0)
    {
        Dealloc(instance);
        <span class="enscript-keyword">return</span> 0;
    }

    <span class="enscript-keyword">return</span> plugin-&gt;_refCount;
}

<span class="enscript-comment">/*****************************************************************************
* Alloc
* -
* Functionas as both +[alloc] and -[init] for the plugin. Add any
* initalization of member variables here.
*****************************************************************************/</span>
<span class="enscript-type">static</span> BonjourUserEventsPlugin* <span class="enscript-function-name">Alloc</span>(CFUUIDRef factoryID)
{
    BonjourUserEventsPlugin* plugin = malloc(<span class="enscript-keyword">sizeof</span>(BonjourUserEventsPlugin));

    plugin-&gt;_UserEventAgentInterface = &amp;UserEventAgentInterfaceFtbl;
    plugin-&gt;_pluginContext = NULL;

    <span class="enscript-keyword">if</span> (factoryID)
    {
        plugin-&gt;_factoryID = (CFUUIDRef)CFRetain(factoryID);
        CFPlugInAddInstanceForFactory(factoryID);
    }

    plugin-&gt;_refCount = 1;
    plugin-&gt;_tokenToBrowserMap = CFDictionaryCreateMutable(NULL, 0, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kNetBrowserInfoDictionaryValueCallbacks);
    plugin-&gt;_browsers = CFDictionaryCreateMutable(NULL, 0, &amp;kNetBrowserInfoDictionaryKeyCallbacks, &amp;kCFTypeDictionaryValueCallBacks);
    plugin-&gt;_onAddEvents = CFDictionaryCreateMutable(NULL, 0, &amp;kNetBrowserInfoDictionaryKeyCallbacks, &amp;kCFTypeDictionaryValueCallBacks);
    plugin-&gt;_onRemoveEvents = CFDictionaryCreateMutable(NULL, 0, &amp;kNetBrowserInfoDictionaryKeyCallbacks, &amp;kCFTypeDictionaryValueCallBacks);

    <span class="enscript-keyword">return</span> plugin;
}

<span class="enscript-comment">/*****************************************************************************
* Dealloc
* -
* Much like Obj-C dealloc this method is responsible for releasing any object
* this plugin is holding. Unlike ObjC, you call directly free() instead of
* [super dalloc].
*****************************************************************************/</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">Dealloc</span>(BonjourUserEventsPlugin* plugin)
{
    CFUUIDRef factoryID = plugin-&gt;_factoryID;

    <span class="enscript-keyword">if</span> (factoryID)
    {
        CFPlugInRemoveInstanceForFactory(factoryID);
        CFRelease(factoryID);
    }

    <span class="enscript-keyword">if</span> (plugin-&gt;_tokenToBrowserMap)
        CFRelease(plugin-&gt;_tokenToBrowserMap);

    <span class="enscript-keyword">if</span> (plugin-&gt;_browsers)
        CFRelease(plugin-&gt;_browsers);

    <span class="enscript-keyword">if</span> (plugin-&gt;_onAddEvents)
        CFRelease(plugin-&gt;_onAddEvents);

    <span class="enscript-keyword">if</span> (plugin-&gt;_onRemoveEvents)
        CFRelease(plugin-&gt;_onRemoveEvents);

    free(plugin);
}

<span class="enscript-comment">/*******************************************************************************
*******************************************************************************/</span>
<span class="enscript-type">void</span> * <span class="enscript-function-name">UserEventAgentFactory</span>(CFAllocatorRef allocator, CFUUIDRef typeID)
{
    (<span class="enscript-type">void</span>)allocator;
    BonjourUserEventsPlugin * result = NULL;

    <span class="enscript-keyword">if</span> (typeID &amp;&amp; CFEqual(typeID, kUserEventAgentTypeID))
    {
        result = Alloc(kUserEventAgentFactoryID);
    }

    <span class="enscript-keyword">return</span> (<span class="enscript-type">void</span> *)result;
}

#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Plugin</span> <span class="enscript-variable-name">Management</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
<span class="enscript-comment">/*****************************************************************************
* Install
* -
* This is invoked once when the plugin is loaded to do initial setup and
* allow us to register with launchd. If UserEventAgent crashes, the plugin
* will need to be reloaded, and hence this will get invoked again.
*****************************************************************************/</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">Install</span>(<span class="enscript-type">void</span> *instance)
{
    BonjourUserEventsPlugin* plugin = (BonjourUserEventsPlugin*)instance;

    plugin-&gt;_pluginContext = UserEventAgentRegisterForLaunchEvents(sPluginIdentifier, &amp;ManageEventsCallback, plugin);

    <span class="enscript-keyword">if</span> (!plugin-&gt;_pluginContext)
    {
        fprintf(stderr, <span class="enscript-string">&quot;%s:%s failed to register for launch events.\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
        <span class="enscript-keyword">return</span>;
    }

}

<span class="enscript-comment">/*****************************************************************************
* ManageEventsCallback
* -
* This is invoked when launchd loads a event dictionary and needs to inform
* us what a daemon / agent is looking for.
*****************************************************************************/</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ManageEventsCallback</span>(UserEventAgentLaunchdAction action, CFNumberRef token, CFTypeRef eventMatchDict, <span class="enscript-type">void</span>* vContext)
{
    <span class="enscript-keyword">if</span> (action == kUserEventAgentLaunchdAdd)
    {
        <span class="enscript-keyword">if</span> (!eventMatchDict)
        {
            fprintf(stderr, <span class="enscript-string">&quot;%s:%s empty dictionary\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
            <span class="enscript-keyword">return</span>;
        }
        <span class="enscript-keyword">if</span> (CFGetTypeID(eventMatchDict) != CFDictionaryGetTypeID())
        {
            fprintf(stderr, <span class="enscript-string">&quot;%s:%s given non-dict for event dictionary, action %d\n&quot;</span>, sPluginIdentifier, __FUNCTION__, action);
            <span class="enscript-keyword">return</span>;
        }
        <span class="enscript-comment">// Launchd wants us to add a launch event for this token and matching dictionary.
</span>        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s calling AddEventToPlugin&quot;</span>, sPluginIdentifier, __FUNCTION__);
        AddEventToPlugin((BonjourUserEventsPlugin*)vContext, token, (CFDictionaryRef)eventMatchDict);
    }
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (action == kUserEventAgentLaunchdRemove)
    {
        <span class="enscript-comment">// Launchd wants us to remove the event hook we setup for this token / matching dictionary.
</span>        <span class="enscript-comment">// Note: eventMatchDict can be NULL for Remove.
</span>        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s calling RemoveEventToPlugin&quot;</span>, sPluginIdentifier, __FUNCTION__);
        RemoveEventFromPlugin((BonjourUserEventsPlugin*)vContext, token);
    }
    <span class="enscript-keyword">else</span>
    {
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s unknown callback event\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
    }
}


#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Plugin</span> <span class="enscript-variable-name">Guts</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -

<span class="enscript-comment">/*****************************************************************************
* AddEventToPlugin
* -
* This method is invoked when launchd wishes the plugin to setup a launch
* event matching the parameters in the dictionary.
*****************************************************************************/</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">AddEventToPlugin</span>(BonjourUserEventsPlugin* plugin, CFNumberRef launchdToken, CFDictionaryRef eventParameters)
{
    CFStringRef domain = CFDictionaryGetValue(eventParameters, sServiceDomainKey);
    CFStringRef type = CFDictionaryGetValue(eventParameters, sServiceTypeKey);
    CFStringRef name = CFDictionaryGetValue(eventParameters, sServiceNameKey);
    CFBooleanRef cfOnAdd = CFDictionaryGetValue(eventParameters, sOnServiceAddKey);
    CFBooleanRef cfOnRemove = CFDictionaryGetValue(eventParameters, sOnServiceRemoveKey);

    Boolean onAdd = false;
    Boolean onRemove = false;

    <span class="enscript-keyword">if</span> (cfOnAdd &amp;&amp; CFGetTypeID(cfOnAdd) == CFBooleanGetTypeID() &amp;&amp; CFBooleanGetValue(cfOnAdd))
        onAdd = true;

    <span class="enscript-keyword">if</span> (cfOnRemove &amp;&amp; CFGetTypeID(cfOnRemove) == CFBooleanGetTypeID() &amp;&amp; CFBooleanGetValue(cfOnRemove))
        onRemove = true;

    <span class="enscript-comment">// A type is required. If none is specified, BAIL
</span>    <span class="enscript-keyword">if</span> (!type || CFGetTypeID(type) != CFStringGetTypeID())
    {
        fprintf(stderr, <span class="enscript-string">&quot;%s:%s: a LaunchEvent is missing a service type.\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-comment">// If we aren't suppose to launch on services appearing or disappearing, this service does nothing. Ignore.
</span>    <span class="enscript-keyword">if</span> (!onAdd &amp;&amp; !onRemove)
    {
        fprintf(stderr, <span class="enscript-string">&quot;%s:%s a LaunchEvent is missing both onAdd and onRemove events\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-comment">// If no domain is specified, assume local.
</span>    <span class="enscript-keyword">if</span> (!domain)
    {
        domain = CFSTR(<span class="enscript-string">&quot;local&quot;</span>);
    }
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (CFGetTypeID(domain) != CFStringGetTypeID() ) <span class="enscript-comment">// If the domain is not a string, fail
</span>    {
        fprintf(stderr, <span class="enscript-string">&quot;%s:%s a LaunchEvent has a domain that is not a string.\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-comment">// If we have a name filter, but it's not a string. This event is broken, bail.
</span>    <span class="enscript-keyword">if</span> (name &amp;&amp; CFGetTypeID(name) != CFStringGetTypeID())
    {
        fprintf(stderr, <span class="enscript-string">&quot;%s:%s a LaunchEvent has a domain that is not a string.\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-comment">// Get us a browser
</span>    NetBrowserInfo* browser = CreateBrowser(plugin, type, domain);

    <span class="enscript-keyword">if</span> (!browser)
    {
        fprintf(stderr, <span class="enscript-string">&quot;%s:%s cannot create browser\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-comment">// Create Event Dictionary
</span>    CFMutableDictionaryRef eventDictionary = CFDictionaryCreateMutable(NULL, 4, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);

    <span class="enscript-comment">// We store both the Token and the Dictionary. UserEventAgentSetLaunchEventState needs
</span>    <span class="enscript-comment">// the token and UserEventAgentSetFireEvent needs both the token and the dictionary
</span>    CFDictionarySetValue(eventDictionary, sLaunchdTokenKey, launchdToken);
    CFDictionarySetValue(eventDictionary, sLaunchdDictKey, eventParameters);

    <span class="enscript-keyword">if</span> (name)
        CFDictionarySetValue(eventDictionary, sServiceNameKey, name);

    <span class="enscript-comment">// Add to the correct dictionary.
</span>    <span class="enscript-keyword">if</span> (onAdd)
    {
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: Adding browser to AddEvents&quot;</span>, sPluginIdentifier, __FUNCTION__);
        AddEventDictionary(eventDictionary, plugin-&gt;_onAddEvents, browser);
    }

    <span class="enscript-keyword">if</span> (onRemove)
    {
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: Adding browser to RemoveEvents&quot;</span>, sPluginIdentifier, __FUNCTION__);
        AddEventDictionary(eventDictionary, plugin-&gt;_onRemoveEvents, browser);
    }

    <span class="enscript-comment">// Add Token Mapping
</span>    CFDictionarySetValue(plugin-&gt;_tokenToBrowserMap, launchdToken, browser);

    <span class="enscript-comment">// Release Memory
</span>    CFRelease(eventDictionary);
}

<span class="enscript-comment">/*****************************************************************************
* RemoveEventFromPlugin
* -
* This method is invoked when launchd wishes the plugin to setup a launch
* event matching the parameters in the dictionary.
*****************************************************************************/</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">RemoveEventFromPlugin</span>(BonjourUserEventsPlugin* plugin, CFNumberRef launchdToken)
{
    NetBrowserInfo* browser = (NetBrowserInfo*)CFDictionaryGetValue(plugin-&gt;_tokenToBrowserMap, launchdToken);
    Boolean othersUsingBrowser = false;

    <span class="enscript-keyword">if</span> (!browser)
    {
        <span class="enscript-type">long</span> <span class="enscript-type">long</span> value = 0;
        CFNumberGetValue(launchdToken, kCFNumberLongLongType, &amp;value);
        fprintf(stderr, <span class="enscript-string">&quot;%s:%s Launchd asked us to remove a token we did not register! ==Token:%lld== \n&quot;</span>, sPluginIdentifier, __FUNCTION__, value);
        <span class="enscript-keyword">return</span>;
    }

    CFMutableArrayRef onAddEvents = (CFMutableArrayRef)CFDictionaryGetValue(plugin-&gt;_onAddEvents, browser);
    CFMutableArrayRef onRemoveEvents = (CFMutableArrayRef)CFDictionaryGetValue(plugin-&gt;_onRemoveEvents, browser);

    <span class="enscript-keyword">if</span> (onAddEvents)
    {
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: Calling RemoveEventFromArray for OnAddEvents&quot;</span>, sPluginIdentifier, __FUNCTION__);
        RemoveEventFromArray(onAddEvents, launchdToken);

        <span class="enscript-comment">// Is the array now empty, clean up
</span>        <span class="enscript-keyword">if</span> (CFArrayGetCount(onAddEvents) == 0)
        {
            os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: Removing the browser from AddEvents&quot;</span>, sPluginIdentifier, __FUNCTION__);
            CFDictionaryRemoveValue(plugin-&gt;_onAddEvents, browser);
        }
    }

    <span class="enscript-keyword">if</span> (onRemoveEvents)
    {
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: Calling RemoveEventFromArray for OnRemoveEvents&quot;</span>, sPluginIdentifier, __FUNCTION__);
        RemoveEventFromArray(onRemoveEvents, launchdToken);

        <span class="enscript-comment">// Is the array now empty, clean up
</span>        <span class="enscript-keyword">if</span> (CFArrayGetCount(onRemoveEvents) == 0)
        {
            os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: Removing the browser from RemoveEvents&quot;</span>, sPluginIdentifier, __FUNCTION__);
            CFDictionaryRemoveValue(plugin-&gt;_onRemoveEvents, browser);
        }
    }

    <span class="enscript-comment">// Remove ourselves from the token dictionary.
</span>    CFDictionaryRemoveValue(plugin-&gt;_tokenToBrowserMap, launchdToken);

    <span class="enscript-comment">// Check to see if anyone else is using this browser.
</span>    CFIndex i;
    CFIndex count = CFDictionaryGetCount(plugin-&gt;_tokenToBrowserMap);
    NetBrowserInfo** browsers = malloc(count * <span class="enscript-keyword">sizeof</span>(NetBrowserInfo*));

    <span class="enscript-comment">// Fetch the values of the token dictionary
</span>    CFDictionaryGetKeysAndValues(plugin-&gt;_tokenToBrowserMap, NULL, (<span class="enscript-type">const</span> <span class="enscript-type">void</span>**)browsers);

    <span class="enscript-keyword">for</span> (i = 0; i &lt; count; ++i)
    {
        <span class="enscript-keyword">if</span> (NetBrowserInfoEqual(browsers[i], browser))
        {
            othersUsingBrowser = true;
            <span class="enscript-keyword">break</span>;
        }
    }

    <span class="enscript-comment">// If no one else is useing our browser, clean up!
</span>    <span class="enscript-keyword">if</span> (!othersUsingBrowser)
    {
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: Removing browser %p from _browsers&quot;</span>, sPluginIdentifier, __FUNCTION__, browser);
        CFDictionaryRemoveValue(plugin-&gt;_browsers, browser); <span class="enscript-comment">// This triggers release and dealloc of the browser
</span>    }
    <span class="enscript-keyword">else</span>
    {
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: Decrementing browsers %p count&quot;</span>, sPluginIdentifier, __FUNCTION__, browser);
        <span class="enscript-comment">// Decrement my reference count (it was incremented when it was added to _browsers in CreateBrowser)
</span>        NetBrowserInfoRelease(NULL, browser);
    }

    free(browsers);
}


<span class="enscript-comment">/*****************************************************************************
* CreateBrowser
* -
* This method returns a NetBrowserInfo that is looking for a type of
* service in a domain. If no browser exists, it will create one and return it.
*****************************************************************************/</span>
NetBrowserInfo* <span class="enscript-function-name">CreateBrowser</span>(BonjourUserEventsPlugin* plugin, CFStringRef type, CFStringRef domain)
{
    CFIndex i;
    CFIndex count = CFDictionaryGetCount(plugin-&gt;_browsers);
    NetBrowserInfo* browser = NULL;
    CFDictionaryRef* dicts = malloc(count * <span class="enscript-keyword">sizeof</span>(CFDictionaryRef));
    NetBrowserInfo** browsers = malloc(count * <span class="enscript-keyword">sizeof</span>(NetBrowserInfo*));

    <span class="enscript-comment">// Fetch the values of the browser dictionary
</span>    CFDictionaryGetKeysAndValues(plugin-&gt;_browsers, (<span class="enscript-type">const</span> <span class="enscript-type">void</span>**)browsers, (<span class="enscript-type">const</span> <span class="enscript-type">void</span>**)dicts);


    <span class="enscript-comment">// Loop thru the browsers list and see if we can find a matching one.
</span>    <span class="enscript-keyword">for</span> (i = 0; i &lt; count; ++i)
    {
        CFDictionaryRef browserDict = dicts[i];

        CFStringRef browserType = CFDictionaryGetValue(browserDict, sServiceTypeKey);
        CFStringRef browserDomain = CFDictionaryGetValue(browserDict, sServiceDomainKey);

        <span class="enscript-comment">// If we have a matching browser, break
</span>        <span class="enscript-keyword">if</span> ((CFStringCompare(browserType, type, kCFCompareCaseInsensitive) == kCFCompareEqualTo) &amp;&amp;
            (CFStringCompare(browserDomain, domain, kCFCompareCaseInsensitive) == kCFCompareEqualTo))
        {
            os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: found a duplicate browser\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
            browser = browsers[i];
            NetBrowserInfoRetain(NULL, browser);
            <span class="enscript-keyword">break</span>;
        }
    }

    <span class="enscript-comment">// No match found, lets create one!
</span>    <span class="enscript-keyword">if</span> (!browser)
    {

        browser = NetBrowserInfoCreate(type, domain, plugin);

        <span class="enscript-keyword">if</span> (!browser)
        {
            fprintf(stderr, <span class="enscript-string">&quot;%s:%s failed to search for %s.%s&quot;</span>, sPluginIdentifier, __FUNCTION__, CStringFromCFString(type), CStringFromCFString(domain));
            free(dicts);
            free(browsers);
            <span class="enscript-keyword">return</span> NULL;
        }

        <span class="enscript-comment">// Service browser created, lets add this to ourselves to the dictionary.
</span>        CFMutableDictionaryRef browserDict = CFDictionaryCreateMutable(NULL, 2, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);

        CFDictionarySetValue(browserDict, sServiceTypeKey, type);
        CFDictionarySetValue(browserDict, sServiceDomainKey, domain);

        <span class="enscript-comment">// Add the dictionary to the browsers dictionary.
</span>        CFDictionarySetValue(plugin-&gt;_browsers, browser, browserDict);

        <span class="enscript-comment">// Release Memory
</span>        CFRelease(browserDict);
    }

    free(dicts);
    free(browsers);

    <span class="enscript-keyword">return</span> browser;
}

<span class="enscript-comment">/*****************************************************************************
* BrowserForSDRef
* -
* This method returns a NetBrowserInfo that matches the calling SDRef passed
* in via the callback.
*****************************************************************************/</span>
NetBrowserInfo* <span class="enscript-function-name">BrowserForSDRef</span>(BonjourUserEventsPlugin* plugin, DNSServiceRef sdRef)
{
    CFIndex i;
    CFIndex count = CFDictionaryGetCount(plugin-&gt;_browsers);
    NetBrowserInfo* browser = NULL;
    NetBrowserInfo** browsers = malloc(count * <span class="enscript-keyword">sizeof</span>(NetBrowserInfo*));

    <span class="enscript-comment">// Fetch the values of the browser dictionary
</span>    CFDictionaryGetKeysAndValues(plugin-&gt;_browsers, (<span class="enscript-type">const</span> <span class="enscript-type">void</span>**)browsers, NULL);

    <span class="enscript-comment">// Loop thru the browsers list and see if we can find a matching one.
</span>    <span class="enscript-keyword">for</span> (i = 0; i &lt; count; ++i)
    {
        NetBrowserInfo* currentBrowser = browsers[i];

        <span class="enscript-keyword">if</span> (currentBrowser-&gt;browserRef == sdRef)
        {
            browser = currentBrowser;
            <span class="enscript-keyword">break</span>;
        }
    }


    free(browsers);

    <span class="enscript-keyword">return</span> browser;
}

<span class="enscript-comment">/*****************************************************************************
* AddEventDictionary
* -
* Adds a event to a browser's event dictionary
*****************************************************************************/</span>

<span class="enscript-type">void</span> <span class="enscript-function-name">AddEventDictionary</span>(CFDictionaryRef eventDict, CFMutableDictionaryRef allEventsDictionary, NetBrowserInfo* key)
{
    CFMutableArrayRef eventsForBrowser = (CFMutableArrayRef)CFDictionaryGetValue(allEventsDictionary, key);

    <span class="enscript-keyword">if</span> (!eventsForBrowser) <span class="enscript-comment">// We have no events for this browser yet, lets add him.
</span>    {
        eventsForBrowser = CFArrayCreateMutable(NULL, 0, &amp;kCFTypeArrayCallBacks);
        CFDictionarySetValue(allEventsDictionary, key, eventsForBrowser);
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s creating a new array&quot;</span>, sPluginIdentifier, __FUNCTION__);
    }
    <span class="enscript-keyword">else</span>
    {
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s Incrementing refcount&quot;</span>, sPluginIdentifier, __FUNCTION__);
        CFRetain(eventsForBrowser);
    }

    CFArrayAppendValue(eventsForBrowser, eventDict);
    CFRelease(eventsForBrowser);
}

<span class="enscript-comment">/*****************************************************************************
* RemoveEventFromArray
* -
* Searches a Array of Event Dictionaries to find one with a matching launchd
* token and remove it.
*****************************************************************************/</span>

<span class="enscript-type">void</span> <span class="enscript-function-name">RemoveEventFromArray</span>(CFMutableArrayRef array, CFNumberRef launchdToken)
{
    CFIndex i;
    CFIndex count = CFArrayGetCount(array);

    <span class="enscript-comment">// Loop thru looking for us.
</span>    <span class="enscript-keyword">for</span> (i = 0; i &lt; count; )
    {
        CFDictionaryRef eventDict = CFArrayGetValueAtIndex(array, i);
        CFNumberRef token = CFDictionaryGetValue(eventDict, sLaunchdTokenKey);

        <span class="enscript-keyword">if</span> (CFEqual(token, launchdToken)) <span class="enscript-comment">// This is the same event?
</span>        {
            os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s found token&quot;</span>, sPluginIdentifier, __FUNCTION__);
            CFArrayRemoveValueAtIndex(array, i);    <span class="enscript-comment">// Remove the event,
</span>            <span class="enscript-keyword">break</span>; <span class="enscript-comment">// The token should only exist once, so it makes no sense to continue.
</span>        }
        <span class="enscript-keyword">else</span>
        {
            ++i; <span class="enscript-comment">// If it's not us, advance.
</span>        }
    }
    <span class="enscript-keyword">if</span> (i == count) os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s did not find token&quot;</span>, sPluginIdentifier, __FUNCTION__);
}

#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Net</span> <span class="enscript-variable-name">Service</span> <span class="enscript-variable-name">Browser</span> <span class="enscript-variable-name">Stuff</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -

<span class="enscript-comment">/*****************************************************************************
* ServiceBrowserCallback
* -
* This method is the heart of the plugin. It's the runloop callback annoucing
* the appearence and disappearance of network services.
*****************************************************************************/</span>

<span class="enscript-type">void</span> <span class="enscript-function-name">ServiceBrowserCallback</span> (DNSServiceRef sdRef,
                             DNSServiceFlags flags,
                             uint32_t interfaceIndex,
                             DNSServiceErrorType errorCode,
                             <span class="enscript-type">const</span> <span class="enscript-type">char</span>*                serviceName,
                             <span class="enscript-type">const</span> <span class="enscript-type">char</span>*                regtype,
                             <span class="enscript-type">const</span> <span class="enscript-type">char</span>*                replyDomain,
                             <span class="enscript-type">void</span>*                      context )
{
    (<span class="enscript-type">void</span>)interfaceIndex;
    (<span class="enscript-type">void</span>)regtype;
    (<span class="enscript-type">void</span>)replyDomain;
    BonjourUserEventsPlugin* plugin = (BonjourUserEventsPlugin*)context;
    NetBrowserInfo* browser = BrowserForSDRef(plugin, sdRef);

    <span class="enscript-keyword">if</span> (!browser) <span class="enscript-comment">// Missing browser?
</span>    {
        fprintf(stderr, <span class="enscript-string">&quot;%s:%s ServiceBrowserCallback: missing browser\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-keyword">if</span> (errorCode != kDNSServiceErr_NoError)
    {
        fprintf(stderr, <span class="enscript-string">&quot;%s:%s ServiceBrowserCallback: errcode set %d\n&quot;</span>, sPluginIdentifier, __FUNCTION__, errorCode);
        <span class="enscript-keyword">return</span>;
    }

    CFStringRef cfServiceName = CFStringCreateWithCString(NULL, serviceName, kCFStringEncodingUTF8);
    <span class="enscript-keyword">if</span> (cfServiceName == NULL)
    {
        <span class="enscript-type">static</span> <span class="enscript-type">int</span> msgCount = 0;
        <span class="enscript-keyword">if</span> (msgCount &lt; 1000)
        {
            os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s Can not create CFString for serviceName %s&quot;</span>, sPluginIdentifier, __FUNCTION__, serviceName);
            msgCount++;
        }
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-keyword">if</span> (flags &amp; kDNSServiceFlagsAdd)
    {
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s calling HandleTemporaryEventsForService Add\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
        HandleTemporaryEventsForService(plugin, browser, cfServiceName, plugin-&gt;_onAddEvents);
    }
    <span class="enscript-keyword">else</span>
    {
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s calling HandleTemporaryEventsForService Remove\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
        HandleTemporaryEventsForService(plugin, browser, cfServiceName, plugin-&gt;_onRemoveEvents);
    }

    CFRelease(cfServiceName);
}

<span class="enscript-comment">/*****************************************************************************
* HandleTemporaryEventsForService
* -
* This method handles the firing of one shot events. Aka. Events that are
* signaled when a service appears / disappears. They have a temporarly
* signaled state.
*****************************************************************************/</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">HandleTemporaryEventsForService</span>(BonjourUserEventsPlugin* plugin, NetBrowserInfo* browser, CFStringRef serviceName, CFMutableDictionaryRef eventsDictionary)
{
    CFArrayRef events = (CFArrayRef)CFDictionaryGetValue(eventsDictionary, browser); <span class="enscript-comment">// Get events for the browser we passed in.
</span>    CFIndex i;
    CFIndex count;

    <span class="enscript-keyword">if</span> (!events)  <span class="enscript-comment">// Somehow we have a orphan browser...
</span>        <span class="enscript-keyword">return</span>;

    count = CFArrayGetCount(events);

    <span class="enscript-comment">// Go thru the events and run filters, notifity if they pass.
</span>    <span class="enscript-keyword">for</span> (i = 0; i &lt; count; ++i)
    {
        CFDictionaryRef eventDict = (CFDictionaryRef)CFArrayGetValueAtIndex(events, i);
        CFStringRef eventServiceName = (CFStringRef)CFDictionaryGetValue(eventDict, sServiceNameKey);
        CFNumberRef token = (CFNumberRef) CFDictionaryGetValue(eventDict, sLaunchdTokenKey);
        CFDictionaryRef dict = (CFDictionaryRef) CFDictionaryGetValue(eventDict, sLaunchdDictKey);

        <span class="enscript-comment">// Currently we only filter on service name, that makes this as simple as...
</span>        <span class="enscript-keyword">if</span> (!eventServiceName || CFEqual(serviceName, eventServiceName))
        {
            uint64_t tokenUint64;
            <span class="enscript-comment">// Signal Event: This is edge trigger. When the action has been taken, it will not
</span>            <span class="enscript-comment">// be remembered anymore.
</span>
            os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s HandleTemporaryEventsForService signal\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
            CFNumberGetValue(token, kCFNumberLongLongType, &amp;tokenUint64);

            xpc_object_t jobRequest = _CFXPCCreateXPCObjectFromCFObject(dict);

            UserEventAgentFireEvent(plugin-&gt;_pluginContext, tokenUint64, jobRequest);
            xpc_release(jobRequest);
        }
    }
}

#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">Convenience</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -

<span class="enscript-comment">/*****************************************************************************
* CStringFromCFString
* -
* Silly convenence function for dealing with non-critical CFSTR -&gt; cStr
* conversions.
*****************************************************************************/</span>

<span class="enscript-type">const</span> <span class="enscript-type">char</span>* <span class="enscript-function-name">CStringFromCFString</span>(CFStringRef string)
{
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>* defaultString = <span class="enscript-string">&quot;??????&quot;</span>;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>* cstring;

    <span class="enscript-keyword">if</span> (!string)
        <span class="enscript-keyword">return</span> defaultString;

    cstring = CFStringGetCStringPtr(string, kCFStringEncodingUTF8);

    <span class="enscript-keyword">return</span> (cstring) ? cstring : defaultString;

}

#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> <span class="enscript-variable-name">NetBrowserInfo</span> <span class="enscript-string">&quot;Object&quot;</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
<span class="enscript-comment">/*****************************************************************************
* NetBrowserInfoCreate
* -
* The method creates a NetBrowserInfo Object and initalizes it.
*****************************************************************************/</span>
NetBrowserInfo* <span class="enscript-function-name">NetBrowserInfoCreate</span>(CFStringRef serviceType, CFStringRef domain, <span class="enscript-type">void</span>* context)
{
    NetBrowserInfo* outObj = NULL;
    DNSServiceRef browserRef = NULL;
    <span class="enscript-type">char</span>* cServiceType = NULL;
    <span class="enscript-type">char</span>* cDomain = NULL;
    Boolean success = true;

    CFIndex serviceSize = CFStringGetMaximumSizeForEncoding(CFStringGetLength(serviceType), kCFStringEncodingUTF8);
    cServiceType = calloc(serviceSize, 1);
    success = CFStringGetCString(serviceType, cServiceType, serviceSize, kCFStringEncodingUTF8);


    <span class="enscript-keyword">if</span> (domain)
    {
        CFIndex domainSize = CFStringGetMaximumSizeForEncoding(CFStringGetLength(domain), kCFStringEncodingUTF8);
        <span class="enscript-keyword">if</span> (domainSize)
        {
            cDomain = calloc(domainSize, 1);
            success = success &amp;&amp; CFStringGetCString(domain, cDomain, domainSize, kCFStringEncodingUTF8);
        }
    }

    <span class="enscript-keyword">if</span> (!success)
    {
        fprintf(stderr, <span class="enscript-string">&quot;%s:%s LaunchEvent has badly encoded service type or domain.\n&quot;</span>, sPluginIdentifier, __FUNCTION__);
        free(cServiceType);

        <span class="enscript-keyword">if</span> (cDomain)
            free(cDomain);

        <span class="enscript-keyword">return</span> NULL;
    }

    DNSServiceErrorType err = DNSServiceBrowse(&amp;browserRef, 0, 0, cServiceType, cDomain, ServiceBrowserCallback, context);

    <span class="enscript-keyword">if</span> (err != kDNSServiceErr_NoError)
    {
        fprintf(stderr, <span class="enscript-string">&quot;%s:%s Failed to create browser for %s, %s\n&quot;</span>, sPluginIdentifier, __FUNCTION__, cServiceType, cDomain);
        free(cServiceType);

        <span class="enscript-keyword">if</span> (cDomain)
            free(cDomain);

        <span class="enscript-keyword">return</span> NULL;
    }

    DNSServiceSetDispatchQueue(browserRef, dispatch_get_main_queue());


    outObj = malloc(<span class="enscript-keyword">sizeof</span>(NetBrowserInfo));

    outObj-&gt;refCount = 1;
    outObj-&gt;browserRef = browserRef;

    os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: created new object %p&quot;</span>, sPluginIdentifier, __FUNCTION__, outObj);

    free(cServiceType);

    <span class="enscript-keyword">if</span> (cDomain)
        free(cDomain);

    <span class="enscript-keyword">return</span> outObj;
}

<span class="enscript-comment">/*****************************************************************************
* NetBrowserInfoRetain
* -
* The method retains a NetBrowserInfo object.
*****************************************************************************/</span>
<span class="enscript-type">const</span> <span class="enscript-type">void</span>* <span class="enscript-function-name">NetBrowserInfoRetain</span>(CFAllocatorRef allocator, <span class="enscript-type">const</span> <span class="enscript-type">void</span>* info)
{
    (<span class="enscript-type">void</span>)allocator;
    NetBrowserInfo* obj = (NetBrowserInfo*)info;

    <span class="enscript-keyword">if</span> (!obj)
        <span class="enscript-keyword">return</span> NULL;

    ++obj-&gt;refCount;
    os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: Incremented ref count on %p, count %d&quot;</span>, sPluginIdentifier, __FUNCTION__, obj-&gt;browserRef, (<span class="enscript-type">int</span>)obj-&gt;refCount);

    <span class="enscript-keyword">return</span> obj;
}

<span class="enscript-comment">/*****************************************************************************
* NetBrowserInfoRelease
* -
* The method releases a NetBrowserInfo object.
*****************************************************************************/</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">NetBrowserInfoRelease</span>(CFAllocatorRef allocator, <span class="enscript-type">const</span> <span class="enscript-type">void</span>* info)
{
    (<span class="enscript-type">void</span>)allocator;
    NetBrowserInfo* obj = (NetBrowserInfo*)info;

    <span class="enscript-keyword">if</span> (!obj)
        <span class="enscript-keyword">return</span>;

    <span class="enscript-keyword">if</span> (obj-&gt;refCount == 1)
    {
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: DNSServiceRefDeallocate %p&quot;</span>, sPluginIdentifier, __FUNCTION__, obj-&gt;browserRef);
        DNSServiceRefDeallocate(obj-&gt;browserRef);
        free(obj);
    }
    <span class="enscript-keyword">else</span>
    {
        --obj-&gt;refCount;
        os_log_info(OS_LOG_DEFAULT, <span class="enscript-string">&quot;%s:%s: Decremented ref count on %p, count %d&quot;</span>, sPluginIdentifier, __FUNCTION__, obj-&gt;browserRef, (<span class="enscript-type">int</span>)obj-&gt;refCount);
    }

}

<span class="enscript-comment">/*****************************************************************************
* NetBrowserInfoEqual
* -
* The method is used to compare two NetBrowserInfo objects for equality.
*****************************************************************************/</span>
Boolean <span class="enscript-function-name">NetBrowserInfoEqual</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *value1, <span class="enscript-type">const</span> <span class="enscript-type">void</span> *value2)
{
    NetBrowserInfo* obj1 = (NetBrowserInfo*)value1;
    NetBrowserInfo* obj2 = (NetBrowserInfo*)value2;

    <span class="enscript-keyword">if</span> (obj1-&gt;browserRef == obj2-&gt;browserRef)
        <span class="enscript-keyword">return</span> true;

    <span class="enscript-keyword">return</span> false;
}

<span class="enscript-comment">/*****************************************************************************
* NetBrowserInfoHash
* -
* The method is used to make a hash for the object. We can cheat and use the
* browser pointer.
*****************************************************************************/</span>
CFHashCode  <span class="enscript-function-name">NetBrowserInfoHash</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *value)
{
    <span class="enscript-keyword">return</span> (CFHashCode)((NetBrowserInfo*)value)-&gt;browserRef;
}


<span class="enscript-comment">/*****************************************************************************
* NetBrowserInfoCopyDescription
* -
* Make CF happy.
*****************************************************************************/</span>
CFStringRef <span class="enscript-function-name">NetBrowserInfoCopyDescription</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *value)
{
    (<span class="enscript-type">void</span>)value;
    <span class="enscript-keyword">return</span> CFStringCreateWithCString(NULL, <span class="enscript-string">&quot;NetBrowserInfo: No useful description&quot;</span>, kCFStringEncodingUTF8);
}

</pre>
<hr />
</body></html>