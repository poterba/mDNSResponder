<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>coreBLE.m</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">coreBLE.m&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="coreBLE.m">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
/* -*- Mode: C; tab-width: 4 -*-
 *
 * Copyright (c) 2015-2016 Apple Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may <span class="enscript-type">not</span> use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>
 *
 * Unless required by applicable law <span class="enscript-type">or</span> agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express <span class="enscript-type">or</span> implied.
 * See the License <span class="enscript-keyword">for</span> the specific language governing permissions <span class="enscript-type">and</span>
 * limitations under the License.
 */

#<span class="enscript-keyword">if</span> ENABLE_BLE_TRIGGERED_BONJOUR

#include &quot;mDNSEmbeddedAPI.h&quot;
#include &quot;DNSCommon.h&quot;

#import &lt;Foundation/Foundation.h&gt;
#import &lt;CoreBluetooth/CoreBluetooth.h&gt;
#import &lt;CoreBluetooth/CoreBluetooth_Private.h&gt;
#import &quot;mDNSMacOSX.h&quot;
#import &quot;BLE.h&quot;
#import &quot;coreBLE.h&quot;

static coreBLE * coreBLEptr;

// Call Bluetooth subsystem to start/stop the the Bonjour BLE beacon <span class="enscript-type">and</span>
// beacon scanning based on the current Bloom <span class="enscript-type">filter</span>.
void updateBLEBeacon(serviceHash_t bloomFilter)
{
    <span class="enscript-keyword">if</span> (coreBLEptr == 0)
        coreBLEptr = <span class="enscript-type">[</span><span class="enscript-type">[</span>coreBLE alloc<span class="enscript-type">]</span> init<span class="enscript-type">]</span>;

    LogInfo(&quot;updateBLEBeacon: bloomFilter = 0x<span class="enscript-comment">%lx&quot;, bloomFilter);
</span>
    <span class="enscript-type">[</span>coreBLEptr updateBeacon:bloomFilter<span class="enscript-type">]</span>;
}

// Stop the current BLE beacon.
void stopBLEBeacon(void)
{
    <span class="enscript-keyword">if</span> (coreBLEptr == 0)
        coreBLEptr = <span class="enscript-type">[</span><span class="enscript-type">[</span>coreBLE alloc<span class="enscript-type">]</span> init<span class="enscript-type">]</span>;

    <span class="enscript-type">[</span>coreBLEptr stopBeacon<span class="enscript-type">]</span>;
}

bool currentlyBeaconing(void)
{
    <span class="enscript-keyword">if</span> (coreBLEptr == 0)
        coreBLEptr = <span class="enscript-type">[</span><span class="enscript-type">[</span>coreBLE alloc<span class="enscript-type">]</span> init<span class="enscript-type">]</span>;

    <span class="enscript-keyword">return</span> <span class="enscript-type">[</span>coreBLEptr isBeaconing<span class="enscript-type">]</span>;
}

// Start the scan.
void startBLEScan(void)
{
    <span class="enscript-keyword">if</span> (coreBLEptr == 0)
        coreBLEptr = <span class="enscript-type">[</span><span class="enscript-type">[</span>coreBLE alloc<span class="enscript-type">]</span> init<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>coreBLEptr startScan<span class="enscript-type">]</span>;
}

// Stop the scan.
void stopBLEScan(void)
{
    <span class="enscript-keyword">if</span> (coreBLEptr == 0)
        coreBLEptr = <span class="enscript-type">[</span><span class="enscript-type">[</span>coreBLE alloc<span class="enscript-type">]</span> init<span class="enscript-type">]</span>;

    <span class="enscript-type">[</span>coreBLEptr stopScan<span class="enscript-type">]</span>;
}

@implementation coreBLE
{
    CBCentralManager     *_centralManager;
    CBPeripheralManager  *_peripheralManager;

    NSData               *_currentlyAdvertisedData;

    // <span class="enscript-type">[</span>_centralManager isScanning<span class="enscript-type">]</span> is only available on iOS <span class="enscript-type">and</span> <span class="enscript-type">not</span> OSX,
    // so track scanning state locally.
    BOOL                 _isScanning;
    BOOL                 _centralManagerIsOn;
    BOOL                 _peripheralManagerIsOn;
}

- (id)init
{
    self = <span class="enscript-type">[</span>super init<span class="enscript-type">]</span>;

    <span class="enscript-keyword">if</span> (self)
    {
        _centralManager     = <span class="enscript-type">[</span><span class="enscript-type">[</span>CBCentralManager alloc<span class="enscript-type">]</span> initWithDelegate:self queue:dispatch_get_main_queue()<span class="enscript-type">]</span>;
        _peripheralManager  = <span class="enscript-type">[</span><span class="enscript-type">[</span>CBPeripheralManager alloc<span class="enscript-type">]</span> initWithDelegate:self queue:dispatch_get_main_queue()<span class="enscript-type">]</span>;
        _currentlyAdvertisedData = nil;
        _isScanning = NO;
        _centralManagerIsOn = NO;
        _peripheralManagerIsOn = NO;

        <span class="enscript-keyword">if</span> (_centralManager == nil || _peripheralManager == nil )
        {
            LogMsg(&quot;coreBLE initialization failed!&quot;);
        } 
        <span class="enscript-keyword">else</span>
        {
            LogInfo(&quot;coreBLE initialized&quot;);
        }
    }

    <span class="enscript-keyword">return</span> self;
}

#define ADVERTISEMENTDATALENGTH 28 // 31 - 3 (3 bytes <span class="enscript-keyword">for</span> flags)

// TODO: 
// Define DBDeviceTypeBonjour <span class="enscript-keyword">for</span> prototyping until we move to the TDS beacon <span class="enscript-type">format</span>.
// The Bluetooth team recommended using a value &lt; 32 <span class="enscript-keyword">for</span> prototyping, since 32 is the number of
// beacon types they can track in their duplicate beacon filtering logic.
#define DBDeviceTypeBonjour     26

// Beacon flags <span class="enscript-type">and</span> <span class="enscript-type">version</span> byte
#define BonjourBLEVersion     1

extern mDNS mDNSStorage;
extern mDNSInterfaceID AWDLInterfaceID;

// Transmit the last beacon indicating we are no longer advertising <span class="enscript-type">or</span> browsing <span class="enscript-type">any</span> services <span class="enscript-keyword">for</span> two seconds.
#define LastBeaconTime 2

- (void) updateBeacon:(serviceHash_t) bloomFilter
{
    uint8_t advertisingData<span class="enscript-type">[</span>ADVERTISEMENTDATALENGTH<span class="enscript-type">]</span> = {0, 0xff, 0x4c, 0x00 };
    uint8_t advertisingLength = 4;

    // If no longer browsing <span class="enscript-type">or</span> advertising, beacon this state <span class="enscript-keyword">for</span> <span class="enscript-string">'LastBeaconTime'</span> seconds
    // so that peers have a chance to notice the state change.
    <span class="enscript-keyword">if</span> (bloomFilter == 0)
    {
        LogInfo(&quot;updateBeacon: Stopping beacon in <span class="enscript-comment">%d seconds&quot;, LastBeaconTime);
</span>
        <span class="enscript-keyword">if</span> (mDNSStorage.timenow == 0)
        {
            // This should never happen since <span class="enscript-type">all</span> calling code paths should have called mDNS_Lock(), <span class="enscript-type">which</span>
            // initializes the mDNSStorage.timenow value.
            LogMsg(&quot;updateBeacon: NOTE, timenow == 0 ??&quot;);
        }

        mDNSStorage.NextBLEServiceTime = NonZeroTime(mDNSStorage.timenow + (LastBeaconTime * mDNSPlatformOneSecond));
        finalBeacon = true;
    }
    <span class="enscript-keyword">else</span>
    {
        // Cancel <span class="enscript-type">any</span> pending final beacon processing.
        finalBeacon = false;
    }

    // The beacon <span class="enscript-type">type</span>.
    advertisingData<span class="enscript-type">[</span>advertisingLength++<span class="enscript-type">]</span> = DBDeviceTypeBonjour;

    // Flags <span class="enscript-type">and</span> Version field
    advertisingData<span class="enscript-type">[</span>advertisingLength++<span class="enscript-type">]</span> = BonjourBLEVersion;

    memcpy(&amp; advertisingData<span class="enscript-type">[</span>advertisingLength<span class="enscript-type">]</span>, &amp; bloomFilter, sizeof(serviceHash_t));
    advertisingLength += sizeof(serviceHash_t);

    // Add the MAC address of the awdl0 interface.  Don<span class="enscript-keyword">'</span>t cache it since
    // it can <span class="enscript-type">get</span> updated periodically.
    <span class="enscript-keyword">if</span> (AWDLInterfaceID)
    {
        NetworkInterfaceInfoOSX *intf = IfindexToInterfaceInfoOSX(AWDLInterfaceID);
        <span class="enscript-keyword">if</span> (intf)
            memcpy(&amp; advertisingData<span class="enscript-type">[</span>advertisingLength<span class="enscript-type">]</span>, &amp; intf-&gt;ifinfo.MAC, sizeof(mDNSEthAddr));
        <span class="enscript-keyword">else</span> 
            memset( &amp; advertisingData<span class="enscript-type">[</span>advertisingLength<span class="enscript-type">]</span>, 0, sizeof(mDNSEthAddr));
    }
    <span class="enscript-keyword">else</span>
    {
        // Just use zero <span class="enscript-keyword">if</span> <span class="enscript-type">not</span> avaiblable.
       memset( &amp; advertisingData<span class="enscript-type">[</span>advertisingLength<span class="enscript-type">]</span>, 0, sizeof(mDNSEthAddr));
    }
    advertisingLength += sizeof(mDNSEthAddr);

    // Total <span class="enscript-type">length</span> of data advertised, <span class="enscript-type">minus</span> this <span class="enscript-type">length</span> byte.
    advertisingData<span class="enscript-type">[</span>0<span class="enscript-type">]</span> = (advertisingLength - 1);

    LogInfo(&quot;updateBeacon: advertisingLength = <span class="enscript-comment">%d&quot;, advertisingLength);
</span>
    <span class="enscript-keyword">if</span> (_currentlyAdvertisedData)
        <span class="enscript-type">[</span>_currentlyAdvertisedData release<span class="enscript-type">]</span>;
    _currentlyAdvertisedData = <span class="enscript-type">[</span><span class="enscript-type">[</span>NSData alloc<span class="enscript-type">]</span> initWithBytes:advertisingData <span class="enscript-type">length</span>:advertisingLength<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>self startBeacon<span class="enscript-type">]</span>;
}

- (void) startBeacon
{
    <span class="enscript-keyword">if</span> (!_peripheralManagerIsOn)
    {
        LogInfo(&quot;startBeacon: Not starting beacon, CBPeripheralManager <span class="enscript-type">not</span> powered on&quot;);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-keyword">if</span> (_currentlyAdvertisedData == nil)
    {
        LogInfo(&quot;startBeacon: Not starting beacon, no data to advertise&quot;);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-keyword">if</span> (<span class="enscript-type">[</span>_peripheralManager isAdvertising<span class="enscript-type">]</span>)
    {
        LogInfo(&quot;startBeacon: Stop current beacon transmission before restarting&quot;);
        <span class="enscript-type">[</span>_peripheralManager stopAdvertising<span class="enscript-type">]</span>;
    }
    LogInfo(&quot;startBeacon: Starting beacon&quot;);

#<span class="enscript-keyword">if</span> 0   // Move to this code during Fall 2018 develelopment <span class="enscript-keyword">if</span> still using these APIs.
    <span class="enscript-type">[</span>_peripheralManager startAdvertising:@{ CBAdvertisementDataAppleMfgData : _currentlyAdvertisedData, CBManagerIsPrivilegedDaemonKey : @YES, @&quot;kCBAdvOptionUseFGInterval&quot; : @YES }<span class="enscript-type">]</span>;
#<span class="enscript-keyword">else</span>
    // While CBCentralManagerScanOptionIsPrivilegedDaemonKey is deprecated in current MobileBluetooth project, it<span class="enscript-keyword">'</span>s still defined in the current <span class="enscript-type">and</span>
    // previous train SDKs.  Suppress deprecated <span class="enscript-type">warning</span> <span class="enscript-keyword">for</span> <span class="enscript-type">now</span> since we intend to move to a different Bluetooth API to manage the BLE Triggered Bonjour 
    // beacons when this code is enabled by default.
#pragma GCC diagnostic push
#pragma GCC diagnostic ignored &quot;-Wdeprecated-declarations&quot;
    <span class="enscript-type">[</span>_peripheralManager startAdvertising:@{ CBAdvertisementDataAppleMfgData : _currentlyAdvertisedData, CBCentralManagerScanOptionIsPrivilegedDaemonKey : @YES, @&quot;kCBAdvOptionUseFGInterval&quot; : @YES }<span class="enscript-type">]</span>;
#pragma GCC diagnostic pop
#endif
}

- (bool) isBeaconing
{
    <span class="enscript-keyword">return</span> (_currentlyAdvertisedData != nil);
}

- (void) stopBeacon
{
    <span class="enscript-keyword">if</span> (!_peripheralManagerIsOn)
    {
        LogInfo(&quot;stopBeacon: CBPeripheralManager is <span class="enscript-type">not</span> powered on&quot;);
        <span class="enscript-keyword">return</span>;
    }

    // Only beaconing <span class="enscript-keyword">if</span> we have advertised data to send.
    <span class="enscript-keyword">if</span> (_currentlyAdvertisedData)
    {
        LogInfo(&quot;stoptBeacon: Stopping beacon&quot;);
        <span class="enscript-type">[</span>_peripheralManager stopAdvertising<span class="enscript-type">]</span>;
        <span class="enscript-type">[</span>_currentlyAdvertisedData release<span class="enscript-type">]</span>;
        _currentlyAdvertisedData = nil;
    }
    <span class="enscript-keyword">else</span>
        LogInfo(&quot;stoptBeacon: Note currently beaconing&quot;);
}

- (void) startScan
{
    <span class="enscript-keyword">if</span> (!_centralManagerIsOn)
    {
        LogInfo(&quot;startScan: Not starting scan, CBCentralManager is <span class="enscript-type">not</span> powered on&quot;);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-keyword">if</span> (_isScanning)
    {
        LogInfo(&quot;startScan: already scanning, stopping scan before restarting&quot;);
        <span class="enscript-type">[</span>_centralManager stopScan<span class="enscript-type">]</span>;
    }

    LogInfo(&quot;startScan: Starting scan&quot;);

    _isScanning = YES;

#<span class="enscript-keyword">if</span> 0   // Move to this code during Fall 2018 develelopment <span class="enscript-keyword">if</span> still using these APIs.
    <span class="enscript-type">[</span>_centralManager scanForPeripheralsWithServices:nil options:@{ CBCentralManagerScanOptionAllowDuplicatesKey : @YES , CBManagerIsPrivilegedDaemonKey : @YES}<span class="enscript-type">]</span>;
#<span class="enscript-keyword">else</span>
    // While CBCentralManagerScanOptionIsPrivilegedDaemonKey is deprecated in current MobileBluetooth project, it<span class="enscript-keyword">'</span>s still defined in the current <span class="enscript-type">and</span>
    // previous train SDKs.  Suppress deprecated <span class="enscript-type">warning</span> <span class="enscript-keyword">for</span> <span class="enscript-type">now</span> since we intend to move to a different Bluetooth API to manage the BLE Triggered Bonjour 
    // beacons when this code is enabled by default.
#pragma GCC diagnostic push
#pragma GCC diagnostic ignored &quot;-Wdeprecated-declarations&quot;
    <span class="enscript-type">[</span>_centralManager scanForPeripheralsWithServices:nil options:@{ CBCentralManagerScanOptionAllowDuplicatesKey : @YES , CBCentralManagerScanOptionIsPrivilegedDaemonKey : @YES}<span class="enscript-type">]</span>;
#pragma GCC diagnostic pop
#endif
}

- (void) stopScan
{
    <span class="enscript-keyword">if</span> (!_centralManagerIsOn)
    {
        LogInfo(&quot;stopScan: Not stopping scan, CBCentralManager is <span class="enscript-type">not</span> powered on&quot;);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-keyword">if</span> (_isScanning)
    {
        LogInfo(&quot;stopScan: Stopping scan&quot;);
        <span class="enscript-type">[</span>_centralManager stopScan<span class="enscript-type">]</span>;
        _isScanning = NO;
    }
    <span class="enscript-keyword">else</span>
    {
        LogInfo(&quot;stopScan: Not currently scanning&quot;);
    }
}

#pragma mark - CBCentralManagerDelegate protocol

- (void)centralManagerDidUpdateState:(CBCentralManager *)central
{
    <span class="enscript-keyword">switch</span> (central.state) {
        <span class="enscript-type">case</span> CBManagerStateUnknown:
            LogInfo(&quot;centralManagerDidUpdateState: CBManagerStateUnknown&quot;);
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> CBManagerStateResetting:
            LogInfo(&quot;centralManagerDidUpdateState: CBManagerStateResetting&quot;);
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> CBManagerStateUnsupported:
            LogInfo(&quot;centralManagerDidUpdateState: CBManagerStateUnsupported&quot;);
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> CBManagerStateUnauthorized:
            LogInfo(&quot;centralManagerDidUpdateState: CBManagerStateUnauthorized&quot;);
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> CBManagerStatePoweredOff:
            LogInfo(&quot;centralManagerDidUpdateState: CBManagerStatePoweredOff&quot;);
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> CBManagerStatePoweredOn:
            // Hold lock to synchronize with main thread from this callback thread.
            KQueueLock();

            LogInfo(&quot;centralManagerDidUpdateState: CBManagerStatePoweredOn&quot;);
            _centralManagerIsOn = YES;
            // Only start scan <span class="enscript-keyword">if</span> we have data we will be transmitting <span class="enscript-type">or</span> <span class="enscript-keyword">if</span> &quot;suppressBeacons&quot;
            // is <span class="enscript-type">set</span>, indicating we should be scanning, but <span class="enscript-type">not</span> beaconing.
            <span class="enscript-keyword">if</span> (_currentlyAdvertisedData || suppressBeacons)
                <span class="enscript-type">[</span>self startScan<span class="enscript-type">]</span>;
            <span class="enscript-keyword">else</span>
                LogInfo(&quot;centralManagerDidUpdateState:: Not starting scan&quot;);

            KQueueUnlock(&quot;CBManagerStatePoweredOn&quot;);
            <span class="enscript-keyword">break</span>;

        default:
            LogInfo(&quot;centralManagerDidUpdateState: Unknown state ??&quot;);
            <span class="enscript-keyword">break</span>;
    }
}

#define beaconTypeByteIndex  2   // Offset of beacon <span class="enscript-type">type</span> in received CBAdvertisementDataManufacturerDataKey byte array.
#define beaconDataLength    18  // Total number of bytes in the CBAdvertisementDataManufacturerDataKey.

- (void)centralManager:(CBCentralManager *)central didDiscoverPeripheral:(CBPeripheral *)peripheral advertisementData:(NSDictionary&lt;NSString *, id&gt; *)advertisementData RSSI:(NSNumber *)RSSI
{
    (void) central;
    (void) peripheral;
    (void) RSSI;

    NSData *data = <span class="enscript-type">[</span>advertisementData objectForKey:CBAdvertisementDataManufacturerDataKey<span class="enscript-type">]</span>;
   
    // Just <span class="enscript-keyword">return</span> <span class="enscript-keyword">if</span> the beacon data does <span class="enscript-type">not</span> match <span class="enscript-type">what</span> we are looking <span class="enscript-keyword">for</span>.
    <span class="enscript-keyword">if</span> (!data || (<span class="enscript-type">[</span>data <span class="enscript-type">length</span><span class="enscript-type">]</span> != beaconDataLength))
    {
        <span class="enscript-keyword">return</span>;
    }

    unsigned <span class="enscript-type">char</span> *bytes = (unsigned <span class="enscript-type">char</span> *)data.bytes;
    
    // Just parse the DBDeviceTypeBonjour beacons.
    <span class="enscript-keyword">if</span> (bytes<span class="enscript-type">[</span>beaconTypeByteIndex<span class="enscript-type">]</span> == DBDeviceTypeBonjour)
    {
        serviceHash_t peerBloomFilter;
        mDNSEthAddr   peerMAC;
        unsigned <span class="enscript-type">char</span> flagsAndVersion;
        unsigned <span class="enscript-type">char</span> *ptr;

#<span class="enscript-keyword">if</span> VERBOSE_BLE_DEBUG
        LogInfo(&quot;didDiscoverPeripheral: received DBDeviceTypeBonjour beacon, <span class="enscript-type">length</span> = <span class="enscript-comment">%d&quot;, [data length]);
</span>        LogInfo(&quot;didDiscoverPeripheral: central = 0x<span class="enscript-comment">%x, peripheral = 0x%x&quot;, central, peripheral);
</span>#endif // VERBOSE_BLE_DEBUG

        // The DBDeviceTypeBonjour beacon bytes will be:
        // 0x4C (1 byte), 0x0 (1 byte), DBDeviceTypeBonjour byte, flags <span class="enscript-type">and</span> <span class="enscript-type">version</span> byte, 8 byte Bloom <span class="enscript-type">filter</span>,
        // 6 byte sender AWDL MAC address

        ptr = &amp; bytes<span class="enscript-type">[</span>beaconTypeByteIndex + 1<span class="enscript-type">]</span>;
        flagsAndVersion = *ptr++;
        memcpy(&amp; peerBloomFilter, ptr, sizeof(serviceHash_t));
        ptr += sizeof(serviceHash_t);
        memcpy(&amp; peerMAC, ptr, sizeof(peerMAC));

#<span class="enscript-keyword">if</span> VERBOSE_BLE_DEBUG
        LogInfo(&quot;didDiscoverPeripheral: <span class="enscript-type">version</span> = 0x<span class="enscript-comment">%x, peerBloomFilter = 0x%x&quot;,
</span>                flagsAndVersion, peerBloomFilter);
        LogInfo(&quot;didDiscoverPeripheral: sender MAC = 0x<span class="enscript-comment">%x 0x%x 0x%x 0x%x 0x%x 0x%x&quot;,
</span>            peerMAC.b<span class="enscript-type">[</span>0<span class="enscript-type">]</span>, peerMAC.b<span class="enscript-type">[</span>1<span class="enscript-type">]</span>, peerMAC.b<span class="enscript-type">[</span>2<span class="enscript-type">]</span>, peerMAC.b<span class="enscript-type">[</span>3<span class="enscript-type">]</span>, peerMAC.b<span class="enscript-type">[</span>4<span class="enscript-type">]</span>, peerMAC.b<span class="enscript-type">[</span>5<span class="enscript-type">]</span>);
#<span class="enscript-keyword">else</span>
        (void)flagsAndVersion; // Unused
#endif  // VERBOSE_BLE_DEBUG

        responseReceived(peerBloomFilter, &amp; peerMAC);
    }
}

#pragma mark - CBPeripheralManagerDelegate protocol

- (void)peripheralManagerDidUpdateState:(CBPeripheralManager *)peripheral
{

    <span class="enscript-keyword">switch</span> (peripheral.state) {
        <span class="enscript-type">case</span> CBManagerStateUnknown:
            LogInfo(&quot;peripheralManagerDidUpdateState: CBManagerStateUnknown&quot;);
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> CBManagerStateResetting:
            LogInfo(&quot;peripheralManagerDidUpdateState: CBManagerStateResetting&quot;);
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> CBManagerStateUnsupported:
            LogInfo(&quot;peripheralManagerDidUpdateState: CBManagerStateUnsupported&quot;);
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> CBManagerStateUnauthorized:
            LogInfo(&quot;peripheralManagerDidUpdateState: CBManagerStateUnauthorized&quot;);
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> CBManagerStatePoweredOff:
            LogInfo(&quot;peripheralManagerDidUpdateState: CBManagerStatePoweredOff&quot;);
            <span class="enscript-keyword">break</span>;

        <span class="enscript-type">case</span> CBManagerStatePoweredOn:
            // Hold lock to synchronize with main thread from this callback thread.
            KQueueLock();

            LogInfo(&quot;peripheralManagerDidUpdateState: CBManagerStatePoweredOn&quot;);
            _peripheralManagerIsOn = YES;

            // Start beaconing <span class="enscript-keyword">if</span> we have initialized beacon data to send.
            <span class="enscript-keyword">if</span> (_currentlyAdvertisedData)
                <span class="enscript-type">[</span>self startBeacon<span class="enscript-type">]</span>;

            KQueueUnlock(&quot;CBManagerStatePoweredOn&quot;);
            <span class="enscript-keyword">break</span>;

        default:
            LogInfo(&quot;peripheralManagerDidUpdateState: Unknown state ??&quot;);
            <span class="enscript-keyword">break</span>;
    }
}

- (void)peripheralManagerDidStartAdvertising:(CBPeripheralManager *)peripheral <span class="enscript-keyword">error</span>:(nullable NSError *)<span class="enscript-keyword">error</span>
{
    (void) peripheral;

    <span class="enscript-keyword">if</span> (<span class="enscript-keyword">error</span>)
    {
        const <span class="enscript-type">char</span> * errorString = <span class="enscript-type">[</span><span class="enscript-type">[</span><span class="enscript-keyword">error</span> localizedDescription<span class="enscript-type">]</span> cStringUsingEncoding:NSASCIIStringEncoding<span class="enscript-type">]</span>;
        LogInfo(&quot;peripheralManagerDidStartAdvertising: <span class="enscript-keyword">error</span> = <span class="enscript-comment">%s&quot;, errorString ? errorString: &quot;unknown&quot;);
</span>    }
    <span class="enscript-keyword">else</span>
    {
        LogInfo(&quot;peripheralManagerDidStartAdvertising:&quot;);
    }
}

@<span class="enscript-keyword">end</span>
#endif  // ENABLE_BLE_TRIGGERED_BONJOUR
</pre>
<hr />
</body></html>