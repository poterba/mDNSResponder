<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>dns-sd.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">dns-sd.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="dns-sd.c">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* -*- Mode: C; tab-width: 4 -*-
 *
 * Copyright (c) 2002-2015 Apple Inc. All rights reserved.
 *
 * Disclaimer: IMPORTANT:  This Apple software is supplied to you by Apple Inc.
 * (&quot;Apple&quot;) in consideration of your agreement to the following terms, and your
 * use, installation, modification or redistribution of this Apple software
 * constitutes acceptance of these terms.  If you do not agree with these terms,
 * please do not use, install, modify or redistribute this Apple software.
 *
 * In consideration of your agreement to abide by the following terms, and subject
 * to these terms, Apple grants you a personal, non-exclusive license, under Apple's
 * copyrights in this original Apple software (the &quot;Apple Software&quot;), to use,
 * reproduce, modify and redistribute the Apple Software, with or without
 * modifications, in source and/or binary forms; provided that if you redistribute
 * the Apple Software in its entirety and without modifications, you must retain
 * this notice and the following text and disclaimers in all such redistributions of
 * the Apple Software.  Neither the name, trademarks, service marks or logos of
 * Apple Inc. may be used to endorse or promote products derived from the
 * Apple Software without specific prior written permission from Apple.  Except as
 * expressly stated in this notice, no other rights or licenses, express or implied,
 * are granted by Apple herein, including but not limited to any patent rights that
 * may be infringed by your derivative works or by other works in which the Apple
 * Software may be incorporated.
 *
 * The Apple Software is provided by Apple on an &quot;AS IS&quot; basis.  APPLE MAKES NO
 * WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION THE IMPLIED
 * WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND OPERATION ALONE OR IN
 * COMBINATION WITH YOUR PRODUCTS.
 *
 * IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE
 * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION, MODIFICATION AND/OR DISTRIBUTION
 * OF THE APPLE SOFTWARE, HOWEVER CAUSED AND WHETHER UNDER THEORY OF CONTRACT, TORT
 * (INCLUDING NEGLIGENCE), STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
   To build this tool, copy and paste the following into a command line:

   OS X:
   gcc dns-sd.c -o dns-sd

   POSIX systems:
   gcc dns-sd.c -o dns-sd -I../mDNSShared -ldns_sd

   Windows:
   cl dns-sd.c -I../mDNSShared -DNOT_HAVE_GETOPT ws2_32.lib ..\mDNSWindows\DLL\Release\dnssd.lib
   (may require that you run a Visual Studio script such as vsvars32.bat first)
 */</span>

<span class="enscript-comment">// For testing changes to dnssd_clientstub.c, uncomment this line and the code will be compiled
</span><span class="enscript-comment">// with an embedded copy of the client stub instead of linking the system library version at runtime.
</span><span class="enscript-comment">// This also useful to work around link errors when you're working on an older version of Mac OS X,
</span><span class="enscript-comment">// and trying to build a newer version of the &quot;dns-sd&quot; command which uses new API entry points that
</span><span class="enscript-comment">// aren't in the system's /usr/lib/libSystem.dylib.
</span><span class="enscript-comment">//#define TEST_NEW_CLIENTSTUB 1
</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ctype.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>          // For stdout, stderr
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>         // For exit()
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>         // For strlen(), strcpy()
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;errno.h&gt;</span>          // For errno, EINTR
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;time.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>      // For u_char
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;inttypes.h&gt;</span>       // For PRId64
#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;xpc/xpc.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;xpc_clients.h&quot;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_WIN32</span>
    #include &lt;winsock2.h&gt;
    #include &lt;ws2tcpip.h&gt;
    #include &lt;Iphlpapi.h&gt;
    #include &lt;process.h&gt;
<span class="enscript-type">typedef</span> <span class="enscript-type">int</span> pid_t;
    #define getpid     _getpid
    #define strcasecmp _stricmp
    #define snprintf   _snprintf
<span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> kFilePathSep = <span class="enscript-string">'\\'</span>;
    #ifndef HeapEnableTerminationOnCorruption
    #     define HeapEnableTerminationOnCorruption (HEAP_INFORMATION_CLASS)1
    #endif
    #<span class="enscript-keyword">if</span> !defined(IFNAMSIZ)
     #define IFNAMSIZ 16
    #endif
    #define if_nametoindex if_nametoindex_win
    #define if_indextoname if_indextoname_win

<span class="enscript-type">typedef</span> <span class="enscript-function-name">PCHAR</span> (WINAPI * if_indextoname_funcptr_t)(ULONG index, PCHAR name);
<span class="enscript-type">typedef</span> <span class="enscript-function-name">ULONG</span> (WINAPI * if_nametoindex_funcptr_t)(PCSTR name);

<span class="enscript-type">unsigned</span> <span class="enscript-function-name">if_nametoindex_win</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *ifname)
{
    HMODULE library;
    <span class="enscript-type">unsigned</span> index = 0;

    <span class="enscript-comment">// Try and load the IP helper library dll
</span>    <span class="enscript-keyword">if</span> ((library = LoadLibrary(TEXT(<span class="enscript-string">&quot;Iphlpapi&quot;</span>)) ) != NULL )
    {
        if_nametoindex_funcptr_t if_nametoindex_funcptr;

        <span class="enscript-comment">// On Vista and above there is a Posix like implementation of if_nametoindex
</span>        <span class="enscript-keyword">if</span> ((if_nametoindex_funcptr = (if_nametoindex_funcptr_t) GetProcAddress(library, <span class="enscript-string">&quot;if_nametoindex&quot;</span>)) != NULL )
        {
            index = if_nametoindex_funcptr(ifname);
        }

        FreeLibrary(library);
    }

    <span class="enscript-keyword">return</span> index;
}

<span class="enscript-type">char</span> * <span class="enscript-function-name">if_indextoname_win</span>( <span class="enscript-type">unsigned</span> ifindex, <span class="enscript-type">char</span> *ifname)
{
    HMODULE library;
    <span class="enscript-type">char</span> * name = NULL;

    <span class="enscript-comment">// Try and load the IP helper library dll
</span>    <span class="enscript-keyword">if</span> ((library = LoadLibrary(TEXT(<span class="enscript-string">&quot;Iphlpapi&quot;</span>)) ) != NULL )
    {
        if_indextoname_funcptr_t if_indextoname_funcptr;

        <span class="enscript-comment">// On Vista and above there is a Posix like implementation of if_indextoname
</span>        <span class="enscript-keyword">if</span> ((if_indextoname_funcptr = (if_indextoname_funcptr_t) GetProcAddress(library, <span class="enscript-string">&quot;if_indextoname&quot;</span>)) != NULL )
        {
            name = if_indextoname_funcptr(ifindex, ifname);
        }

        FreeLibrary(library);
    }

    <span class="enscript-keyword">return</span> name;
}

<span class="enscript-type">static</span> size_t <span class="enscript-function-name">_sa_len</span>(<span class="enscript-type">const</span> <span class="enscript-type">struct</span> sockaddr *addr)
{
    <span class="enscript-keyword">if</span> (addr-&gt;sa_family == AF_INET) <span class="enscript-keyword">return</span> (<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> sockaddr_in));
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (addr-&gt;sa_family == AF_INET6) <span class="enscript-keyword">return</span> (<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> sockaddr_in6));
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">return</span> (<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> sockaddr));
}

#   <span class="enscript-reference">define</span> <span class="enscript-function-name">SA_LEN</span>(addr) (_sa_len(addr))

#<span class="enscript-reference">else</span>
    #include &lt;unistd.h&gt;         <span class="enscript-comment">// For getopt() and optind
</span>    #include &lt;netdb.h&gt;          <span class="enscript-comment">// For getaddrinfo()
</span>    #include &lt;sys/time.h&gt;       <span class="enscript-comment">// For struct timeval
</span>    #include &lt;sys/socket.h&gt;     <span class="enscript-comment">// For AF_INET
</span>    #include &lt;netinet/in.h&gt;     <span class="enscript-comment">// For struct sockaddr_in()
</span>    #include &lt;arpa/inet.h&gt;      <span class="enscript-comment">// For inet_addr()
</span>    #include &lt;net/<span class="enscript-keyword">if</span>.h&gt;         <span class="enscript-comment">// For if_nametoindex()
</span><span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> kFilePathSep = <span class="enscript-string">'/'</span>;
<span class="enscript-comment">// #ifndef NOT_HAVE_SA_LEN
</span><span class="enscript-comment">//  #define SA_LEN(addr) ((addr)-&gt;sa_len)
</span><span class="enscript-comment">// #else
</span>    #define SA_LEN(addr) (((addr)-&gt;sa_family == AF_INET6) ? <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> sockaddr_in6) : <span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> sockaddr_in))
<span class="enscript-comment">// #endif
</span>#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> (<span class="enscript-variable-name">TEST_NEW_CLIENTSTUB</span> &amp;&amp; !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__APPLE_API_PRIVATE</span>))
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">__APPLE_API_PRIVATE</span> 1
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">// DNSServiceSetDispatchQueue is not supported on 10.6 &amp; prior
</span>#<span class="enscript-reference">if</span> !<span class="enscript-variable-name">TEST_NEW_CLIENTSTUB</span> &amp;&amp; <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__</span>) &amp;&amp; (<span class="enscript-variable-name">__ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__</span> - (<span class="enscript-variable-name">__ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__</span> % 10) &lt;= 1060)
#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">_DNS_SD_LIBDISPATCH</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;dns_sd.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;dns_sd_internal.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;ClientCommon.h&quot;</span>


#<span class="enscript-reference">if</span> <span class="enscript-variable-name">TEST_NEW_CLIENTSTUB</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;../mDNSShared/dnssd_ipc.c&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;../mDNSShared/dnssd_clientlib.c&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;../mDNSShared/dnssd_clientstub.c&quot;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Globals
</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DS_FIXED_SIZE</span>   4
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> keyTag;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> alg; 
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> digestType;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>  *digest;
} rdataDS;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DNSKEY_FIXED_SIZE</span>    4
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> flags;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> proto;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> alg;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *data;
} rdataDNSKey;

<span class="enscript-comment">//size of rdataRRSIG excluding signerName and signature (which are variable fields) 
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RRSIG_FIXED_SIZE</span>      18
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span>
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> typeCovered;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> alg; 
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> labels;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> origTTL;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> sigExpireTime;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> sigInceptTime;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> keyTag;
    <span class="enscript-type">char</span> signerName[256];
    <span class="enscript-comment">//unsigned char *signature
</span>} rdataRRSig;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RR_TYPE_SIZE</span> 16

<span class="enscript-type">typedef</span> <span class="enscript-type">union</span> { <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> b[2]; <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> NotAnInteger; } Opaque16;

<span class="enscript-type">static</span> <span class="enscript-type">int</span> operation;
<span class="enscript-type">static</span> uint32_t opinterface = kDNSServiceInterfaceIndexAny;
<span class="enscript-type">static</span> DNSServiceRef client    = NULL;
<span class="enscript-type">static</span> DNSServiceRef client_pa = NULL;  <span class="enscript-comment">// DNSServiceRef for RegisterProxyAddressRecord
</span><span class="enscript-type">static</span> DNSServiceRef sc1, sc2, sc3;     <span class="enscript-comment">// DNSServiceRefs for kDNSServiceFlagsShareConnection testing
</span>
<span class="enscript-type">static</span> <span class="enscript-type">int</span> num_printed;
<span class="enscript-type">static</span> <span class="enscript-type">char</span> addtest = 0;
<span class="enscript-type">static</span> DNSRecordRef record = NULL;
<span class="enscript-type">static</span> <span class="enscript-type">char</span> myhinfoW[14] = <span class="enscript-string">&quot;\002PC\012Windows XP&quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">char</span> myhinfoX[ 9] = <span class="enscript-string">&quot;\003Mac\004OS X&quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">char</span> updatetest[3] = <span class="enscript-string">&quot;\002AA&quot;</span>;
<span class="enscript-type">static</span> <span class="enscript-type">char</span> bigNULL[8192];  <span class="enscript-comment">// 8K is maximum rdata we support
</span>
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_DNS_SD_LIBDISPATCH</span>
dispatch_queue_t main_queue;
dispatch_source_t timer_source;
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">// Note: the select() implementation on Windows (Winsock2) fails with any timeout much larger than this
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LONG_TIME</span> 100000000

<span class="enscript-type">static</span> <span class="enscript-type">volatile</span> <span class="enscript-type">int</span> stopNow = 0;
<span class="enscript-type">static</span> <span class="enscript-type">volatile</span> <span class="enscript-type">int</span> timeOut = LONG_TIME;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_DNS_SD_LIBDISPATCH</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXIT_IF_LIBDISPATCH_FATAL_ERROR</span>(E) \
    if (main_queue &amp;&amp; (E) == kDNSServiceErr_ServiceNotRunning) { fprintf(stderr, <span class="enscript-string">&quot;Error code %d\n&quot;</span>, (E)); exit(0); }
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">EXIT_IF_LIBDISPATCH_FATAL_ERROR</span>(E)
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Supporting Utility Functions
</span><span class="enscript-type">static</span> uint16_t <span class="enscript-function-name">GetRRClass</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *s)   
{
    <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;IN&quot;</span>)) 
        <span class="enscript-keyword">return</span> kDNSServiceClass_IN;
    <span class="enscript-keyword">else</span>
        <span class="enscript-keyword">return</span>(atoi(s));
}     

<span class="enscript-type">static</span> uint16_t <span class="enscript-function-name">GetRRType</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *s)
{
    <span class="enscript-keyword">if</span>      (!strcasecmp(s, <span class="enscript-string">&quot;A&quot;</span>       )) <span class="enscript-keyword">return</span>(kDNSServiceType_A);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;NS&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_NS);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;MD&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_MD);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;MF&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_MF);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;CNAME&quot;</span>   )) <span class="enscript-keyword">return</span>(kDNSServiceType_CNAME);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;SOA&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_SOA);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;MB&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_MB);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;MG&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_MG);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;MR&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_MR);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;NULL&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_NULL);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;WKS&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_WKS);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;PTR&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_PTR);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;HINFO&quot;</span>   )) <span class="enscript-keyword">return</span>(kDNSServiceType_HINFO);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;MINFO&quot;</span>   )) <span class="enscript-keyword">return</span>(kDNSServiceType_MINFO);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;MX&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_MX);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;TXT&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_TXT);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;RP&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_RP);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;AFSDB&quot;</span>   )) <span class="enscript-keyword">return</span>(kDNSServiceType_AFSDB);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;X25&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_X25);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;ISDN&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_ISDN);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;RT&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_RT);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;NSAP&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_NSAP);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;NSAP_PTR&quot;</span>)) <span class="enscript-keyword">return</span>(kDNSServiceType_NSAP_PTR);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;SIG&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_SIG);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;KEY&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_KEY);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;PX&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_PX);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;GPOS&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_GPOS);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;AAAA&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_AAAA);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;LOC&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_LOC);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;NXT&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_NXT);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;EID&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_EID);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;NIMLOC&quot;</span>  )) <span class="enscript-keyword">return</span>(kDNSServiceType_NIMLOC);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;SRV&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_SRV);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;ATMA&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_ATMA);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;NAPTR&quot;</span>   )) <span class="enscript-keyword">return</span>(kDNSServiceType_NAPTR);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;KX&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_KX);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;CERT&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_CERT);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;A6&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_A6);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;DNAME&quot;</span>   )) <span class="enscript-keyword">return</span>(kDNSServiceType_DNAME);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;SINK&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_SINK);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;OPT&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_OPT);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;TKEY&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_TKEY);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;TSIG&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_TSIG);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;IXFR&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_IXFR);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;AXFR&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_AXFR);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;MAILB&quot;</span>   )) <span class="enscript-keyword">return</span>(kDNSServiceType_MAILB);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;MAILA&quot;</span>   )) <span class="enscript-keyword">return</span>(kDNSServiceType_MAILA);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;dnskey&quot;</span>  )) <span class="enscript-keyword">return</span>(kDNSServiceType_DNSKEY);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;ds&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceType_DS);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;rrsig&quot;</span>   )) <span class="enscript-keyword">return</span>(kDNSServiceType_RRSIG);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;nsec&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceType_NSEC);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;ANY&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceType_ANY);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">return</span>(atoi(s));
}

<span class="enscript-type">static</span> <span class="enscript-type">char</span> *<span class="enscript-function-name">DNSTypeName</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> rr_type)
{
    <span class="enscript-keyword">switch</span> (rr_type)
    {
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_A</span>:          <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;Addr&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NS</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;NS&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_MD</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;MD&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_MF</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;MF&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_CNAME</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;CNAME&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_SOA</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;SOA&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_MB</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;MB&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_MG</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;MG&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_MR</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;MR&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NULL</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;NULL&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_WKS</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;WKS&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_PTR</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;PTR&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_HINFO</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;HINFO&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_MINFO</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;MINFO&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_MX</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;MX&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_TXT</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;TXT&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_RP</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;RP&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_AFSDB</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;AFSDB&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_X25</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;X25&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_ISDN</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;ISDN&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_RT</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;RT&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NSAP</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;NSAP&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NSAP_PTR</span>:   <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;NSAP_PTR&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_SIG</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;SIG&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_KEY</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;KEY&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_PX</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;PX&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_GPOS</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;GPOS&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_AAAA</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;AAAA&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_LOC</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;LOC&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NXT</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;NXT&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_EID</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;EID&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NIMLOC</span>:     <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;NIMLOC&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_SRV</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;SRV&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_ATMA</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;ATMA&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NAPTR</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;NAPTR&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_KX</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;KX&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_CERT</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;CERT&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_A6</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;A6&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_DNAME</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;DNAME&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_SINK</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;SINK&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_OPT</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;OPT&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_APL</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;APL&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_DS</span>:         <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;DS&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_SSHFP</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;SSHFP&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_IPSECKEY</span>:   <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;IPSECKEY&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_RRSIG</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;RRSIG&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NSEC</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;NSEC&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_DNSKEY</span>:     <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;DNSKEY&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_DHCID</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;DHCID&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NSEC3</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;NSEC3&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NSEC3PARAM</span>: <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;NSEC3PARAM&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_HIP</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;HIP&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_SPF</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;SPF&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_UINFO</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;UINFO&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_UID</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;UID&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_GID</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;GID&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_UNSPEC</span>:     <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;UNSPEC&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_TKEY</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;TKEY&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_TSIG</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;TSIG&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_IXFR</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;IXFR&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_AXFR</span>:       <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;AXFR&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_MAILB</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;MAILB&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_MAILA</span>:      <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;MAILA&quot;</span>);
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_ANY</span>:        <span class="enscript-keyword">return</span>(<span class="enscript-string">&quot;ANY&quot;</span>);
        <span class="enscript-reference">default</span>:            
        {
            <span class="enscript-type">static</span> <span class="enscript-type">char</span> buffer[RR_TYPE_SIZE];
            snprintf(buffer, <span class="enscript-keyword">sizeof</span>(buffer), <span class="enscript-string">&quot;TYPE%d&quot;</span>, rr_type);
            <span class="enscript-keyword">return</span>(buffer);
        }
    }
}

<span class="enscript-type">static</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> <span class="enscript-function-name">swap16</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span> x)
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *ptr = (<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)&amp;x;
    <span class="enscript-keyword">return</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>)((<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>)ptr[0] &lt;&lt; 8 | ptr[1]);
}

<span class="enscript-type">static</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">swap32</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> x) 
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *ptr = (<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)&amp;x;
    <span class="enscript-keyword">return</span> (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>)((<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>)ptr[0] &lt;&lt; 24 | (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>)ptr[1] &lt;&lt; 16 | (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>)ptr[2] &lt;&lt; 8 | ptr[3]);
}
<span class="enscript-type">static</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> <span class="enscript-function-name">keytag</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *key, <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> keysize)  
{
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> ac;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;

    <span class="enscript-keyword">for</span> (ac = 0, i = 0; i &lt; keysize; ++i)
        ac += (i &amp; 1) ? key[i] : key[i] &lt;&lt; 8;
    ac += (ac &gt;&gt; 16) &amp; 0xFFFF;
    <span class="enscript-keyword">return</span> ac &amp; 0xFFFF;
}

<span class="enscript-comment">// Base 64 encoding according to &lt;<a href="https://tools.ietf.org/html/rfc4648#section-4">https://tools.ietf.org/html/rfc4648#section-4</a>&gt;.
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kBase64EncodingTable</span> <span class="enscript-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">base64Encode</span>(<span class="enscript-type">char</span> *buffer, size_t buflen, <span class="enscript-type">void</span> *rdata, size_t rdlen)
{
    <span class="enscript-type">const</span> uint8_t *src = (<span class="enscript-type">const</span> uint8_t *)rdata;
    <span class="enscript-type">const</span> uint8_t *<span class="enscript-type">const</span> end = &amp;src[rdlen];
    <span class="enscript-type">char</span> *dst = buffer;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *lim;

    <span class="enscript-keyword">if</span> (buflen == 0) <span class="enscript-keyword">return</span>;
    lim = &amp;buffer[buflen - 1];
    <span class="enscript-keyword">while</span> ((src &lt; end) &amp;&amp; (dst &lt; lim))
    {
        uint32_t i;
        <span class="enscript-type">const</span> size_t rem = (size_t)(end - src);

        <span class="enscript-comment">// Form a 24-bit input group. If less than 24 bits remain, pad with zero bits.
</span>        <span class="enscript-keyword">if</span> (     rem &gt;= 3) i = (src[0] &lt;&lt; 16) | (src[1] &lt;&lt; 8) | src[2]; <span class="enscript-comment">// 24 bits are equal to 4 6-bit groups.
</span>        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (rem == 2) i = (src[0] &lt;&lt; 16) | (src[1] &lt;&lt; 8);          <span class="enscript-comment">// 16 bits are treated as 3 6-bit groups + 1 pad
</span>        <span class="enscript-keyword">else</span>               i =  src[0] &lt;&lt; 16;                           <span class="enscript-comment">//  8 bits are treated as 2 6-bit groups + 2 pads
</span>
        <span class="enscript-comment">// Encode each 6-bit group.
</span>                       *dst++ =              kBase64EncodingTable[(i &gt;&gt; 18) &amp; 0x3F];
        <span class="enscript-keyword">if</span> (dst &lt; lim) *dst++ =              kBase64EncodingTable[(i &gt;&gt; 12) &amp; 0x3F];
        <span class="enscript-keyword">if</span> (dst &lt; lim) *dst++ = (rem &gt;= 2) ? kBase64EncodingTable[(i &gt;&gt;  6) &amp; 0x3F] : <span class="enscript-string">'='</span>;
        <span class="enscript-keyword">if</span> (dst &lt; lim) *dst++ = (rem &gt;= 3) ? kBase64EncodingTable[ i        &amp; 0x3F] : <span class="enscript-string">'='</span>;
        src += (rem &gt; 3) ? 3 : rem;
    }
    *dst = <span class="enscript-string">'\0'</span>;
}

<span class="enscript-type">static</span> DNSServiceProtocol <span class="enscript-function-name">GetProtocol</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *s)
{
    <span class="enscript-keyword">if</span>      (!strcasecmp(s, <span class="enscript-string">&quot;v4&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceProtocol_IPv4);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;v6&quot;</span>      )) <span class="enscript-keyword">return</span>(kDNSServiceProtocol_IPv6);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;v4v6&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceProtocol_IPv4 | kDNSServiceProtocol_IPv6);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;v6v4&quot;</span>    )) <span class="enscript-keyword">return</span>(kDNSServiceProtocol_IPv4 | kDNSServiceProtocol_IPv6);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;udp&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceProtocol_UDP);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;tcp&quot;</span>     )) <span class="enscript-keyword">return</span>(kDNSServiceProtocol_TCP);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;udptcp&quot;</span>  )) <span class="enscript-keyword">return</span>(kDNSServiceProtocol_UDP | kDNSServiceProtocol_TCP);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcasecmp(s, <span class="enscript-string">&quot;tcpudp&quot;</span>  )) <span class="enscript-keyword">return</span>(kDNSServiceProtocol_UDP | kDNSServiceProtocol_TCP);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">return</span>(atoi(s));
}


<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Sample callback functions for each of the operation types
</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">printtimestamp</span>() printtimestamp_F(stdout)

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">printtimestamp_F</span>(FILE *outstream)
{
    <span class="enscript-type">struct</span> tm tm;
    <span class="enscript-type">int</span> ms;
    <span class="enscript-type">static</span> <span class="enscript-type">char</span> date[16];
    <span class="enscript-type">static</span> <span class="enscript-type">char</span> new_date[16];
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_WIN32</span>
    SYSTEMTIME sysTime;
    time_t uct = time(NULL);
    tm = *localtime(&amp;uct);
    GetLocalTime(&amp;sysTime);
    ms = sysTime.wMilliseconds;
#<span class="enscript-reference">else</span>
    <span class="enscript-type">struct</span> timeval tv;
    gettimeofday(&amp;tv, NULL);
    localtime_r((time_t*)&amp;tv.tv_sec, &amp;tm);
    ms = tv.tv_usec/1000;
#<span class="enscript-reference">endif</span>
    strftime(new_date, <span class="enscript-keyword">sizeof</span>(new_date), <span class="enscript-string">&quot;%a %d %b %Y&quot;</span>, &amp;tm);
    <span class="enscript-keyword">if</span> (strncmp(date, new_date, <span class="enscript-keyword">sizeof</span>(new_date)))
    {
        fprintf(outstream, <span class="enscript-string">&quot;DATE: ---%s---\n&quot;</span>, new_date); <span class="enscript-comment">//display date only if it has changed
</span>        strncpy(date, new_date, <span class="enscript-keyword">sizeof</span>(date));
    }
    fprintf(outstream, <span class="enscript-string">&quot;%2d:%02d:%02d.%03d  &quot;</span>, tm.tm_hour, tm.tm_min, tm.tm_sec, ms);
}

<span class="enscript-comment">// formating time to RFC 4034 format
</span><span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">FormatTime</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> te, <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *buf, <span class="enscript-type">int</span> bufsize) 
{
    <span class="enscript-type">struct</span> tm tmTime;
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">_WIN32</span>
	__time32_t t = (__time32_t) te;
	_gmtime32_s(&amp;tmTime, &amp;t);
#<span class="enscript-reference">else</span>
    <span class="enscript-comment">// Time since epoch : strftime takes &quot;tm&quot;. Convert seconds to &quot;tm&quot; using
</span>    <span class="enscript-comment">// gmtime_r first and then use strftime
</span>	time_t t = (time_t)te;
	gmtime_r(&amp;t, &amp;tmTime);
#<span class="enscript-reference">endif</span>
    strftime((<span class="enscript-type">char</span> *)buf, bufsize, <span class="enscript-string">&quot;%Y%m%d%H%M%S&quot;</span>, &amp;tmTime);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">print_usage</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *arg0, <span class="enscript-type">int</span> print_all)
{
    <span class="enscript-comment">// Print the commonly used command line options.  These are listed in &quot;the order they have been in historically&quot;.
</span>    fprintf(stderr, <span class="enscript-string">&quot;%s -E                          (Enumerate recommended registration domains)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -F                          (Enumerate recommended browsing     domains)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -R &lt;Name&gt; &lt;Type&gt; &lt;Domain&gt; &lt;Port&gt; [&lt;TXT&gt;...]         (Register a service)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -P &lt;Name&gt; &lt;Type&gt; &lt;Domain&gt; &lt;Port&gt; &lt;Host&gt; &lt;IP&gt; [&lt;TXT&gt;...] (Register Proxy)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -B        &lt;Type&gt; &lt;Domain&gt;                 (Browse for service instances)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -Z        &lt;Type&gt; &lt;Domain&gt;           (Output results in Zone File format)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -L &lt;Name&gt; &lt;Type&gt; &lt;Domain&gt;        (Resolve (lookup) a service instance)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -Q &lt;name&gt; &lt;rrtype&gt; &lt;rrclass&gt;         (Generic query for any record type)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -q &lt;name&gt; &lt;rrtype&gt; &lt;rrclass&gt;     (Generic query, using SuppressUnusable)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -G v4/v6/v4v6 &lt;hostname&gt;          (Get address information for hostname)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -X udp/tcp/udptcp &lt;IntPort&gt; &lt;ExtPort&gt; &lt;TTL&gt;           (NAT Port Mapping)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -H                               (Print usage for complete command list)\n&quot;</span>, arg0);
    fprintf(stderr, <span class="enscript-string">&quot;%s -V            (Get version of currently running daemon / system service)\n&quot;</span>, arg0);
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>
    fprintf(stderr, <span class="enscript-string">&quot;%s -O [-compress|-stdout](Dump the state of mDNSResponder to file / STDOUT)\n&quot;</span>, arg0);
#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>

    <span class="enscript-keyword">if</span> (print_all)  <span class="enscript-comment">// Print all available options for dns-sd tool.  Keep these in alphabetical order for easier maintenance.
</span>    {
        fprintf(stderr, <span class="enscript-string">&quot;\n&quot;</span>);
        fprintf(stderr, <span class="enscript-string">&quot;%s -A                              (Test Adding/Updating/Deleting a record)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -C &lt;name&gt; &lt;rrtype&gt; &lt;rrclass&gt;           (Query; reconfirming each result)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -D &lt;name&gt; &lt;rrtype&gt; &lt;rrclass&gt;                (Validate query with DNSSEC)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -I           (Test registering and then immediately updating TXT record)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -N                                     (Test adding a large NULL record)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -M              (Test creating a registration with multiple TXT records)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -S                         (Test multiple operations on a shared socket)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -T                                    (Test creating a large TXT record)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -U                                          (Test updating a TXT record)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -ble                                  (Use kDNSServiceInterfaceIndexBLE)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -g v4/v6/v4v6 &lt;hostname&gt;             (Validate address info with DNSSEC)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -i &lt;Interface&gt;         (Run dns-sd cmd on a specific interface (en0/en1)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -includep2p                        (Set kDNSServiceFlagsIncludeP2P flag)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -includeAWDL                      (Set kDNSServiceFlagsIncludeAWDL flag)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -intermediates            (Set kDNSServiceFlagsReturnIntermediates flag)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -ku                               (Set kDNSServiceFlagsKnownUnique flag)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -lo                          (Run dns-sd cmd using local only interface)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -optional                    (Set kDNSServiceFlagsValidateOptional flag)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -p2p                                  (Use kDNSServiceInterfaceIndexP2P)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -tc                    (Set kDNSServiceFlagsBackgroundTrafficClass flag)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -test                                  (Run basic API input range tests)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -t1                              (Set kDNSServiceFlagsThresholdOne flag)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -tFinder                      (Set kDNSServiceFlagsThresholdFinder flag)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -timeout                              (Set kDNSServiceFlagsTimeout flag)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -unicastResponse              (Set kDNSServiceFlagsUnicastResponse flag)\n&quot;</span>, arg0);
        fprintf(stderr, <span class="enscript-string">&quot;%s -autoTrigger                      (Set kDNSServiceFlagsAutoTrigger flag)\n&quot;</span>, arg0);
    }
}

#<span class="enscript-reference">define</span> <span class="enscript-function-name">DomainMsg</span>(X) (((X) &amp;kDNSServiceFlagsDefault) ? <span class="enscript-string">&quot;(Default)&quot;</span> : \
                      ((X) &amp;kDNSServiceFlagsAdd)     ? <span class="enscript-string">&quot;Added&quot;</span>     : <span class="enscript-string">&quot;Removed&quot;</span>)

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_LABELS</span> 128

<span class="enscript-type">static</span> <span class="enscript-type">void</span> DNSSD_API <span class="enscript-function-name">enum_reply</span>(DNSServiceRef sdref, <span class="enscript-type">const</span> DNSServiceFlags flags, uint32_t ifIndex,
                                 DNSServiceErrorType errorCode, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *replyDomain, <span class="enscript-type">void</span> *context)
{
    DNSServiceFlags partialflags = flags &amp; ~(kDNSServiceFlagsMoreComing | kDNSServiceFlagsAdd | kDNSServiceFlagsDefault);
    <span class="enscript-type">int</span> labels = 0, depth = 0, i, initial = 0;
    <span class="enscript-type">char</span> text[64];
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *label[MAX_LABELS];

    (<span class="enscript-type">void</span>)sdref;        <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)ifIndex;      <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)context;      <span class="enscript-comment">// Unused
</span>    EXIT_IF_LIBDISPATCH_FATAL_ERROR(errorCode);

    <span class="enscript-comment">// 1. Print the header
</span>    <span class="enscript-keyword">if</span> (num_printed++ == 0) printf(<span class="enscript-string">&quot;Timestamp     Recommended %s domain\n&quot;</span>, operation == <span class="enscript-string">'E'</span> ? <span class="enscript-string">&quot;Registration&quot;</span> : <span class="enscript-string">&quot;Browsing&quot;</span>);
    printtimestamp();
    <span class="enscript-keyword">if</span> (errorCode)
        printf(<span class="enscript-string">&quot;Error code %d\n&quot;</span>, errorCode);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!*replyDomain)
        printf(<span class="enscript-string">&quot;Error: No reply domain\n&quot;</span>);
    <span class="enscript-keyword">else</span>
    {
        printf(<span class="enscript-string">&quot;%-10s&quot;</span>, DomainMsg(flags));
        printf(<span class="enscript-string">&quot;%-8s&quot;</span>, (flags &amp; kDNSServiceFlagsMoreComing) ? <span class="enscript-string">&quot;(More)&quot;</span> : <span class="enscript-string">&quot;&quot;</span>);
        <span class="enscript-keyword">if</span> (partialflags) printf(<span class="enscript-string">&quot;Flags: %4X  &quot;</span>, partialflags);
        <span class="enscript-keyword">else</span> printf(<span class="enscript-string">&quot;             &quot;</span>);

        <span class="enscript-comment">// 2. Count the labels
</span>        <span class="enscript-keyword">while</span> (replyDomain &amp;&amp; *replyDomain &amp;&amp; labels &lt; MAX_LABELS)
        {
            label[labels++] = replyDomain;
            replyDomain = GetNextLabel(replyDomain, text);
        }

        <span class="enscript-comment">// 3. Decide if we're going to clump the last two or three labels (e.g. &quot;apple.com&quot;, or &quot;nicta.com.au&quot;)
</span>        <span class="enscript-keyword">if</span>      (labels &gt;= 3 &amp;&amp; replyDomain - label[labels-1] &lt;= 3 &amp;&amp; label[labels-1] - label[labels-2] &lt;= 4) initial = 3;
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (labels &gt;= 2 &amp;&amp; replyDomain - label[labels-1] &lt;= 4) initial = 2;
        <span class="enscript-keyword">else</span> initial = 1;
        labels -= initial;

        <span class="enscript-comment">// 4. Print the initial one-, two- or three-label clump
</span>        <span class="enscript-keyword">for</span> (i=0; i&lt;initial; i++)
        {
            GetNextLabel(label[labels+i], text);
            <span class="enscript-keyword">if</span> (i&gt;0) printf(<span class="enscript-string">&quot;.&quot;</span>);
            printf(<span class="enscript-string">&quot;%s&quot;</span>, text);
        }
        printf(<span class="enscript-string">&quot;\n&quot;</span>);

        <span class="enscript-comment">// 5. Print the remainder of the hierarchy
</span>        <span class="enscript-keyword">for</span> (depth=0; depth&lt;labels; depth++)
        {
            printf(<span class="enscript-string">&quot;                                             &quot;</span>);
            <span class="enscript-keyword">for</span> (i=0; i&lt;=depth; i++) printf(<span class="enscript-string">&quot;- &quot;</span>);
            GetNextLabel(label[labels-1-depth], text);
            printf(<span class="enscript-string">&quot;&gt; %s\n&quot;</span>, text);
        }
    }

    <span class="enscript-keyword">if</span> (!(flags &amp; kDNSServiceFlagsMoreComing)) fflush(stdout);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">CopyLabels</span>(<span class="enscript-type">char</span> *dst, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *lim, <span class="enscript-type">const</span> <span class="enscript-type">char</span> **srcp, <span class="enscript-type">int</span> labels)
{
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *src = *srcp;
    <span class="enscript-keyword">while</span> (*src != <span class="enscript-string">'.'</span> || --labels &gt; 0)
    {
        <span class="enscript-keyword">if</span> (*src == <span class="enscript-string">'\\'</span>) *dst++ = *src++;  <span class="enscript-comment">// Make sure &quot;\.&quot; doesn't confuse us
</span>        <span class="enscript-keyword">if</span> (!*src || dst &gt;= lim) <span class="enscript-keyword">return</span> -1;
        *dst++ = *src++;
        <span class="enscript-keyword">if</span> (!*src || dst &gt;= lim) <span class="enscript-keyword">return</span> -1;
    }
    *dst++ = 0;
    *srcp = src + 1;    <span class="enscript-comment">// skip over final dot
</span>    <span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> DNSSD_API <span class="enscript-function-name">zonedata_resolve</span>(DNSServiceRef sdref, <span class="enscript-type">const</span> DNSServiceFlags flags, uint32_t ifIndex, DNSServiceErrorType errorCode,
                                       <span class="enscript-type">const</span> <span class="enscript-type">char</span> *fullname, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *hosttarget, uint16_t opaqueport, uint16_t txtLen, <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *txt, <span class="enscript-type">void</span> *context)
{
    <span class="enscript-type">union</span> { uint16_t s; u_char b[2]; } port = { opaqueport };
    uint16_t PortAsNumber = ((uint16_t)port.b[0]) &lt;&lt; 8 | port.b[1];

    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *p = fullname;
    <span class="enscript-type">char</span> n[kDNSServiceMaxDomainName];
    <span class="enscript-type">char</span> t[kDNSServiceMaxDomainName];

    <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *max = txt + txtLen;

    (<span class="enscript-type">void</span>)sdref;        <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)ifIndex;      <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)context;      <span class="enscript-comment">// Unused
</span>
    <span class="enscript-comment">//if (!(flags &amp; kDNSServiceFlagsAdd)) return;
</span>    <span class="enscript-keyword">if</span> (errorCode) { printf(<span class="enscript-string">&quot;Error code %d\n&quot;</span>, errorCode); <span class="enscript-keyword">return</span>; }

    <span class="enscript-keyword">if</span> (CopyLabels(n, n + kDNSServiceMaxDomainName, &amp;p, 3)) <span class="enscript-keyword">return</span>;     <span class="enscript-comment">// Fetch name+type
</span>    p = fullname;
    <span class="enscript-keyword">if</span> (CopyLabels(t, t + kDNSServiceMaxDomainName, &amp;p, 1)) <span class="enscript-keyword">return</span>;     <span class="enscript-comment">// Skip first label
</span>    <span class="enscript-keyword">if</span> (CopyLabels(t, t + kDNSServiceMaxDomainName, &amp;p, 2)) <span class="enscript-keyword">return</span>;     <span class="enscript-comment">// Fetch next two labels (service type)
</span>
    <span class="enscript-keyword">if</span> (num_printed++ == 0)
    {
        printf(<span class="enscript-string">&quot;\n&quot;</span>);
        printf(<span class="enscript-string">&quot;; To direct clients to browse a different domain, substitute that domain in place of '@'\n&quot;</span>);
        printf(<span class="enscript-string">&quot;%-47s PTR     %s\n&quot;</span>, <span class="enscript-string">&quot;lb._dns-sd._udp&quot;</span>, <span class="enscript-string">&quot;@&quot;</span>);
        printf(<span class="enscript-string">&quot;\n&quot;</span>);
        printf(<span class="enscript-string">&quot;; In the list of services below, the SRV records will typically reference dot-local Multicast DNS names.\n&quot;</span>);
        printf(<span class="enscript-string">&quot;; When transferring this zone file data to your unicast DNS server, you'll need to replace those dot-local\n&quot;</span>);
        printf(<span class="enscript-string">&quot;; names with the correct fully-qualified (unicast) domain name of the target host offering the service.\n&quot;</span>);
    }

    printf(<span class="enscript-string">&quot;\n&quot;</span>);
    printf(<span class="enscript-string">&quot;%-47s PTR     %s\n&quot;</span>, t, n);
    printf(<span class="enscript-string">&quot;%-47s SRV     0 0 %d %s ; Replace with unicast FQDN of target host\n&quot;</span>, n, PortAsNumber, hosttarget);
    printf(<span class="enscript-string">&quot;%-47s TXT    &quot;</span>, n);

    <span class="enscript-keyword">while</span> (txt &lt; max)
    {
        <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *<span class="enscript-type">const</span> end = txt + 1 + txt[0];
        txt++;      <span class="enscript-comment">// Skip over length byte
</span>        printf(<span class="enscript-string">&quot; \&quot;&quot;</span>);
        <span class="enscript-keyword">while</span> (txt&lt;end)
        {
            <span class="enscript-keyword">if</span> (*txt == <span class="enscript-string">'\\'</span> || *txt == <span class="enscript-string">'\&quot;'</span>) printf(<span class="enscript-string">&quot;\\&quot;</span>);
            printf(<span class="enscript-string">&quot;%c&quot;</span>, *txt++);
        }
        printf(<span class="enscript-string">&quot;\&quot;&quot;</span>);
    }
    printf(<span class="enscript-string">&quot;\n&quot;</span>);

    DNSServiceRefDeallocate(sdref);
    free(context);

    <span class="enscript-keyword">if</span> (!(flags &amp; kDNSServiceFlagsMoreComing)) fflush(stdout);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> DNSSD_API <span class="enscript-function-name">zonedata_browse</span>(DNSServiceRef sdref, <span class="enscript-type">const</span> DNSServiceFlags flags, uint32_t ifIndex, DNSServiceErrorType errorCode,
                                      <span class="enscript-type">const</span> <span class="enscript-type">char</span> *replyName, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *replyType, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *replyDomain, <span class="enscript-type">void</span> *context)
{
    DNSServiceRef *newref;

    (<span class="enscript-type">void</span>)sdref;        <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)context;      <span class="enscript-comment">// Unused
</span>    EXIT_IF_LIBDISPATCH_FATAL_ERROR(errorCode);

    <span class="enscript-keyword">if</span> (!(flags &amp; kDNSServiceFlagsAdd)) <span class="enscript-keyword">return</span>;
    <span class="enscript-keyword">if</span> (errorCode) { printf(<span class="enscript-string">&quot;Error code %d\n&quot;</span>, errorCode); <span class="enscript-keyword">return</span>; }

    newref = malloc(<span class="enscript-keyword">sizeof</span>(*newref));
    *newref = client;
    DNSServiceResolve(newref, kDNSServiceFlagsShareConnection, ifIndex, replyName, replyType, replyDomain, zonedata_resolve, newref);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> DNSSD_API <span class="enscript-function-name">browse_reply</span>(DNSServiceRef sdref, <span class="enscript-type">const</span> DNSServiceFlags flags, uint32_t ifIndex, DNSServiceErrorType errorCode,
                                   <span class="enscript-type">const</span> <span class="enscript-type">char</span> *replyName, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *replyType, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *replyDomain, <span class="enscript-type">void</span> *context)
{
    <span class="enscript-type">char</span> *op = (flags &amp; kDNSServiceFlagsAdd) ? <span class="enscript-string">&quot;Add&quot;</span> : <span class="enscript-string">&quot;Rmv&quot;</span>;
    (<span class="enscript-type">void</span>)sdref;        <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)context;      <span class="enscript-comment">// Unused
</span>    EXIT_IF_LIBDISPATCH_FATAL_ERROR(errorCode);

    <span class="enscript-keyword">if</span> (num_printed++ == 0) printf(<span class="enscript-string">&quot;Timestamp     A/R    Flags  if %-20s %-20s %s\n&quot;</span>, <span class="enscript-string">&quot;Domain&quot;</span>, <span class="enscript-string">&quot;Service Type&quot;</span>, <span class="enscript-string">&quot;Instance Name&quot;</span>);
    printtimestamp();
    <span class="enscript-keyword">if</span> (errorCode) 
        printf(<span class="enscript-string">&quot;Error code %d\n&quot;</span>, errorCode);
    <span class="enscript-keyword">else</span> 
        printf(<span class="enscript-string">&quot;%s %8X %3d %-20s %-20s %s\n&quot;</span>, 
                op, flags, ifIndex, replyDomain, replyType, replyName);
    <span class="enscript-keyword">if</span> (!(flags &amp; kDNSServiceFlagsMoreComing)) fflush(stdout);

    <span class="enscript-comment">// To test selective cancellation of operations of shared sockets,
</span>    <span class="enscript-comment">// cancel the current operation when we've got a multiple of five results
</span>    <span class="enscript-comment">//if (operation == 'S' &amp;&amp; num_printed % 5 == 0) DNSServiceRefDeallocate(sdref);
</span>}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ShowTXTRecord</span>(uint16_t txtLen, <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *txtRecord)
{
    <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *ptr = txtRecord;
    <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *max = txtRecord + txtLen;
    <span class="enscript-keyword">while</span> (ptr &lt; max)
    {
        <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *<span class="enscript-type">const</span> end = ptr + 1 + ptr[0];
        <span class="enscript-keyword">if</span> (end &gt; max) { printf(<span class="enscript-string">&quot;&lt;&lt; invalid data &gt;&gt;&quot;</span>); <span class="enscript-keyword">break</span>; }
        <span class="enscript-keyword">if</span> (++ptr &lt; end) printf(<span class="enscript-string">&quot; &quot;</span>);   <span class="enscript-comment">// As long as string is non-empty, begin with a space
</span>        <span class="enscript-keyword">while</span> (ptr&lt;end)
        {
            <span class="enscript-comment">// We'd like the output to be shell-friendly, so that it can be copied and pasted unchanged into a &quot;dns-sd -R&quot; command.
</span>            <span class="enscript-comment">// However, this is trickier than it seems. Enclosing a string in double quotes doesn't necessarily make it
</span>            <span class="enscript-comment">// shell-safe, because shells still expand variables like $foo even when they appear inside quoted strings.
</span>            <span class="enscript-comment">// Enclosing a string in single quotes is better, but when using single quotes even backslash escapes are ignored,
</span>            <span class="enscript-comment">// meaning there's simply no way to represent a single quote (or apostrophe) inside a single-quoted string.
</span>            <span class="enscript-comment">// The only remaining solution is not to surround the string with quotes at all, but instead to use backslash
</span>            <span class="enscript-comment">// escapes to encode spaces and all other known shell metacharacters.
</span>            <span class="enscript-comment">// (If we've missed any known shell metacharacters, please let us know.)
</span>            <span class="enscript-comment">// In addition, non-printing ascii codes (0-31) are displayed as \xHH, using a two-digit hex value.
</span>            <span class="enscript-comment">// Because '\' is itself a shell metacharacter (the shell escape character), it has to be escaped as &quot;\\&quot; to survive
</span>            <span class="enscript-comment">// the round-trip to the shell and back. This means that a single '\' is represented here as EIGHT backslashes:
</span>            <span class="enscript-comment">// The C compiler eats half of them, resulting in four appearing in the output.
</span>            <span class="enscript-comment">// The shell parses those four as a pair of &quot;\\&quot; sequences, passing two backslashes to the &quot;dns-sd -R&quot; command.
</span>            <span class="enscript-comment">// The &quot;dns-sd -R&quot; command interprets this single &quot;\\&quot; pair as an escaped literal backslash. Sigh.
</span>            <span class="enscript-keyword">if</span> (strchr(<span class="enscript-string">&quot; &amp;;`'\&quot;|*?~&lt;&gt;^()[]{}$&quot;</span>, *ptr)) printf(<span class="enscript-string">&quot;\\&quot;</span>);
            <span class="enscript-keyword">if</span>      (*ptr == <span class="enscript-string">'\\'</span>) printf(<span class="enscript-string">&quot;\\\\\\\\&quot;</span>);
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (*ptr &gt;= <span class="enscript-string">' '</span> ) printf(<span class="enscript-string">&quot;%c&quot;</span>,        *ptr);
            <span class="enscript-keyword">else</span> printf(<span class="enscript-string">&quot;\\\\x%02X&quot;</span>, *ptr);
            ptr++;
        }
    }
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> DNSSD_API <span class="enscript-function-name">resolve_reply</span>(DNSServiceRef sdref, <span class="enscript-type">const</span> DNSServiceFlags flags, uint32_t ifIndex, DNSServiceErrorType errorCode,
                                    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *fullname, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *hosttarget, uint16_t opaqueport, uint16_t txtLen, <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *txtRecord, <span class="enscript-type">void</span> *context)
{
    <span class="enscript-type">union</span> { uint16_t s; u_char b[2]; } port = { opaqueport };
    uint16_t PortAsNumber = ((uint16_t)port.b[0]) &lt;&lt; 8 | port.b[1];

    (<span class="enscript-type">void</span>)sdref;        <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)ifIndex;      <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)context;      <span class="enscript-comment">// Unused
</span>    EXIT_IF_LIBDISPATCH_FATAL_ERROR(errorCode);

    printtimestamp();

    printf(<span class="enscript-string">&quot;%s &quot;</span>, fullname);

    <span class="enscript-keyword">if</span> (errorCode == kDNSServiceErr_NoSuchRecord) printf(<span class="enscript-string">&quot;No Such Record&quot;</span>);
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (errorCode) printf(<span class="enscript-string">&quot;error code %d\n&quot;</span>, errorCode);
    <span class="enscript-keyword">else</span> printf(<span class="enscript-string">&quot;can be reached at %s:%u (interface %d)&quot;</span>, hosttarget, PortAsNumber, ifIndex);

    <span class="enscript-keyword">if</span> (flags) printf(<span class="enscript-string">&quot; Flags: %X&quot;</span>, flags);

    <span class="enscript-comment">// Don't show degenerate TXT records containing nothing but a single empty string
</span>    <span class="enscript-keyword">if</span> (!errorCode &amp;&amp; txtLen &gt; 1) { printf(<span class="enscript-string">&quot;\n&quot;</span>); ShowTXTRecord(txtLen, txtRecord); }

    printf(<span class="enscript-string">&quot;\n&quot;</span>);

    <span class="enscript-keyword">if</span> (!(flags &amp; kDNSServiceFlagsMoreComing)) fflush(stdout);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">myTimerCallBack</span>(<span class="enscript-type">void</span>)
{
    DNSServiceErrorType err = kDNSServiceErr_Unknown;

    <span class="enscript-keyword">switch</span> (operation)
    {
    <span class="enscript-keyword">case</span> <span class="enscript-string">'A'</span>:
    {
        <span class="enscript-keyword">switch</span> (addtest)
        {
        <span class="enscript-keyword">case</span> <span class="enscript-reference">0</span>: printf(<span class="enscript-string">&quot;Adding Test HINFO record\n&quot;</span>);
            err = DNSServiceAddRecord(client, &amp;record, 0, kDNSServiceType_HINFO, <span class="enscript-keyword">sizeof</span>(myhinfoW), &amp;myhinfoW[0], 0);
            addtest = 1;
            <span class="enscript-keyword">break</span>;
        <span class="enscript-keyword">case</span> <span class="enscript-reference">1</span>: printf(<span class="enscript-string">&quot;Updating Test HINFO record\n&quot;</span>);
            err = DNSServiceUpdateRecord(client, record, 0, <span class="enscript-keyword">sizeof</span>(myhinfoX), &amp;myhinfoX[0], 0);
            addtest = 2;
            <span class="enscript-keyword">break</span>;
        <span class="enscript-keyword">case</span> <span class="enscript-reference">2</span>: printf(<span class="enscript-string">&quot;Removing Test HINFO record\n&quot;</span>);
            err = DNSServiceRemoveRecord(client, record, 0);
            addtest = 0;
            <span class="enscript-keyword">break</span>;
        }
    }
    <span class="enscript-keyword">break</span>;

    <span class="enscript-keyword">case</span> <span class="enscript-string">'U'</span>:
    {
        <span class="enscript-keyword">if</span> (updatetest[1] != <span class="enscript-string">'Z'</span>) updatetest[1]++;
        <span class="enscript-keyword">else</span> updatetest[1] = <span class="enscript-string">'A'</span>;
        <span class="enscript-comment">// The following line toggles the string length between 1 and 2 characters.
</span>        updatetest[0] = 3 - updatetest[0];
        updatetest[2] = updatetest[1];
        printtimestamp();
        printf(<span class="enscript-string">&quot;Updating Test TXT record to %c\n&quot;</span>, updatetest[1]);
        err = DNSServiceUpdateRecord(client, NULL, 0, 1+updatetest[0], &amp;updatetest[0], 0);
    }
    <span class="enscript-keyword">break</span>;

    <span class="enscript-keyword">case</span> <span class="enscript-string">'N'</span>:
    {
        printf(<span class="enscript-string">&quot;Adding big NULL record\n&quot;</span>);
        err = DNSServiceAddRecord(client, &amp;record, 0, kDNSServiceType_NULL, <span class="enscript-keyword">sizeof</span>(bigNULL), &amp;bigNULL[0], 0);
        <span class="enscript-keyword">if</span> (err) printf(<span class="enscript-string">&quot;Failed: %d\n&quot;</span>, err);<span class="enscript-keyword">else</span> printf(<span class="enscript-string">&quot;Succeeded\n&quot;</span>);
        timeOut = LONG_TIME;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_DNS_SD_LIBDISPATCH</span>
        <span class="enscript-keyword">if</span> (timer_source)
            dispatch_source_set_timer(timer_source, dispatch_time(DISPATCH_TIME_NOW, (uint64_t)timeOut * NSEC_PER_SEC),
                                      (uint64_t)timeOut * NSEC_PER_SEC, 0);
#<span class="enscript-reference">endif</span>
    }
    <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">if</span> (err != kDNSServiceErr_NoError)
    {
        fprintf(stderr, <span class="enscript-string">&quot;DNSService add/update/remove failed %ld\n&quot;</span>, (<span class="enscript-type">long</span> <span class="enscript-type">int</span>)err);
        stopNow = 1;
    }
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> DNSSD_API <span class="enscript-function-name">reg_reply</span>(DNSServiceRef sdref, <span class="enscript-type">const</span> DNSServiceFlags flags, DNSServiceErrorType errorCode,
                                <span class="enscript-type">const</span> <span class="enscript-type">char</span> *name, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *regtype, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *domain, <span class="enscript-type">void</span> *context)
{
    (<span class="enscript-type">void</span>)sdref;    <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)flags;    <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)context;  <span class="enscript-comment">// Unused
</span>    EXIT_IF_LIBDISPATCH_FATAL_ERROR(errorCode);

    printtimestamp();
    printf(<span class="enscript-string">&quot;Got a reply for service %s.%s%s: &quot;</span>, name, regtype, domain);

    <span class="enscript-keyword">if</span> (errorCode == kDNSServiceErr_NoError)
    {
        <span class="enscript-keyword">if</span> (flags &amp; kDNSServiceFlagsAdd) printf(<span class="enscript-string">&quot;Name now registered and active\n&quot;</span>);
        <span class="enscript-keyword">else</span> printf(<span class="enscript-string">&quot;Name registration removed\n&quot;</span>);
        <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'A'</span> || operation == <span class="enscript-string">'U'</span> || operation == <span class="enscript-string">'N'</span>)
        {
            timeOut = 5;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_DNS_SD_LIBDISPATCH</span>
            <span class="enscript-keyword">if</span> (timer_source)
                dispatch_source_set_timer(timer_source, dispatch_time(DISPATCH_TIME_NOW, (uint64_t)timeOut * NSEC_PER_SEC),
                                          (uint64_t)timeOut * NSEC_PER_SEC, 0);
#<span class="enscript-reference">endif</span>
        }
    }
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (errorCode == kDNSServiceErr_NameConflict)
    {
        printf(<span class="enscript-string">&quot;Name in use, please choose another\n&quot;</span>);
        exit(-1);
    }
    <span class="enscript-keyword">else</span>
        printf(<span class="enscript-string">&quot;Error %d\n&quot;</span>, errorCode);

    <span class="enscript-keyword">if</span> (!(flags &amp; kDNSServiceFlagsMoreComing)) fflush(stdout);
}

<span class="enscript-comment">// Output the wire-format domainname pointed to by rd
</span><span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">snprintd</span>(<span class="enscript-type">char</span> *p, <span class="enscript-type">int</span> max, <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> **rd)
{
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-type">const</span> buf = p;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-type">const</span> end = p + max;
    <span class="enscript-keyword">while</span> (**rd) 
    { 
        p += snprintf(p, end-p, <span class="enscript-string">&quot;%.*s.&quot;</span>, **rd, *rd+1); 
        *rd += 1 + **rd; 
    }
    *rd += 1;   <span class="enscript-comment">// Advance over the final zero byte
</span>    <span class="enscript-keyword">return</span>(p-buf);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ParseDNSSECRecords</span>(uint16_t rrtype, <span class="enscript-type">char</span> *rdb, size_t rdb_size, <span class="enscript-type">unsigned</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> *rd, uint16_t rdlen)
{
    <span class="enscript-type">char</span> *p = rdb;
    <span class="enscript-keyword">switch</span> (rrtype) 
    {
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_DS</span>:
        {
            <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *ptr;
            <span class="enscript-type">int</span> i;
            rdataDS *rrds = (rdataDS *)rd;
            p += snprintf(p, rdb + rdb_size - p, <span class="enscript-string">&quot;%d  %d  %d  &quot;</span>,
                          rrds-&gt;alg, swap16(rrds-&gt;keyTag), rrds-&gt;digestType);
            ptr = (<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)(rd + DS_FIXED_SIZE);
            <span class="enscript-keyword">for</span> (i = 0; i &lt; (rdlen - DS_FIXED_SIZE); i++)
                p += snprintf(p, rdb + rdb_size - p, <span class="enscript-string">&quot;%x&quot;</span>, ptr[i]);   
            <span class="enscript-keyword">break</span>; 
        } 
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_DNSKEY</span>:
        {
            rdataDNSKey *rrkey = (rdataDNSKey *)rd;
            p += snprintf(p, rdb + rdb_size - p, <span class="enscript-string">&quot;%d  %d  %d  %u &quot;</span>, swap16(rrkey-&gt;flags), rrkey-&gt;proto,
                          rrkey-&gt;alg, (<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>)keytag((<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)rrkey, rdlen));
            base64Encode(p, rdb + rdb_size - p, (<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)(rd + DNSKEY_FIXED_SIZE), rdlen - DNSKEY_FIXED_SIZE);
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NSEC</span>: 
        {
            <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *next = (<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)rd;
            <span class="enscript-type">int</span> len, bitmaplen;
            <span class="enscript-type">int</span> win, wlen, type;
            <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *bmap;
            <span class="enscript-type">char</span> *l = NULL;
            
            l = p;
            p += snprintd(p, rdb + rdb_size - p, &amp;rd);
            len = p - l + 1;
            
            bitmaplen = rdlen - len;
            bmap = (<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)((<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)next + len);
            
            <span class="enscript-keyword">while</span> (bitmaplen &gt; 0)
            {
                <span class="enscript-type">int</span> i;
                
                <span class="enscript-keyword">if</span> (bitmaplen &lt; 3)
                {
                    printf(<span class="enscript-string">&quot;Case NSEC: malformed nsec, bitmaplen %d short\n&quot;</span>, bitmaplen);
                    <span class="enscript-keyword">break</span>;
                }   
                
                win = *bmap++;
                wlen = *bmap++;
                bitmaplen -= 2;
                <span class="enscript-keyword">if</span> (bitmaplen &lt; wlen || wlen &lt; 1 || wlen &gt; 32)
                {
                    printf(<span class="enscript-string">&quot;Case NSEC: malformed nsec, bitmaplen %d wlen %d\n&quot;</span>, bitmaplen, wlen);
                    <span class="enscript-keyword">break</span>;
                }
                <span class="enscript-keyword">if</span> (win &lt; 0 || win &gt;= 256)
                {
                    printf(<span class="enscript-string">&quot;Case NSEC: malformed nsec, bad window win %d\n&quot;</span>, win);
                    <span class="enscript-keyword">break</span>;
                }
                type = win * 256;
                <span class="enscript-keyword">for</span> (i = 0; i &lt; wlen * 8; i++)
                {
                    <span class="enscript-keyword">if</span> (bmap[i&gt;&gt;3] &amp; (128 &gt;&gt; (i&amp;7)))
                        p += snprintf(p, rdb + rdb_size - p, <span class="enscript-string">&quot; %s &quot;</span>, DNSTypeName(type + i));
                }
                bmap += wlen;
                bitmaplen -= wlen;
            }
            <span class="enscript-keyword">break</span>;
        }
            
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_RRSIG</span>:    
        {
            rdataRRSig *rrsig = (rdataRRSig *)rd;
            <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> expTimeBuf[64];
            <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> inceptTimeBuf[64];
            <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> inceptClock;
            <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> expClock;
            <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *q = NULL;
            <span class="enscript-type">char</span> *k = NULL;
            <span class="enscript-type">int</span> len;
            
            expClock = (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>)swap32(rrsig-&gt;sigExpireTime);
            FormatTime(expClock, expTimeBuf, <span class="enscript-keyword">sizeof</span>(expTimeBuf));
            
            inceptClock = (<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>)swap32(rrsig-&gt;sigInceptTime);
            FormatTime(inceptClock, inceptTimeBuf, <span class="enscript-keyword">sizeof</span>(inceptTimeBuf));
            
            p += snprintf(p, rdb + rdb_size - p, <span class="enscript-string">&quot; %-7s  %d  %d  %d  %s  %s  %7d  &quot;</span>,
                          DNSTypeName(swap16(rrsig-&gt;typeCovered)), rrsig-&gt;alg, rrsig-&gt;labels, swap32(rrsig-&gt;origTTL),
                          expTimeBuf, inceptTimeBuf, swap16(rrsig-&gt;keyTag));
            
            q = (<span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)&amp;rrsig-&gt;signerName;
            k = p;
            p += snprintd(p, rdb + rdb_size - p, &amp;q);
            len = p - k + 1;
            
            <span class="enscript-keyword">if</span> ((&amp;rdb[rdb_size] - p) &gt;= 2)
            {
                *p++ = <span class="enscript-string">' '</span>;
                *p   = <span class="enscript-string">'\0'</span>;
            }
            base64Encode(p, rdb + rdb_size - p, (<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)(rd + len + RRSIG_FIXED_SIZE), rdlen - (len + RRSIG_FIXED_SIZE));
            <span class="enscript-keyword">break</span>;
        }
    }
    <span class="enscript-keyword">return</span>;                           
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> DNSSD_API <span class="enscript-function-name">qr_reply</span>(DNSServiceRef sdref, <span class="enscript-type">const</span> DNSServiceFlags flags, uint32_t ifIndex, DNSServiceErrorType errorCode,
                               <span class="enscript-type">const</span> <span class="enscript-type">char</span> *fullname, uint16_t rrtype, uint16_t rrclass, uint16_t rdlen, <span class="enscript-type">const</span> <span class="enscript-type">void</span> *rdata, uint32_t ttl, <span class="enscript-type">void</span> *context)
{
    <span class="enscript-type">char</span> *op = (flags &amp; kDNSServiceFlagsAdd) ? <span class="enscript-string">&quot;Add&quot;</span> : <span class="enscript-string">&quot;Rmv&quot;</span>;
    <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *rd  = rdata;
    <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *end = (<span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *) rdata + rdlen;
    <span class="enscript-type">char</span> rdb[1000] = <span class="enscript-string">&quot;0.0.0.0&quot;</span>, *p = rdb;
    <span class="enscript-type">int</span> unknowntype = 0;
    <span class="enscript-type">char</span> dnssec_status[15] = <span class="enscript-string">&quot;Unknown&quot;</span>;
    <span class="enscript-type">char</span> rr_type[RR_TYPE_SIZE];
    <span class="enscript-type">char</span> rr_class[6];
    DNSServiceFlags check_flags = flags;<span class="enscript-comment">//local flags for dnssec status checking
</span>
    (<span class="enscript-type">void</span>)sdref;    <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)ifIndex;  <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)ttl;      <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)context;  <span class="enscript-comment">// Unused
</span>    EXIT_IF_LIBDISPATCH_FATAL_ERROR(errorCode);

    <span class="enscript-keyword">if</span> (num_printed++ == 0)
    {
        <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'D'</span>) 
            printf(<span class="enscript-string">&quot;Timestamp     A/R if %-30s%-6s%-7s%-18s Rdata\n&quot;</span>, <span class="enscript-string">&quot;Name&quot;</span>, <span class="enscript-string">&quot;Type&quot;</span>, <span class="enscript-string">&quot;Class&quot;</span>, <span class="enscript-string">&quot;DNSSECStatus&quot;</span>); 
        <span class="enscript-keyword">else</span>     
            printf(<span class="enscript-string">&quot;Timestamp     A/R    Flags if %-30s%-6s%-7s Rdata\n&quot;</span>, <span class="enscript-string">&quot;Name&quot;</span>, <span class="enscript-string">&quot;Type&quot;</span>, <span class="enscript-string">&quot;Class&quot;</span>);
    }
    printtimestamp();

    <span class="enscript-keyword">switch</span> (rrclass)
    {
        <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceClass_IN</span>:
            strncpy(rr_class, <span class="enscript-string">&quot;IN&quot;</span>, <span class="enscript-keyword">sizeof</span>(rr_class));
            <span class="enscript-keyword">break</span>;
        <span class="enscript-reference">default</span>:
            snprintf(rr_class, <span class="enscript-keyword">sizeof</span>(rr_class), <span class="enscript-string">&quot;%d&quot;</span>, rrclass);
            <span class="enscript-keyword">break</span>;
    }
    strncpy(rr_type, DNSTypeName(rrtype), <span class="enscript-keyword">sizeof</span>(rr_type));

    <span class="enscript-keyword">if</span> (!errorCode) <span class="enscript-comment">//to avoid printing garbage in rdata
</span>    {
        <span class="enscript-keyword">if</span> (!(check_flags &amp; (kDNSServiceFlagsValidate | kDNSServiceFlagsValidateOptional)))
        {
            <span class="enscript-keyword">switch</span> (rrtype)
            {
                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_A</span>:
                    snprintf(rdb, <span class="enscript-keyword">sizeof</span>(rdb), <span class="enscript-string">&quot;%d.%d.%d.%d&quot;</span>, rd[0], rd[1], rd[2], rd[3]);
                    <span class="enscript-keyword">break</span>;
    
                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NS</span>:
                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_CNAME</span>:
                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_PTR</span>:
                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_DNAME</span>:
                    snprintd(p, <span class="enscript-keyword">sizeof</span>(rdb), &amp;rd);
                    <span class="enscript-keyword">break</span>;

                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_SOA</span>:
                    p += snprintd(p, rdb + <span class="enscript-keyword">sizeof</span>(rdb) - p, &amp;rd);           <span class="enscript-comment">// mname
</span>                    p += snprintf(p, rdb + <span class="enscript-keyword">sizeof</span>(rdb) - p, <span class="enscript-string">&quot; &quot;</span>);
                    p += snprintd(p, rdb + <span class="enscript-keyword">sizeof</span>(rdb) - p, &amp;rd);           <span class="enscript-comment">// rname
</span>                         snprintf(p, rdb + <span class="enscript-keyword">sizeof</span>(rdb) - p, <span class="enscript-string">&quot; Ser %d Ref %d Ret %d Exp %d Min %d&quot;</span>,
                             ntohl(((uint32_t*)rd)[0]), ntohl(((uint32_t*)rd)[1]), ntohl(((uint32_t*)rd)[2]), ntohl(((uint32_t*)rd)[3]), ntohl(((uint32_t*)rd)[4]));
                    <span class="enscript-keyword">break</span>;

                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_AAAA</span>:
                    snprintf(rdb, <span class="enscript-keyword">sizeof</span>(rdb), <span class="enscript-string">&quot;%02X%02X:%02X%02X:%02X%02X:%02X%02X:%02X%02X:%02X%02X:%02X%02X:%02X%02X&quot;</span>,
                        rd[0x0], rd[0x1], rd[0x2], rd[0x3], rd[0x4], rd[0x5], rd[0x6], rd[0x7],
                        rd[0x8], rd[0x9], rd[0xA], rd[0xB], rd[0xC], rd[0xD], rd[0xE], rd[0xF]);
                    <span class="enscript-keyword">break</span>;

                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_SRV</span>:
                    p += snprintf(p, rdb + <span class="enscript-keyword">sizeof</span>(rdb) - p, <span class="enscript-string">&quot;%d %d %d &quot;</span>,        <span class="enscript-comment">// priority, weight, port
</span>                             ntohs(*(<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>*)rd), ntohs(*(<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>*)(rd+2)), ntohs(*(<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>*)(rd+4)));
                    rd += 6;
                         snprintd(p, rdb + <span class="enscript-keyword">sizeof</span>(rdb) - p, &amp;rd);               <span class="enscript-comment">// target host
</span>                    <span class="enscript-keyword">break</span>;

                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_DS</span>:
                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_DNSKEY</span>:
                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_NSEC</span>:
                <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceType_RRSIG</span>:
                    ParseDNSSECRecords(rrtype, rdb, <span class="enscript-keyword">sizeof</span>(rdb), rd, rdlen);
                    <span class="enscript-keyword">break</span>;

                <span class="enscript-reference">default</span>: 
                    snprintf(rdb, <span class="enscript-keyword">sizeof</span>(rdb), <span class="enscript-string">&quot;%d bytes%s&quot;</span>, rdlen, rdlen ? <span class="enscript-string">&quot;:&quot;</span> : <span class="enscript-string">&quot;&quot;</span>); 
                    unknowntype = 1;
                    <span class="enscript-keyword">break</span>;
            }   
        }   
        <span class="enscript-keyword">else</span> 
        {
            strncpy(rdb, <span class="enscript-string">&quot;----&quot;</span>, <span class="enscript-keyword">sizeof</span>(rdb));
            <span class="enscript-comment">//Clear all o/p bits, and then check for dnssec status
</span>            check_flags &amp;= ~kDNSServiceOutputFlags;
            <span class="enscript-keyword">if</span> (check_flags &amp; kDNSServiceFlagsSecure)
                strncpy(dnssec_status, <span class="enscript-string">&quot;Secure&quot;</span>, <span class="enscript-keyword">sizeof</span>(dnssec_status));
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (check_flags &amp; kDNSServiceFlagsInsecure)
                strncpy(dnssec_status, <span class="enscript-string">&quot;Insecure&quot;</span>, <span class="enscript-keyword">sizeof</span>(dnssec_status));
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (check_flags &amp; kDNSServiceFlagsIndeterminate)
                strncpy(dnssec_status, <span class="enscript-string">&quot;Indeterminate&quot;</span>, <span class="enscript-keyword">sizeof</span>(dnssec_status));
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (check_flags &amp; kDNSServiceFlagsBogus) 
                strncpy(dnssec_status, <span class="enscript-string">&quot;Bogus&quot;</span>, <span class="enscript-keyword">sizeof</span>(dnssec_status));
        }
    }

    <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'D'</span>)
        printf(<span class="enscript-string">&quot;%s%3d %-30s%-6s%-7s%-18s %s&quot;</span>, op, ifIndex, fullname, rr_type, rr_class, dnssec_status, rdb);
    <span class="enscript-keyword">else</span>
        printf(<span class="enscript-string">&quot;%s%9X%3d %-30s%-7s%-6s %s&quot;</span>, op, flags, ifIndex, fullname, rr_type, rr_class, rdb);
    <span class="enscript-keyword">if</span> (unknowntype)
    { 
        <span class="enscript-keyword">while</span> (rd &lt; end) 
            printf(<span class="enscript-string">&quot; %02X&quot;</span>, *rd++);
    }
    <span class="enscript-keyword">if</span> (errorCode)
    {
        <span class="enscript-keyword">if</span> (errorCode == kDNSServiceErr_NoSuchRecord) 
            printf(<span class="enscript-string">&quot;    No Such Record&quot;</span>);
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (errorCode == kDNSServiceErr_Timeout)
        {
            printf(<span class="enscript-string">&quot;    No Such Record\n&quot;</span>);
            printf(<span class="enscript-string">&quot;Query Timed Out\n&quot;</span>);
            exit(1);
        }
    }
    printf(<span class="enscript-string">&quot;\n&quot;</span>);

    <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'C'</span>)
        <span class="enscript-keyword">if</span> (flags &amp; kDNSServiceFlagsAdd)
            DNSServiceReconfirmRecord(flags, ifIndex, fullname, rrtype, rrclass, rdlen, rdata);

    <span class="enscript-keyword">if</span> (!(flags &amp; kDNSServiceFlagsMoreComing)) 
        fflush(stdout);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> DNSSD_API <span class="enscript-function-name">port_mapping_create_reply</span>(DNSServiceRef sdref, DNSServiceFlags flags, uint32_t ifIndex, DNSServiceErrorType errorCode, uint32_t publicAddress, uint32_t protocol, uint16_t privatePort, uint16_t publicPort, uint32_t ttl, <span class="enscript-type">void</span> *context)
{
    (<span class="enscript-type">void</span>)sdref;       <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)flags;       <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)context;     <span class="enscript-comment">// Unused
</span>    EXIT_IF_LIBDISPATCH_FATAL_ERROR(errorCode);

    <span class="enscript-keyword">if</span> (num_printed++ == 0) printf(<span class="enscript-string">&quot;Timestamp     if   %-20s %-15s %-15s %-15s %-6s\n&quot;</span>, <span class="enscript-string">&quot;External Address&quot;</span>, <span class="enscript-string">&quot;Protocol&quot;</span>, <span class="enscript-string">&quot;Internal Port&quot;</span>, <span class="enscript-string">&quot;External Port&quot;</span>, <span class="enscript-string">&quot;TTL&quot;</span>);
    printtimestamp();
    <span class="enscript-keyword">if</span> (errorCode &amp;&amp; errorCode != kDNSServiceErr_DoubleNAT) printf(<span class="enscript-string">&quot;Error code %d\n&quot;</span>, errorCode);
    <span class="enscript-keyword">else</span>
    {
        <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *digits = (<span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *)&amp;publicAddress;
        <span class="enscript-type">char</span> addr[256];

        snprintf(addr, <span class="enscript-keyword">sizeof</span>(addr), <span class="enscript-string">&quot;%d.%d.%d.%d&quot;</span>, digits[0], digits[1], digits[2], digits[3]);
        printf(<span class="enscript-string">&quot;%-4d %-20s %-15d %-15d %-15d %-6d%s\n&quot;</span>, ifIndex, addr, protocol, ntohs(privatePort), ntohs(publicPort), ttl, errorCode == kDNSServiceErr_DoubleNAT ? <span class="enscript-string">&quot; Double NAT&quot;</span> : <span class="enscript-string">&quot;&quot;</span>);
    }

    <span class="enscript-keyword">if</span> (!(flags &amp; kDNSServiceFlagsMoreComing)) fflush(stdout);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> DNSSD_API <span class="enscript-function-name">addrinfo_reply</span>(DNSServiceRef sdref, <span class="enscript-type">const</span> DNSServiceFlags flags, uint32_t interfaceIndex, DNSServiceErrorType errorCode, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *hostname, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> sockaddr *address, uint32_t ttl, <span class="enscript-type">void</span> *context)
{
    <span class="enscript-type">char</span> *op = (flags &amp; kDNSServiceFlagsAdd) ? <span class="enscript-string">&quot;Add&quot;</span> : <span class="enscript-string">&quot;Rmv&quot;</span>;
    <span class="enscript-type">char</span> addr[256] = <span class="enscript-string">&quot;&quot;</span>;
    <span class="enscript-type">char</span> dnssec_status[15] = <span class="enscript-string">&quot;Unknown&quot;</span>; 
    DNSServiceFlags check_flags = flags;
	(<span class="enscript-type">void</span>) sdref;
	(<span class="enscript-type">void</span>) context;

    EXIT_IF_LIBDISPATCH_FATAL_ERROR(errorCode);

    <span class="enscript-keyword">if</span> (num_printed++ == 0)
    {
        <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'g'</span>) 
            printf(<span class="enscript-string">&quot;Timestamp     A/R if %-25s %-44s %-18s\n&quot;</span>, <span class="enscript-string">&quot;Hostname&quot;</span>, <span class="enscript-string">&quot;Address&quot;</span>, <span class="enscript-string">&quot;DNSSECStatus&quot;</span>);
        <span class="enscript-keyword">else</span>  
            printf(<span class="enscript-string">&quot;Timestamp     A/R    Flags if %-38s %-44s %s\n&quot;</span>, <span class="enscript-string">&quot;Hostname&quot;</span>, <span class="enscript-string">&quot;Address&quot;</span>, <span class="enscript-string">&quot;TTL&quot;</span>);
    }
    printtimestamp();
   
    <span class="enscript-keyword">if</span> (address &amp;&amp; address-&gt;sa_family == AF_INET)
    {
        <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *b = (<span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *) &amp;((<span class="enscript-type">struct</span> sockaddr_in *)address)-&gt;sin_addr;
        snprintf(addr, <span class="enscript-keyword">sizeof</span>(addr), <span class="enscript-string">&quot;%d.%d.%d.%d&quot;</span>, b[0], b[1], b[2], b[3]);
    }
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (address &amp;&amp; address-&gt;sa_family == AF_INET6)
    {
        <span class="enscript-type">char</span> if_name[IFNAMSIZ];     <span class="enscript-comment">// Older Linux distributions don't define IF_NAMESIZE
</span>        <span class="enscript-type">const</span> <span class="enscript-type">struct</span> sockaddr_in6 *s6 = (<span class="enscript-type">const</span> <span class="enscript-type">struct</span> sockaddr_in6 *)address;
        <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>       *b  = (<span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *      )&amp;s6-&gt;sin6_addr;
        <span class="enscript-keyword">if</span> (!if_indextoname(s6-&gt;sin6_scope_id, if_name))
            snprintf(if_name, <span class="enscript-keyword">sizeof</span>(if_name), <span class="enscript-string">&quot;&lt;%d&gt;&quot;</span>, s6-&gt;sin6_scope_id);
        snprintf(addr, <span class="enscript-keyword">sizeof</span>(addr), <span class="enscript-string">&quot;%02X%02X:%02X%02X:%02X%02X:%02X%02X:%02X%02X:%02X%02X:%02X%02X:%02X%02X%%%s&quot;</span>,
            b[0x0], b[0x1], b[0x2], b[0x3], b[0x4], b[0x5], b[0x6], b[0x7],
            b[0x8], b[0x9], b[0xA], b[0xB], b[0xC], b[0xD], b[0xE], b[0xF], if_name);
    }

    <span class="enscript-comment">//go through this only if you have a dnssec validation status
</span>    <span class="enscript-keyword">if</span> (!errorCode &amp;&amp; (check_flags &amp; (kDNSServiceFlagsValidate | kDNSServiceFlagsValidateOptional)))
    {
        strncpy(addr, <span class="enscript-string">&quot;----&quot;</span>, <span class="enscript-keyword">sizeof</span>(addr));
        <span class="enscript-comment">//Clear all o/p bits, and then check for dnssec status
</span>        check_flags &amp;= ~kDNSServiceOutputFlags;
        <span class="enscript-keyword">if</span> (check_flags &amp; kDNSServiceFlagsSecure)
            strncpy(dnssec_status, <span class="enscript-string">&quot;Secure&quot;</span>, <span class="enscript-keyword">sizeof</span>(dnssec_status));
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (check_flags &amp; kDNSServiceFlagsInsecure)
            strncpy(dnssec_status, <span class="enscript-string">&quot;Insecure&quot;</span>, <span class="enscript-keyword">sizeof</span>(dnssec_status));
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (check_flags &amp; kDNSServiceFlagsIndeterminate)
            strncpy(dnssec_status, <span class="enscript-string">&quot;Indeterminate&quot;</span>, <span class="enscript-keyword">sizeof</span>(dnssec_status));
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (check_flags &amp; kDNSServiceFlagsBogus) 
            strncpy(dnssec_status, <span class="enscript-string">&quot;Bogus&quot;</span>, <span class="enscript-keyword">sizeof</span>(dnssec_status));
    }
    
    <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'g'</span>)
        printf(<span class="enscript-string">&quot;%s%3d %-25s %-44s %-18s&quot;</span>, op, interfaceIndex, hostname, addr, dnssec_status);
    <span class="enscript-keyword">else</span>
        printf(<span class="enscript-string">&quot;%s%9X%3d %-38s %-44s %d&quot;</span>, op, flags, interfaceIndex, hostname, addr, ttl);
    <span class="enscript-keyword">if</span> (errorCode)
    {
        <span class="enscript-keyword">if</span> (errorCode == kDNSServiceErr_NoSuchRecord) 
            printf(<span class="enscript-string">&quot;   No Such Record&quot;</span>);
        <span class="enscript-keyword">else</span> 
            printf(<span class="enscript-string">&quot;   Error code %d&quot;</span>, errorCode);
    }
    printf(<span class="enscript-string">&quot;\n&quot;</span>);

    <span class="enscript-keyword">if</span> (!(flags &amp; kDNSServiceFlagsMoreComing)) 
        fflush(stdout);
}

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// The main test function
</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">HandleEvents</span>(<span class="enscript-type">void</span>)
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_DNS_SD_LIBDISPATCH</span>
{
    main_queue = dispatch_get_main_queue();
    <span class="enscript-keyword">if</span> (client) DNSServiceSetDispatchQueue(client, main_queue);
    <span class="enscript-keyword">if</span> (client_pa) DNSServiceSetDispatchQueue(client_pa, main_queue);
    <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'A'</span> || operation == <span class="enscript-string">'U'</span> || operation == <span class="enscript-string">'N'</span>)
    {
        timer_source = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, main_queue);
        <span class="enscript-keyword">if</span> (timer_source)
        {
            <span class="enscript-comment">// Start the timer &quot;timeout&quot; seconds into the future and repeat it every &quot;timeout&quot; seconds
</span>            dispatch_source_set_timer(timer_source, dispatch_time(DISPATCH_TIME_NOW, (uint64_t)timeOut * NSEC_PER_SEC),
                                      (uint64_t)timeOut * NSEC_PER_SEC, 0);
            dispatch_source_set_event_handler(timer_source, ^{myTimerCallBack();});
            dispatch_resume(timer_source);
        }
    }
    dispatch_main();
}
#<span class="enscript-reference">else</span>
{
    <span class="enscript-type">int</span> dns_sd_fd  = client    ? DNSServiceRefSockFD(client   ) : -1;
    <span class="enscript-type">int</span> dns_sd_fd2 = client_pa ? DNSServiceRefSockFD(client_pa) : -1;
    <span class="enscript-type">int</span> nfds = dns_sd_fd + 1;
    fd_set readfds;
    <span class="enscript-type">struct</span> timeval tv;
    <span class="enscript-type">int</span> result;

    <span class="enscript-keyword">if</span> (dns_sd_fd2 &gt; dns_sd_fd) nfds = dns_sd_fd2 + 1;

    <span class="enscript-keyword">while</span> (!stopNow)
    {
        <span class="enscript-comment">// 1. Set up the fd_set as usual here.
</span>        <span class="enscript-comment">// This example client has no file descriptors of its own,
</span>        <span class="enscript-comment">// but a real application would call FD_SET to add them to the set here
</span>        FD_ZERO(&amp;readfds);

        <span class="enscript-comment">// 2. Add the fd for our client(s) to the fd_set
</span>        <span class="enscript-keyword">if</span> (client   ) FD_SET(dns_sd_fd, &amp;readfds);
        <span class="enscript-keyword">if</span> (client_pa) FD_SET(dns_sd_fd2, &amp;readfds);

        <span class="enscript-comment">// 3. Set up the timeout.
</span>        tv.tv_sec  = timeOut;
        tv.tv_usec = 0;

        result = select(nfds, &amp;readfds, (fd_set*)NULL, (fd_set*)NULL, &amp;tv);
        <span class="enscript-keyword">if</span> (result &gt; 0)
        {
            DNSServiceErrorType err = kDNSServiceErr_NoError;
            <span class="enscript-keyword">if</span>      (client    &amp;&amp; FD_ISSET(dns_sd_fd, &amp;readfds)) err = DNSServiceProcessResult(client   );
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (client_pa &amp;&amp; FD_ISSET(dns_sd_fd2, &amp;readfds)) err = DNSServiceProcessResult(client_pa);
            <span class="enscript-keyword">if</span> (err) { printtimestamp_F(stderr); fprintf(stderr, <span class="enscript-string">&quot;DNSServiceProcessResult returned %d\n&quot;</span>, err); stopNow = 1; }
        }
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (result == 0)
            myTimerCallBack();
        <span class="enscript-keyword">else</span>
        {
            printf(<span class="enscript-string">&quot;select() returned %d errno %d %s\n&quot;</span>, result, errno, strerror(errno));
            <span class="enscript-keyword">if</span> (errno != EINTR) stopNow = 1;
        }
    }
}
#<span class="enscript-reference">endif</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">getfirstoption</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> **argv, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *optstr, <span class="enscript-type">int</span> *pOptInd)
<span class="enscript-comment">// Return the recognized option in optstr and the option index of the next arg.
</span>#<span class="enscript-reference">if</span> <span class="enscript-variable-name">NOT_HAVE_GETOPT</span>
{
    <span class="enscript-type">int</span> i;
    <span class="enscript-keyword">for</span> (i=1; i &lt; argc; i++)
    {
        <span class="enscript-keyword">if</span> (argv[i][0] == <span class="enscript-string">'-'</span> &amp;&amp; &amp;argv[i][1] &amp;&amp;
            NULL != strchr(optstr, argv[i][1]))
        {
            *pOptInd = i + 1;
            <span class="enscript-keyword">return</span> argv[i][1];
        }
    }
    <span class="enscript-keyword">return</span> -1;
}
#<span class="enscript-reference">else</span>
{
    <span class="enscript-type">int</span> o = getopt(argc, (<span class="enscript-type">char</span> *<span class="enscript-type">const</span> *)argv, optstr);
    *pOptInd = optind;
    <span class="enscript-keyword">return</span> o;
}
#<span class="enscript-reference">endif</span>

<span class="enscript-type">static</span> <span class="enscript-type">void</span> DNSSD_API <span class="enscript-function-name">MyRegisterRecordCallback</span>(DNSServiceRef service, DNSRecordRef rec, <span class="enscript-type">const</span> DNSServiceFlags flags,
                                               DNSServiceErrorType errorCode, <span class="enscript-type">void</span> *context)
{
    <span class="enscript-type">char</span> *name = (<span class="enscript-type">char</span> *)context;

    (<span class="enscript-type">void</span>)service;  <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)rec;      <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)flags;    <span class="enscript-comment">// Unused
</span>    EXIT_IF_LIBDISPATCH_FATAL_ERROR(errorCode);

    printtimestamp();
    printf(<span class="enscript-string">&quot;Got a reply for record %s: &quot;</span>, name);

    <span class="enscript-keyword">switch</span> (errorCode)
    {
    <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceErr_NoError</span>:      printf(<span class="enscript-string">&quot;Name now registered and active\n&quot;</span>); <span class="enscript-keyword">break</span>;
    <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSServiceErr_NameConflict</span>: printf(<span class="enscript-string">&quot;Name in use, please choose another\n&quot;</span>); exit(-1);
    <span class="enscript-reference">default</span>:                          printf(<span class="enscript-string">&quot;Error %d\n&quot;</span>, errorCode); <span class="enscript-keyword">break</span>;
    }
    <span class="enscript-keyword">if</span> (!(flags &amp; kDNSServiceFlagsMoreComing)) fflush(stdout);
}

<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">getip</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-type">const</span> name, <span class="enscript-type">struct</span> sockaddr_storage *result)
{
    <span class="enscript-type">struct</span> addrinfo *addrs = NULL;
    <span class="enscript-type">int</span> err = getaddrinfo(name, NULL, NULL, &amp;addrs);
    <span class="enscript-keyword">if</span> (err) fprintf(stderr, <span class="enscript-string">&quot;getaddrinfo error %d for %s&quot;</span>, err, name);
    <span class="enscript-keyword">else</span> memcpy(result, addrs-&gt;ai_addr, SA_LEN(addrs-&gt;ai_addr));
    <span class="enscript-keyword">if</span> (addrs) freeaddrinfo(addrs);
}

<span class="enscript-type">static</span> DNSServiceErrorType <span class="enscript-function-name">RegisterProxyAddressRecord</span>(DNSServiceRef sdref, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *host, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *ip, DNSServiceFlags flags)
{
    <span class="enscript-comment">// Call getip() after the call DNSServiceCreateConnection().
</span>    <span class="enscript-comment">// On the Win32 platform, WinSock must be initialized for getip() to succeed.
</span>    <span class="enscript-comment">// Any DNSService* call will initialize WinSock for us, so we make sure
</span>    <span class="enscript-comment">// DNSServiceCreateConnection() is called before getip() is.
</span>    <span class="enscript-type">struct</span> sockaddr_storage hostaddr;
    memset(&amp;hostaddr, 0, <span class="enscript-keyword">sizeof</span>(hostaddr));
    getip(ip, &amp;hostaddr);
    flags |= kDNSServiceFlagsUnique;
    <span class="enscript-keyword">if</span> (hostaddr.ss_family == AF_INET)
        <span class="enscript-keyword">return</span>(DNSServiceRegisterRecord(sdref, &amp;record, flags, opinterface, host,
                                        kDNSServiceType_A,    kDNSServiceClass_IN,  4, &amp;((<span class="enscript-type">struct</span> sockaddr_in *)&amp;hostaddr)-&gt;sin_addr,  240, MyRegisterRecordCallback, (<span class="enscript-type">void</span>*)host));
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (hostaddr.ss_family == AF_INET6)
        <span class="enscript-keyword">return</span>(DNSServiceRegisterRecord(sdref, &amp;record, flags, opinterface, host,
                                        kDNSServiceType_AAAA, kDNSServiceClass_IN, 16, &amp;((<span class="enscript-type">struct</span> sockaddr_in6*)&amp;hostaddr)-&gt;sin6_addr, 240, MyRegisterRecordCallback, (<span class="enscript-type">void</span>*)host));
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">return</span>(kDNSServiceErr_BadParam);
}

#<span class="enscript-reference">define</span> <span class="enscript-function-name">HexVal</span>(X) ( ((X) &gt;= <span class="enscript-string">'0'</span> &amp;&amp; (X) &lt;= <span class="enscript-string">'9'</span>) ? ((X) - <span class="enscript-string">'0'</span>     ) :  \
                    ((X) &gt;= <span class="enscript-string">'A'</span> &amp;&amp; (X) &lt;= <span class="enscript-string">'F'</span>) ? ((X) - <span class="enscript-string">'A'</span> + 10) :  \
                    ((X) &gt;= <span class="enscript-string">'a'</span> &amp;&amp; (X) &lt;= <span class="enscript-string">'f'</span>) ? ((X) - <span class="enscript-string">'a'</span> + 10) : 0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">HexPair</span>(P) ((HexVal((P)[0]) &lt;&lt; 4) | HexVal((P)[1]))

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAXTXTRecordSize</span> 8900
<span class="enscript-type">static</span> DNSServiceErrorType <span class="enscript-function-name">RegisterService</span>(DNSServiceRef *sdref,
                                           <span class="enscript-type">const</span> <span class="enscript-type">char</span> *nam, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *typ, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *dom, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *host, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *port, <span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> **argv, DNSServiceFlags flags)
{
    uint16_t PortAsNumber = atoi(port);
    Opaque16 registerPort = { { PortAsNumber &gt;&gt; 8, PortAsNumber &amp; 0xFF } };
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> txt[MAXTXTRecordSize];
    txt[0] = <span class="enscript-string">'\0'</span>;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *ptr = txt;
    <span class="enscript-type">int</span> i;

    <span class="enscript-keyword">if</span> (nam[0] == <span class="enscript-string">'.'</span> &amp;&amp; nam[1] == 0) nam = <span class="enscript-string">&quot;&quot;</span>;   <span class="enscript-comment">// We allow '.' on the command line as a synonym for empty string
</span>    <span class="enscript-keyword">if</span> (dom[0] == <span class="enscript-string">'.'</span> &amp;&amp; dom[1] == 0) dom = <span class="enscript-string">&quot;&quot;</span>;   <span class="enscript-comment">// We allow '.' on the command line as a synonym for empty string
</span>
    printf(<span class="enscript-string">&quot;Registering Service %s.%s%s%s&quot;</span>, nam[0] ? nam : <span class="enscript-string">&quot;&lt;&lt;Default&gt;&gt;&quot;</span>, typ, dom[0] ? <span class="enscript-string">&quot;.&quot;</span> : <span class="enscript-string">&quot;&quot;</span>, dom);
    <span class="enscript-keyword">if</span> (host &amp;&amp; *host) printf(<span class="enscript-string">&quot; host %s&quot;</span>, host);
    printf(<span class="enscript-string">&quot; port %s&quot;</span>, port);

    <span class="enscript-keyword">if</span> (argc)
    {
        <span class="enscript-keyword">for</span> (i = 0; i &lt; argc; i++)
        {
            <span class="enscript-type">const</span> <span class="enscript-type">char</span> *p = argv[i];
            <span class="enscript-keyword">if</span> (ptr &gt;= txt + <span class="enscript-keyword">sizeof</span>(txt))
                <span class="enscript-keyword">return</span> kDNSServiceErr_BadParam;
            *ptr = 0;
            <span class="enscript-keyword">while</span> (*p &amp;&amp; *ptr &lt; 255)
            {
                <span class="enscript-keyword">if</span> (ptr + 1 + *ptr &gt;= txt + <span class="enscript-keyword">sizeof</span>(txt))
                    <span class="enscript-keyword">return</span> kDNSServiceErr_BadParam;
                <span class="enscript-keyword">if</span>      (p[0] != <span class="enscript-string">'\\'</span> || p[1] == 0)                       { ptr[++*ptr] = *p;           p+=1; }
                <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (p[1] == <span class="enscript-string">'x'</span> &amp;&amp; isxdigit(p[2]) &amp;&amp; isxdigit(p[3])) { ptr[++*ptr] = HexPair(p+2); p+=4; }
                <span class="enscript-keyword">else</span>                                                      { ptr[++*ptr] = p[1];         p+=2; }
            }
            ptr += 1 + *ptr;
        }
        printf(<span class="enscript-string">&quot; TXT&quot;</span>);
        ShowTXTRecord(ptr-txt, txt);
    }
    printf(<span class="enscript-string">&quot;\n&quot;</span>);

    <span class="enscript-comment">//flags |= kDNSServiceFlagsAllowRemoteQuery;
</span>    <span class="enscript-comment">//flags |= kDNSServiceFlagsNoAutoRename;
</span>
    <span class="enscript-keyword">return</span>(DNSServiceRegister(sdref, flags, opinterface, nam, typ, dom, host, registerPort.NotAnInteger, (uint16_t) (ptr-txt), txt, reg_reply, NULL));
}

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">TypeBufferSize</span> 80
<span class="enscript-type">static</span> <span class="enscript-type">char</span> *<span class="enscript-function-name">gettype</span>(<span class="enscript-type">char</span> *buffer, <span class="enscript-type">char</span> *typ)
{
    <span class="enscript-keyword">if</span> (!typ || !*typ || (typ[0] == <span class="enscript-string">'.'</span> &amp;&amp; typ[1] == 0)) typ = <span class="enscript-string">&quot;_http._tcp&quot;</span>;
    <span class="enscript-keyword">if</span> (!strchr(typ, <span class="enscript-string">'.'</span>)) { snprintf(buffer, TypeBufferSize, <span class="enscript-string">&quot;%s._tcp&quot;</span>, typ); typ = buffer; }
    <span class="enscript-keyword">return</span>(typ);
}

<span class="enscript-comment">// Do some basic tests to verify API handles &gt; 63 byte strings gracefully with 
</span><span class="enscript-comment">// a returned error code.
</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">STRING_64_BYTES</span> <span class="enscript-string">&quot;_123456789012345678901234567890123456789012345678901234567890123&quot;</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">API_string_limit_test</span>()
{
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> * regtype;
    DNSServiceRef sdRef = NULL;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> * longHost = STRING_64_BYTES <span class="enscript-string">&quot;.local&quot;</span>;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> * longDomain = <span class="enscript-string">&quot;hostname.&quot;</span> STRING_64_BYTES;

    printf(<span class="enscript-string">&quot;Testing for error returns when various strings are &gt; 63 bytes.\n&quot;</span>);

    printf(<span class="enscript-string">&quot;DNSServiceGetAddrInfo(), hostname = %s\n&quot;</span>, longHost);
    <span class="enscript-keyword">if</span> (DNSServiceGetAddrInfo(&amp;sdRef, 0, 0, 0, longHost, addrinfo_reply, 0) == 0)
    {
        printf(<span class="enscript-string">&quot;DNSServiceGetAddrInfo(): expected error return\n&quot;</span>);
        <span class="enscript-keyword">return</span> 1;
    };

    printf(<span class="enscript-string">&quot;DNSServiceGetAddrInfo(), hostname = %s\n&quot;</span>, longDomain);
    <span class="enscript-keyword">if</span> (DNSServiceGetAddrInfo(&amp;sdRef, 0, 0, 0, longDomain, addrinfo_reply, 0) == 0)
    {
        printf(<span class="enscript-string">&quot;DNSServiceGetAddrInfo(): expected error return\n&quot;</span>);
        <span class="enscript-keyword">return</span> 1;
    };

    printf(<span class="enscript-string">&quot;DNSServiceResolve(), name = %s\n&quot;</span>, STRING_64_BYTES);
    <span class="enscript-keyword">if</span> (DNSServiceResolve(&amp;sdRef, 0, 0, STRING_64_BYTES, <span class="enscript-string">&quot;_test._tcp&quot;</span>, <span class="enscript-string">&quot;local&quot;</span>, resolve_reply, NULL) == 0)
    {
        printf(<span class="enscript-string">&quot;DNSServiceResolve(): expected error return\n&quot;</span>);
        <span class="enscript-keyword">return</span> 1;
    };

    regtype = STRING_64_BYTES <span class="enscript-string">&quot;._tcp&quot;</span>;
    printf(<span class="enscript-string">&quot;DNSServiceResolve(), regtype = %s\n&quot;</span>, regtype);
    <span class="enscript-keyword">if</span> (DNSServiceResolve(&amp;sdRef, 0, 0, <span class="enscript-string">&quot;instanceName&quot;</span>, regtype, <span class="enscript-string">&quot;local&quot;</span>, resolve_reply, NULL) == 0)
    {
        printf(<span class="enscript-string">&quot;DNSServiceResolve(): expected error return\n&quot;</span>);
        <span class="enscript-keyword">return</span> 1;
    };

    printf(<span class="enscript-string">&quot;DNSServiceResolve(), domain = %s\n&quot;</span>, STRING_64_BYTES);
    <span class="enscript-keyword">if</span> (DNSServiceResolve(&amp;sdRef, 0, 0, <span class="enscript-string">&quot;instanceName&quot;</span>, <span class="enscript-string">&quot;_test._tcp&quot;</span>, STRING_64_BYTES, resolve_reply, NULL) == 0)
    {
        printf(<span class="enscript-string">&quot;DNSServiceResolve(): expected error return\n&quot;</span>);
        <span class="enscript-keyword">return</span> 1;
    };

    printf(<span class="enscript-string">&quot;Testing for error returns when various strings are &gt; 63 bytes: PASSED\n&quot;</span>);
    <span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">API_NULL_input_test</span>()
{
    printf(<span class="enscript-string">&quot;Running basic API input range tests with various pointer parameters set to NULL:\n&quot;</span>);

    <span class="enscript-comment">// Test that API's handle NULL pointers by returning an error when appropriate.
</span>
    <span class="enscript-comment">// DNSServiceRefSockFD()
</span>    <span class="enscript-keyword">if</span> (DNSServiceRefSockFD(0) != -1)
    {
        printf(<span class="enscript-string">&quot;DNSServiceRefSockFD(): expected dnssd_InvalidSocket return\n&quot;</span>);
        <span class="enscript-keyword">return</span> 1;
    }

    <span class="enscript-comment">// DNSServiceProcessResult()
</span>    <span class="enscript-keyword">if</span> (DNSServiceProcessResult(0) == 0)
    {
        printf(<span class="enscript-string">&quot;DNSServiceProcessResult(): expected error return\n&quot;</span>);
        <span class="enscript-keyword">return</span> 1;
    }

    <span class="enscript-comment">// DNSServiceRefDeallocate(): no return value, just verify it doesn't crash
</span>    DNSServiceRefDeallocate(0);

    <span class="enscript-comment">// DNSServiceGetProperty()
</span>    {
        uint32_t   result;
        uint32_t   size;

	    <span class="enscript-keyword">if</span> (    (DNSServiceGetProperty(                                0, &amp;result, &amp;size) == 0)
	         || (DNSServiceGetProperty(kDNSServiceProperty_DaemonVersion,       0, &amp;size) == 0)
	         || (DNSServiceGetProperty(kDNSServiceProperty_DaemonVersion, &amp;result, 0) == 0)
           )
	    {
	        printf(<span class="enscript-string">&quot;DNSServiceGetProperty(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }
    }

    <span class="enscript-comment">// DNSServiceResolve()
</span>    {
	    DNSServiceRef       sdRef;
	    DNSServiceFlags     flags = 0;
	    uint32_t            interfaceIndex = 0;
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *name = <span class="enscript-string">&quot;name&quot;</span>;
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *regtype = <span class="enscript-string">&quot;_test._tcp&quot;</span>;
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *domain = <span class="enscript-string">&quot;local&quot;</span>;
	    DNSServiceResolveReply callBack = 0;
	    <span class="enscript-type">void</span>                *context = 0;   <span class="enscript-comment">// can be a NULL pointer
</span>
	    <span class="enscript-keyword">if</span> (    (DNSServiceResolve(    0,  flags, interfaceIndex, name, regtype, domain, callBack, context) == 0)
            ||  (DNSServiceResolve(&amp;sdRef, flags, interfaceIndex,    0, regtype, domain, callBack, context) == 0)
            ||  (DNSServiceResolve(&amp;sdRef, flags, interfaceIndex, name,       0, domain, callBack, context) == 0)
            ||  (DNSServiceResolve(&amp;sdRef, flags, interfaceIndex, name, regtype,      0, callBack, context) == 0)
            ||  (DNSServiceResolve(&amp;sdRef, flags, interfaceIndex, name, regtype, domain, callBack, context) == 0)
           )
	    {
	        printf(<span class="enscript-string">&quot;DNSServiceResolve(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }
    }

    <span class="enscript-comment">// DNSServiceQueryRecord()
</span>    {
	    DNSServiceRef       sdRef;
	    DNSServiceFlags     flags = 0;
	    uint32_t            interfaceIndex = 0;
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *fullname = <span class="enscript-string">&quot;fullname&quot;</span>;
	    uint16_t            rrtype = 0;
	    uint16_t            rrclass = 0;
	    DNSServiceQueryRecordReply callBack = 0;
	    <span class="enscript-type">void</span>                *context = 0;  <span class="enscript-comment">/* may be NULL */</span>

	    <span class="enscript-keyword">if</span> (    (DNSServiceQueryRecord(     0, flags, interfaceIndex, fullname, rrtype, rrclass, callBack, context) == 0)
	        ||  (DNSServiceQueryRecord(&amp;sdRef, flags, interfaceIndex, 0,        rrtype, rrclass, callBack, context) == 0)
	        ||  (DNSServiceQueryRecord(&amp;sdRef, flags, interfaceIndex, fullname, rrtype, rrclass,        0, context) == 0)
           )
	    {
	        printf(<span class="enscript-string">&quot;DNSServiceQueryRecord(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }
    }

    <span class="enscript-comment">// DNSServiceGetAddrInfo()
</span>    {
	    DNSServiceRef       sdRef;
	    DNSServiceFlags     flags = 0;
	    uint32_t            interfaceIndex = 0;
	    DNSServiceProtocol  protocol = kDNSServiceProtocol_IPv4|kDNSServiceProtocol_IPv6;
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *hostname = <span class="enscript-string">&quot;host.local&quot;</span>;
	    DNSServiceGetAddrInfoReply callBack = 0;
	    <span class="enscript-type">void</span>                *context = 0;   <span class="enscript-comment">// may be NULL
</span>
	    <span class="enscript-keyword">if</span> (    (DNSServiceGetAddrInfo(     0, flags, interfaceIndex, protocol, hostname, callBack, context) == 0)
            ||  (DNSServiceGetAddrInfo(&amp;sdRef, flags, interfaceIndex, protocol,        0, callBack, context) == 0)
            ||  (DNSServiceGetAddrInfo(&amp;sdRef, flags, interfaceIndex, protocol, hostname,        0, context) == 0)
           )
	    {
	        printf(<span class="enscript-string">&quot;DNSServiceGetAddrInfo(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }
    }

    <span class="enscript-comment">// DNSServiceBrowse()
</span>    {
	    DNSServiceRef       sdRef;
	    DNSServiceFlags     flags = 0;
	    uint32_t            interfaceIndex = 0;
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *regtype = <span class="enscript-string">&quot;_test._tcp&quot;</span>;
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *domain = 0;    <span class="enscript-comment">/* may be NULL */</span>
	    DNSServiceBrowseReply callBack = 0;
	    <span class="enscript-type">void</span>                *context = 0;   <span class="enscript-comment">/* may be NULL */</span>

	    <span class="enscript-keyword">if</span> (    (DNSServiceBrowse(     0, flags, interfaceIndex, regtype, domain, callBack, context) == 0)
            ||  (DNSServiceBrowse(&amp;sdRef, flags, interfaceIndex,       0, domain, callBack, context) == 0)
            ||  (DNSServiceBrowse(&amp;sdRef, flags, interfaceIndex, regtype, domain,        0, context) == 0)
           )
	    {
	        printf(<span class="enscript-string">&quot;DNSServiceBrowse(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }
    }

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>
    <span class="enscript-comment">// DNSServiceSetDefaultDomainForUser()
</span>    <span class="enscript-keyword">if</span> (DNSServiceSetDefaultDomainForUser(0, 0) == 0)
    {
        printf(<span class="enscript-string">&quot;DNSServiceSetDefaultDomainForUser(): expected error return\n&quot;</span>);
        <span class="enscript-keyword">return</span> 1;
    }
#<span class="enscript-reference">endif</span>

    <span class="enscript-comment">// DNSServiceRegister()
</span>    {
	    DNSServiceRef       sdRef;
	    DNSServiceFlags     flags = 0;
	    uint32_t            interfaceIndex = 0;
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *name = 0;         <span class="enscript-comment">/* may be NULL */</span>
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *regtype = <span class="enscript-string">&quot;_test._tcp&quot;</span>;
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *domain = 0;       <span class="enscript-comment">/* may be NULL */</span>
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *host = 0;         <span class="enscript-comment">/* may be NULL */</span>
	    uint16_t            port = 0x2211;     <span class="enscript-comment">/* In network byte order */</span>
	    uint16_t            txtLen = 1;
	    <span class="enscript-type">const</span> <span class="enscript-type">void</span>          *txtRecord = <span class="enscript-string">&quot;\0&quot;</span>;    <span class="enscript-comment">/* may be NULL */</span>
	    DNSServiceRegisterReply callBack = 0;  <span class="enscript-comment">/* may be NULL */</span>
	    <span class="enscript-type">void</span>                *context = 0;      <span class="enscript-comment">/* may be NULL */</span>

	    <span class="enscript-keyword">if</span> (    (DNSServiceRegister(     0, flags, interfaceIndex, name, regtype, domain, host, port, txtLen, txtRecord, callBack, context) == 0)
            ||  (DNSServiceRegister(&amp;sdRef, flags, interfaceIndex, name,       0, domain, host, port, txtLen, txtRecord, callBack, context) == 0)
           )
	    {
	        printf(<span class="enscript-string">&quot;DNSServiceRegister(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }
    }

    <span class="enscript-comment">// DNSServiceEnumerateDomains()
</span>    {
	    DNSServiceRef       sdRef;
	    DNSServiceFlags     flags = 0;
	    uint32_t            interfaceIndex = 0;
	    DNSServiceDomainEnumReply callBack = 0;
	    <span class="enscript-type">void</span>                *context = 0;  <span class="enscript-comment">/* may be NULL */</span>

	    <span class="enscript-keyword">if</span> (    (DNSServiceEnumerateDomains(     0, flags, interfaceIndex, callBack, context) == 0)
            ||  (DNSServiceEnumerateDomains(&amp;sdRef, flags, interfaceIndex,        0, context) == 0)
           )
	    {
	        printf(<span class="enscript-string">&quot;DNSServiceEnumerateDomains(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }
    }

    <span class="enscript-comment">// DNSServiceCreateConnection()
</span>    <span class="enscript-keyword">if</span> (DNSServiceCreateConnection(0) == 0)
    {
        printf(<span class="enscript-string">&quot;DNSServiceCreateConnection(): expected error return\n&quot;</span>);
        <span class="enscript-keyword">return</span> 1;
    }

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>
    <span class="enscript-comment">// DNSServiceCreateDelegateConnection()
</span>    <span class="enscript-keyword">if</span> (DNSServiceCreateDelegateConnection(0, 0, 0) == 0)
    {
        printf(<span class="enscript-string">&quot;DNSServiceCreateDelegateConnection(): expected error return\n&quot;</span>);
        <span class="enscript-keyword">return</span> 1;
    }
#<span class="enscript-reference">endif</span>

    <span class="enscript-comment">// DNSServiceRegisterRecord()
</span>    {
	    DNSServiceRef       sdRef;
	    DNSRecordRef        RecordRef;
	    DNSServiceFlags     flags = 0;
	    uint32_t            interfaceIndex = 0;
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *fullname = <span class="enscript-string">&quot;test1._test._tcp.local&quot;</span>;
	    uint16_t            rrtype = kDNSServiceType_TXT;
	    uint16_t            rrclass = kDNSServiceClass_IN;
	    uint16_t            rdlen = 1;
	    <span class="enscript-type">const</span> <span class="enscript-type">void</span>          *rdata = <span class="enscript-string">&quot;\0&quot;</span>;
	    uint32_t            ttl = 0;
	    DNSServiceRegisterRecordReply callBack = 0;
	    <span class="enscript-type">void</span>                *context = 0;    <span class="enscript-comment">/* may be NULL */</span>

        <span class="enscript-comment">// Need an initialize sdRef
</span>        <span class="enscript-keyword">if</span> (DNSServiceCreateConnection(&amp;sdRef))
        {
	        printf(<span class="enscript-string">&quot;DNSServiceCreateConnection(): failed\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
        }

	    <span class="enscript-keyword">if</span> (    (DNSServiceRegisterRecord(     0, &amp;RecordRef, flags, interfaceIndex, fullname, rrtype, rrclass, rdlen, rdata, ttl, callBack, context) == 0)
	        ||  (DNSServiceRegisterRecord(sdRef, &amp;RecordRef, flags, interfaceIndex,         0, rrtype, rrclass, rdlen, rdata, ttl, callBack, context) == 0)
	        ||  (DNSServiceRegisterRecord(sdRef, &amp;RecordRef, flags, interfaceIndex,  fullname, rrtype, rrclass, rdlen,     0, ttl, callBack, context) == 0)
	        ||  (DNSServiceRegisterRecord(sdRef, &amp;RecordRef, flags, interfaceIndex,  fullname, rrtype, rrclass, rdlen, rdata, ttl,        0, context) == 0)
           )
	    {
	        printf(<span class="enscript-string">&quot;DNSServiceRegisterRecord(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }
    }

    <span class="enscript-comment">// DNSServiceAddRecord(), DNSServiceUpdateRecord(), and DNSServiceRemoveRecord() verify that they 
</span>    <span class="enscript-comment">// get a valid DNSServiceRef returned from DNSServiceRegister() 
</span>    {
        DNSServiceErrorType err;
	    Opaque16            registerPort = { { 0x12, 0x34 } };
	    <span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span>   TXT[] = <span class="enscript-string">&quot;\xC&quot;</span> <span class="enscript-string">&quot;First String&quot;</span>;
        DNSServiceRef       sdRef;

	    DNSRecordRef        RecordRef;
	    DNSServiceFlags     flags = 0;
	    uint16_t            rrtype = kDNSServiceType_TXT;
	    uint16_t            rdlen = 1;
	    <span class="enscript-type">const</span> <span class="enscript-type">void</span>          *rdata = <span class="enscript-string">&quot;\0&quot;</span>;
	    uint32_t            ttl = 100;

	    err = DNSServiceRegister(&amp;sdRef, 0, 0, <span class="enscript-string">&quot;Test&quot;</span>, <span class="enscript-string">&quot;_test._tcp.&quot;</span>, <span class="enscript-string">&quot;&quot;</span>, NULL, registerPort.NotAnInteger, <span class="enscript-keyword">sizeof</span>(TXT)-1, TXT, reg_reply, NULL);
        <span class="enscript-keyword">if</span> (err)
        {
            printf(<span class="enscript-string">&quot;DNSServiceRegister() failed with: %d\n&quot;</span>, err);
            <span class="enscript-keyword">return</span> 1;
        }
	
	    <span class="enscript-comment">// DNSServiceAddRecord()
</span>	    <span class="enscript-keyword">if</span> (    (DNSServiceAddRecord(    0, &amp;RecordRef, flags, rrtype, rdlen, rdata, ttl) == 0)
	        ||  (DNSServiceAddRecord(sdRef,          0, flags, rrtype, rdlen, rdata, ttl) == 0)
	        ||  (DNSServiceAddRecord(sdRef, &amp;RecordRef, flags, rrtype, rdlen,     0, ttl) == 0)
           )

	    {
	        printf(<span class="enscript-string">&quot;DNSServiceAddRecord(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }

        <span class="enscript-comment">// (rdlen == 0 &amp;&amp; rdata == 0) should indicate a TXT with rdata containing only a 0 length byte.
</span>        <span class="enscript-keyword">if</span> (DNSServiceAddRecord(sdRef, &amp;RecordRef, flags, rrtype, 0, 0, ttl) == kDNSServiceErr_BadParam)
        {
	        printf(<span class="enscript-string">&quot;DNSServiceAddRecord(): with (rdlen == 0 &amp;&amp; rdata == 0) returned kDNSServiceErr_BadParam\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
        }
	
	    <span class="enscript-comment">// DNSServiceUpdateRecord()
</span>        <span class="enscript-comment">// Note, RecordRef can be NULL per explanation with declaration in dns_sd.h
</span>	    <span class="enscript-keyword">if</span> (    (DNSServiceUpdateRecord(    0, RecordRef, flags, rdlen, rdata, ttl) == 0)
	        ||  (DNSServiceUpdateRecord(sdRef, RecordRef, flags, rdlen,     0, ttl) == 0)
           )
	    {
	        printf(<span class="enscript-string">&quot;DNSServiceUpdateRecord(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }
	
        <span class="enscript-comment">// (rdlen == 0 &amp;&amp; rdata == 0) should indicate a TXT with rdata containing only a 0 length byte.
</span>        <span class="enscript-keyword">if</span> (DNSServiceUpdateRecord(sdRef, RecordRef, flags, 0, 0, ttl) == kDNSServiceErr_BadParam)
        {
	        printf(<span class="enscript-string">&quot;DNSServiceUpdateRecord(): with (rdlen == 0 &amp;&amp; rdata == 0) returned kDNSServiceErr_BadParam\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
        }

	    <span class="enscript-comment">// DNSServiceRemoveRecord()
</span>	    <span class="enscript-keyword">if</span> (    (DNSServiceRemoveRecord(    0, RecordRef, flags) == 0)
	        ||  (DNSServiceRemoveRecord(sdRef,         0, flags) == 0)
           )
	    {
	        printf(<span class="enscript-string">&quot;DNSServiceRemoveRecord(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }

        DNSServiceRefDeallocate(sdRef);
    }

    <span class="enscript-comment">// DNSServiceReconfirmRecord()
</span>    {
	    DNSServiceFlags     flags = 0;
	    uint32_t            interfaceIndex = 0;
	    <span class="enscript-type">const</span> <span class="enscript-type">char</span>          *fullname = <span class="enscript-string">&quot;aaa._test._tcp.local&quot;</span>;
	    uint16_t            rrtype = kDNSServiceType_TXT;
	    uint16_t            rrclass = kDNSServiceClass_IN;
	    uint16_t            rdlen = 1;
	    <span class="enscript-type">const</span> <span class="enscript-type">void</span>          *rdata = <span class="enscript-string">&quot;\0&quot;</span>;
	
	    <span class="enscript-keyword">if</span> (    (DNSServiceReconfirmRecord(flags, interfaceIndex,        0, rrtype, rrclass, rdlen, rdata) == 0)
            ||  (DNSServiceReconfirmRecord(flags, interfaceIndex, fullname, rrtype, rrclass, rdlen,     0) == 0)
           )
	    {
	        printf(<span class="enscript-string">&quot;DNSServiceReconfirmRecord(): expected error return\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
	    }
        <span class="enscript-comment">// (rdlen == 0 &amp;&amp; rdata == 0) should indicate a TXT with rdata containing only a 0 length byte.
</span>        <span class="enscript-keyword">if</span> (DNSServiceReconfirmRecord(flags, interfaceIndex, fullname, rrtype, rrclass, 0, 0) == kDNSServiceErr_BadParam)
        {
	        printf(<span class="enscript-string">&quot;DNSServiceReconfirmRecord(): with (rdlen == 0 &amp;&amp; rdata == 0) returned kDNSServiceErr_BadParam\n&quot;</span>);
	        <span class="enscript-keyword">return</span> 1;
        }
    }


    printf(<span class="enscript-string">&quot;Basic API input range tests: PASSED\n&quot;</span>);
    <span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">API_input_range_test</span>()
{

    <span class="enscript-keyword">if</span> (API_string_limit_test())
        <span class="enscript-keyword">return</span> 1;

    <span class="enscript-keyword">if</span> (API_NULL_input_test())
        <span class="enscript-keyword">return</span> 1;

    <span class="enscript-keyword">return</span> 0;
}

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">handle_state_dump_request</span>(uint8_t if_compress_state_dump, uint8_t if_dump_to_stdout);
#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>
<span class="enscript-type">int</span> <span class="enscript-function-name">main</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> **argv)
{
    DNSServiceErrorType err;
    <span class="enscript-type">char</span> buffer[TypeBufferSize], *typ, *dom;
    <span class="enscript-type">int</span> opi;
    DNSServiceFlags flags = 0;
    <span class="enscript-type">int</span> optional = 0;

    <span class="enscript-comment">// Extract the program name from argv[0], which by convention contains the path to this executable.
</span>    <span class="enscript-comment">// Note that this is just a voluntary convention, not enforced by the kernel --
</span>    <span class="enscript-comment">// the process calling exec() can pass bogus data in argv[0] if it chooses to.
</span>    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *a0 = strrchr(argv[0], kFilePathSep) + 1;
    <span class="enscript-keyword">if</span> (a0 == (<span class="enscript-type">const</span> <span class="enscript-type">char</span> *)1) a0 = argv[0];

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">_WIN32</span>)
    HeapSetInformation(NULL, HeapEnableTerminationOnCorruption, NULL, 0);
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">TEST_NEW_CLIENTSTUB</span>
    printf(<span class="enscript-string">&quot;Using embedded copy of dnssd_clientstub instead of system library\n&quot;</span>);
    <span class="enscript-keyword">if</span> (<span class="enscript-keyword">sizeof</span>(argv) == 8) printf(<span class="enscript-string">&quot;Running in 64-bit mode\n&quot;</span>);
#<span class="enscript-reference">endif</span>

    <span class="enscript-comment">// Test code for TXTRecord functions
</span>    <span class="enscript-comment">//TXTRecordRef txtRecord;
</span>    <span class="enscript-comment">//TXTRecordCreate(&amp;txtRecord, 0, NULL);
</span>    <span class="enscript-comment">//TXTRecordSetValue(&amp;txtRecord, &quot;aaa&quot;, 1, &quot;b&quot;);
</span>    <span class="enscript-comment">//printf(&quot;%d\n&quot;, TXTRecordContainsKey(TXTRecordGetLength(&amp;txtRecord), TXTRecordGetBytesPtr(&amp;txtRecord), &quot;Aaa&quot;));
</span>
    <span class="enscript-keyword">while</span> (argc &gt; 1)
    {
        <span class="enscript-type">int</span> entryCount;

        <span class="enscript-comment">// record current argc to see if we process an argument in this pass
</span>        entryCount = argc;

	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcmp(argv[1], <span class="enscript-string">&quot;-test&quot;</span>))
	    {
	        argc--;
	        argv++;
	        <span class="enscript-keyword">return</span> API_input_range_test();
	    }
	
	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcmp(argv[1], <span class="enscript-string">&quot;-lo&quot;</span>))
	    {
	        argc--;
	        argv++;
	        opinterface = kDNSServiceInterfaceIndexLocalOnly;
	        printf(<span class="enscript-string">&quot;Using LocalOnly\n&quot;</span>);
	    }
	
	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; (!strcasecmp(argv[1], <span class="enscript-string">&quot;-p2p&quot;</span>)))
	    {
	        argc--;
	        argv++;
	        opinterface = kDNSServiceInterfaceIndexP2P;
	    }
	
	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; (!strcasecmp(argv[1], <span class="enscript-string">&quot;-ble&quot;</span>)))
	    {
	        argc--;
	        argv++;
	        opinterface = kDNSServiceInterfaceIndexBLE;
	    }
	
        <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-allowexpired&quot;</span>))
        {
            argc--;
            argv++;
            flags |= kDNSServiceFlagsAllowExpiredAnswers;
            printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsAllowExpiredAnswers\n&quot;</span>);
        }
        
	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-includep2p&quot;</span>))
	    {
	        argc--;
	        argv++;
	        flags |= kDNSServiceFlagsIncludeP2P;
	        printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsIncludeP2P\n&quot;</span>);
	    }

	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-fmc&quot;</span>))
	    {
	        argc--;
	        argv++;
	        flags |= kDNSServiceFlagsForceMulticast;
	        printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsForceMulticast flag for this request\n&quot;</span>);
	    }
	
	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-includeAWDL&quot;</span>))
	    {
	        argc--;
	        argv++;
	        flags |= kDNSServiceFlagsIncludeAWDL;
	        printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsIncludeAWDL\n&quot;</span>);
	    }

        <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-intermediates&quot;</span>))
        {
            argc--;
            argv++;
            flags |= kDNSServiceFlagsReturnIntermediates;
            printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsReturnIntermediates\n&quot;</span>);
        }

        <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-tc&quot;</span>))
	    {
	        argc--;
	        argv++;
	        flags |= kDNSServiceFlagsBackgroundTrafficClass;
	        printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsBackgroundTrafficClass\n&quot;</span>);
	    }
	
	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-t1&quot;</span>))
	    {
	        argc--;
	        argv++;
	        flags |= kDNSServiceFlagsThresholdOne;
	        printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsThresholdOne\n&quot;</span>);
	    }
	
	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-tFinder&quot;</span>))
	    {
	        argc--;
	        argv++;
	        flags |= kDNSServiceFlagsThresholdFinder;
	        printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsThresholdFinder\n&quot;</span>);
	    }
	
	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-wo&quot;</span>))
	    {
	        argc--;
	        argv++;
	        flags |= kDNSServiceFlagsWakeOnlyService;
	        printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsWakeOnlyService\n&quot;</span>);
	    }
	
	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-ku&quot;</span>))
	    {
	        argc--;
	        argv++;
	        flags |= kDNSServiceFlagsKnownUnique;
	        printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsKnownUnique\n&quot;</span>);
	    }
	
	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-unicastResponse&quot;</span>))
	    {
	        argc--;
	        argv++;
	        flags |= kDNSServiceFlagsUnicastResponse;
	        printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsUnicastResponse\n&quot;</span>);
	    }

	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-timeout&quot;</span>))
	    {
	        argc--;
	        argv++;
	        flags |= kDNSServiceFlagsTimeout;
	        printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsTimeout\n&quot;</span>);
	    }

	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-autoTrigger&quot;</span>))
	    {
	        argc--;
	        argv++;
	        flags |= kDNSServiceFlagsAutoTrigger;
	        printf(<span class="enscript-string">&quot;Setting kDNSServiceFlagsAutoTrigger\n&quot;</span>);
	    }

	    <span class="enscript-keyword">if</span> (argc &gt; 1 &amp;&amp; !strcasecmp(argv[1], <span class="enscript-string">&quot;-optional&quot;</span>))
	    {
	        argc--;
	        argv++;
	        optional = 1;
	        printf(<span class="enscript-string">&quot;Setting DNSSEC optional flag\n&quot;</span>);
	    }

	    <span class="enscript-keyword">if</span> (argc &gt; 2 &amp;&amp; !strcmp(argv[1], <span class="enscript-string">&quot;-i&quot;</span>))
	    {
	        opinterface = if_nametoindex(argv[2]);
	        <span class="enscript-keyword">if</span> (!opinterface) opinterface = atoi(argv[2]);
	        <span class="enscript-keyword">if</span> (!opinterface) { fprintf(stderr, <span class="enscript-string">&quot;Unknown interface %s\n&quot;</span>, argv[2]); <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>; }
	        argc -= 2;
	        argv += 2;
	    }

        <span class="enscript-comment">// Exit loop if if we didn't match one of the multi character options.
</span>        <span class="enscript-keyword">if</span> (argc == entryCount)
            <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">if</span> (argc &lt; 2) <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;        <span class="enscript-comment">// Minimum command line is the command name and one argument
</span>    operation = getfirstoption(argc, argv, <span class="enscript-string">&quot;ABCDEFHILMNPQRSTUVZhlq&quot;</span>
                               <span class="enscript-string">&quot;X&quot;</span>
                               <span class="enscript-string">&quot;Gg&quot;</span>
                               , &amp;opi);
    <span class="enscript-keyword">if</span> (operation == -1) <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;

    <span class="enscript-keyword">if</span> (opinterface) printf(<span class="enscript-string">&quot;Using interface %d\n&quot;</span>, opinterface);

    <span class="enscript-keyword">switch</span> (operation)
    {
    <span class="enscript-keyword">case</span> <span class="enscript-string">'E'</span>:   printf(<span class="enscript-string">&quot;Looking for recommended registration domains:\n&quot;</span>);
        err = DNSServiceEnumerateDomains(&amp;client, kDNSServiceFlagsRegistrationDomains, opinterface, enum_reply, NULL);
        <span class="enscript-keyword">break</span>;

    <span class="enscript-keyword">case</span> <span class="enscript-string">'F'</span>:   printf(<span class="enscript-string">&quot;Looking for recommended browsing domains:\n&quot;</span>);
        err = DNSServiceEnumerateDomains(&amp;client, kDNSServiceFlagsBrowseDomains, opinterface, enum_reply, NULL);
        <span class="enscript-comment">//enum_reply(client, kDNSServiceFlagsAdd, 0, 0, &quot;nicta.com.au.&quot;, NULL);
</span>        <span class="enscript-comment">//enum_reply(client, kDNSServiceFlagsAdd, 0, 0, &quot;bonjour.nicta.com.au.&quot;, NULL);
</span>        <span class="enscript-comment">//enum_reply(client, kDNSServiceFlagsAdd, 0, 0, &quot;ibm.com.&quot;, NULL);
</span>        <span class="enscript-comment">//enum_reply(client, kDNSServiceFlagsAdd, 0, 0, &quot;dns-sd.ibm.com.&quot;, NULL);
</span>        <span class="enscript-keyword">break</span>;

    <span class="enscript-keyword">case</span> <span class="enscript-string">'B'</span>:   typ = (argc &lt; opi+1) ? <span class="enscript-string">&quot;&quot;</span> : argv[opi+0];
        dom = (argc &lt; opi+2) ? <span class="enscript-string">&quot;&quot;</span> : argv[opi+1];              <span class="enscript-comment">// Missing domain argument is the same as empty string i.e. use system default(s)
</span>        typ = gettype(buffer, typ);
        <span class="enscript-keyword">if</span> (dom[0] == <span class="enscript-string">'.'</span> &amp;&amp; dom[1] == 0) dom[0] = 0;               <span class="enscript-comment">// We allow '.' on the command line as a synonym for empty string
</span>        printf(<span class="enscript-string">&quot;Browsing for %s%s%s\n&quot;</span>, typ, dom[0] ? <span class="enscript-string">&quot;.&quot;</span> : <span class="enscript-string">&quot;&quot;</span>, dom);
        err = DNSServiceBrowse(&amp;client, flags, opinterface, typ, dom, browse_reply, NULL);
        <span class="enscript-keyword">break</span>;

    <span class="enscript-keyword">case</span> <span class="enscript-string">'Z'</span>:   typ = (argc &lt; opi+1) ? <span class="enscript-string">&quot;&quot;</span> : argv[opi+0];
        dom = (argc &lt; opi+2) ? <span class="enscript-string">&quot;&quot;</span> : argv[opi+1];              <span class="enscript-comment">// Missing domain argument is the same as empty string i.e. use system default(s)
</span>        typ = gettype(buffer, typ);
        <span class="enscript-keyword">if</span> (dom[0] == <span class="enscript-string">'.'</span> &amp;&amp; dom[1] == 0) dom[0] = 0;               <span class="enscript-comment">// We allow '.' on the command line as a synonym for empty string
</span>        printf(<span class="enscript-string">&quot;Browsing for %s%s%s\n&quot;</span>, typ, dom[0] ? <span class="enscript-string">&quot;.&quot;</span> : <span class="enscript-string">&quot;&quot;</span>, dom);
        err = DNSServiceCreateConnection(&amp;client);
        <span class="enscript-keyword">if</span> (err) { fprintf(stderr, <span class="enscript-string">&quot;DNSServiceCreateConnection returned %d\n&quot;</span>, err); <span class="enscript-keyword">return</span>(err); }
        sc1 = client;
        err = DNSServiceBrowse(&amp;sc1, kDNSServiceFlagsShareConnection, opinterface, typ, dom, zonedata_browse, NULL);
        <span class="enscript-keyword">break</span>;

    <span class="enscript-keyword">case</span> <span class="enscript-string">'l'</span>:
    <span class="enscript-keyword">case</span> <span class="enscript-string">'L'</span>:   {
        <span class="enscript-keyword">if</span> (argc &lt; opi+2) <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;
        typ = (argc &lt; opi+2) ? <span class="enscript-string">&quot;&quot;</span>      : argv[opi+1];
        dom = (argc &lt; opi+3) ? <span class="enscript-string">&quot;local&quot;</span> : argv[opi+2];
        typ = gettype(buffer, typ);
        <span class="enscript-keyword">if</span> (dom[0] == <span class="enscript-string">'.'</span> &amp;&amp; dom[1] == 0) dom = <span class="enscript-string">&quot;local&quot;</span>;               <span class="enscript-comment">// We allow '.' on the command line as a synonym for &quot;local&quot;
</span>        printf(<span class="enscript-string">&quot;Lookup %s.%s.%s\n&quot;</span>, argv[opi+0], typ, dom);
        <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'l'</span>) flags |= kDNSServiceFlagsWakeOnResolve;
        err = DNSServiceResolve(&amp;client, flags, opinterface, argv[opi+0], typ, dom, resolve_reply, NULL);
        <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">case</span> <span class="enscript-string">'R'</span>:   <span class="enscript-keyword">if</span> (argc &lt; opi+4) <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;
        typ = (argc &lt; opi+2) ? <span class="enscript-string">&quot;&quot;</span> : argv[opi+1];
        dom = (argc &lt; opi+3) ? <span class="enscript-string">&quot;&quot;</span> : argv[opi+2];
        typ = gettype(buffer, typ);
        <span class="enscript-keyword">if</span> (dom[0] == <span class="enscript-string">'.'</span> &amp;&amp; dom[1] == 0) dom[0] = 0;               <span class="enscript-comment">// We allow '.' on the command line as a synonym for empty string
</span>        err = RegisterService(&amp;client, argv[opi+0], typ, dom, NULL, argv[opi+3], argc-(opi+4), argv+(opi+4), flags);
        <span class="enscript-keyword">break</span>;


    <span class="enscript-keyword">case</span> <span class="enscript-string">'P'</span>:   <span class="enscript-keyword">if</span> (argc &lt; opi+6) <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;
        err = DNSServiceCreateConnection(&amp;client_pa);
        <span class="enscript-keyword">if</span> (err) { fprintf(stderr, <span class="enscript-string">&quot;DNSServiceCreateConnection returned %d\n&quot;</span>, err); <span class="enscript-keyword">return</span>(err); }
        err = RegisterProxyAddressRecord(client_pa, argv[opi+4], argv[opi+5], flags);
        <span class="enscript-keyword">if</span> (err) <span class="enscript-keyword">break</span>;
        err = RegisterService(&amp;client, argv[opi+0], gettype(buffer, argv[opi+1]), argv[opi+2], argv[opi+4], argv[opi+3], argc-(opi+6), argv+(opi+6), flags);
        <span class="enscript-keyword">break</span>;

    <span class="enscript-keyword">case</span> <span class="enscript-string">'D'</span>:
    <span class="enscript-keyword">case</span> <span class="enscript-string">'q'</span>:
    <span class="enscript-keyword">case</span> <span class="enscript-string">'Q'</span>:
    <span class="enscript-keyword">case</span> <span class="enscript-string">'C'</span>:   {
        uint16_t rrtype, rrclass;
        flags |= kDNSServiceFlagsReturnIntermediates;
        <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'q'</span>)
            flags |= kDNSServiceFlagsSuppressUnusable;
        <span class="enscript-keyword">if</span> (argc &lt; opi+1) 
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;
        rrtype = (argc &lt;= opi+1) ? kDNSServiceType_A  : GetRRType(argv[opi+1]);
        rrclass = (argc &lt;= opi+2) ? kDNSServiceClass_IN : GetRRClass(argv[opi+2]);
        <span class="enscript-keyword">if</span> (rrtype == kDNSServiceType_TXT || rrtype == kDNSServiceType_PTR)
            flags |= kDNSServiceFlagsLongLivedQuery;
        <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'D'</span>)
        {
            flags |= kDNSServiceFlagsSuppressUnusable;
            <span class="enscript-keyword">if</span> (optional)
                flags |= kDNSServiceFlagsValidateOptional;
            <span class="enscript-keyword">else</span>
                flags |= kDNSServiceFlagsValidate;
        }
        err = DNSServiceQueryRecord(&amp;client, flags, opinterface, argv[opi+0], rrtype, rrclass, qr_reply, NULL);
        <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">case</span> <span class="enscript-string">'A'</span>:
    <span class="enscript-keyword">case</span> <span class="enscript-string">'U'</span>:
    <span class="enscript-keyword">case</span> <span class="enscript-string">'N'</span>:   {
        Opaque16 registerPort = { { 0x12, 0x34 } };
        <span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> TXT[] = <span class="enscript-string">&quot;\xC&quot;</span> <span class="enscript-string">&quot;First String&quot;</span> <span class="enscript-string">&quot;\xD&quot;</span> <span class="enscript-string">&quot;Second String&quot;</span> <span class="enscript-string">&quot;\xC&quot;</span> <span class="enscript-string">&quot;Third String&quot;</span>;
        printf(<span class="enscript-string">&quot;Registering Service Test._testupdate._tcp.local.\n&quot;</span>);
        err = DNSServiceRegister(&amp;client, 0, opinterface, <span class="enscript-string">&quot;Test&quot;</span>, <span class="enscript-string">&quot;_testupdate._tcp.&quot;</span>, <span class="enscript-string">&quot;&quot;</span>, NULL, registerPort.NotAnInteger, <span class="enscript-keyword">sizeof</span>(TXT)-1, TXT, reg_reply, NULL);
        <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">case</span> <span class="enscript-string">'T'</span>:   {
        Opaque16 registerPort = { { 0x23, 0x45 } };
        <span class="enscript-type">char</span> TXT[1024];
        <span class="enscript-type">unsigned</span> <span class="enscript-type">int</span> i;
        <span class="enscript-keyword">for</span> (i=0; i&lt;<span class="enscript-keyword">sizeof</span>(TXT); i++)
            <span class="enscript-keyword">if</span> ((i &amp; 0x1F) == 0) TXT[i] = 0x1F;<span class="enscript-keyword">else</span> TXT[i] = <span class="enscript-string">'A'</span> + (i &gt;&gt; 5);
        printf(<span class="enscript-string">&quot;Registering Service Test._testlargetxt._tcp.local.\n&quot;</span>);
        err = DNSServiceRegister(&amp;client, 0, opinterface, <span class="enscript-string">&quot;Test&quot;</span>, <span class="enscript-string">&quot;_testlargetxt._tcp.&quot;</span>, <span class="enscript-string">&quot;&quot;</span>, NULL, registerPort.NotAnInteger, <span class="enscript-keyword">sizeof</span>(TXT), TXT, reg_reply, NULL);
        <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">case</span> <span class="enscript-string">'M'</span>:   {
        pid_t pid = getpid();
        Opaque16 registerPort = { { pid &gt;&gt; 8, pid &amp; 0xFF } };
        <span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> TXT1[] = <span class="enscript-string">&quot;\xC&quot;</span> <span class="enscript-string">&quot;First String&quot;</span>  <span class="enscript-string">&quot;\xD&quot;</span> <span class="enscript-string">&quot;Second String&quot;</span> <span class="enscript-string">&quot;\xC&quot;</span> <span class="enscript-string">&quot;Third String&quot;</span>;
        <span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> TXT2[] = <span class="enscript-string">&quot;\xD&quot;</span> <span class="enscript-string">&quot;Fourth String&quot;</span> <span class="enscript-string">&quot;\xC&quot;</span> <span class="enscript-string">&quot;Fifth String&quot;</span>  <span class="enscript-string">&quot;\xC&quot;</span> <span class="enscript-string">&quot;Sixth String&quot;</span>;
        printf(<span class="enscript-string">&quot;Registering Service Test._testdualtxt._tcp.local.\n&quot;</span>);
        err = DNSServiceRegister(&amp;client, flags, opinterface, <span class="enscript-string">&quot;Test&quot;</span>, <span class="enscript-string">&quot;_testdualtxt._tcp.&quot;</span>, <span class="enscript-string">&quot;&quot;</span>, NULL, registerPort.NotAnInteger, <span class="enscript-keyword">sizeof</span>(TXT1)-1, TXT1, reg_reply, NULL);
        <span class="enscript-keyword">if</span> (!err) err = DNSServiceAddRecord(client, &amp;record, flags, kDNSServiceType_TXT, <span class="enscript-keyword">sizeof</span>(TXT2)-1, TXT2, 0);
        <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">case</span> <span class="enscript-string">'I'</span>:   {
        pid_t pid = getpid();
        Opaque16 registerPort = { { pid &gt;&gt; 8, pid &amp; 0xFF } };
        <span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> TXT[] = <span class="enscript-string">&quot;\x09&quot;</span> <span class="enscript-string">&quot;Test Data&quot;</span>;
        printf(<span class="enscript-string">&quot;Registering Service Test._testtxt._tcp.local.\n&quot;</span>);
        err = DNSServiceRegister(&amp;client, 0, opinterface, <span class="enscript-string">&quot;Test&quot;</span>, <span class="enscript-string">&quot;_testtxt._tcp.&quot;</span>, <span class="enscript-string">&quot;&quot;</span>, NULL, registerPort.NotAnInteger, 0, NULL, reg_reply, NULL);
        <span class="enscript-keyword">if</span> (!err) err = DNSServiceUpdateRecord(client, NULL, 0, <span class="enscript-keyword">sizeof</span>(TXT)-1, TXT, 0);
        <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">case</span> <span class="enscript-string">'X'</span>:   {
        <span class="enscript-keyword">if</span> (argc == opi)                <span class="enscript-comment">// If no arguments, just fetch IP address
</span>            err = DNSServiceNATPortMappingCreate(&amp;client, 0, 0, 0, 0, 0, 0, port_mapping_create_reply, NULL);
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (argc &gt;= opi+2 &amp;&amp; atoi(argv[opi+0]) == 0)
        {
            DNSServiceProtocol prot  = GetProtocol(argv[opi+0]);                                    <span class="enscript-comment">// Must specify TCP or UDP
</span>            uint16_t IntPortAsNumber = atoi(argv[opi+1]);                                       <span class="enscript-comment">// Must specify internal port
</span>            uint16_t ExtPortAsNumber = (argc &lt; opi+3) ? 0 : atoi(argv[opi+2]);              <span class="enscript-comment">// Optional desired external port
</span>            uint32_t ttl             = (argc &lt; opi+4) ? 0 : atoi(argv[opi+3]);              <span class="enscript-comment">// Optional desired lease lifetime
</span>            Opaque16 intp = { { IntPortAsNumber &gt;&gt; 8, IntPortAsNumber &amp; 0xFF } };
            Opaque16 extp = { { ExtPortAsNumber &gt;&gt; 8, ExtPortAsNumber &amp; 0xFF } };
            err = DNSServiceNATPortMappingCreate(&amp;client, 0, 0, prot, intp.NotAnInteger, extp.NotAnInteger, ttl, port_mapping_create_reply, NULL);
        }
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;
        <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">case</span> <span class="enscript-string">'g'</span>:
    <span class="enscript-keyword">case</span> <span class="enscript-string">'G'</span>:   {
        flags |= kDNSServiceFlagsReturnIntermediates;

        <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'g'</span>)
        {
            flags |= kDNSServiceFlagsSuppressUnusable;
            <span class="enscript-keyword">if</span> (optional)
                flags |= kDNSServiceFlagsValidateOptional;
            <span class="enscript-keyword">else</span>
                flags |= kDNSServiceFlagsValidate;
        }
        <span class="enscript-keyword">if</span> (argc != opi+2) 
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;
        <span class="enscript-keyword">else</span> 
            err = DNSServiceGetAddrInfo(&amp;client, flags, opinterface, GetProtocol(argv[opi+0]), argv[opi+1], addrinfo_reply, NULL);
        <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">case</span> <span class="enscript-string">'S'</span>:   {
        Opaque16 registerPort = { { 0x23, 0x45 } };                 <span class="enscript-comment">// 9029 decimal
</span>        <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> txtrec[16] = <span class="enscript-string">&quot;\xF&quot;</span> <span class="enscript-string">&quot;/path=test.html&quot;</span>;
        DNSRecordRef rec;
        <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> nulrec[4] = <span class="enscript-string">&quot;1234&quot;</span>;

        err = DNSServiceCreateConnection(&amp;client);
        <span class="enscript-keyword">if</span> (err) { fprintf(stderr, <span class="enscript-string">&quot;DNSServiceCreateConnection failed %ld\n&quot;</span>, (<span class="enscript-type">long</span> <span class="enscript-type">int</span>)err); <span class="enscript-keyword">return</span> (-1); }

        sc1 = client;
        err = DNSServiceBrowse(&amp;sc1, kDNSServiceFlagsShareConnection, opinterface, <span class="enscript-string">&quot;_http._tcp&quot;</span>, <span class="enscript-string">&quot;&quot;</span>, browse_reply, NULL);
        <span class="enscript-keyword">if</span> (err) { fprintf(stderr, <span class="enscript-string">&quot;DNSServiceBrowse _http._tcp failed %ld\n&quot;</span>, (<span class="enscript-type">long</span> <span class="enscript-type">int</span>)err); <span class="enscript-keyword">return</span> (-1); }

        sc2 = client;
        err = DNSServiceBrowse(&amp;sc2, kDNSServiceFlagsShareConnection, opinterface, <span class="enscript-string">&quot;_ftp._tcp&quot;</span>, <span class="enscript-string">&quot;&quot;</span>, browse_reply, NULL);
        <span class="enscript-keyword">if</span> (err) { fprintf(stderr, <span class="enscript-string">&quot;DNSServiceBrowse _ftp._tcp failed %ld\n&quot;</span>, (<span class="enscript-type">long</span> <span class="enscript-type">int</span>)err); <span class="enscript-keyword">return</span> (-1); }

        sc3 = client;
        err = DNSServiceRegister(&amp;sc3, kDNSServiceFlagsShareConnection, opinterface, <span class="enscript-string">&quot;kDNSServiceFlagsShareConnection&quot;</span>,
                                 <span class="enscript-string">&quot;_http._tcp&quot;</span>, <span class="enscript-string">&quot;local&quot;</span>, NULL, registerPort.NotAnInteger, 0, NULL, reg_reply, NULL);
        <span class="enscript-keyword">if</span> (err) { fprintf(stderr, <span class="enscript-string">&quot;SharedConnection DNSServiceRegister failed %ld\n&quot;</span>, (<span class="enscript-type">long</span> <span class="enscript-type">int</span>)err); <span class="enscript-keyword">return</span> (-1); }

        err = DNSServiceUpdateRecord(sc3, NULL, 0, <span class="enscript-keyword">sizeof</span>(txtrec), txtrec, 0);
        <span class="enscript-keyword">if</span> (err) { fprintf(stderr, <span class="enscript-string">&quot;SharedConnection DNSServiceUpdateRecord failed %ld\n&quot;</span>, (<span class="enscript-type">long</span> <span class="enscript-type">int</span>)err); <span class="enscript-keyword">return</span> (-1); }

        err = DNSServiceAddRecord(sc3, &amp;rec, 0, kDNSServiceType_NULL, <span class="enscript-keyword">sizeof</span>(nulrec), nulrec, 0);
        <span class="enscript-keyword">if</span> (err) { fprintf(stderr, <span class="enscript-string">&quot;SharedConnection DNSServiceAddRecord failed %ld\n&quot;</span>, (<span class="enscript-type">long</span> <span class="enscript-type">int</span>)err); <span class="enscript-keyword">return</span> (-1); }

        err = DNSServiceRemoveRecord(sc3, rec, 0);
        <span class="enscript-keyword">if</span> (err) { fprintf(stderr, <span class="enscript-string">&quot;SharedConnection DNSServiceRemoveRecord failed %ld\n&quot;</span>, (<span class="enscript-type">long</span> <span class="enscript-type">int</span>)err); <span class="enscript-keyword">return</span> (-1); }

        <span class="enscript-keyword">break</span>;
    }

    <span class="enscript-keyword">case</span> <span class="enscript-string">'V'</span>:   {
        uint32_t v;
        uint32_t size = <span class="enscript-keyword">sizeof</span>(v);
        err = DNSServiceGetProperty(kDNSServiceProperty_DaemonVersion, &amp;v, &amp;size);
        <span class="enscript-keyword">if</span> (err) fprintf(stderr, <span class="enscript-string">&quot;DNSServiceGetProperty failed %ld\n&quot;</span>, (<span class="enscript-type">long</span> <span class="enscript-type">int</span>)err);
        <span class="enscript-keyword">else</span> printf(<span class="enscript-string">&quot;Currently running daemon (system service) is version %d.%d.%d\n&quot;</span>,  v / 10000, v / 100 % 100, v % 100);
        exit(0);
    }
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>
    <span class="enscript-keyword">case</span> <span class="enscript-string">'O'</span>: {
        <span class="enscript-comment">// check if the user specifies the flag &quot;-compress&quot;
</span>        uint8_t if_compress_state_dump = 0;
        uint8_t if_dump_to_stdout = 0;

        <span class="enscript-keyword">if</span> (argc &gt; opi+1) {
            printf(<span class="enscript-string">&quot;dns-sd: illegal option count\n&quot;</span>);
            <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;
        }
        
        <span class="enscript-keyword">if</span> (argc == opi+1) {
            <span class="enscript-type">const</span> <span class="enscript-type">char</span> *param = argv[opi];
            <span class="enscript-keyword">if</span> (strcasecmp(<span class="enscript-string">&quot;-compress&quot;</span>, param) == 0) {
                if_compress_state_dump = 1;
            } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcasecmp(<span class="enscript-string">&quot;-stdout&quot;</span>, param) == 0) {
                if_dump_to_stdout = 1;
            } <span class="enscript-keyword">else</span> {
                printf(<span class="enscript-string">&quot;dns-sd: illegal option %s \n&quot;</span>, param);
                <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;
            }
        }
        handle_state_dump_request(if_compress_state_dump, if_dump_to_stdout);
        err = kDNSServiceErr_NoError;
        <span class="enscript-keyword">break</span>;
    }
#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>

    <span class="enscript-keyword">case</span> <span class="enscript-string">'H'</span>: <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;

    <span class="enscript-reference">default</span>: <span class="enscript-keyword">goto</span> <span class="enscript-reference">Fail</span>;
    }
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>
    <span class="enscript-comment">// state dump does not need to create DNSServiceRef, so we can return directly here without cleaning up.
</span>    <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'O'</span>)
        <span class="enscript-keyword">return</span> 0;
#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>

    <span class="enscript-keyword">if</span> (!client || err != kDNSServiceErr_NoError)
    {
        fprintf(stderr, <span class="enscript-string">&quot;DNSService call failed %ld%s\n&quot;</span>, (<span class="enscript-type">long</span> <span class="enscript-type">int</span>)err,
            (err == kDNSServiceErr_ServiceNotRunning) ? <span class="enscript-string">&quot; (Service Not Running)&quot;</span> : <span class="enscript-string">&quot;&quot;</span>);
        <span class="enscript-keyword">return</span> (-1);
    }
    printtimestamp();
    printf(<span class="enscript-string">&quot;...STARTING...\n&quot;</span>);
    HandleEvents();

    <span class="enscript-comment">// Be sure to deallocate the DNSServiceRef when you're finished
</span>    <span class="enscript-keyword">if</span> (client   ) DNSServiceRefDeallocate(client   );
    <span class="enscript-keyword">if</span> (client_pa) DNSServiceRefDeallocate(client_pa);
    <span class="enscript-keyword">return</span> 0;

<span class="enscript-reference">Fail</span>:
    <span class="enscript-keyword">if</span> (operation == <span class="enscript-string">'H'</span>) print_usage(a0,1);
    <span class="enscript-keyword">else</span> print_usage(a0,0);
    <span class="enscript-keyword">return</span> 0;
}

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>
<span class="enscript-comment">/*
 *  if_compress_state_dump and if_dump_to_stdout cannot be set at the same time.
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">void</span> <span class="enscript-function-name">handle_state_dump_request</span>(uint8_t if_compress_state_dump, uint8_t if_dump_to_stdout)
{
    <span class="enscript-comment">// create xpc connection to the xpc server for log utility
</span>    xpc_connection_t log_utility_connection =  xpc_connection_create_mach_service(kDNSLogUtilityService, dispatch_get_main_queue(), XPC_CONNECTION_MACH_SERVICE_PRIVILEGED);
    xpc_connection_set_event_handler(log_utility_connection, ^(xpc_object_t event){
        printf(<span class="enscript-string">&quot;Connecting to %s, status: %s\n&quot;</span>, kDNSLogUtilityService, xpc_dictionary_get_string(event, XPC_ERROR_KEY_DESCRIPTION));
    });
    xpc_connection_resume(log_utility_connection);

    <span class="enscript-comment">// set option for the state dump
</span>    xpc_object_t xpc_dict = xpc_dictionary_create(NULL, NULL, 0);
    uint64_t dump_option;
    <span class="enscript-keyword">if</span> (if_compress_state_dump) {
        dump_option = full_state_with_compression;
    }
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (if_dump_to_stdout) {
        <span class="enscript-comment">// we pass the stdout directly to xpc server
</span>        dump_option = full_state_to_stdout;
        xpc_dictionary_set_fd(xpc_dict, kDNSStateDumpFD, STDOUT_FILENO);
    }
    <span class="enscript-keyword">else</span> {
        dump_option = full_state;
    }

    xpc_dictionary_set_uint64(xpc_dict, kDNSStateDump, dump_option);

    <span class="enscript-comment">// send the request and handle the response from xpc server
</span>    xpc_connection_send_message_with_reply(log_utility_connection, xpc_dict, dispatch_get_main_queue(), ^(xpc_object_t recv_msg){
        xpc_type_t msg_type = xpc_get_type(recv_msg);

        <span class="enscript-keyword">if</span> (msg_type != XPC_TYPE_DICTIONARY) {
            printf(<span class="enscript-string">&quot;Received unexpected reply from daemon, error: \&quot;%s\&quot;\nUnexpected reply Contents:\n%s\n&quot;</span>,
                   xpc_dictionary_get_string(recv_msg, XPC_ERROR_KEY_DESCRIPTION), xpc_copy_description(recv_msg));
            exit(1);
        }

        <span class="enscript-comment">// get the response dictionary
</span>        uint32_t return_code = (uint32_t)xpc_dictionary_get_uint64(recv_msg, kDNSDaemonReply);
        <span class="enscript-keyword">if</span> (return_code != kDNSMsg_NoError) {
            <span class="enscript-type">const</span> <span class="enscript-type">char</span> *error_description = xpc_dictionary_get_string(recv_msg, kDNSErrorDescription);
            printf(<span class="enscript-string">&quot;XPC service returns error, description: %s\n&quot;</span>, error_description);
            exit(1);
        }

        <span class="enscript-comment">// print the state information returned from the XPC server
</span>        <span class="enscript-keyword">if</span> (dump_option != full_state_to_stdout) {
            <span class="enscript-type">const</span> <span class="enscript-type">char</span> *path = xpc_dictionary_get_string(recv_msg, kDNSDumpFilePath);
            printf(<span class="enscript-string">&quot;State Dump Is Saved to: %s\n&quot;</span>, path);
        }

        int64_t time_used = xpc_dictionary_get_int64(recv_msg, kDNSStateDumpTimeUsed);
        printf(<span class="enscript-string">&quot;             Time Used: %&quot;</span> PRId64 <span class="enscript-string">&quot; ms\n&quot;</span>, time_used);

        xpc_release(xpc_dict);
        exit(0);
    });

    dispatch_main();
}
#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">APPLE_OSX_mDNSResponder</span>

<span class="enscript-comment">// Note: The C preprocessor stringify operator ('#') makes a string from its argument, without macro expansion
</span><span class="enscript-comment">// e.g. If &quot;version&quot; is #define'd to be &quot;4&quot;, then STRINGIFY_AWE(version) will return the string &quot;version&quot;, not &quot;4&quot;
</span><span class="enscript-comment">// To expand &quot;version&quot; to its value before making the string, use STRINGIFY(version) instead
</span>#<span class="enscript-reference">define</span> <span class="enscript-function-name">STRINGIFY_ARGUMENT_WITHOUT_EXPANSION</span>(s) # s
#<span class="enscript-reference">define</span> <span class="enscript-function-name">STRINGIFY</span>(s) STRINGIFY_ARGUMENT_WITHOUT_EXPANSION(s)

<span class="enscript-comment">// NOT static -- otherwise the compiler may optimize it out
</span><span class="enscript-comment">// The &quot;@(#) &quot; pattern is a special prefix the &quot;what&quot; command looks for
</span><span class="enscript-type">const</span> <span class="enscript-type">char</span> VersionString_SCCS[] = <span class="enscript-string">&quot;@(#) dns-sd &quot;</span> STRINGIFY(mDNSResponderVersion) <span class="enscript-string">&quot; (&quot;</span> __DATE__ <span class="enscript-string">&quot; &quot;</span> __TIME__ <span class="enscript-string">&quot;)&quot;</span>;

#<span class="enscript-reference">if</span> <span class="enscript-variable-name">_BUILDING_XCODE_PROJECT_</span>
<span class="enscript-comment">// If the process crashes, then this string will be magically included in the automatically-generated crash log
</span><span class="enscript-type">const</span> <span class="enscript-type">char</span> *__crashreporter_info__ = VersionString_SCCS + 5;
<span class="enscript-function-name">asm</span> (<span class="enscript-string">&quot;.desc ___crashreporter_info__, 0x10&quot;</span>);
#<span class="enscript-reference">endif</span>
</pre>
<hr />
</body></html>