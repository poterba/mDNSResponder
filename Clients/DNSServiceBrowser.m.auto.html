<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>DNSServiceBrowser.m</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">DNSServiceBrowser.m&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="DNSServiceBrowser.m">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
/* -*- Mode: C; tab-width: 4 -*-
 *
 * Copyright (c) 2002-2003 Apple Computer, Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may <span class="enscript-type">not</span> use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>
 * 
 * Unless required by applicable law <span class="enscript-type">or</span> agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express <span class="enscript-type">or</span> implied.
 * See the License <span class="enscript-keyword">for</span> the specific language governing permissions <span class="enscript-type">and</span>
 * limitations under the License.
 */

#import &lt;Cocoa/Cocoa.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;net/<span class="enscript-keyword">if</span>.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;netdb.h&gt;
#include &lt;sys/select.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;unistd.h&gt;
#include &lt;dns_sd.h&gt;

@<span class="enscript-type">class</span> ServiceController;  // holds state corresponding to outstanding DNSServiceRef

@interface BrowserController : NSObject
{
    IBOutlet id nameField;
    IBOutlet id typeField;

    IBOutlet id serviceDisplayTable;
    IBOutlet id typeColumn;
    IBOutlet id nameColumn;
    IBOutlet id serviceTypeField;
    IBOutlet id serviceNameField;

    IBOutlet id hostField;
    IBOutlet id ipAddressField;
    IBOutlet id ip6AddressField;
    IBOutlet id portField;
    IBOutlet id interfaceField;
    IBOutlet id textField;
    
    NSMutableArray *_srvtypeKeys;
    NSMutableArray *_srvnameKeys;
    NSMutableArray *_sortedServices;
    NSMutableDictionary *_servicesDict;

	ServiceController *_serviceBrowser;
	ServiceController *_serviceResolver;
	ServiceController *_ipv4AddressResolver;
	ServiceController *_ipv6AddressResolver;
}

- (void)notifyTypeSelectionChange:(NSNotification*)note;
- (void)notifyNameSelectionChange:(NSNotification*)note;

- (IBAction)connect:(id)sender;

- (IBAction)handleTableClick:(id)sender;
- (IBAction)removeSelected:(id)sender;
- (IBAction)addNewService:(id)sender;

- (IBAction)update:(NSString *)Type;

- (void)updateBrowseWithName:(const <span class="enscript-type">char</span> *)name <span class="enscript-type">type</span>:(const <span class="enscript-type">char</span> *)resulttype domain:(const <span class="enscript-type">char</span> *)domain interface:(uint32_t)interface flags:(DNSServiceFlags)flags;
- (void)resolveClientWitHost:(NSString *)host port:(uint16_t)port interfaceIndex:(uint32_t)interface txtRecord:(const <span class="enscript-type">char</span>*)txtRecord txtLen:(uint16_t)txtLen;
- (void)updateAddress:(uint16_t)rrtype addr:(const void *)buff addrLen:(uint16_t)addrLen host:(const <span class="enscript-type">char</span>*)host interfaceIndex:(uint32_t)interface <span class="enscript-type">more</span>:(boolean_t)moreToCome;

- (void)_cancelPendingResolve;
- (void)_clearResolvedInfo;

@<span class="enscript-keyword">end</span>

// The ServiceController manages cleanup of DNSServiceRef &amp; runloop info <span class="enscript-keyword">for</span> an outstanding request
@interface ServiceController : NSObject
{
	DNSServiceRef       fServiceRef;
	CFSocketRef         fSocketRef;
	CFRunLoopSourceRef  fRunloopSrc;
}

- (id)initWithServiceRef:(DNSServiceRef)ref;
- (void)addToCurrentRunLoop;
- (DNSServiceRef)serviceRef;
- (void)dealloc;

@<span class="enscript-keyword">end</span> // interface ServiceController


static void
ProcessSockData(CFSocketRef s, CFSocketCallBackType <span class="enscript-type">type</span>, CFDataRef address, const void *data, void *info)
{
	DNSServiceRef serviceRef = (DNSServiceRef)info;
	DNSServiceErrorType err = DNSServiceProcessResult(serviceRef);
	<span class="enscript-keyword">if</span> (err != kDNSServiceErr_NoError) {
		printf(&quot;DNSServiceProcessResult() returned an <span class="enscript-keyword">error</span>! <span class="enscript-comment">%d\n&quot;, err);
</span>    }
}


static void
ServiceBrowseReply(DNSServiceRef sdRef, DNSServiceFlags servFlags, uint32_t interfaceIndex, DNSServiceErrorType errorCode, 
    const <span class="enscript-type">char</span> *serviceName, const <span class="enscript-type">char</span> *regtype, const <span class="enscript-type">char</span> *replyDomain, void *context)
{
	<span class="enscript-keyword">if</span> (errorCode == kDNSServiceErr_NoError) {
		<span class="enscript-type">[</span>(BrowserController*)context updateBrowseWithName:serviceName <span class="enscript-type">type</span>:regtype domain:replyDomain interface:interfaceIndex flags:servFlags<span class="enscript-type">]</span>;
	} <span class="enscript-keyword">else</span> {
		printf(&quot;ServiceBrowseReply got an <span class="enscript-keyword">error</span>! <span class="enscript-comment">%d\n&quot;, errorCode);
</span>	}
}


static void
ServiceResolveReply(DNSServiceRef sdRef, DNSServiceFlags flags, uint32_t interfaceIndex, DNSServiceErrorType errorCode,
    const <span class="enscript-type">char</span> *fullname, const <span class="enscript-type">char</span> *hosttarget, uint16_t port, uint16_t txtLen, const <span class="enscript-type">char</span> *txtRecord, void *context)
{
	<span class="enscript-keyword">if</span> (errorCode == kDNSServiceErr_NoError) {
		<span class="enscript-type">[</span>(BrowserController*)context resolveClientWitHost:<span class="enscript-type">[</span>NSString stringWithUTF8String:hosttarget<span class="enscript-type">]</span> port:port interfaceIndex:interfaceIndex txtRecord:txtRecord txtLen:txtLen<span class="enscript-type">]</span>;
	} <span class="enscript-keyword">else</span> {
		printf(&quot;ServiceResolveReply got an <span class="enscript-keyword">error</span>! <span class="enscript-comment">%d\n&quot;, errorCode);
</span>	}
}


static void
QueryRecordReply(DNSServiceRef DNSServiceRef, DNSServiceFlags flags, uint32_t interfaceIndex, DNSServiceErrorType errorCode,
    const <span class="enscript-type">char</span> *fullname, uint16_t rrtype, uint16_t rrclass,  uint16_t rdlen, const void *rdata, uint32_t ttl, void *context)
{
    <span class="enscript-keyword">if</span> (errorCode == kDNSServiceErr_NoError) {
        <span class="enscript-type">[</span>(BrowserController*)context updateAddress:rrtype addr:rdata addrLen:rdlen host:fullname interfaceIndex:interfaceIndex <span class="enscript-type">more</span>:(flags &amp; kDNSServiceFlagsMoreComing)<span class="enscript-type">]</span>;
    } <span class="enscript-keyword">else</span> {
        printf(&quot;QueryRecordReply got an <span class="enscript-keyword">error</span>! <span class="enscript-comment">%d\n&quot;, errorCode);
</span>    }
}


static void
InterfaceIndexToName(uint32_t interface, <span class="enscript-type">char</span> *interfaceName)
{
    assert(interfaceName);
    
    <span class="enscript-keyword">if</span> (interface == kDNSServiceInterfaceIndexAny) {
        // All active network interfaces.
        strlcpy(interfaceName, &quot;<span class="enscript-type">all</span>&quot;, IF_NAMESIZE);
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (interface == kDNSServiceInterfaceIndexLocalOnly) {
        // Only available locally on this machine.
        strlcpy(interfaceName, &quot;local&quot;, IF_NAMESIZE);
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (interface == kDNSServiceInterfaceIndexP2P) {
        // Peer-to-peer.
        strlcpy(interfaceName, &quot;p2p&quot;, IF_NAMESIZE);
    } <span class="enscript-keyword">else</span> {
        // Converts interface index to interface name.
        if_indextoname(interface, interfaceName);
    }
}


@implementation BrowserController		//Begin implementation of BrowserController methods

- (void)registerDefaults
{
    NSMutableDictionary *regDict = <span class="enscript-type">[</span>NSMutableDictionary dictionary<span class="enscript-type">]</span>;

    NSArray *typeArray = <span class="enscript-type">[</span>NSArray arrayWithObjects:@&quot;_afpovertcp._tcp&quot;,
                                                   @&quot;_smb._tcp&quot;,
                                                   @&quot;_rfb._tcp&quot;,
												   @&quot;_ssh._tcp&quot;,
                                                   @&quot;_ftp._tcp&quot;,
												   @&quot;_http._tcp&quot;,
												   @&quot;_printer._tcp&quot;,
                                                   @&quot;_ipp._tcp&quot;,
                                                   @&quot;_airport._tcp&quot;,
												   @&quot;_presence._tcp&quot;,
												   @&quot;_daap._tcp&quot;,
												   @&quot;_dpap._tcp&quot;,
                                                   nil<span class="enscript-type">]</span>;
                                                   
    NSArray *nameArray = <span class="enscript-type">[</span>NSArray arrayWithObjects:@&quot;AppleShare Servers&quot;,
                                                   @&quot;Windows Sharing&quot;,
                                                   @&quot;Screen Sharing&quot;,
	                                               @&quot;Secure Shell&quot;,
                                                   @&quot;FTP Servers&quot;,
	                                               @&quot;Web Servers&quot;,
	                                               @&quot;LPR Printers&quot;,
                                                   @&quot;IPP Printers&quot;,
                                                   @&quot;AirPort Base Stations&quot;,
												   @&quot;iChat Buddies&quot;,
												   @&quot;iTunes Libraries&quot;,
												   @&quot;iPhoto Libraries&quot;,
                                                   nil<span class="enscript-type">]</span>;

    <span class="enscript-type">[</span>regDict setObject:typeArray forKey:@&quot;SrvTypeKeys&quot;<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>regDict setObject:nameArray forKey:@&quot;SrvNameKeys&quot;<span class="enscript-type">]</span>;

    <span class="enscript-type">[</span><span class="enscript-type">[</span>NSUserDefaults standardUserDefaults<span class="enscript-type">]</span> registerDefaults:regDict<span class="enscript-type">]</span>;
}


- (id)init
{
    self = <span class="enscript-type">[</span>super init<span class="enscript-type">]</span>;
    <span class="enscript-keyword">if</span> (self) {
        _srvtypeKeys = nil;
        _srvnameKeys = nil;
        _serviceBrowser = nil;
        _serviceResolver = nil;
        _ipv4AddressResolver = nil;
        _ipv6AddressResolver = nil;
        _sortedServices = <span class="enscript-type">[</span><span class="enscript-type">[</span>NSMutableArray alloc<span class="enscript-type">]</span> init<span class="enscript-type">]</span>;
        _servicesDict = <span class="enscript-type">[</span><span class="enscript-type">[</span>NSMutableDictionary alloc<span class="enscript-type">]</span> init<span class="enscript-type">]</span>;
    }
    <span class="enscript-keyword">return</span> self;
}


- (void)awakeFromNib
{
    <span class="enscript-type">[</span>typeField sizeLastColumnToFit<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>nameField sizeLastColumnToFit<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>nameField setDoubleAction:@selector(connect:)<span class="enscript-type">]</span>;

    <span class="enscript-type">[</span><span class="enscript-type">[</span>NSNotificationCenter defaultCenter<span class="enscript-type">]</span> addObserver:self selector:@selector(notifyTypeSelectionChange:) name:NSTableViewSelectionDidChangeNotification object:typeField<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span><span class="enscript-type">[</span>NSNotificationCenter defaultCenter<span class="enscript-type">]</span> addObserver:self selector:@selector(notifyNameSelectionChange:) name:NSTableViewSelectionDidChangeNotification object:nameField<span class="enscript-type">]</span>;
    
    _srvtypeKeys = <span class="enscript-type">[</span><span class="enscript-type">[</span><span class="enscript-type">[</span>NSUserDefaults standardUserDefaults<span class="enscript-type">]</span> arrayForKey:@&quot;SrvTypeKeys&quot;<span class="enscript-type">]</span> mutableCopy<span class="enscript-type">]</span>;
    _srvnameKeys = <span class="enscript-type">[</span><span class="enscript-type">[</span><span class="enscript-type">[</span>NSUserDefaults standardUserDefaults<span class="enscript-type">]</span> arrayForKey:@&quot;SrvNameKeys&quot;<span class="enscript-type">]</span> mutableCopy<span class="enscript-type">]</span>;

    <span class="enscript-keyword">if</span> (!_srvtypeKeys || !_srvnameKeys) {
        <span class="enscript-type">[</span>_srvtypeKeys release<span class="enscript-type">]</span>;
        <span class="enscript-type">[</span>_srvnameKeys release<span class="enscript-type">]</span>;
        <span class="enscript-type">[</span>self registerDefaults<span class="enscript-type">]</span>;
        _srvtypeKeys = <span class="enscript-type">[</span><span class="enscript-type">[</span><span class="enscript-type">[</span>NSUserDefaults standardUserDefaults<span class="enscript-type">]</span> arrayForKey:@&quot;SrvTypeKeys&quot;<span class="enscript-type">]</span> mutableCopy<span class="enscript-type">]</span>;
        _srvnameKeys = <span class="enscript-type">[</span><span class="enscript-type">[</span><span class="enscript-type">[</span>NSUserDefaults standardUserDefaults<span class="enscript-type">]</span> arrayForKey:@&quot;SrvNameKeys&quot;<span class="enscript-type">]</span> mutableCopy<span class="enscript-type">]</span>;
    }
    
    <span class="enscript-type">[</span>typeField reloadData<span class="enscript-type">]</span>;
}


- (void)dealloc
{
    <span class="enscript-type">[</span>_srvtypeKeys release<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>_srvnameKeys release<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>_servicesDict release<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>_sortedServices release<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>super dealloc<span class="enscript-type">]</span>;
}


-(void)tableView:(NSTableView *)theTableView setObjectValue:(id)object forTableColumn:(NSTableColumn *)tableColumn row:(int)row
{
    <span class="enscript-keyword">if</span> (row &lt; 0) <span class="enscript-keyword">return</span>;
}


- (int)numberOfRowsInTableView:(NSTableView *)theTableView	//Begin mandatory TableView methods
{
    <span class="enscript-keyword">if</span> (theTableView == typeField) {
        <span class="enscript-keyword">return</span> <span class="enscript-type">[</span>_srvnameKeys count<span class="enscript-type">]</span>;
    }
    <span class="enscript-keyword">if</span> (theTableView == nameField) {
        <span class="enscript-keyword">return</span> <span class="enscript-type">[</span>_servicesDict count<span class="enscript-type">]</span>;
    }
    <span class="enscript-keyword">if</span> (theTableView == serviceDisplayTable) {
        <span class="enscript-keyword">return</span> <span class="enscript-type">[</span>_srvnameKeys count<span class="enscript-type">]</span>;
    }
    <span class="enscript-keyword">return</span> 0;
}


- (id)tableView:(NSTableView *)theTableView objectValueForTableColumn:(NSTableColumn *)theColumn row:(int)rowIndex
{
    <span class="enscript-keyword">if</span> (theTableView == typeField) {
        <span class="enscript-keyword">return</span> <span class="enscript-type">[</span>_srvnameKeys objectAtIndex:rowIndex<span class="enscript-type">]</span>;
    }
    <span class="enscript-keyword">if</span> (theTableView == nameField) {
        <span class="enscript-keyword">return</span> <span class="enscript-type">[</span><span class="enscript-type">[</span>_servicesDict objectForKey:<span class="enscript-type">[</span>_sortedServices objectAtIndex:rowIndex<span class="enscript-type">]</span><span class="enscript-type">]</span> name<span class="enscript-type">]</span>;
    }
    <span class="enscript-keyword">if</span> (theTableView == serviceDisplayTable) {
        <span class="enscript-keyword">if</span> (theColumn == typeColumn) {
            <span class="enscript-keyword">return</span> <span class="enscript-type">[</span>_srvtypeKeys objectAtIndex:rowIndex<span class="enscript-type">]</span>;
        }
        <span class="enscript-keyword">if</span> (theColumn == nameColumn) {
            <span class="enscript-keyword">return</span> <span class="enscript-type">[</span>_srvnameKeys objectAtIndex:rowIndex<span class="enscript-type">]</span>;
        }
        <span class="enscript-keyword">return</span> nil;
    }
    
    <span class="enscript-keyword">return</span> nil;
}


- (void)notifyTypeSelectionChange:(NSNotification*)note
{
    <span class="enscript-type">[</span>self _cancelPendingResolve<span class="enscript-type">]</span>;

    int index = <span class="enscript-type">[</span><span class="enscript-type">[</span>note object<span class="enscript-type">]</span> selectedRow<span class="enscript-type">]</span>;
    <span class="enscript-keyword">if</span> (index != -1) {
        <span class="enscript-type">[</span>self update:<span class="enscript-type">[</span>_srvtypeKeys objectAtIndex:index<span class="enscript-type">]</span><span class="enscript-type">]</span>;
    } <span class="enscript-keyword">else</span> {
        <span class="enscript-type">[</span>self update:nil<span class="enscript-type">]</span>;
    }
}


- (void)notifyNameSelectionChange:(NSNotification*)note
{
    <span class="enscript-type">[</span>self _cancelPendingResolve<span class="enscript-type">]</span>;
    
    int index = <span class="enscript-type">[</span><span class="enscript-type">[</span>note object<span class="enscript-type">]</span> selectedRow<span class="enscript-type">]</span>;
    <span class="enscript-keyword">if</span> (index == -1) {
		<span class="enscript-keyword">return</span>;
	}
    
    // Get the currently selected service
    NSNetService *service = <span class="enscript-type">[</span>_servicesDict objectForKey:<span class="enscript-type">[</span>_sortedServices objectAtIndex:index<span class="enscript-type">]</span><span class="enscript-type">]</span>;
	
    DNSServiceRef serviceRef;
	DNSServiceErrorType err = DNSServiceResolve(&amp;serviceRef,
                                         (DNSServiceFlags)0,
                               kDNSServiceInterfaceIndexAny,
                  (const <span class="enscript-type">char</span> *)<span class="enscript-type">[</span><span class="enscript-type">[</span>service name<span class="enscript-type">]</span> UTF8String<span class="enscript-type">]</span>,
                 (const <span class="enscript-type">char</span> *)<span class="enscript-type">[</span><span class="enscript-type">[</span>service <span class="enscript-type">type</span><span class="enscript-type">]</span>  UTF8String<span class="enscript-type">]</span>,
                (const <span class="enscript-type">char</span> *)<span class="enscript-type">[</span><span class="enscript-type">[</span>service domain<span class="enscript-type">]</span> UTF8String<span class="enscript-type">]</span>,
                (DNSServiceResolveReply)ServiceResolveReply,
                                                      self);
        
	<span class="enscript-keyword">if</span> (kDNSServiceErr_NoError == err) {
		_serviceResolver = <span class="enscript-type">[</span><span class="enscript-type">[</span>ServiceController alloc<span class="enscript-type">]</span> initWithServiceRef:serviceRef<span class="enscript-type">]</span>;
		<span class="enscript-type">[</span>_serviceResolver addToCurrentRunLoop<span class="enscript-type">]</span>;
	}
}


- (IBAction)update:(NSString *)theType
{
    <span class="enscript-type">[</span>_servicesDict removeAllObjects<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>_sortedServices removeAllObjects<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>nameField reloadData<span class="enscript-type">]</span>;

    // <span class="enscript-type">get</span> rid of the previous browser <span class="enscript-keyword">if</span> one exists
    <span class="enscript-keyword">if</span> (_serviceBrowser != nil) {
		<span class="enscript-type">[</span>_serviceBrowser release<span class="enscript-type">]</span>;
        _serviceBrowser = nil;
    }
    
    <span class="enscript-keyword">if</span> (theType) {
        DNSServiceRef serviceRef;
        DNSServiceErrorType err = DNSServiceBrowse(&amp;serviceRef, (DNSServiceFlags)0, 0, <span class="enscript-type">[</span>theType UTF8String<span class="enscript-type">]</span>, NULL, ServiceBrowseReply, self);
        <span class="enscript-keyword">if</span> (kDNSServiceErr_NoError == err) {
            _serviceBrowser = <span class="enscript-type">[</span><span class="enscript-type">[</span>ServiceController alloc<span class="enscript-type">]</span> initWithServiceRef:serviceRef<span class="enscript-type">]</span>;
            <span class="enscript-type">[</span>_serviceBrowser addToCurrentRunLoop<span class="enscript-type">]</span>;
        }
    }
}


- (BOOL)applicationShouldTerminateAfterLastWindowClosed:(NSApplication *)theApplication
{
    <span class="enscript-keyword">return</span> YES;
}


- (void)updateBrowseWithName:(const <span class="enscript-type">char</span> *)name <span class="enscript-type">type</span>:(const <span class="enscript-type">char</span> *)<span class="enscript-type">type</span> domain:(const <span class="enscript-type">char</span> *)domain interface:(uint32_t)interface flags:(DNSServiceFlags)flags
{
    NSString *key = <span class="enscript-type">[</span>NSString stringWithFormat:@&quot;<span class="enscript-comment">%s.%s%s%d&quot;, name, type, domain, interface];
</span>    NSNetService *service = <span class="enscript-type">[</span><span class="enscript-type">[</span>NSNetService alloc<span class="enscript-type">]</span> initWithDomain:<span class="enscript-type">[</span>NSString stringWithUTF8String:domain<span class="enscript-type">]</span> <span class="enscript-type">type</span>:<span class="enscript-type">[</span>NSString stringWithUTF8String:<span class="enscript-type">type</span><span class="enscript-type">]</span> name:<span class="enscript-type">[</span>NSString stringWithUTF8String:name<span class="enscript-type">]</span><span class="enscript-type">]</span>;
    
    <span class="enscript-keyword">if</span> (flags &amp; kDNSServiceFlagsAdd) {
        <span class="enscript-type">[</span>_servicesDict setObject:service forKey:key<span class="enscript-type">]</span>;
    } <span class="enscript-keyword">else</span> {
        <span class="enscript-type">[</span>_servicesDict removeObjectForKey:key<span class="enscript-type">]</span>;
    }

    // If <span class="enscript-type">not</span> expecting <span class="enscript-type">any</span> <span class="enscript-type">more</span> data, then reload (redraw) TableView with newly found data
    <span class="enscript-keyword">if</span> (!(flags &amp; kDNSServiceFlagsMoreComing)) {
    
        // Save the current TableView selection
        int index = <span class="enscript-type">[</span>nameField selectedRow<span class="enscript-type">]</span>;
        NSString *selected = (index != -1) ? <span class="enscript-type">[</span><span class="enscript-type">[</span>_sortedServices objectAtIndex:index<span class="enscript-type">]</span> copy<span class="enscript-type">]</span> : nil;
        
        <span class="enscript-type">[</span>_sortedServices release<span class="enscript-type">]</span>;
        _sortedServices = <span class="enscript-type">[</span><span class="enscript-type">[</span>_servicesDict allKeys<span class="enscript-type">]</span> mutableCopy<span class="enscript-type">]</span>;        
        <span class="enscript-type">[</span>_sortedServices sortUsingSelector:@selector(caseInsensitiveCompare:)<span class="enscript-type">]</span>;
        <span class="enscript-type">[</span>nameField reloadData<span class="enscript-type">]</span>;
        
        // Restore the previous TableView selection
        index = selected ? <span class="enscript-type">[</span>_sortedServices indexOfObject:selected<span class="enscript-type">]</span> : NSNotFound;
        <span class="enscript-keyword">if</span> (index != NSNotFound) {
            <span class="enscript-type">[</span>nameField selectRowIndexes:<span class="enscript-type">[</span>NSIndexSet indexSetWithIndex:index<span class="enscript-type">]</span> byExtendingSelection:NO<span class="enscript-type">]</span>;
            <span class="enscript-type">[</span>nameField scrollRowToVisible:index<span class="enscript-type">]</span>;
        }
        
        <span class="enscript-type">[</span>selected release<span class="enscript-type">]</span>;
    }

    <span class="enscript-type">[</span>service release<span class="enscript-type">]</span>;

    <span class="enscript-keyword">return</span>;
}


- (void)resolveClientWitHost:(NSString *)host port:(uint16_t)port interfaceIndex:(uint32_t)interface txtRecord:(const <span class="enscript-type">char</span>*)txtRecord txtLen:(uint16_t)txtLen
{
	DNSServiceRef serviceRef;

	<span class="enscript-keyword">if</span> (_ipv4AddressResolver) {
		<span class="enscript-type">[</span>_ipv4AddressResolver release<span class="enscript-type">]</span>;
		_ipv4AddressResolver = nil;
	}
    
    <span class="enscript-keyword">if</span> (_ipv6AddressResolver) {
		<span class="enscript-type">[</span>_ipv6AddressResolver release<span class="enscript-type">]</span>;
		_ipv6AddressResolver = nil;
	}

	// Start an async lookup <span class="enscript-keyword">for</span> IPv4 addresses
	DNSServiceErrorType err = DNSServiceQueryRecord(&amp;serviceRef, (DNSServiceFlags)0, interface, <span class="enscript-type">[</span>host UTF8String<span class="enscript-type">]</span>, kDNSServiceType_A, kDNSServiceClass_IN, QueryRecordReply, self);
	<span class="enscript-keyword">if</span> (err == kDNSServiceErr_NoError) {
		_ipv4AddressResolver = <span class="enscript-type">[</span><span class="enscript-type">[</span>ServiceController alloc<span class="enscript-type">]</span> initWithServiceRef:serviceRef<span class="enscript-type">]</span>;
		<span class="enscript-type">[</span>_ipv4AddressResolver addToCurrentRunLoop<span class="enscript-type">]</span>;
	}

	// Start an async lookup <span class="enscript-keyword">for</span> IPv6 addresses
    err = DNSServiceQueryRecord(&amp;serviceRef, (DNSServiceFlags)0, interface, <span class="enscript-type">[</span>host UTF8String<span class="enscript-type">]</span>, kDNSServiceType_AAAA, kDNSServiceClass_IN, QueryRecordReply, self);
    <span class="enscript-keyword">if</span> (err == kDNSServiceErr_NoError) {
        _ipv6AddressResolver = <span class="enscript-type">[</span><span class="enscript-type">[</span>ServiceController alloc<span class="enscript-type">]</span> initWithServiceRef:serviceRef<span class="enscript-type">]</span>;
        <span class="enscript-type">[</span>_ipv6AddressResolver addToCurrentRunLoop<span class="enscript-type">]</span>;
    }

    <span class="enscript-type">char</span> interfaceName<span class="enscript-type">[</span>IF_NAMESIZE<span class="enscript-type">]</span>;
    InterfaceIndexToName(interface, interfaceName);

    <span class="enscript-type">[</span>hostField setStringValue:host<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>interfaceField setStringValue:<span class="enscript-type">[</span>NSString stringWithUTF8String:interfaceName<span class="enscript-type">]</span><span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>portField setIntValue:ntohs(port)<span class="enscript-type">]</span>;

	// kind of a hack: munge txtRecord so it<span class="enscript-keyword">'</span>s human-readable
	<span class="enscript-keyword">if</span> (txtLen &gt; 0) {
		<span class="enscript-type">char</span> *readableText = (<span class="enscript-type">char</span>*) malloc(txtLen);
		<span class="enscript-keyword">if</span> (readableText != nil) {
			ByteCount index, subStrLen;
			memcpy(readableText, txtRecord, txtLen);
			<span class="enscript-keyword">for</span> (index=0; index &lt; txtLen - 1; index += subStrLen + 1) {
				subStrLen = readableText<span class="enscript-type">[</span>index<span class="enscript-type">]</span>;
				readableText<span class="enscript-type">[</span>index<span class="enscript-type">]</span> = <span class="enscript-string">' '</span>;
			}
			<span class="enscript-type">[</span>textField setStringValue:<span class="enscript-type">[</span>NSString stringWithCString:&amp;readableText<span class="enscript-type">[</span>1<span class="enscript-type">]</span> <span class="enscript-type">length</span>:txtLen - 1<span class="enscript-type">]</span><span class="enscript-type">]</span>;
			free(readableText);
		}
	}
}


- (void)updateAddress:(uint16_t)rrtype  addr:(const void *)buff addrLen:(uint16_t)addrLen host:(const <span class="enscript-type">char</span>*) host interfaceIndex:(uint32_t)interface <span class="enscript-type">more</span>:(boolean_t)moreToCome
{
    <span class="enscript-type">char</span> addrBuff<span class="enscript-type">[</span>256<span class="enscript-type">]</span>;

	<span class="enscript-keyword">if</span> (rrtype == kDNSServiceType_A) {
		inet_ntop(AF_INET, buff, addrBuff, sizeof(addrBuff));
        <span class="enscript-keyword">if</span> (<span class="enscript-type">[</span><span class="enscript-type">[</span>ipAddressField stringValue<span class="enscript-type">]</span> <span class="enscript-type">length</span><span class="enscript-type">]</span> &gt; 0) {
            <span class="enscript-type">[</span>ipAddressField setStringValue:<span class="enscript-type">[</span>NSString stringWithFormat:@&quot;<span class="enscript-comment">%@, &quot;, [ipAddressField stringValue]]];
</span>        }
		<span class="enscript-type">[</span>ipAddressField setStringValue:<span class="enscript-type">[</span>NSString stringWithFormat:@&quot;<span class="enscript-comment">%@%s&quot;, [ipAddressField stringValue], addrBuff]];
</span>
		<span class="enscript-keyword">if</span> (!moreToCome) {
			<span class="enscript-type">[</span>_ipv4AddressResolver release<span class="enscript-type">]</span>;
			_ipv4AddressResolver = nil;
		}
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (rrtype == kDNSServiceType_AAAA) {
		inet_ntop(AF_INET6, buff, addrBuff, sizeof(addrBuff));
        <span class="enscript-keyword">if</span> (<span class="enscript-type">[</span><span class="enscript-type">[</span>ip6AddressField stringValue<span class="enscript-type">]</span> <span class="enscript-type">length</span><span class="enscript-type">]</span> &gt; 0) {
            <span class="enscript-type">[</span>ip6AddressField setStringValue:<span class="enscript-type">[</span>NSString stringWithFormat:@&quot;<span class="enscript-comment">%@, &quot;, [ip6AddressField stringValue]]];
</span>        }
		<span class="enscript-type">[</span>ip6AddressField setStringValue:<span class="enscript-type">[</span>NSString stringWithFormat:@&quot;<span class="enscript-comment">%@%s&quot;, [ip6AddressField stringValue], addrBuff]];
</span>
		<span class="enscript-keyword">if</span> (!moreToCome) {
			<span class="enscript-type">[</span>_ipv6AddressResolver release<span class="enscript-type">]</span>;
			_ipv6AddressResolver = nil;
		}
	}
}


- (void)connect:(id)sender
{
    NSString *host = <span class="enscript-type">[</span>hostField stringValue<span class="enscript-type">]</span>;
    NSString *txtRecord = <span class="enscript-type">[</span>textField stringValue<span class="enscript-type">]</span>;
    int port = <span class="enscript-type">[</span>portField intValue<span class="enscript-type">]</span>;
        
    int index = <span class="enscript-type">[</span>nameField selectedRow<span class="enscript-type">]</span>;
    NSString *selected = (index &gt;= 0) ? <span class="enscript-type">[</span>_sortedServices objectAtIndex:index<span class="enscript-type">]</span> : nil;
    NSString *<span class="enscript-type">type</span> = <span class="enscript-type">[</span><span class="enscript-type">[</span>_servicesDict objectForKey:selected<span class="enscript-type">]</span> <span class="enscript-type">type</span><span class="enscript-type">]</span>;
    
    <span class="enscript-keyword">if</span> (<span class="enscript-type">[</span><span class="enscript-type">type</span> isEqual:@&quot;_http._tcp.&quot;<span class="enscript-type">]</span>) {
        NSString *pathDelim = @&quot;<span class="enscript-type">path</span>=&quot;;
		NSRange where;

        // If the TXT record specifies a <span class="enscript-type">path</span>, extract it.
		where = <span class="enscript-type">[</span>txtRecord rangeOfString:pathDelim options:NSCaseInsensitiveSearch<span class="enscript-type">]</span>;
        <span class="enscript-keyword">if</span> (where.<span class="enscript-type">length</span>) {
			NSRange	targetRange = { where.location + where.<span class="enscript-type">length</span>, <span class="enscript-type">[</span>txtRecord <span class="enscript-type">length</span><span class="enscript-type">]</span> - where.location - where.<span class="enscript-type">length</span> };
			NSRange	endDelim = <span class="enscript-type">[</span>txtRecord rangeOfString:@&quot;\n&quot; options:kNilOptions range:targetRange<span class="enscript-type">]</span>;
			
			<span class="enscript-keyword">if</span> (endDelim.<span class="enscript-type">length</span>)   // <span class="enscript-keyword">if</span> a delimiter was found, truncate the target range
				targetRange.<span class="enscript-type">length</span> = endDelim.location - targetRange.location;

            NSString    *<span class="enscript-type">path</span> = <span class="enscript-type">[</span>txtRecord substringWithRange:targetRange<span class="enscript-type">]</span>;
            <span class="enscript-type">[</span><span class="enscript-type">[</span>NSWorkspace sharedWorkspace<span class="enscript-type">]</span> openURL:<span class="enscript-type">[</span>NSURL URLWithString:<span class="enscript-type">[</span>NSString stringWithFormat:@&quot;<a href="http://%">http://%</a>@:<span class="enscript-comment">%d%@&quot;, host, port, path]]];
</span>        } <span class="enscript-keyword">else</span> {
            <span class="enscript-type">[</span><span class="enscript-type">[</span>NSWorkspace sharedWorkspace<span class="enscript-type">]</span> openURL:<span class="enscript-type">[</span>NSURL URLWithString:<span class="enscript-type">[</span>NSString stringWithFormat:@&quot;<a href="http://%">http://%</a>@:<span class="enscript-comment">%d&quot;, host, port]]];
</span>        }
    }
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (<span class="enscript-type">[</span><span class="enscript-type">type</span> isEqual:@&quot;_ftp._tcp.&quot;<span class="enscript-type">]</span>)        <span class="enscript-type">[</span><span class="enscript-type">[</span>NSWorkspace sharedWorkspace<span class="enscript-type">]</span> openURL:<span class="enscript-type">[</span>NSURL URLWithString:<span class="enscript-type">[</span>NSString stringWithFormat:@&quot;<a href="ftp://%">ftp://%</a>@:<span class="enscript-comment">%d/&quot;, host, port]]];
</span>    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (<span class="enscript-type">[</span><span class="enscript-type">type</span> isEqual:@&quot;_ssh._tcp.&quot;<span class="enscript-type">]</span>)        <span class="enscript-type">[</span><span class="enscript-type">[</span>NSWorkspace sharedWorkspace<span class="enscript-type">]</span> openURL:<span class="enscript-type">[</span>NSURL URLWithString:<span class="enscript-type">[</span>NSString stringWithFormat:@&quot;ssh://<span class="enscript-comment">%@:%d/&quot;, host, port]]];
</span>    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (<span class="enscript-type">[</span><span class="enscript-type">type</span> isEqual:@&quot;_afpovertcp._tcp.&quot;<span class="enscript-type">]</span>) <span class="enscript-type">[</span><span class="enscript-type">[</span>NSWorkspace sharedWorkspace<span class="enscript-type">]</span> openURL:<span class="enscript-type">[</span>NSURL URLWithString:<span class="enscript-type">[</span>NSString stringWithFormat:@&quot;afp://<span class="enscript-comment">%@:%d/&quot;, host, port]]];
</span>    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (<span class="enscript-type">[</span><span class="enscript-type">type</span> isEqual:@&quot;_smb._tcp.&quot;<span class="enscript-type">]</span>)        <span class="enscript-type">[</span><span class="enscript-type">[</span>NSWorkspace sharedWorkspace<span class="enscript-type">]</span> openURL:<span class="enscript-type">[</span>NSURL URLWithString:<span class="enscript-type">[</span>NSString stringWithFormat:@&quot;smb://<span class="enscript-comment">%@:%d/&quot;, host, port]]];
</span>    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (<span class="enscript-type">[</span><span class="enscript-type">type</span> isEqual:@&quot;_rfb._tcp.&quot;<span class="enscript-type">]</span>)        <span class="enscript-type">[</span><span class="enscript-type">[</span>NSWorkspace sharedWorkspace<span class="enscript-type">]</span> openURL:<span class="enscript-type">[</span>NSURL URLWithString:<span class="enscript-type">[</span>NSString stringWithFormat:@&quot;vnc://<span class="enscript-comment">%@:%d/&quot;, host, port]]];
</span>
    <span class="enscript-keyword">return</span>;
}


- (IBAction)handleTableClick:(id)sender
{
    //populate the <span class="enscript-type">text</span> fields
}


- (IBAction)removeSelected:(id)sender
{
    // remove the selected row <span class="enscript-type">and</span> force a <span class="enscript-type">refresh</span>

    int selectedRow = <span class="enscript-type">[</span>serviceDisplayTable selectedRow<span class="enscript-type">]</span>;

    <span class="enscript-keyword">if</span> (selectedRow) {

        <span class="enscript-type">[</span>_srvtypeKeys removeObjectAtIndex:selectedRow<span class="enscript-type">]</span>;
        <span class="enscript-type">[</span>_srvnameKeys removeObjectAtIndex:selectedRow<span class="enscript-type">]</span>;

        <span class="enscript-type">[</span><span class="enscript-type">[</span>NSUserDefaults standardUserDefaults<span class="enscript-type">]</span> setObject:_srvtypeKeys forKey:@&quot;SrvTypeKeys&quot;<span class="enscript-type">]</span>;
        <span class="enscript-type">[</span><span class="enscript-type">[</span>NSUserDefaults standardUserDefaults<span class="enscript-type">]</span> setObject:_srvnameKeys forKey:@&quot;SrvNameKeys&quot;<span class="enscript-type">]</span>;

        <span class="enscript-type">[</span>typeField reloadData<span class="enscript-type">]</span>;
        <span class="enscript-type">[</span>serviceDisplayTable reloadData<span class="enscript-type">]</span>;
    }
}


- (IBAction)addNewService:(id)sender
{
    // add new entries from the edit fields to the arrays <span class="enscript-keyword">for</span> the defaults
    NSString *newType = <span class="enscript-type">[</span>serviceTypeField stringValue<span class="enscript-type">]</span>;
    NSString *newName = <span class="enscript-type">[</span>serviceNameField stringValue<span class="enscript-type">]</span>;

    // 3282283: trim trailing <span class="enscript-string">'.'</span> from service <span class="enscript-type">type</span> field
    <span class="enscript-keyword">if</span> (<span class="enscript-type">[</span>newType <span class="enscript-type">length</span><span class="enscript-type">]</span> &amp;&amp; <span class="enscript-type">[</span>newType hasSuffix:@&quot;.&quot;<span class="enscript-type">]</span>)
        newType = <span class="enscript-type">[</span>newType substringToIndex:<span class="enscript-type">[</span>newType <span class="enscript-type">length</span><span class="enscript-type">]</span> - 1<span class="enscript-type">]</span>;

    <span class="enscript-keyword">if</span> (<span class="enscript-type">[</span>newType <span class="enscript-type">length</span><span class="enscript-type">]</span> &amp;&amp; <span class="enscript-type">[</span>newName <span class="enscript-type">length</span><span class="enscript-type">]</span>) {
        <span class="enscript-type">[</span>_srvtypeKeys addObject:newType<span class="enscript-type">]</span>;
        <span class="enscript-type">[</span>_srvnameKeys addObject:newName<span class="enscript-type">]</span>;

        <span class="enscript-type">[</span><span class="enscript-type">[</span>NSUserDefaults standardUserDefaults<span class="enscript-type">]</span> setObject:_srvtypeKeys forKey:@&quot;SrvTypeKeys&quot;<span class="enscript-type">]</span>;
        <span class="enscript-type">[</span><span class="enscript-type">[</span>NSUserDefaults standardUserDefaults<span class="enscript-type">]</span> setObject:_srvnameKeys forKey:@&quot;SrvNameKeys&quot;<span class="enscript-type">]</span>;

        <span class="enscript-type">[</span>typeField reloadData<span class="enscript-type">]</span>;
        <span class="enscript-type">[</span>serviceDisplayTable reloadData<span class="enscript-type">]</span>;
    }
}


- (void)_cancelPendingResolve
{
    <span class="enscript-type">[</span>_ipv4AddressResolver release<span class="enscript-type">]</span>;
    _ipv4AddressResolver = nil;

    <span class="enscript-type">[</span>_ipv6AddressResolver release<span class="enscript-type">]</span>;
    _ipv6AddressResolver = nil;

    <span class="enscript-type">[</span>_serviceResolver release<span class="enscript-type">]</span>;
    _serviceResolver = nil;

	<span class="enscript-type">[</span>self _clearResolvedInfo<span class="enscript-type">]</span>;
}


- (void)_clearResolvedInfo
{
	<span class="enscript-type">[</span>hostField setStringValue:@&quot;&quot;<span class="enscript-type">]</span>;
	<span class="enscript-type">[</span>ipAddressField setStringValue:@&quot;&quot;<span class="enscript-type">]</span>;
	<span class="enscript-type">[</span>ip6AddressField setStringValue:@&quot;&quot;<span class="enscript-type">]</span>;
	<span class="enscript-type">[</span>portField setStringValue:@&quot;&quot;<span class="enscript-type">]</span>;
    <span class="enscript-type">[</span>interfaceField setStringValue:@&quot;&quot;<span class="enscript-type">]</span>;
	<span class="enscript-type">[</span>textField setStringValue:@&quot;&quot;<span class="enscript-type">]</span>;
}

@<span class="enscript-keyword">end</span> // implementation BrowserController


@implementation ServiceController : NSObject
{
	DNSServiceRef        fServiceRef;
	CFSocketRef          fSocketRef;
	CFRunLoopSourceRef   fRunloopSrc;
}


- (id)initWithServiceRef:(DNSServiceRef)ref
{
	self = <span class="enscript-type">[</span>super init<span class="enscript-type">]</span>;
    <span class="enscript-keyword">if</span> (self) {
        fServiceRef = ref;
        fSocketRef = NULL;
        fRunloopSrc = NULL;
    }
	<span class="enscript-keyword">return</span> self;
}


- (void)addToCurrentRunLoop
{
	CFSocketContext	context = { 0, (void*)fServiceRef, NULL, NULL, NULL };

	fSocketRef = CFSocketCreateWithNative(kCFAllocatorDefault, DNSServiceRefSockFD(fServiceRef), kCFSocketReadCallBack, ProcessSockData, &amp;context);
	<span class="enscript-keyword">if</span> (fSocketRef) {
        // Prevent CFSocketInvalidate from closing DNSServiceRef<span class="enscript-keyword">'</span>s socket.
        CFOptionFlags sockFlags = CFSocketGetSocketFlags(fSocketRef);
        CFSocketSetSocketFlags(fSocketRef, sockFlags &amp; (~kCFSocketCloseOnInvalidate));
		fRunloopSrc = CFSocketCreateRunLoopSource(kCFAllocatorDefault, fSocketRef, 0);
    }
	<span class="enscript-keyword">if</span> (fRunloopSrc) {
		CFRunLoopAddSource(CFRunLoopGetCurrent(), fRunloopSrc, kCFRunLoopDefaultMode);
    } <span class="enscript-keyword">else</span> {
		printf(&quot;Could <span class="enscript-type">not</span> listen to runloop socket\n&quot;);
    }
}


- (DNSServiceRef)serviceRef
{
	<span class="enscript-keyword">return</span> fServiceRef;
}


- (void)dealloc
{
	<span class="enscript-keyword">if</span> (fSocketRef) {
		CFSocketInvalidate(fSocketRef);		// Note: Also closes the underlying socket
		CFRelease(fSocketRef);
        
        // Workaround that gives time to CFSocket<span class="enscript-keyword">'</span>s select thread so it can remove the socket from its
        // FD <span class="enscript-type">set</span> before we <span class="enscript-keyword">close</span> the socket by calling DNSServiceRefDeallocate. &lt;rdar://problem/3585273&gt;
        usleep(1000);
	}

	<span class="enscript-keyword">if</span> (fRunloopSrc) {
		CFRunLoopRemoveSource(CFRunLoopGetCurrent(), fRunloopSrc, kCFRunLoopDefaultMode);
		CFRelease(fRunloopSrc);
	}

	DNSServiceRefDeallocate(fServiceRef);

	<span class="enscript-type">[</span>super dealloc<span class="enscript-type">]</span>;
}


@<span class="enscript-keyword">end</span> // implementation ServiceController

int main(int argc, const <span class="enscript-type">char</span> *argv<span class="enscript-type">[</span><span class="enscript-type">]</span>)
{
    <span class="enscript-keyword">return</span> NSApplicationMain(argc, argv);
}
</pre>
<hr />
</body></html>