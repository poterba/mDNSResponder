<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>dnssd_ipc.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">dnssd_ipc.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="dnssd_ipc.c">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 2003-2019 Apple Inc. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1.  Redistributions of source code must retain the above copyright notice,
 *     this list of conditions and the following disclaimer.
 * 2.  Redistributions in binary form must reproduce the above copyright notice,
 *     this list of conditions and the following disclaimer in the documentation
 *     and/or other materials provided with the distribution.
 * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of its
 *     contributors may be used to endorse or promote products derived from this
 *     software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;dnssd_ipc.h&quot;</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">_WIN32</span>)

<span class="enscript-type">char</span> *<span class="enscript-function-name">win32_strerror</span>(<span class="enscript-type">int</span> inErrorCode)
{
    <span class="enscript-type">static</span> <span class="enscript-type">char</span> buffer[1024];
    DWORD n;
    memset(buffer, 0, <span class="enscript-keyword">sizeof</span>(buffer));
    n = FormatMessageA(
        FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS,
        NULL,
        (DWORD) inErrorCode,
        MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
        buffer,
        <span class="enscript-keyword">sizeof</span>(buffer),
        NULL);
    <span class="enscript-keyword">if</span> (n &gt; 0)
    {
        <span class="enscript-comment">// Remove any trailing CR's or LF's since some messages have them.
</span>        <span class="enscript-keyword">while</span> ((n &gt; 0) &amp;&amp; isspace(((<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *) buffer)[n - 1]))
            buffer[--n] = <span class="enscript-string">'\0'</span>;
    }
    <span class="enscript-keyword">return</span> buffer;
}

#<span class="enscript-reference">endif</span>

<span class="enscript-type">void</span> <span class="enscript-function-name">put_uint32</span>(<span class="enscript-type">const</span> uint32_t l, <span class="enscript-type">char</span> **ptr)
{
    (*ptr)[0] = (<span class="enscript-type">char</span>)((l &gt;&gt; 24) &amp;  0xFF);
    (*ptr)[1] = (<span class="enscript-type">char</span>)((l &gt;&gt; 16) &amp;  0xFF);
    (*ptr)[2] = (<span class="enscript-type">char</span>)((l &gt;&gt;  8) &amp;  0xFF);
    (*ptr)[3] = (<span class="enscript-type">char</span>)((l      ) &amp;  0xFF);
    *ptr += <span class="enscript-keyword">sizeof</span>(uint32_t);
}

uint32_t <span class="enscript-function-name">get_uint32</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> **ptr, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *end)
{
    <span class="enscript-keyword">if</span> (!*ptr || *ptr + <span class="enscript-keyword">sizeof</span>(uint32_t) &gt; end)
    {
        *ptr = NULL;
        <span class="enscript-keyword">return</span>(0);
    }
    <span class="enscript-keyword">else</span>
    {
        uint8_t *p = (uint8_t*) *ptr;
        *ptr += <span class="enscript-keyword">sizeof</span>(uint32_t);
        <span class="enscript-keyword">return</span>((uint32_t) ((uint32_t)p[0] &lt;&lt; 24 | (uint32_t)p[1] &lt;&lt; 16 | (uint32_t)p[2] &lt;&lt; 8 | p[3]));
    }
}

<span class="enscript-type">void</span> <span class="enscript-function-name">put_uint16</span>(uint16_t s, <span class="enscript-type">char</span> **ptr)
{
    (*ptr)[0] = (<span class="enscript-type">char</span>)((s &gt;&gt;  8) &amp;  0xFF);
    (*ptr)[1] = (<span class="enscript-type">char</span>)((s      ) &amp;  0xFF);
    *ptr += <span class="enscript-keyword">sizeof</span>(uint16_t);
}

uint16_t <span class="enscript-function-name">get_uint16</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> **ptr, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *end)
{
    <span class="enscript-keyword">if</span> (!*ptr || *ptr + <span class="enscript-keyword">sizeof</span>(uint16_t) &gt; end)
    {
        *ptr = NULL;
        <span class="enscript-keyword">return</span>(0);
    }
    <span class="enscript-keyword">else</span>
    {
        uint8_t *p = (uint8_t*) *ptr;
        *ptr += <span class="enscript-keyword">sizeof</span>(uint16_t);
        <span class="enscript-keyword">return</span>((uint16_t) ((uint16_t)p[0] &lt;&lt; 8 | p[1]));
    }
}

<span class="enscript-type">int</span> <span class="enscript-function-name">put_string</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *str, <span class="enscript-type">char</span> **ptr)
{
    size_t len;
    <span class="enscript-keyword">if</span> (!str) str = <span class="enscript-string">&quot;&quot;</span>;
    len = strlen(str) + 1;
    memcpy(*ptr, str, len);
    *ptr += len;
    <span class="enscript-keyword">return</span> 0;
}

<span class="enscript-type">int</span> <span class="enscript-function-name">get_string</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> **ptr, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-type">const</span> end, <span class="enscript-type">char</span> *buffer, <span class="enscript-type">int</span> buflen)
{
    <span class="enscript-keyword">if</span> (!*ptr)
    {
        *buffer = 0;
        <span class="enscript-keyword">return</span>(-1);
    }
    <span class="enscript-keyword">else</span>
    {
        <span class="enscript-type">char</span> *lim = buffer + buflen;    <span class="enscript-comment">// Calculate limit
</span>        <span class="enscript-keyword">while</span> (*ptr &lt; end &amp;&amp; buffer &lt; lim)
        {
            <span class="enscript-type">char</span> c = *buffer++ = *(*ptr)++;
            <span class="enscript-keyword">if</span> (c == 0) <span class="enscript-keyword">return</span>(0);      <span class="enscript-comment">// Success
</span>        }
        <span class="enscript-keyword">if</span> (buffer == lim) buffer--;
        *buffer = 0;                    <span class="enscript-comment">// Failed, so terminate string,
</span>        *ptr = NULL;                    <span class="enscript-comment">// clear pointer,
</span>        <span class="enscript-keyword">return</span>(-1);                     <span class="enscript-comment">// and return failure indication
</span>    }
}

<span class="enscript-type">void</span> <span class="enscript-function-name">put_rdata</span>(<span class="enscript-type">const</span> <span class="enscript-type">int</span> rdlen, <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *rdata, <span class="enscript-type">char</span> **ptr)
{
    memcpy(*ptr, rdata, rdlen);
    *ptr += rdlen;
}

<span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-function-name">get_rdata</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> **ptr, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *end, <span class="enscript-type">int</span> rdlen)
{
    <span class="enscript-keyword">if</span> (!*ptr || *ptr + rdlen &gt; end)
    {
        *ptr = NULL;
        <span class="enscript-keyword">return</span>(0);
    }
    <span class="enscript-keyword">else</span>
    {
        <span class="enscript-type">const</span> <span class="enscript-type">char</span> *rd = *ptr;
        *ptr += rdlen;
        <span class="enscript-keyword">return</span> rd;
    }
}

<span class="enscript-type">void</span> <span class="enscript-function-name">ConvertHeaderBytes</span>(ipc_msg_hdr *hdr)
{
    hdr-&gt;version   = htonl(hdr-&gt;version);
    hdr-&gt;datalen   = htonl(hdr-&gt;datalen);
    hdr-&gt;ipc_flags = htonl(hdr-&gt;ipc_flags);
    hdr-&gt;op        = htonl(hdr-&gt;op );
    hdr-&gt;reg_index = htonl(hdr-&gt;reg_index);
}
</pre>
<hr />
</body></html>