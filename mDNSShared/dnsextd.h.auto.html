<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>dnsextd.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">dnsextd.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="dnsextd.h">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* -*- Mode: C; tab-width: 4 -*-
 *
 * Copyright (c) 2006-2018 Apple Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>


#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">_dnsextd_h</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">_dnsextd_h</span>


#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;mDNSEmbeddedAPI.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;DNSCommon.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;GenLinkedList.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/types.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socket.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>


#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LLQ_TABLESIZE</span>   1024    // !!!KRS make this dynamically growable


<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span> DNSZoneSpecType
{
    kDNSZonePublic,
    kDNSZonePrivate
} DNSZoneSpecType;


<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> DNSZone
{
    domainname name;
    DNSZoneSpecType type;
    DomainAuthInfo      *   updateKeys; <span class="enscript-comment">// linked list of keys for signing deletion updates
</span>    DomainAuthInfo      *   queryKeys;  <span class="enscript-comment">// linked list of keys for queries
</span>    <span class="enscript-type">struct</span> DNSZone      *   next;
} DNSZone;


<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span>
{
    <span class="enscript-type">struct</span> sockaddr_in src;
    size_t len;
    DNSZone * zone;
    mDNSBool isZonePublic;
    DNSMessage msg;
    <span class="enscript-comment">// Note: extra storage for oversized (TCP) messages goes here
</span>} PktMsg;

<span class="enscript-comment">// lease table entry
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> RRTableElem
{
    <span class="enscript-type">struct</span> RRTableElem *next;
    <span class="enscript-type">struct</span> sockaddr_in cli;   <span class="enscript-comment">// client's source address
</span>    <span class="enscript-type">long</span> expire;              <span class="enscript-comment">// expiration time, in seconds since epoch
</span>    domainname zone;          <span class="enscript-comment">// from zone field of update message
</span>    domainname name;          <span class="enscript-comment">// name of the record
</span>    CacheRecord rr;           <span class="enscript-comment">// last field in struct allows for allocation of oversized RRs
</span>} RRTableElem;

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span>
{
    RequestReceived = 0,
    ChallengeSent   = 1,
    Established     = 2
} LLQState;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> AnswerListElem
{
    <span class="enscript-type">struct</span> AnswerListElem *next;
    domainname name;
    mDNSu16 type;
    CacheRecord *KnownAnswers;  <span class="enscript-comment">// All valid answers delivered to client
</span>    CacheRecord *EventList;     <span class="enscript-comment">// New answers (adds/removes) to be sent to client
</span>    <span class="enscript-type">int</span> refcount;
    mDNSBool UseTCP;            <span class="enscript-comment">// Use TCP if UDP would cause truncation
</span>    pthread_t tid;              <span class="enscript-comment">// Allow parallel list updates
</span>} AnswerListElem;

<span class="enscript-comment">// llq table entry
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> LLQEntry
{
    <span class="enscript-type">struct</span> LLQEntry *next;
    <span class="enscript-type">struct</span> sockaddr_in cli;   <span class="enscript-comment">// clien'ts source address
</span>    domainname qname;
    mDNSu16 qtype;
    mDNSOpaque64 id;
    LLQState state;
    mDNSu32 lease;            <span class="enscript-comment">// original lease, in seconds
</span>    mDNSs32 expire;           <span class="enscript-comment">// expiration, absolute, in seconds since epoch
</span>    AnswerListElem *AnswerList;
} LLQEntry;


<span class="enscript-type">typedef</span> <span class="enscript-function-name">void</span> (*EventCallback)( <span class="enscript-type">void</span> * context );

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> EventSource
{
    EventCallback callback;
    <span class="enscript-type">void</span>                *   context;
    TCPSocket *         sock;
    <span class="enscript-type">int</span> fd;
    mDNSBool markedForDeletion;
    <span class="enscript-type">struct</span>  EventSource *   next;
} EventSource;


<span class="enscript-comment">// daemon-wide information
</span><span class="enscript-type">typedef</span> <span class="enscript-type">struct</span>
{
    <span class="enscript-comment">// server variables - read only after initialization (no locking)
</span>    <span class="enscript-type">struct</span> sockaddr_in addr;            <span class="enscript-comment">// the address we will bind to
</span>    <span class="enscript-type">struct</span> sockaddr_in llq_addr;        <span class="enscript-comment">// the address we will receive llq requests on.
</span>    <span class="enscript-type">struct</span> sockaddr_in ns_addr;         <span class="enscript-comment">// the real ns server address
</span>    <span class="enscript-type">int</span> tcpsd;                          <span class="enscript-comment">// listening TCP socket for dns requests
</span>    <span class="enscript-type">int</span> udpsd;                          <span class="enscript-comment">// listening UDP socket for dns requests
</span>    <span class="enscript-type">int</span> tlssd;                          <span class="enscript-comment">// listening TCP socket for private browsing
</span>    <span class="enscript-type">int</span> llq_tcpsd;                      <span class="enscript-comment">// listening TCP socket for llq service
</span>    <span class="enscript-type">int</span> llq_udpsd;                      <span class="enscript-comment">// listening UDP socket for llq service
</span>    DNameListElem   *   public_names;   <span class="enscript-comment">// list of public SRV names
</span>    DNSZone         *   zones;

    <span class="enscript-comment">// daemon variables - read only after initialization (no locking)
</span>    mDNSIPPort private_port;           <span class="enscript-comment">// listening port for private messages
</span>    mDNSIPPort llq_port;           <span class="enscript-comment">// listening port for llq
</span>
    <span class="enscript-comment">// lease table variables (locked via mutex after initialization)
</span>    RRTableElem **table;       <span class="enscript-comment">// hashtable for records with leases
</span>    pthread_mutex_t tablelock; <span class="enscript-comment">// mutex for lease table
</span>    mDNSs32 nbuckets;          <span class="enscript-comment">// buckets allocated
</span>    mDNSs32 nelems;            <span class="enscript-comment">// elements in table
</span>
    <span class="enscript-comment">// LLQ table variables
</span>    LLQEntry *LLQTable[LLQ_TABLESIZE];  <span class="enscript-comment">// !!!KRS change this and RRTable to use a common data structure
</span>    AnswerListElem *AnswerTable[LLQ_TABLESIZE];
    <span class="enscript-type">int</span> AnswerTableCount;
    <span class="enscript-type">int</span> LLQEventNotifySock;          <span class="enscript-comment">// Unix domain socket pair - update handling thread writes to EventNotifySock, which wakes
</span>    <span class="enscript-type">int</span> LLQEventListenSock;          <span class="enscript-comment">// the main thread listening on EventListenSock, indicating that the zone has changed
</span>
    GenLinkedList eventSources;     <span class="enscript-comment">// linked list of EventSource's
</span>} DaemonInfo;


<span class="enscript-type">int</span>
ParseConfig
(
    DaemonInfo  *   d,
    <span class="enscript-type">const</span> <span class="enscript-type">char</span>  *   file
);


#<span class="enscript-reference">endif</span>
</pre>
<hr />
</body></html>