<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>DNSCommon.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">DNSCommon.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="DNSCommon.h">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* -*- Mode: C; tab-width: 4 -*-
 *
 * Copyright (c) 2002-2019 Apple Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__DNSCOMMON_H_</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">__DNSCOMMON_H_</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;mDNSEmbeddedAPI.h&quot;</span>

#<span class="enscript-reference">ifdef</span>  <span class="enscript-variable-name">__cplusplus</span>
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Macros
</span>
<span class="enscript-comment">// Note: The C preprocessor stringify operator ('#') makes a string from its argument, without macro expansion
</span><span class="enscript-comment">// e.g. If &quot;version&quot; is #define'd to be &quot;4&quot;, then STRINGIFY_AWE(version) will return the string &quot;version&quot;, not &quot;4&quot;
</span><span class="enscript-comment">// To expand &quot;version&quot; to its value before making the string, use STRINGIFY(version) instead
</span>#<span class="enscript-reference">define</span> <span class="enscript-function-name">STRINGIFY_ARGUMENT_WITHOUT_EXPANSION</span>(s) # s
#<span class="enscript-reference">define</span> <span class="enscript-function-name">STRINGIFY</span>(s) STRINGIFY_ARGUMENT_WITHOUT_EXPANSION(s)

<span class="enscript-comment">// ***************************************************************************
</span>#<span class="enscript-reference">if</span> <span class="enscript-variable-name">COMPILER_LIKES_PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> - <span class="enscript-variable-name">DNS</span> <span class="enscript-variable-name">Protocol</span> <span class="enscript-variable-name">Constants</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span>
{
    kDNSFlag0_QR_Mask        = 0x80,    <span class="enscript-comment">// Query or response?
</span>    kDNSFlag0_QR_Query       = 0x00,
    kDNSFlag0_QR_Response    = 0x80,

    kDNSFlag0_OP_Mask        = 0xF &lt;&lt; 3, <span class="enscript-comment">// Operation type
</span>    kDNSFlag0_OP_StdQuery    = 0x0 &lt;&lt; 3,
    kDNSFlag0_OP_Iquery      = 0x1 &lt;&lt; 3,
    kDNSFlag0_OP_Status      = 0x2 &lt;&lt; 3,
    kDNSFlag0_OP_Unused3     = 0x3 &lt;&lt; 3,
    kDNSFlag0_OP_Notify      = 0x4 &lt;&lt; 3,
    kDNSFlag0_OP_Update      = 0x5 &lt;&lt; 3,
    kDNSFlag0_OP_DSO         = 0x6 &lt;&lt; 3,

    kDNSFlag0_QROP_Mask   = kDNSFlag0_QR_Mask | kDNSFlag0_OP_Mask,

    kDNSFlag0_AA          = 0x04,       <span class="enscript-comment">// Authoritative Answer?
</span>    kDNSFlag0_TC          = 0x02,       <span class="enscript-comment">// Truncated?
</span>    kDNSFlag0_RD          = 0x01,       <span class="enscript-comment">// Recursion Desired?
</span>    kDNSFlag1_RA          = 0x80,       <span class="enscript-comment">// Recursion Available?
</span>
    kDNSFlag1_Zero        = 0x40,       <span class="enscript-comment">// Reserved; must be zero
</span>    kDNSFlag1_AD          = 0x20,       <span class="enscript-comment">// Authentic Data [RFC 2535]
</span>    kDNSFlag1_CD          = 0x10,       <span class="enscript-comment">// Checking Disabled [RFC 2535]
</span>
    kDNSFlag1_RC_Mask     = 0x0F,       <span class="enscript-comment">// Response code
</span>    kDNSFlag1_RC_NoErr    = 0x00,
    kDNSFlag1_RC_FormErr  = 0x01,
    kDNSFlag1_RC_ServFail = 0x02,
    kDNSFlag1_RC_NXDomain = 0x03,
    kDNSFlag1_RC_NotImpl  = 0x04,
    kDNSFlag1_RC_Refused  = 0x05,
    kDNSFlag1_RC_YXDomain = 0x06,
    kDNSFlag1_RC_YXRRSet  = 0x07,
    kDNSFlag1_RC_NXRRSet  = 0x08,
    kDNSFlag1_RC_NotAuth  = 0x09,
    kDNSFlag1_RC_NotZone  = 0x0A,
	kDNSFlag1_RC_DSOTypeNI = 0x0B
} DNS_Flags;

<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span>
{
    TSIG_ErrBadSig  = 16,
    TSIG_ErrBadKey  = 17,
    TSIG_ErrBadTime = 18
} TSIG_ErrorCode;


<span class="enscript-comment">// ***************************************************************************
</span>#<span class="enscript-reference">if</span> <span class="enscript-variable-name">COMPILER_LIKES_PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> - <span class="enscript-variable-name">General</span> <span class="enscript-variable-name">Utility</span> <span class="enscript-variable-name">Functions</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">extern</span> NetworkInterfaceInfo *<span class="enscript-function-name">GetFirstActiveInterface</span>(NetworkInterfaceInfo *intf);
<span class="enscript-type">extern</span> mDNSInterfaceID <span class="enscript-function-name">GetNextActiveInterfaceID</span>(<span class="enscript-type">const</span> NetworkInterfaceInfo *intf);

<span class="enscript-type">extern</span> mDNSu32 <span class="enscript-function-name">mDNSRandom</span>(mDNSu32 max);     <span class="enscript-comment">// Returns pseudo-random result from zero to max inclusive
</span>
<span class="enscript-type">extern</span> mDNSu32 <span class="enscript-function-name">mDNS_GetNextResolverGroupID</span>(<span class="enscript-type">void</span>);

<span class="enscript-comment">// ***************************************************************************
</span>#<span class="enscript-reference">if</span> <span class="enscript-variable-name">COMPILER_LIKES_PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> - <span class="enscript-variable-name">Domain</span> <span class="enscript-variable-name">Name</span> <span class="enscript-variable-name">Utility</span> <span class="enscript-variable-name">Functions</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">mDNSSubTypeLabel</span>   <span class="enscript-string">&quot;\x04_sub&quot;</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">mDNSIsDigit</span>(X)     ((X) &gt;= <span class="enscript-string">'0'</span> &amp;&amp; (X) &lt;= <span class="enscript-string">'9'</span>)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">mDNSIsUpperCase</span>(X) ((X) &gt;= <span class="enscript-string">'A'</span> &amp;&amp; (X) &lt;= <span class="enscript-string">'Z'</span>)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">mDNSIsLowerCase</span>(X) ((X) &gt;= <span class="enscript-string">'a'</span> &amp;&amp; (X) &lt;= <span class="enscript-string">'z'</span>)
#<span class="enscript-reference">define</span> <span class="enscript-function-name">mDNSIsLetter</span>(X)    (mDNSIsUpperCase(X) || mDNSIsLowerCase(X))
    
<span class="enscript-comment">// We believe we have adequate safeguards to protect against cache poisoning.
</span><span class="enscript-comment">// In the event that someone does find a workable cache poisoning attack, we want to limit the lifetime of the poisoned entry.
</span><span class="enscript-comment">// We set the maximum allowable TTL to one hour.
</span><span class="enscript-comment">// With the 25% correction factor to avoid the DNS Zeno's paradox bug, that gives us an actual maximum lifetime of 75 minutes.
</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">mDNSMaximumMulticastTTLSeconds</span>  (mDNSu32)4500
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">mDNSMaximumUnicastTTLSeconds</span>    (mDNSu32)3600

#<span class="enscript-reference">define</span> <span class="enscript-function-name">mDNSValidHostChar</span>(X, notfirst, notlast) (mDNSIsLetter(X) || mDNSIsDigit(X) || ((notfirst) &amp;&amp; (notlast) &amp;&amp; (X) == <span class="enscript-string">'-'</span>) )

<span class="enscript-type">extern</span> mDNSu16 <span class="enscript-function-name">CompressedDomainNameLength</span>(<span class="enscript-type">const</span> domainname *<span class="enscript-type">const</span> name, <span class="enscript-type">const</span> domainname *parent);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">CountLabels</span>(<span class="enscript-type">const</span> domainname *d);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> domainname *<span class="enscript-function-name">SkipLeadingLabels</span>(<span class="enscript-type">const</span> domainname *d, <span class="enscript-type">int</span> skip);

<span class="enscript-type">extern</span> mDNSu32 <span class="enscript-function-name">TruncateUTF8ToLength</span>(mDNSu8 *string, mDNSu32 length, mDNSu32 max);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">LabelContainsSuffix</span>(<span class="enscript-type">const</span> domainlabel *<span class="enscript-type">const</span> name, <span class="enscript-type">const</span> mDNSBool RichText);
<span class="enscript-type">extern</span> mDNSu32 <span class="enscript-function-name">RemoveLabelSuffix</span>(domainlabel *name, mDNSBool RichText);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">AppendLabelSuffix</span>(domainlabel *<span class="enscript-type">const</span> name, mDNSu32 val, <span class="enscript-type">const</span> mDNSBool RichText);
#<span class="enscript-reference">define</span> <span class="enscript-function-name">ValidateDomainName</span>(N) (DomainNameLength(N) &lt;= MAX_DOMAIN_NAME)

<span class="enscript-comment">// ***************************************************************************
</span>#<span class="enscript-reference">if</span> <span class="enscript-variable-name">COMPILER_LIKES_PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> - <span class="enscript-variable-name">Resource</span> <span class="enscript-variable-name">Record</span> <span class="enscript-variable-name">Utility</span> <span class="enscript-variable-name">Functions</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">// IdenticalResourceRecord returns true if two resources records have
</span><span class="enscript-comment">// the same name, type, class, and identical rdata (InterfaceID and TTL may differ)
</span>
<span class="enscript-comment">// IdenticalSameNameRecord is the same, except it skips the expensive SameDomainName() check,
</span><span class="enscript-comment">// which is at its most expensive and least useful in cases where we know in advance that the names match
</span>
<span class="enscript-comment">// Note: The dominant use of IdenticalResourceRecord is from ProcessQuery(), handling known-answer lists. In this case
</span><span class="enscript-comment">// it's common to have a whole bunch or records with exactly the same name (e.g. &quot;_http._tcp.local&quot;) but different RDATA.
</span><span class="enscript-comment">// The SameDomainName() check is expensive when the names match, and in this case *all* the names match, so we
</span><span class="enscript-comment">// used to waste a lot of CPU time verifying that the names match, only then to find that the RDATA is different.
</span><span class="enscript-comment">// We observed mDNSResponder spending 30% of its total CPU time on this single task alone.
</span><span class="enscript-comment">// By swapping the checks so that we check the RDATA first, we can quickly detect when it's different
</span><span class="enscript-comment">// (99% of the time) and then bail out before we waste time on the expensive SameDomainName() check.
</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">IdenticalResourceRecord</span>(r1,r2) ( \
        (r1)-&gt;rrtype    == (r2)-&gt;rrtype      &amp;&amp; \
        (r1)-&gt;rrclass   == (r2)-&gt;rrclass     &amp;&amp; \
        (r1)-&gt;namehash  == (r2)-&gt;namehash    &amp;&amp; \
        (r1)-&gt;rdlength  == (r2)-&gt;rdlength    &amp;&amp; \
        (r1)-&gt;rdatahash == (r2)-&gt;rdatahash   &amp;&amp; \
        SameRDataBody((r1), &amp;(r2)-&gt;rdata-&gt;u, SameDomainName) &amp;&amp; \
        SameDomainName((r1)-&gt;name, (r2)-&gt;name))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">IdenticalSameNameRecord</span>(r1,r2) ( \
        (r1)-&gt;rrtype    == (r2)-&gt;rrtype      &amp;&amp; \
        (r1)-&gt;rrclass   == (r2)-&gt;rrclass     &amp;&amp; \
        (r1)-&gt;rdlength  == (r2)-&gt;rdlength    &amp;&amp; \
        (r1)-&gt;rdatahash == (r2)-&gt;rdatahash   &amp;&amp; \
        SameRDataBody((r1), &amp;(r2)-&gt;rdata-&gt;u, SameDomainName))

<span class="enscript-comment">// A given RRType answers a QuestionType if RRType is CNAME, or types match, or QuestionType is ANY,
</span><span class="enscript-comment">// or the RRType is NSEC and positively asserts the nonexistence of the type being requested
</span>#<span class="enscript-reference">define</span> <span class="enscript-function-name">RRTypeAnswersQuestionType</span>(R,Q) ((R)-&gt;rrtype == kDNSType_CNAME || (R)-&gt;rrtype == (Q) || (Q) == kDNSQType_ANY || RRAssertsNonexistence((R),(Q)))
<span class="enscript-comment">// Unicast NSEC records have the NSEC bit set whereas the multicast NSEC ones don't
</span>#<span class="enscript-reference">define</span> <span class="enscript-function-name">UNICAST_NSEC</span>(rr) ((rr)-&gt;rrtype == kDNSType_NSEC &amp;&amp; RRAssertsExistence((rr), kDNSType_NSEC))

<span class="enscript-type">extern</span> mDNSu32 <span class="enscript-function-name">RDataHashValue</span>(<span class="enscript-type">const</span> ResourceRecord *<span class="enscript-type">const</span> rr);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">SameRDataBody</span>(<span class="enscript-type">const</span> ResourceRecord *<span class="enscript-type">const</span> r1, <span class="enscript-type">const</span> RDataBody *<span class="enscript-type">const</span> r2, DomainNameComparisonFn *samename);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">SameNameCacheRecordAnswersQuestion</span>(<span class="enscript-type">const</span> CacheRecord *<span class="enscript-type">const</span> cr, <span class="enscript-type">const</span> DNSQuestion *<span class="enscript-type">const</span> q);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">ResourceRecordAnswersQuestion</span>(<span class="enscript-type">const</span> ResourceRecord *<span class="enscript-type">const</span> rr, <span class="enscript-type">const</span> DNSQuestion *<span class="enscript-type">const</span> q);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">AuthRecordAnswersQuestion</span>(<span class="enscript-type">const</span> AuthRecord *<span class="enscript-type">const</span> ar, <span class="enscript-type">const</span> DNSQuestion *<span class="enscript-type">const</span> q);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">CacheRecordAnswersQuestion</span>(<span class="enscript-type">const</span> CacheRecord *<span class="enscript-type">const</span> cr, <span class="enscript-type">const</span> DNSQuestion *<span class="enscript-type">const</span> q);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">AnyTypeRecordAnswersQuestion</span> (<span class="enscript-type">const</span> AuthRecord *<span class="enscript-type">const</span> ar, <span class="enscript-type">const</span> DNSQuestion *<span class="enscript-type">const</span> q);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">ResourceRecordAnswersUnicastResponse</span>(<span class="enscript-type">const</span> ResourceRecord *<span class="enscript-type">const</span> rr, <span class="enscript-type">const</span> DNSQuestion *<span class="enscript-type">const</span> q);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">LocalOnlyRecordAnswersQuestion</span>(AuthRecord *<span class="enscript-type">const</span> rr, <span class="enscript-type">const</span> DNSQuestion *<span class="enscript-type">const</span> q);
<span class="enscript-type">extern</span> mDNSu16 <span class="enscript-function-name">GetRDLength</span>(<span class="enscript-type">const</span> ResourceRecord *<span class="enscript-type">const</span> rr, mDNSBool estimate);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">ValidateRData</span>(<span class="enscript-type">const</span> mDNSu16 rrtype, <span class="enscript-type">const</span> mDNSu16 rdlength, <span class="enscript-type">const</span> RData *<span class="enscript-type">const</span> rd);
<span class="enscript-type">extern</span> mStatus <span class="enscript-function-name">DNSNameToLowerCase</span>(domainname *d, domainname *result);

#<span class="enscript-reference">define</span> <span class="enscript-function-name">GetRRDomainNameTarget</span>(RR) (                                                                          \
        ((RR)-&gt;rrtype == kDNSType_NS || (RR)-&gt;rrtype == kDNSType_CNAME || (RR)-&gt;rrtype == kDNSType_PTR || (RR)-&gt;rrtype == kDNSType_DNAME) ? &amp;(RR)-&gt;rdata-&gt;u.name        : \
        ((RR)-&gt;rrtype == kDNSType_MX || (RR)-&gt;rrtype == kDNSType_AFSDB || (RR)-&gt;rrtype == kDNSType_RT  || (RR)-&gt;rrtype == kDNSType_KX   ) ? &amp;(RR)-&gt;rdata-&gt;u.mx.exchange : \
        ((RR)-&gt;rrtype == kDNSType_SRV                                  ) ? &amp;(RR)-&gt;rdata-&gt;u.srv.target : mDNSNULL )

#<span class="enscript-reference">define</span> <span class="enscript-function-name">LocalRecordReady</span>(X) ((X)-&gt;resrec.RecordType != kDNSRecordTypeUnique)

<span class="enscript-comment">// ***************************************************************************
</span>#<span class="enscript-reference">if</span> <span class="enscript-variable-name">COMPILER_LIKES_PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> - <span class="enscript-variable-name">DNS</span> <span class="enscript-variable-name">Message</span> <span class="enscript-variable-name">Creation</span> <span class="enscript-variable-name">Functions</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">InitializeDNSMessage</span>(DNSMessageHeader *h, mDNSOpaque16 id, mDNSOpaque16 flags);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">FindCompressionPointer</span>(<span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> base, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> domname);
<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putDomainNameAsLabels</span>(<span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> limit, <span class="enscript-type">const</span> domainname *<span class="enscript-type">const</span> name);
<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putRData</span>(<span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> limit, <span class="enscript-type">const</span> ResourceRecord *<span class="enscript-type">const</span> rr);

<span class="enscript-comment">// If we have a single large record to put in the packet, then we allow the packet to be up to 9K bytes,
</span><span class="enscript-comment">// but in the normal case we try to keep the packets below 1500 to avoid IP fragmentation on standard Ethernet
</span>
#<span class="enscript-reference">define</span> <span class="enscript-function-name">AllowedRRSpace</span>(msg) (((msg)-&gt;h.numAnswers || (msg)-&gt;h.numAuthorities || (msg)-&gt;h.numAdditionals) ? NormalMaxDNSMessageData : AbsoluteMaxDNSMessageData)

<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">PutResourceRecordTTLWithLimit</span>(DNSMessage *<span class="enscript-type">const</span> msg, mDNSu8 *ptr, mDNSu16 *count, ResourceRecord *rr, mDNSu32 ttl, <span class="enscript-type">const</span> mDNSu8 *limit);

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PutResourceRecordTTL</span>(msg, ptr, count, rr, ttl) \
    PutResourceRecordTTLWithLimit((msg), (ptr), (count), (rr), (ttl), (msg)-&gt;data + AllowedRRSpace(msg))

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PutResourceRecordTTLJumbo</span>(msg, ptr, count, rr, ttl) \
    PutResourceRecordTTLWithLimit((msg), (ptr), (count), (rr), (ttl), (msg)-&gt;data + AbsoluteMaxDNSMessageData)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PutResourceRecord</span>(MSG, P, C, RR) PutResourceRecordTTL((MSG), (P), (C), (RR), (RR)-&gt;rroriginalttl)

<span class="enscript-comment">// The PutRR_OS variants assume a local variable 'm', put build the packet at m-&gt;omsg,
</span><span class="enscript-comment">// and assume local variables 'OwnerRecordSpace' &amp; 'TraceRecordSpace' indicating how many bytes (if any) to reserve to add an OWNER/TRACER option at the end
</span>#<span class="enscript-reference">define</span> <span class="enscript-function-name">PutRR_OS_TTL</span>(ptr, count, rr, ttl) \
    PutResourceRecordTTLWithLimit(&amp;m-&gt;omsg, (ptr), (count), (rr), (ttl), m-&gt;omsg.data + AllowedRRSpace(&amp;m-&gt;omsg) - OwnerRecordSpace - TraceRecordSpace)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">PutRR_OS</span>(P, C, RR) PutRR_OS_TTL((P), (C), (RR), (RR)-&gt;rroriginalttl)

<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putQuestion</span>(DNSMessage *<span class="enscript-type">const</span> msg, mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> limit, <span class="enscript-type">const</span> domainname *<span class="enscript-type">const</span> name, mDNSu16 rrtype, mDNSu16 rrclass);
<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putZone</span>(DNSMessage *<span class="enscript-type">const</span> msg, mDNSu8 *ptr, mDNSu8 *limit, <span class="enscript-type">const</span> domainname *zone, mDNSOpaque16 zoneClass);
<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putPrereqNameNotInUse</span>(<span class="enscript-type">const</span> domainname *<span class="enscript-type">const</span> name, DNSMessage *<span class="enscript-type">const</span> msg, mDNSu8 *<span class="enscript-type">const</span> ptr, mDNSu8 *<span class="enscript-type">const</span> end);
<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putDeletionRecord</span>(DNSMessage *msg, mDNSu8 *ptr, ResourceRecord *rr);
<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putDeletionRecordWithLimit</span>(DNSMessage *msg, mDNSu8 *ptr, ResourceRecord *rr, mDNSu8 *limit);
<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putDeleteRRSetWithLimit</span>(DNSMessage *msg, mDNSu8 *ptr, <span class="enscript-type">const</span> domainname *name, mDNSu16 rrtype, mDNSu8 *limit);
<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putDeleteAllRRSets</span>(DNSMessage *msg, mDNSu8 *ptr, <span class="enscript-type">const</span> domainname *name);
<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putUpdateLease</span>(DNSMessage *msg, mDNSu8 *ptr, mDNSu32 lease);
<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putUpdateLeaseWithLimit</span>(DNSMessage *msg, mDNSu8 *ptr, mDNSu32 lease, mDNSu8 *limit);

<span class="enscript-type">extern</span> mDNSu8 *<span class="enscript-function-name">putDNSSECOption</span>(DNSMessage *msg, mDNSu8 *end, mDNSu8 *limit);
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">baseEncode</span>(<span class="enscript-type">char</span> *buffer, <span class="enscript-type">int</span> blen, <span class="enscript-type">const</span> mDNSu8 *data, <span class="enscript-type">int</span> len, <span class="enscript-type">int</span> encAlg);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">NSEC3Parse</span>(<span class="enscript-type">const</span> ResourceRecord *<span class="enscript-type">const</span> rr, mDNSu8 **salt, <span class="enscript-type">int</span> *hashLength, mDNSu8 **nxtName, <span class="enscript-type">int</span> *bitmaplen, mDNSu8 **bitmap);

<span class="enscript-comment">// ***************************************************************************
</span>#<span class="enscript-reference">if</span> <span class="enscript-variable-name">COMPILER_LIKES_PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> - <span class="enscript-variable-name">DNS</span> <span class="enscript-variable-name">Message</span> <span class="enscript-variable-name">Parsing</span> <span class="enscript-variable-name">Functions</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">HashSlotFromNameHash</span>(X) ((X) % CACHE_HASH_SLOTS)
<span class="enscript-type">extern</span> mDNSu32 <span class="enscript-function-name">DomainNameHashValue</span>(<span class="enscript-type">const</span> domainname *<span class="enscript-type">const</span> name);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">SetNewRData</span>(ResourceRecord *<span class="enscript-type">const</span> rr, RData *NewRData, mDNSu16 rdlength);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">skipDomainName</span>(<span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">getDomainName</span>(<span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end,
                                   domainname *<span class="enscript-type">const</span> name);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">skipResourceRecord</span>(<span class="enscript-type">const</span> DNSMessage *msg, <span class="enscript-type">const</span> mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *end);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">GetLargeResourceRecord</span>(mDNS *<span class="enscript-type">const</span> m, <span class="enscript-type">const</span> DNSMessage * <span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *ptr,
                                            <span class="enscript-type">const</span> mDNSu8 * end, <span class="enscript-type">const</span> mDNSInterfaceID InterfaceID, mDNSu8 RecordType, LargeCacheRecord *<span class="enscript-type">const</span> largecr);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">SetRData</span>(<span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *end,
    LargeCacheRecord *<span class="enscript-type">const</span> largecr, mDNSu16 rdlength);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">skipQuestion</span>(<span class="enscript-type">const</span> DNSMessage *msg, <span class="enscript-type">const</span> mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *end);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">getQuestion</span>(<span class="enscript-type">const</span> DNSMessage *msg, <span class="enscript-type">const</span> mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *end, <span class="enscript-type">const</span> mDNSInterfaceID InterfaceID,
                                 DNSQuestion *question);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">LocateAnswers</span>(<span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">LocateAuthorities</span>(<span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">LocateAdditionals</span>(<span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">LocateOptRR</span>(<span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end, <span class="enscript-type">int</span> minsize);
<span class="enscript-type">extern</span> <span class="enscript-type">const</span> rdataOPT *<span class="enscript-function-name">GetLLQOptData</span>(mDNS *<span class="enscript-type">const</span> m, <span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">GetPktLease</span>(mDNS *<span class="enscript-type">const</span> m, <span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end, mDNSu32 *<span class="enscript-type">const</span> lease);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">DumpPacket</span>(mStatus status, mDNSBool sent, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *transport, <span class="enscript-type">const</span> mDNSAddr *srcaddr, mDNSIPPort srcport,
    <span class="enscript-type">const</span> mDNSAddr *dstaddr, mDNSIPPort dstport, <span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end,
    mDNSInterfaceID interfaceID);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">RRAssertsNonexistence</span>(<span class="enscript-type">const</span> ResourceRecord *<span class="enscript-type">const</span> rr, mDNSu16 type);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">RRAssertsExistence</span>(<span class="enscript-type">const</span> ResourceRecord *<span class="enscript-type">const</span> rr, mDNSu16 type);
<span class="enscript-type">extern</span> mDNSBool <span class="enscript-function-name">BitmapTypeCheck</span>(mDNSu8 *bmap, <span class="enscript-type">int</span> bitmaplen, mDNSu16 type);

<span class="enscript-type">extern</span> mDNSu16 <span class="enscript-function-name">swap16</span>(mDNSu16 x);
<span class="enscript-type">extern</span> mDNSu32 <span class="enscript-function-name">swap32</span>(mDNSu32 x);

<span class="enscript-comment">// ***************************************************************************
</span>#<span class="enscript-reference">if</span> <span class="enscript-variable-name">COMPILER_LIKES_PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> - <span class="enscript-variable-name">Packet</span> <span class="enscript-variable-name">Sending</span> <span class="enscript-variable-name">Functions</span>
#<span class="enscript-reference">endif</span>
<span class="enscript-type">extern</span> mStatus <span class="enscript-function-name">mDNSSendDNSMessage</span>(mDNS *<span class="enscript-type">const</span> m, DNSMessage *<span class="enscript-type">const</span> msg, mDNSu8 *end,
                                  mDNSInterfaceID InterfaceID, TCPSocket *tcpSrc, UDPSocket *udpSrc, <span class="enscript-type">const</span> mDNSAddr *dst,
                                  mDNSIPPort dstport, DomainAuthInfo *authInfo, mDNSBool useBackgroundTrafficClass);

<span class="enscript-comment">// ***************************************************************************
</span>#<span class="enscript-reference">if</span> <span class="enscript-variable-name">COMPILER_LIKES_PRAGMA_MARK</span>
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> -
#<span class="enscript-reference">pragma</span> <span class="enscript-variable-name">mark</span> - <span class="enscript-variable-name">RR</span> <span class="enscript-variable-name">List</span> <span class="enscript-variable-name">Management</span> &amp; <span class="enscript-variable-name">Task</span> <span class="enscript-variable-name">Management</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">ShowTaskSchedulingError</span>(mDNS *<span class="enscript-type">const</span> m);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mDNS_Lock_</span>(mDNS *<span class="enscript-type">const</span> m, <span class="enscript-type">const</span> <span class="enscript-type">char</span> * <span class="enscript-type">const</span> functionname);
<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mDNS_Unlock_</span>(mDNS *<span class="enscript-type">const</span> m, <span class="enscript-type">const</span> <span class="enscript-type">char</span> * <span class="enscript-type">const</span> functionname);
    
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">_WIN32</span>)
 #define __func__ __FUNCTION__
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">mDNS_Lock</span>(X) mDNS_Lock_((X), __func__)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">mDNS_Unlock</span>(X) mDNS_Unlock_((X), __func__)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">mDNS_CheckLock</span>(X) \
    if ((X)-&gt;mDNS_busy != (X)-&gt;mDNS_reentrancy+1) LogMsg(<span class="enscript-string">&quot;%s: Lock not held! mDNS_busy (%ld) mDNS_reentrancy (%ld)&quot;</span>, __func__, (X)-&gt;mDNS_busy, (X)-&gt;mDNS_reentrancy)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">mDNS_DropLockBeforeCallback</span>() do { m-&gt;mDNS_reentrancy++; \
    if (m-&gt;mDNS_busy != m-&gt;mDNS_reentrancy) LogMsg(<span class="enscript-string">&quot;%s: Locking Failure! mDNS_busy (%ld) != mDNS_reentrancy (%ld)&quot;</span>, __func__, m-&gt;mDNS_busy, m-&gt;mDNS_reentrancy); \
    } while (0)

#<span class="enscript-reference">define</span> <span class="enscript-function-name">mDNS_ReclaimLockAfterCallback</span>() do { \
    if (m-&gt;mDNS_busy != m-&gt;mDNS_reentrancy) LogMsg(<span class="enscript-string">&quot;%s: Unlocking Failure! mDNS_busy (%ld) != mDNS_reentrancy (%ld)&quot;</span>, __func__, m-&gt;mDNS_busy, m-&gt;mDNS_reentrancy); \
    m-&gt;mDNS_reentrancy--; } while (0)

#<span class="enscript-reference">ifdef</span>  <span class="enscript-variable-name">__cplusplus</span>
}
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">__DNSCOMMON_H_</span>
</pre>
<hr />
</body></html>