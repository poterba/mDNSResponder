<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>dso-transport.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">dso-transport.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="dso-transport.h">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* dso-transport.h
 *
 * Copyright (c) 2018-2019 Apple Computer, Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__DSO_TRANSPORT_H</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">__DSO_TRANSPORT_H</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">DSO_USES_NETWORK_FRAMEWORK</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;Network/Network.h&gt;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">// Maximum number of IP addresses that we'll deal with as a result of looking up a name
</span><span class="enscript-comment">// to which to connect.
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_DSO_CONNECT_ADDRS</span> 16

<span class="enscript-comment">// Threshold above which we indicate that a DSO connection isn't writable.   This is advisory,
</span><span class="enscript-comment">// but e.g. for a Discovery Relay, if the remote proxy isn't consuming what we are sending, we
</span><span class="enscript-comment">// should start dropping packets on the floor rather than just queueing more and more packets.
</span><span class="enscript-comment">// 60k may actually be too much.   This is used when we're using NW Framework, because it doesn't
</span><span class="enscript-comment">// allow us to use TCP_NOTSENT_LOWAT directly.
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_UNSENT_BYTES</span> 60000

<span class="enscript-type">struct</span> dso_transport {
    dso_state_t *dso;			   <span class="enscript-comment">// DSO state for which this is the transport 
</span>    <span class="enscript-type">struct</span> dso_transport *next;    <span class="enscript-comment">// Transport is on list of transports.
</span>    <span class="enscript-type">void</span> *event_context;           <span class="enscript-comment">// I/O event context
</span>    mDNSAddr remote_addr;          <span class="enscript-comment">// The IP address to which we have connected
</span>    <span class="enscript-type">int</span> remote_port;               <span class="enscript-comment">// The port to which we have connected
</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">DSO_USES_NETWORK_FRAMEWORK</span>
    nw_connection_t connection;
    dispatch_data_t to_write;
    size_t bytes_to_write;
    size_t unsent_bytes;
    uint32_t serial;               <span class="enscript-comment">// Serial number for locating possibly freed dso_transport_t structs
</span>    bool write_failed;             <span class="enscript-comment">// This is set if any of the parts of the dso_write process fail
</span>#<span class="enscript-reference">else</span>
    TCPSocket *connection;         <span class="enscript-comment">// Socket connected to Discovery Proxy
</span>    size_t bytes_needed;
    size_t message_length;         <span class="enscript-comment">// Length of message we are currently accumulating, if known
</span>    uint8_t *inbuf;                <span class="enscript-comment">// Buffer for incoming messages.
</span>    size_t inbuf_size;
    uint8_t *inbufp;               <span class="enscript-comment">// Current read pointer (may not be in inbuf)
</span>    bool need_length;              <span class="enscript-comment">// True if we need a 2-byte length
</span>
    uint8_t lenbuf[2];             <span class="enscript-comment">// Buffer for storing the length in a DNS TCP message
</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MAX_WRITE_HUNKS</span> 4          // When writing a DSO message, we need this many separate hunks.
    <span class="enscript-type">const</span> uint8_t *to_write[MAX_WRITE_HUNKS];
    ssize_t write_lengths[MAX_WRITE_HUNKS];
    <span class="enscript-type">int</span> num_to_write;
#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">DSO_USES_NETWORK_FRAMEWORK</span>

    uint8_t *outbuf;               <span class="enscript-comment">// Output buffer for building and sending DSO messages
</span>    size_t outbuf_size;
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> dso_lookup dso_lookup_t;
<span class="enscript-type">struct</span> dso_lookup {
    dso_lookup_t *next;
    DNSServiceRef sdref;
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> dso_connect_state dso_connect_state_t;
<span class="enscript-type">struct</span> dso_connect_state {
    dso_connect_state_t *next;
    dso_event_callback_t callback;
    dso_state_t *dso;
    <span class="enscript-type">char</span> *detail;
    <span class="enscript-type">void</span> *context;
    TCPListener *listener;

    <span class="enscript-type">char</span> *hostname;
    <span class="enscript-type">int</span> num_addrs;
    <span class="enscript-type">int</span> cur_addr;
    mDNSAddr addresses[MAX_DSO_CONNECT_ADDRS];
    mDNSIPPort ports[MAX_DSO_CONNECT_ADDRS];
    DNSServiceRef lookup;

    mDNSBool connecting;
    mDNSIPPort config_port, connect_port;
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">DSO_USES_NETWORK_FRAMEWORK</span>
    uint32_t serial;
    nw_connection_t connection;
    bool tls_enabled;
#<span class="enscript-reference">else</span>
    size_t inbuf_size;
#<span class="enscript-reference">endif</span>
    size_t outbuf_size;
    <span class="enscript-type">int</span> max_outstanding_queries;
    mDNSs32 last_event;
    mDNSs32 reconnect_time;
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
	TCPListener *listener;
    dso_event_callback_t callback;
	<span class="enscript-type">void</span> *context;
} dso_listen_context_t;

<span class="enscript-type">void</span> <span class="enscript-function-name">dso_transport_init</span>(<span class="enscript-type">void</span>);
mStatus <span class="enscript-function-name">dso_set_connection</span>(dso_state_t *dso, TCPSocket *socket);
<span class="enscript-type">void</span> <span class="enscript-function-name">dso_schedule_reconnect</span>(mDNS *m, dso_connect_state_t *cs, mDNSs32 when);
<span class="enscript-type">void</span> <span class="enscript-function-name">dso_set_callback</span>(dso_state_t *dso, <span class="enscript-type">void</span> *context, dso_event_callback_t cb);
mStatus <span class="enscript-function-name">dso_message_write</span>(dso_state_t *dso, dso_message_t *msg, bool disregard_low_water);
dso_connect_state_t *<span class="enscript-function-name">dso_connect_state_create</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *host, mDNSAddr *addr, mDNSIPPort port,
                                              <span class="enscript-type">int</span> num_outstanding_queries,
                                              size_t inbuf_size, size_t outbuf_size,
                                              dso_event_callback_t callback,
                                              dso_state_t *dso, <span class="enscript-type">void</span> *context, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *detail);
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">DSO_USES_NETWORK_FRAMEWORK</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">dso_connect_state_use_tls</span>(dso_connect_state_t *cs);
#<span class="enscript-reference">endif</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">dso_connect_state_drop</span>(dso_connect_state_t *cs);
bool <span class="enscript-function-name">dso_connect</span>(dso_connect_state_t *connect_state);
mStatus <span class="enscript-function-name">dso_listen</span>(dso_connect_state_t *listen_context);
bool <span class="enscript-function-name">dso_write_start</span>(dso_transport_t *transport, size_t length);
bool <span class="enscript-function-name">dso_write_finish</span>(dso_transport_t *transport);
<span class="enscript-type">void</span> <span class="enscript-function-name">dso_write</span>(dso_transport_t *transport, <span class="enscript-type">const</span> uint8_t *buf, size_t length);
#<span class="enscript-reference">endif</span> // <span class="enscript-variable-name">__DSO_TRANSPORT_H</span>

<span class="enscript-comment">// Local Variables:
</span><span class="enscript-comment">// mode: C
</span><span class="enscript-comment">// tab-width: 4
</span><span class="enscript-comment">// c-file-style: &quot;bsd&quot;
</span><span class="enscript-comment">// c-basic-offset: 4
</span><span class="enscript-comment">// fill-column: 108
</span><span class="enscript-comment">// indent-tabs-mode: nil
</span><span class="enscript-comment">// End:
</span></pre>
<hr />
</body></html>