<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>parselog.py</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">parselog.py&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="parselog.py">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">#!/usr/bin/python
</span><span class="enscript-comment"># Emacs settings: -*- tab-width: 4 -*-
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># Copyright (c) 2002-2003 Apple Computer, Inc. All rights reserved.
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
</span><span class="enscript-comment"># you may not use this file except in compliance with the License.
</span><span class="enscript-comment"># You may obtain a copy of the License at
</span><span class="enscript-comment"># 
</span><span class="enscript-comment">#     <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>
</span><span class="enscript-comment"># 
</span><span class="enscript-comment"># Unless required by applicable law or agreed to in writing, software
</span><span class="enscript-comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
</span><span class="enscript-comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span class="enscript-comment"># See the License for the specific language governing permissions and
</span><span class="enscript-comment"># limitations under the License.
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># parselog.py, written and contributed by Kevin Marks
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># Requires OS X 10.3 Panther or later, for Python and Core Graphics Python APIs
</span><span class="enscript-comment"># Invoke from the command line with &quot;parselog.py fname&quot; where fname is a log file made by mDNSNetMonitor
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># Caveats:
</span><span class="enscript-comment"># It expects plain ASCII, and doesn't handle spaces in record names very well right now
</span><span class="enscript-comment"># There's a procedure you can follow to 'sanitize' an mDNSNetMonitor log file to make it more paletable to parselog.py:
</span><span class="enscript-comment"># 1. Run mDNSNetMonitor in a terminal window.
</span><span class="enscript-comment">#    When you have enough traffic, type Ctrl-C and save the content of the terminal window to disk.
</span><span class="enscript-comment">#    Alternatively, you can use &quot;mDNSNetMonitor &gt; logfile&quot; to write the text directly to a file.
</span><span class="enscript-comment">#    You now have a UTF-8 text file.
</span><span class="enscript-comment"># 2. Open the UTF-8 text file using BBEdit or some other text editor.
</span><span class="enscript-comment">#    (These instructions are for BBEdit, which I highly recommend you use when doing this.)
</span><span class="enscript-comment"># 3. Make sure BBEdit correctly interprets the file as UTF-8.
</span><span class="enscript-comment">#    Either set your &quot;Text Files Opening&quot; preference to &quot;UTF-8 no BOM&quot;, and drop the file onto BBEdit,
</span><span class="enscript-comment">#    or manually open the File using &quot;File -&gt; Open&quot; and make sure the &quot;Read As&quot; setting is set to &quot;UTF-8 no BOM&quot;
</span><span class="enscript-comment">#    Check in the document pulldown menu in the window toolbar to make sure that it says &quot;Encoding: UTF-8 no BOM&quot;
</span><span class="enscript-comment"># 4. Use &quot;Tools -&gt; Convert to ASCII&quot; to replace all special characters with their seven-bit ascii equivalents.
</span><span class="enscript-comment">#    (e.g. curly quotes are converted to straight quotes)
</span><span class="enscript-comment"># 5. Do a grep search and replace. (Cmd-F; make sure Grep checkbox is turned on.)
</span><span class="enscript-comment">#    Enter this search text     : ^(.................\(................\S*) (.* -&gt; .*)$
</span><span class="enscript-comment">#    Enter this replacement text: \1-\2
</span><span class="enscript-comment">#    Click &quot;Replace All&quot;
</span><span class="enscript-comment">#    Press Cmd-Opt-= repeatedly until there are no more instances to be replaced.
</span><span class="enscript-comment">#    You now have text file with all spaces in names changed to hyphens
</span><span class="enscript-comment"># 6. Save the new file. You can save it as &quot;UTF-8 no BOM&quot;, or as &quot;Mac Roman&quot;. It really doesn't matter which --
</span><span class="enscript-comment">#    the file now contains only seven-bit ascii, so it's all the same no matter how you save it.
</span><span class="enscript-comment"># 7. Run &quot;parselog.py fname&quot;
</span><span class="enscript-comment"># 8. Open the resulting fname.pdf file with a PDF viewer like Preview on OS X
</span><span class="enscript-comment">#
</span><span class="enscript-comment"># Key to what you see:
</span><span class="enscript-comment"># Time is on the horizontal axis
</span><span class="enscript-comment"># Individual machines are shown on the vertical axis
</span><span class="enscript-comment"># Filled red    circle: Normal query              Hollow red    circle: Query requesting unicast reply
</span><span class="enscript-comment"># Filled orange circle: Probe (service starting)  Hollow orange circle: First probe (requesting unicast reply)
</span><span class="enscript-comment"># Filled green  circle: Normal answer             Hollow green  circle: Goodbye message (record going away)
</span><span class="enscript-comment">#                                                 Hollow blue   circle: Legacy query (from old client)
</span>
<span class="enscript-keyword">from</span> CoreGraphics <span class="enscript-keyword">import</span> *
<span class="enscript-keyword">import</span> math   <span class="enscript-comment"># for pi
</span>
<span class="enscript-keyword">import</span> string
<span class="enscript-keyword">import</span> sys, os
<span class="enscript-keyword">import</span> re

<span class="enscript-keyword">def</span> <span class="enscript-function-name">parselog</span>(inFile):
	f = open(inFile)
	hunt = <span class="enscript-string">'getTime'</span>
	ipList = {}
	querySource = {}
	plotPoints = []
	maxTime=0
	minTime = 36*60*60
	spaceExp = re.compile(r<span class="enscript-string">'\s+'</span>)
	<span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Reading &quot;</span> + inFile
	<span class="enscript-keyword">while</span> 1:
		lines = f.readlines(100000)
		<span class="enscript-keyword">if</span> <span class="enscript-keyword">not</span> lines:
			<span class="enscript-keyword">break</span>
		<span class="enscript-keyword">for</span> line <span class="enscript-keyword">in</span> lines:
			<span class="enscript-keyword">if</span> (hunt == <span class="enscript-string">'skip'</span>):
				<span class="enscript-keyword">if</span> (line == <span class="enscript-string">'\n'</span> <span class="enscript-keyword">or</span> line == <span class="enscript-string">'\r'</span> <span class="enscript-keyword">or</span> line ==<span class="enscript-string">''</span>): 
					hunt = <span class="enscript-string">'getTime'</span>
<span class="enscript-comment">#				else:
</span><span class="enscript-comment">#					msg = (&quot;skipped&quot; , line)
</span><span class="enscript-comment">#					print msg
</span>			<span class="enscript-keyword">elif</span> (hunt == <span class="enscript-string">'getTime'</span>):
				<span class="enscript-keyword">if</span> (line == <span class="enscript-string">&quot;^C\n&quot;</span> ):
					<span class="enscript-keyword">break</span>
				time = line.split(<span class="enscript-string">' '</span>)[0].split(<span class="enscript-string">':'</span>)
				<span class="enscript-keyword">if</span> (len(time)&lt;3):
					<span class="enscript-comment">#print &quot;bad time, skipping&quot;,time
</span>					hunt = <span class="enscript-string">'skip'</span>
				<span class="enscript-keyword">else</span>:
					hunt = <span class="enscript-string">'getIP'</span>
				<span class="enscript-comment">#print ((&quot;getTime:%s&quot; % (line)), time)
</span>			<span class="enscript-keyword">elif</span> (hunt == <span class="enscript-string">'getIP'</span>):
				ip = line.split(<span class="enscript-string">' '</span>,1)
				ip = ip[0]
				secs=0
				<span class="enscript-keyword">for</span> t <span class="enscript-keyword">in</span> time:
					secs = secs*60 +float(t)
				<span class="enscript-keyword">if</span> (secs&gt;maxTime):
					maxTime=secs
				<span class="enscript-keyword">if</span> (secs&lt;minTime):
					minTime=secs
				<span class="enscript-keyword">if</span> (<span class="enscript-keyword">not</span> ip <span class="enscript-keyword">in</span> ipList):
					ipList[ip] = [len(ipList), <span class="enscript-string">&quot;&quot;</span>, <span class="enscript-string">&quot;&quot;</span>]
				<span class="enscript-comment">#print ((&quot;getIP:%s&quot; % (line)), time, secs)
</span>				hunt = <span class="enscript-string">'getQA'</span>
			<span class="enscript-keyword">elif</span> (hunt == <span class="enscript-string">'getQA'</span>):
				qaList = spaceExp.split(line)
				<span class="enscript-comment"># qaList[0] Source Address
</span>				<span class="enscript-comment"># qaList[1] Operation type (PU/PM/QU/QM/AN etc.)
</span>				<span class="enscript-comment"># qaList[2] Record type (PTR/SRV/TXT etc.)
</span>				<span class="enscript-comment"># For QU/QM/LQ:
</span>				<span class="enscript-comment"># qaList[3] RR name
</span>				<span class="enscript-comment"># For PU/PM/AN/AN+/AD/AD+/KA:
</span>				<span class="enscript-comment"># qaList[3] TTL
</span>				<span class="enscript-comment"># qaList[4] RR name
</span>				<span class="enscript-comment"># qaList[5...] &quot;-&gt;&quot; symbol and following rdata
</span>				<span class="enscript-comment">#print qaList
</span>				<span class="enscript-keyword">if</span> (qaList[0] == ip):
					<span class="enscript-keyword">if</span> (qaList[1] == <span class="enscript-string">'(QU)'</span> <span class="enscript-keyword">or</span> qaList[1] == <span class="enscript-string">'(LQ)'</span> <span class="enscript-keyword">or</span> qaList[1] == <span class="enscript-string">'(PU)'</span>):
						plotPoints.append([secs, ipList[ip][0], (qaList[1])[1:-1]])
					<span class="enscript-keyword">elif</span> (qaList[1] == <span class="enscript-string">'(QM)'</span>):
						plotPoints.append([secs, ipList[ip][0], (qaList[1])[1:-1]])
						querySource[qaList[3]] = len(plotPoints)-1
					<span class="enscript-keyword">elif</span> (qaList[1] == <span class="enscript-string">'(PM)'</span>):
						plotPoints.append([secs, ipList[ip][0], (qaList[1])[1:-1]])
						querySource[qaList[4]] = len(plotPoints)-1
					<span class="enscript-keyword">elif</span> (qaList[1] == <span class="enscript-string">'(AN)'</span> <span class="enscript-keyword">or</span> qaList[1] == <span class="enscript-string">'(AN+)'</span> <span class="enscript-keyword">or</span> qaList[1] == <span class="enscript-string">'(DE)'</span>):
						plotPoints.append([secs, ipList[ip][0], (qaList[1])[1:-1]])
						<span class="enscript-keyword">try</span>:
							theQuery = querySource[qaList[4]]
							theDelta = secs - plotPoints[theQuery][0]
							<span class="enscript-keyword">if</span> (theDelta &lt; 1.0):
								plotPoints[-1].append(querySource[qaList[4]])
							<span class="enscript-comment">#print &quot;Answer AN+ %s points to %d&quot; % (qaList[4],querySource[qaList[4]])
</span>						<span class="enscript-keyword">except</span>:
							<span class="enscript-comment">#print &quot;Couldn't find any preceeding question for&quot;, qaList
</span>							<span class="enscript-keyword">pass</span>
					<span class="enscript-keyword">elif</span> (qaList[1] != <span class="enscript-string">'(KA)'</span> <span class="enscript-keyword">and</span> qaList[1] != <span class="enscript-string">'(AD)'</span> <span class="enscript-keyword">and</span> qaList[1] != <span class="enscript-string">'(AD+)'</span>):
						<span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Operation unknown&quot;</span>, qaList

					<span class="enscript-keyword">if</span> (qaList[1] == <span class="enscript-string">'(AN)'</span> <span class="enscript-keyword">or</span> qaList[1] == <span class="enscript-string">'(AN+)'</span> <span class="enscript-keyword">or</span> qaList[1] == <span class="enscript-string">'(AD)'</span> <span class="enscript-keyword">or</span> qaList[1] == <span class="enscript-string">'(AD+)'</span>):
						<span class="enscript-keyword">if</span> (qaList[2] == <span class="enscript-string">'HINFO'</span>):
							ipList[ip][1] = qaList[4]
							ipList[ip][2] = string.join(qaList[6:])
							<span class="enscript-comment">#print ipList[ip][1]
</span>						<span class="enscript-keyword">elif</span> (qaList[2] == <span class="enscript-string">'AAAA'</span>):
							<span class="enscript-keyword">if</span> (ipList[ip][1] == <span class="enscript-string">&quot;&quot;</span>):
								ipList[ip][1] = qaList[4]
								ipList[ip][2] = <span class="enscript-string">&quot;Panther&quot;</span>
						<span class="enscript-keyword">elif</span> (qaList[2] == <span class="enscript-string">'Addr'</span>):
							<span class="enscript-keyword">if</span> (ipList[ip][1] == <span class="enscript-string">&quot;&quot;</span>):
								ipList[ip][1] = qaList[4]
								ipList[ip][2] = <span class="enscript-string">&quot;Jaguar&quot;</span>
				<span class="enscript-keyword">else</span>:
					<span class="enscript-keyword">if</span> (line == <span class="enscript-string">'\n'</span>): 
						hunt = <span class="enscript-string">'getTime'</span>
					<span class="enscript-keyword">else</span>:
						hunt = <span class="enscript-string">'skip'</span>
	f.close()
	<span class="enscript-comment">#print plotPoints
</span>	<span class="enscript-comment">#print querySource
</span>	<span class="enscript-comment">#width=20.0*(maxTime-minTime)
</span>	<span class="enscript-keyword">if</span> (maxTime &lt; minTime + 10.0):
		maxTime = minTime + 10.0
	typesize = 12
	width=20.0*(maxTime-minTime)
	pageHeight=(len(ipList)+1) * typesize
	scale = width/(maxTime-minTime)
	leftMargin = typesize * 60
	bottomMargin = typesize
	pageRect = CGRectMake (-leftMargin, -bottomMargin,  leftMargin + width, bottomMargin + pageHeight)   <span class="enscript-comment">#  landscape
</span>	outFile = <span class="enscript-string">&quot;%s.pdf&quot;</span> % (<span class="enscript-string">&quot;.&quot;</span>.join(inFile.split(<span class="enscript-string">'.'</span>)[:-1]))
	c = CGPDFContextCreateWithFilename (outFile, pageRect)
	<span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Writing &quot;</span> + outFile
	ourColourSpace = c.getColorSpace()
	<span class="enscript-comment"># QM/QU red    solid/hollow
</span>	<span class="enscript-comment"># PM/PU orange solid/hollow
</span>	<span class="enscript-comment"># LQ    blue         hollow
</span>	<span class="enscript-comment"># AN/DA green  solid/hollow
</span>	<span class="enscript-comment">#colourLookup = {&quot;L&quot;:(0.0,0.0,.75), &quot;Q&quot;:(.75,0.0,0.0), &quot;P&quot;:(.75,0.5,0.0), &quot;A&quot;:(0.0,0.75,0.0), &quot;D&quot;:(0.0,0.75,0.0), &quot;?&quot;:(.25,0.25,0.25)}
</span>	colourLookup = {<span class="enscript-string">&quot;L&quot;</span>:(0.0,0.0,1.0), <span class="enscript-string">&quot;Q&quot;</span>:(1.0,0.0,0.0), <span class="enscript-string">&quot;P&quot;</span>:(1.0,0.8,0.0), <span class="enscript-string">&quot;A&quot;</span>:(0.0,1.0,0.0), <span class="enscript-string">&quot;D&quot;</span>:(0.0,1.0,0.0), <span class="enscript-string">&quot;?&quot;</span>:(1.0,1.0,1.0)}
	c.beginPage (pageRect)
	c.setRGBFillColor(.75,0.0,0.0,1.0)
	c.setRGBStrokeColor(.25,0.75,0.25,1.0)
	c.setLineWidth(0.25)
	<span class="enscript-keyword">for</span> point <span class="enscript-keyword">in</span> plotPoints:
		<span class="enscript-comment">#c.addArc((point[0]-minTime)*scale,point[1]*typesize+6,5,0,2*math.pi,1)
</span>		c.addArc((point[0]-minTime)*scale,point[1]*typesize+6,typesize/4,0,2*math.pi,1)
		theColour = colourLookup[(point[2])[0]]
		<span class="enscript-keyword">if</span> (((point[2])[0]) != <span class="enscript-string">&quot;L&quot;</span>) <span class="enscript-keyword">and</span> (((point[2])[0]) != <span class="enscript-string">&quot;Q&quot;</span>) <span class="enscript-keyword">and</span> (((point[2])[0]) != <span class="enscript-string">&quot;P&quot;</span>) <span class="enscript-keyword">and</span> (((point[2])[0]) != <span class="enscript-string">&quot;A&quot;</span>) <span class="enscript-keyword">and</span> (((point[2])[0]) != <span class="enscript-string">&quot;D&quot;</span>):
			<span class="enscript-keyword">print</span> <span class="enscript-string">&quot;Unknown&quot;</span>, point
		<span class="enscript-keyword">if</span> ((point[2])[-1] == <span class="enscript-string">&quot;M&quot;</span> <span class="enscript-keyword">or</span> (point[2])[0]== <span class="enscript-string">&quot;A&quot;</span>):
			c.setRGBFillColor(theColour[0],theColour[1],theColour[2],.5)
			c.fillPath()
		<span class="enscript-keyword">else</span>:
			c.setRGBStrokeColor(theColour[0],theColour[1],theColour[2],.5)
			c.setLineWidth(1.0)
			c.strokePath()
		c.setRGBStrokeColor(.25,0.75,0.25,1.0)
		c.setLineWidth(0.25)
		<span class="enscript-keyword">for</span> index <span class="enscript-keyword">in</span> point[3:]:
			c.beginPath()
			c.moveToPoint((point[0]-minTime)*scale,point[1]*typesize+6)
			c.addLineToPoint(((plotPoints[index])[0]-minTime)*scale,(plotPoints[index])[1]*typesize+6)
			c.closePath()
			c.strokePath()
	c.setRGBFillColor (0,0,0, 1)
	c.setTextDrawingMode (kCGTextFill)
	c.setTextMatrix (CGAffineTransformIdentity)
	c.selectFont (<span class="enscript-string">'Gill Sans'</span>, typesize, kCGEncodingMacRoman)
	c.setRGBStrokeColor(0.25,0.0,0.0,1.0)
	c.setLineWidth(0.1)
	<span class="enscript-keyword">for</span> ip,[height,hname,hinfo] <span class="enscript-keyword">in</span> ipList.items():
		c.beginPath()
		c.moveToPoint(pageRect.origin.x,height*typesize+6)
		c.addLineToPoint(width,height*typesize+6)
		c.closePath()
		c.strokePath()
		c.showTextAtPoint(pageRect.origin.x + 2,               height*typesize + 2, ip,    len(ip))
		c.showTextAtPoint(pageRect.origin.x + 2 + typesize*8,  height*typesize + 2, hname, len(hname))
		c.showTextAtPoint(pageRect.origin.x + 2 + typesize*25, height*typesize + 2, hinfo, len(hinfo))
	<span class="enscript-keyword">for</span> time <span class="enscript-keyword">in</span> range (int(minTime),int(maxTime)+1):
		c.beginPath()
		c.moveToPoint((time-minTime)*scale,pageRect.origin.y)
		c.addLineToPoint((time-minTime)*scale,pageHeight)
		c.closePath()
		<span class="enscript-keyword">if</span> (int(time) % 10 == 0):
			theHours = time/3600
			theMinutes = time/60 % 60
			theSeconds = time % 60
			theTimeString = <span class="enscript-string">'%d:%02d:%02d'</span> % (theHours, theMinutes, theSeconds)
			<span class="enscript-comment"># Should measure string width, but don't know how to do that
</span>			theStringWidth = typesize * 3.5
			c.showTextAtPoint((time-minTime)*scale - theStringWidth/2, pageRect.origin.y + 2, theTimeString, len(theTimeString))
			c.setLineWidth(0.3)
		<span class="enscript-keyword">else</span>:
			c.setLineWidth(0.1)
		c.strokePath()
	c.endPage()
	c.finish()

			
<span class="enscript-keyword">for</span> arg <span class="enscript-keyword">in</span> sys.argv[1:]:
	parselog(arg)
</pre>
<hr />
</body></html>