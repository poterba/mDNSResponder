<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>NetMonitor.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">NetMonitor.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="NetMonitor.c">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* -*- Mode: C; tab-width: 4 -*-
 *
 * Copyright (c) 2002-2004 Apple Computer, Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */</span>

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Incorporate mDNS.c functionality
</span>
<span class="enscript-comment">// We want to use much of the functionality provided by &quot;mDNS.c&quot;,
</span><span class="enscript-comment">// except we'll steal the packets that would be sent to normal mDNSCoreReceive() routine
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">mDNSCoreReceive</span> __NOT__mDNSCoreReceive__NOT__
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;../mDNSCore/mDNS.c&quot;</span>
#<span class="enscript-reference">undef</span> <span class="enscript-variable-name">mDNSCoreReceive</span>

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Headers
</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>          // For printf()
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>         // For malloc()
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>         // For strrchr(), strcmp()
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;time.h&gt;</span>           // For <span class="enscript-string">&quot;struct tm&quot;</span> etc.
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;signal.h&gt;</span>         // For SIGINT, SIGTERM
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">WIN32</span>)
<span class="enscript-comment">// Both mDNS.c and mDNSWin32.h declare UDPSocket_struct type resulting in a compile-time error, so
</span><span class="enscript-comment">// trick the compiler when including mDNSWin32.h
</span>#   <span class="enscript-reference">define</span> <span class="enscript-variable-name">UDPSocket_struct</span> _UDPSocket_struct
#   <span class="enscript-reference">include</span> <span class="enscript-string">&lt;mDNSEmbeddedAPI.h&gt;</span>
#   <span class="enscript-reference">include</span> <span class="enscript-string">&lt;mDNSWin32.h&gt;</span>
#   <span class="enscript-reference">include</span> <span class="enscript-string">&lt;PosixCompat.h&gt;</span>
#   <span class="enscript-reference">include</span> <span class="enscript-string">&lt;Poll.h&gt;</span>
#   <span class="enscript-reference">define</span> <span class="enscript-variable-name">IFNAMSIZ</span> 256
<span class="enscript-type">static</span> HANDLE gStopEvent = INVALID_HANDLE_VALUE;
<span class="enscript-type">static</span> mDNSBool gRunning;
<span class="enscript-type">static</span> <span class="enscript-type">void</span> CALLBACK <span class="enscript-function-name">StopNotification</span>( HANDLE event, <span class="enscript-type">void</span> *context ) { gRunning = mDNSfalse; }
<span class="enscript-type">static</span> BOOL WINAPI <span class="enscript-function-name">ConsoleControlHandler</span>( DWORD inControlEvent ) { SetEvent( gStopEvent ); <span class="enscript-keyword">return</span> TRUE; }
<span class="enscript-type">void</span> <span class="enscript-function-name">setlinebuf</span>( FILE * fp ) {}
#<span class="enscript-reference">else</span>
#   <span class="enscript-reference">include</span> <span class="enscript-string">&lt;netdb.h&gt;</span>           // For gethostbyname()
#   <span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/socket.h&gt;</span>      // For AF_INET, AF_INET6, etc.
#   <span class="enscript-reference">include</span> <span class="enscript-string">&lt;net/if.h&gt;</span>          // For IF_NAMESIZE
#   <span class="enscript-reference">include</span> <span class="enscript-string">&lt;netinet/in.h&gt;</span>      // For INADDR_NONE
#   <span class="enscript-reference">include</span> <span class="enscript-string">&lt;arpa/inet.h&gt;</span>       // For inet_addr()
#   <span class="enscript-reference">include</span> <span class="enscript-string">&quot;mDNSPosix.h&quot;</span>      // Defines the specific types needed to run mDNS on this platform
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;ExampleClientApp.h&quot;</span>

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Types and structures
</span>
<span class="enscript-type">enum</span>
{
    <span class="enscript-comment">// Primitive operations
</span>    OP_probe        = 0,
    OP_goodbye      = 1,

    <span class="enscript-comment">// These are meta-categories;
</span>    <span class="enscript-comment">// Query and Answer operations are actually subdivided into two classes:
</span>    <span class="enscript-comment">// Browse  query/answer and
</span>    <span class="enscript-comment">// Resolve query/answer
</span>    OP_query        = 2,
    OP_answer       = 3,

    <span class="enscript-comment">// The &quot;Browse&quot; variants of query/answer
</span>    OP_browsegroup  = 2,
    OP_browseq      = 2,
    OP_browsea      = 3,

    <span class="enscript-comment">// The &quot;Resolve&quot; variants of query/answer
</span>    OP_resolvegroup = 4,
    OP_resolveq     = 4,
    OP_resolvea     = 5,

    OP_NumTypes = 6
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> ActivityStat_struct ActivityStat;
<span class="enscript-type">struct</span> ActivityStat_struct
{
    ActivityStat *next;
    domainname srvtype;
    <span class="enscript-type">int</span> printed;
    <span class="enscript-type">int</span> totalops;
    <span class="enscript-type">int</span> stat[OP_NumTypes];
};

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> FilterList_struct FilterList;
<span class="enscript-type">struct</span> FilterList_struct
{
    FilterList *next;
    mDNSAddr FilterAddr;
};

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Constants
</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kReportTopServices</span> 15
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">kReportTopHosts</span>    15

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Globals
</span>
mDNS mDNSStorage;                       <span class="enscript-comment">// mDNS core uses this to store its globals
</span><span class="enscript-type">static</span> mDNS_PlatformSupport PlatformStorage;    <span class="enscript-comment">// Stores this platform's globals
</span>mDNSexport <span class="enscript-type">const</span> <span class="enscript-type">char</span> ProgramName[] = <span class="enscript-string">&quot;mDNSNetMonitor&quot;</span>;

<span class="enscript-type">struct</span> timeval tv_start, tv_end, tv_interval;
<span class="enscript-type">static</span> <span class="enscript-type">int</span> FilterInterface = 0;
<span class="enscript-type">static</span> FilterList *Filters;
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ExactlyOneFilter</span> (Filters &amp;&amp; !Filters-&gt;next)
<span class="enscript-type">static</span> mDNSBool AddressType = mDNSAddrType_IPv4;

<span class="enscript-type">static</span> <span class="enscript-type">int</span> NumPktQ, NumPktL, NumPktR, NumPktB;  <span class="enscript-comment">// Query/Legacy/Response/Bad
</span><span class="enscript-type">static</span> <span class="enscript-type">int</span> NumProbes, NumGoodbyes, NumQuestions, NumLegacy, NumAnswers, NumAdditionals;

<span class="enscript-type">static</span> ActivityStat *stats;

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">OPBanner</span> <span class="enscript-string">&quot;Total Ops   Probe   Goodbye  BrowseQ  BrowseA ResolveQ ResolveA&quot;</span>

mDNSexport <span class="enscript-type">void</span> <span class="enscript-function-name">mDNSCoreReceive</span>(mDNS *<span class="enscript-type">const</span> m, DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end, <span class="enscript-type">const</span> mDNSAddr *<span class="enscript-type">const</span> srcaddr, <span class="enscript-type">const</span> mDNSIPPort srcport, <span class="enscript-type">const</span> mDNSAddr *dstaddr, <span class="enscript-type">const</span> mDNSIPPort dstport, <span class="enscript-type">const</span> mDNSInterfaceID InterfaceID);

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Utilities
</span>
<span class="enscript-comment">// Special version of printf that knows how to print IP addresses, DNS-format name strings, etc.
</span>mDNSlocal mDNSu32 <span class="enscript-function-name">mprintf</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *format, ...) IS_A_PRINTF_STYLE_FUNCTION(1,2);
mDNSlocal mDNSu32 <span class="enscript-function-name">mprintf</span>(<span class="enscript-type">const</span> <span class="enscript-type">char</span> *format, ...)
{
    mDNSu32 length;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> buffer[512];
    va_list ptr;
    va_start(ptr,format);
    length = mDNS_vsnprintf((<span class="enscript-type">char</span> *)buffer, <span class="enscript-keyword">sizeof</span>(buffer), format, ptr);
    va_end(ptr);
    printf(<span class="enscript-string">&quot;%s&quot;</span>, buffer);
    <span class="enscript-keyword">return</span>(length);
}

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Host Address List
</span><span class="enscript-comment">//
</span><span class="enscript-comment">// Would benefit from a hash
</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">enum</span>
{
    HostPkt_Q        = 0,       <span class="enscript-comment">// Query
</span>    HostPkt_L        = 1,       <span class="enscript-comment">// Legacy Query
</span>    HostPkt_R        = 2,       <span class="enscript-comment">// Response
</span>    HostPkt_B        = 3,       <span class="enscript-comment">// Bad
</span>    HostPkt_NumTypes = 4
} HostPkt_Type;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span>
{
    mDNSAddr addr;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> pkts[HostPkt_NumTypes];
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> totalops;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> stat[OP_NumTypes];
    domainname hostname;
    domainname revname;
    UTF8str255 HIHardware;
    UTF8str255 HISoftware;
    mDNSu32 NumQueries;
    mDNSs32 LastQuery;
} HostEntry;

#<span class="enscript-reference">define</span> <span class="enscript-function-name">HostEntryTotalPackets</span>(H) ((H)-&gt;pkts[HostPkt_Q] + (H)-&gt;pkts[HostPkt_L] + (H)-&gt;pkts[HostPkt_R] + (H)-&gt;pkts[HostPkt_B])

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span>
{
    <span class="enscript-type">long</span> num;
    <span class="enscript-type">long</span> max;
    HostEntry   *hosts;
} HostList;

<span class="enscript-type">static</span> HostList IPv4HostList = { 0, 0, 0 };
<span class="enscript-type">static</span> HostList IPv6HostList = { 0, 0, 0 };

mDNSlocal HostEntry *<span class="enscript-function-name">FindHost</span>(<span class="enscript-type">const</span> mDNSAddr *addr, HostList *list)
{
    <span class="enscript-type">long</span> i;

    <span class="enscript-keyword">for</span> (i = 0; i &lt; list-&gt;num; i++)
    {
        HostEntry *entry = list-&gt;hosts + i;
        <span class="enscript-keyword">if</span> (mDNSSameAddress(addr, &amp;entry-&gt;addr))
            <span class="enscript-keyword">return</span> entry;
    }

    <span class="enscript-keyword">return</span> NULL;
}

mDNSlocal HostEntry *<span class="enscript-function-name">AddHost</span>(<span class="enscript-type">const</span> mDNSAddr *addr, HostList *list)
{
    <span class="enscript-type">int</span> i;
    HostEntry *entry;
    <span class="enscript-keyword">if</span> (list-&gt;num &gt;= list-&gt;max)
    {
        <span class="enscript-type">long</span> newMax = list-&gt;max + 64;
        HostEntry *newHosts = realloc(list-&gt;hosts, newMax * <span class="enscript-keyword">sizeof</span>(HostEntry));
        <span class="enscript-keyword">if</span> (newHosts == NULL)
            <span class="enscript-keyword">return</span> NULL;
        list-&gt;max = newMax;
        list-&gt;hosts = newHosts;
    }

    entry = list-&gt;hosts + list-&gt;num++;

    entry-&gt;addr = *addr;
    <span class="enscript-keyword">for</span> (i=0; i&lt;HostPkt_NumTypes; i++) entry-&gt;pkts[i] = 0;
    entry-&gt;totalops = 0;
    <span class="enscript-keyword">for</span> (i=0; i&lt;OP_NumTypes;      i++) entry-&gt;stat[i] = 0;
    entry-&gt;hostname.c[0] = 0;
    entry-&gt;revname.c[0] = 0;
    entry-&gt;HIHardware.c[0] = 0;
    entry-&gt;HISoftware.c[0] = 0;
    entry-&gt;NumQueries = 0;

    <span class="enscript-keyword">if</span> (entry-&gt;addr.type == mDNSAddrType_IPv4)
    {
        mDNSv4Addr ip = entry-&gt;addr.ip.v4;
        <span class="enscript-type">char</span> buffer[32];
        <span class="enscript-comment">// Note: This is reverse order compared to a normal dotted-decimal IP address, so we can't use our customary &quot;%.4a&quot; format code
</span>        mDNS_snprintf(buffer, <span class="enscript-keyword">sizeof</span>(buffer), <span class="enscript-string">&quot;%d.%d.%d.%d.in-addr.arpa.&quot;</span>, ip.b[3], ip.b[2], ip.b[1], ip.b[0]);
        MakeDomainNameFromDNSNameString(&amp;entry-&gt;revname, buffer);
    }

    <span class="enscript-keyword">return</span>(entry);
}

mDNSlocal HostEntry *<span class="enscript-function-name">GotPacketFromHost</span>(<span class="enscript-type">const</span> mDNSAddr *addr, HostPkt_Type t, mDNSOpaque16 id)
{
    <span class="enscript-keyword">if</span> (ExactlyOneFilter) <span class="enscript-keyword">return</span>(NULL);
    <span class="enscript-keyword">else</span>
    {
        HostList *list = (addr-&gt;type == mDNSAddrType_IPv4) ? &amp;IPv4HostList : &amp;IPv6HostList;
        HostEntry *entry = FindHost(addr, list);
        <span class="enscript-keyword">if</span> (!entry) entry = AddHost(addr, list);
        <span class="enscript-keyword">if</span> (!entry) <span class="enscript-keyword">return</span>(NULL);
        <span class="enscript-comment">// Don't count our own interrogation packets
</span>        <span class="enscript-keyword">if</span> (id.NotAnInteger != 0xFFFF) entry-&gt;pkts[t]++;
        <span class="enscript-keyword">return</span>(entry);
    }
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">RecordHostInfo</span>(HostEntry *entry, <span class="enscript-type">const</span> ResourceRecord *<span class="enscript-type">const</span> pktrr)
{
    <span class="enscript-keyword">if</span> (!entry-&gt;hostname.c[0])
    {
        <span class="enscript-keyword">if</span> (pktrr-&gt;rrtype == kDNSType_A || pktrr-&gt;rrtype == kDNSType_AAAA)
        {
            <span class="enscript-comment">// Should really check that the rdata in the address record matches the source address of this packet
</span>            entry-&gt;NumQueries = 0;
            AssignDomainName(&amp;entry-&gt;hostname, pktrr-&gt;name);
        }

        <span class="enscript-keyword">if</span> (pktrr-&gt;rrtype == kDNSType_PTR)
            <span class="enscript-keyword">if</span> (SameDomainName(&amp;entry-&gt;revname, pktrr-&gt;name))
            {
                entry-&gt;NumQueries = 0;
                AssignDomainName(&amp;entry-&gt;hostname, &amp;pktrr-&gt;rdata-&gt;u.name);
            }
    }
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (pktrr-&gt;rrtype == kDNSType_HINFO)
    {
        RDataBody *rd = &amp;pktrr-&gt;rdata-&gt;u;
        mDNSu8 *rdend = (mDNSu8 *)rd + pktrr-&gt;rdlength;
        mDNSu8 *hw = rd-&gt;txt.c;
        mDNSu8 *sw = hw + 1 + (mDNSu32)hw[0];
        <span class="enscript-keyword">if</span> (sw + 1 + sw[0] &lt;= rdend)
        {
            AssignDomainName(&amp;entry-&gt;hostname, pktrr-&gt;name);
            mDNSPlatformMemCopy(entry-&gt;HIHardware.c, hw, 1 + (mDNSu32)hw[0]);
            mDNSPlatformMemCopy(entry-&gt;HISoftware.c, sw, 1 + (mDNSu32)sw[0]);
        }
    }
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">SendUnicastQuery</span>(mDNS *<span class="enscript-type">const</span> m, HostEntry *entry, domainname *name, mDNSu16 rrtype, mDNSInterfaceID InterfaceID)
{
    <span class="enscript-type">const</span> mDNSOpaque16 id = { { 0xFF, 0xFF } };
    DNSMessage query;
    mDNSu8       *qptr        = query.data;
    <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> limit = query.data + <span class="enscript-keyword">sizeof</span>(query.data);
    <span class="enscript-type">const</span> mDNSAddr *target    = &amp;entry-&gt;addr;
    InitializeDNSMessage(&amp;query.h, id, QueryFlags);
    qptr = putQuestion(&amp;query, qptr, limit, name, rrtype, kDNSClass_IN);
    entry-&gt;LastQuery = m-&gt;timenow;
    entry-&gt;NumQueries++;

    <span class="enscript-comment">// Note: When there are multiple mDNSResponder agents running on a single machine
</span>    <span class="enscript-comment">// (e.g. Apple mDNSResponder plus a SliMP3 server with embedded mDNSResponder)
</span>    <span class="enscript-comment">// it is possible that unicast queries may not go to the primary system responder.
</span>    <span class="enscript-comment">// We try the first query using unicast, but if that doesn't work we try again via multicast.
</span>    <span class="enscript-keyword">if</span> (entry-&gt;NumQueries &gt; 2)
    {
        target = &amp;AllDNSLinkGroup_v4;
    }
    <span class="enscript-keyword">else</span>
    {
        <span class="enscript-comment">//mprintf(&quot;%#a Q\n&quot;, target);
</span>        InterfaceID = mDNSInterface_Any;    <span class="enscript-comment">// Send query from our unicast reply socket
</span>    }

    mDNSSendDNSMessage(m, &amp;query, qptr, InterfaceID, mDNSNULL, mDNSNULL, target, MulticastDNSPort, mDNSNULL, mDNSfalse);
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">AnalyseHost</span>(mDNS *<span class="enscript-type">const</span> m, HostEntry *entry, <span class="enscript-type">const</span> mDNSInterfaceID InterfaceID)
{
    <span class="enscript-comment">// If we've done four queries without answer, give up
</span>    <span class="enscript-keyword">if</span> (entry-&gt;NumQueries &gt;= 4) <span class="enscript-keyword">return</span>;

    <span class="enscript-comment">// If we've done a query in the last second, give the host a chance to reply before trying again
</span>    <span class="enscript-keyword">if</span> (entry-&gt;NumQueries &amp;&amp; m-&gt;timenow - entry-&gt;LastQuery &lt; mDNSPlatformOneSecond) <span class="enscript-keyword">return</span>;

    <span class="enscript-comment">// If we don't know the host name, try to find that first
</span>    <span class="enscript-keyword">if</span> (!entry-&gt;hostname.c[0])
    {
        <span class="enscript-keyword">if</span> (entry-&gt;revname.c[0])
        {
            SendUnicastQuery(m, entry, &amp;entry-&gt;revname, kDNSType_PTR, InterfaceID);
            <span class="enscript-comment">//mprintf(&quot;%##s PTR %d\n&quot;, entry-&gt;revname.c, entry-&gt;NumQueries);
</span>        }
    }
    <span class="enscript-comment">// If we have the host name but no HINFO, now ask for that
</span>    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!entry-&gt;HIHardware.c[0])
    {
        SendUnicastQuery(m, entry, &amp;entry-&gt;hostname, kDNSType_HINFO, InterfaceID);
        <span class="enscript-comment">//mprintf(&quot;%##s HINFO %d\n&quot;, entry-&gt;hostname.c, entry-&gt;NumQueries);
</span>    }
}

mDNSlocal <span class="enscript-type">int</span> <span class="enscript-function-name">CompareHosts</span>(<span class="enscript-type">const</span> <span class="enscript-type">void</span> *p1, <span class="enscript-type">const</span> <span class="enscript-type">void</span> *p2)
{
    <span class="enscript-keyword">return</span> (<span class="enscript-type">int</span>)(HostEntryTotalPackets((HostEntry *)p2) - HostEntryTotalPackets((HostEntry *)p1));
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">ShowSortedHostList</span>(HostList *list, <span class="enscript-type">int</span> max)
{
    HostEntry *e, *end = &amp;list-&gt;hosts[(max &lt; list-&gt;num) ? max : list-&gt;num];
    qsort(list-&gt;hosts, list-&gt;num, <span class="enscript-keyword">sizeof</span>(HostEntry), CompareHosts);
    <span class="enscript-keyword">if</span> (list-&gt;num) mprintf(<span class="enscript-string">&quot;\n%-25s%s%s\n&quot;</span>, <span class="enscript-string">&quot;Source Address&quot;</span>, OPBanner, <span class="enscript-string">&quot;    Pkts    Query   LegacyQ Response&quot;</span>);
    <span class="enscript-keyword">for</span> (e = &amp;list-&gt;hosts[0]; e &lt; end; e++)
    {
        <span class="enscript-type">int</span> len = mprintf(<span class="enscript-string">&quot;%#-25a&quot;</span>, &amp;e-&gt;addr);
        <span class="enscript-keyword">if</span> (len &gt; 25) mprintf(<span class="enscript-string">&quot;\n%25s&quot;</span>, <span class="enscript-string">&quot;&quot;</span>);
        mprintf(<span class="enscript-string">&quot;%8lu %8lu %8lu %8lu %8lu %8lu %8lu&quot;</span>, e-&gt;totalops,
                e-&gt;stat[OP_probe], e-&gt;stat[OP_goodbye],
                e-&gt;stat[OP_browseq], e-&gt;stat[OP_browsea],
                e-&gt;stat[OP_resolveq], e-&gt;stat[OP_resolvea]);
        mprintf(<span class="enscript-string">&quot; %8lu %8lu %8lu %8lu&quot;</span>,
                HostEntryTotalPackets(e), e-&gt;pkts[HostPkt_Q], e-&gt;pkts[HostPkt_L], e-&gt;pkts[HostPkt_R]);
        <span class="enscript-keyword">if</span> (e-&gt;pkts[HostPkt_B]) mprintf(<span class="enscript-string">&quot;Bad: %8lu&quot;</span>, e-&gt;pkts[HostPkt_B]);
        mprintf(<span class="enscript-string">&quot;\n&quot;</span>);
        <span class="enscript-keyword">if</span> (!e-&gt;HISoftware.c[0] &amp;&amp; e-&gt;NumQueries &gt; 2)
            mDNSPlatformMemCopy(&amp;e-&gt;HISoftware, <span class="enscript-string">&quot;\x27*** Unknown (Jaguar, Windows, etc.) ***&quot;</span>, 0x28);
        <span class="enscript-keyword">if</span> (e-&gt;hostname.c[0] || e-&gt;HIHardware.c[0] || e-&gt;HISoftware.c[0])
            mprintf(<span class="enscript-string">&quot;%##-45s %#-14s %#s\n&quot;</span>, e-&gt;hostname.c, e-&gt;HIHardware.c, e-&gt;HISoftware.c);
    }
}

<span class="enscript-comment">//*************************************************************************************************************
</span><span class="enscript-comment">// Receive and process packets
</span>
mDNSlocal mDNSBool <span class="enscript-function-name">ExtractServiceType</span>(<span class="enscript-type">const</span> domainname *<span class="enscript-type">const</span> fqdn, domainname *<span class="enscript-type">const</span> srvtype)
{
    <span class="enscript-type">int</span> i, len;
    <span class="enscript-type">const</span> mDNSu8 *src = fqdn-&gt;c;
    mDNSu8 *dst = srvtype-&gt;c;

    len = *src;
    <span class="enscript-keyword">if</span> (len == 0 || len &gt;= 0x40) <span class="enscript-keyword">return</span>(mDNSfalse);
    <span class="enscript-keyword">if</span> (src[1] != <span class="enscript-string">'_'</span>) src += 1 + len;

    len = *src;
    <span class="enscript-keyword">if</span> (len == 0 || len &gt;= 0x40 || src[1] != <span class="enscript-string">'_'</span>) <span class="enscript-keyword">return</span>(mDNSfalse);
    <span class="enscript-keyword">for</span> (i=0; i&lt;=len; i++) *dst++ = *src++;

    len = *src;
    <span class="enscript-keyword">if</span> (len == 0 || len &gt;= 0x40 || src[1] != <span class="enscript-string">'_'</span>) <span class="enscript-keyword">return</span>(mDNSfalse);
    <span class="enscript-keyword">for</span> (i=0; i&lt;=len; i++) *dst++ = *src++;

    *dst++ = 0;     <span class="enscript-comment">// Put the null root label on the end of the service type
</span>
    <span class="enscript-keyword">return</span>(mDNStrue);
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">recordstat</span>(HostEntry *entry, <span class="enscript-type">const</span> domainname *fqdn, <span class="enscript-type">int</span> op, mDNSu16 rrtype)
{
    ActivityStat **s = &amp;stats;
    domainname srvtype;

    <span class="enscript-keyword">if</span> (op != OP_probe)
    {
        <span class="enscript-keyword">if</span> (rrtype == kDNSType_SRV || rrtype == kDNSType_TXT) op = op - OP_browsegroup + OP_resolvegroup;
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (rrtype != kDNSType_PTR) <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-keyword">if</span> (!ExtractServiceType(fqdn, &amp;srvtype)) <span class="enscript-keyword">return</span>;

    <span class="enscript-keyword">while</span> (*s &amp;&amp; !SameDomainName(&amp;(*s)-&gt;srvtype, &amp;srvtype)) s = &amp;(*s)-&gt;next;
    <span class="enscript-keyword">if</span> (!*s)
    {
        <span class="enscript-type">int</span> i;
        *s = malloc(<span class="enscript-keyword">sizeof</span>(ActivityStat));
        <span class="enscript-keyword">if</span> (!*s) exit(-1);
        (*s)-&gt;next     = NULL;
        (*s)-&gt;srvtype  = srvtype;
        (*s)-&gt;printed  = 0;
        (*s)-&gt;totalops = 0;
        <span class="enscript-keyword">for</span> (i=0; i&lt;OP_NumTypes; i++) (*s)-&gt;stat[i] = 0;
    }

    (*s)-&gt;totalops++;
    (*s)-&gt;stat[op]++;
    <span class="enscript-keyword">if</span> (entry)
    {
        entry-&gt;totalops++;
        entry-&gt;stat[op]++;
    }
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">printstats</span>(<span class="enscript-type">int</span> max)
{
    <span class="enscript-type">int</span> i;
    <span class="enscript-keyword">if</span> (!stats) <span class="enscript-keyword">return</span>;
    <span class="enscript-keyword">for</span> (i=0; i&lt;max; i++)
    {
        <span class="enscript-type">int</span> max_val = 0;
        ActivityStat *s, *m = NULL;
        <span class="enscript-keyword">for</span> (s = stats; s; s=s-&gt;next)
            <span class="enscript-keyword">if</span> (!s-&gt;printed &amp;&amp; max_val &lt; s-&gt;totalops)
            { m = s; max_val = s-&gt;totalops; }
        <span class="enscript-keyword">if</span> (!m) <span class="enscript-keyword">return</span>;
        m-&gt;printed = mDNStrue;
        <span class="enscript-keyword">if</span> (i==0) mprintf(<span class="enscript-string">&quot;%-25s%s\n&quot;</span>, <span class="enscript-string">&quot;Service Type&quot;</span>, OPBanner);
        mprintf(<span class="enscript-string">&quot;%##-25s%8d %8d %8d %8d %8d %8d %8d\n&quot;</span>, m-&gt;srvtype.c, m-&gt;totalops, m-&gt;stat[OP_probe],
                m-&gt;stat[OP_goodbye], m-&gt;stat[OP_browseq], m-&gt;stat[OP_browsea], m-&gt;stat[OP_resolveq], m-&gt;stat[OP_resolvea]);
    }
}

mDNSlocal <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-function-name">FindUpdate</span>(mDNS *<span class="enscript-type">const</span> m, <span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> query, <span class="enscript-type">const</span> mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end,
                                   DNSQuestion *q, LargeCacheRecord *pkt)
{
    <span class="enscript-type">int</span> i;
    <span class="enscript-keyword">for</span> (i = 0; i &lt; query-&gt;h.numAuthorities; i++)
    {
        <span class="enscript-type">const</span> mDNSu8 *p2 = ptr;
        ptr = GetLargeResourceRecord(m, query, ptr, end, q-&gt;InterfaceID, kDNSRecordTypePacketAuth, pkt);
        <span class="enscript-keyword">if</span> (!ptr) <span class="enscript-keyword">break</span>;
        <span class="enscript-keyword">if</span> (m-&gt;rec.r.resrec.RecordType != kDNSRecordTypePacketNegative &amp;&amp; ResourceRecordAnswersQuestion(&amp;pkt-&gt;r.resrec, q)) <span class="enscript-keyword">return</span>(p2);
    }
    <span class="enscript-keyword">return</span>(mDNSNULL);
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">DisplayPacketHeader</span>(mDNS *<span class="enscript-type">const</span> m, <span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end, <span class="enscript-type">const</span> mDNSAddr *srcaddr, mDNSIPPort srcport, <span class="enscript-type">const</span> mDNSAddr *dstaddr, <span class="enscript-type">const</span> mDNSInterfaceID InterfaceID)
{
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-type">const</span> ptype = (msg-&gt;h.flags.b[0] &amp; kDNSFlag0_QR_Response)             ? <span class="enscript-string">&quot;-R- &quot;</span> :
                              (srcport.NotAnInteger == MulticastDNSPort.NotAnInteger) ? <span class="enscript-string">&quot;-Q- &quot;</span> : <span class="enscript-string">&quot;-LQ-&quot;</span>;
    <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> length = end - (mDNSu8 *)msg;
    <span class="enscript-type">struct</span> timeval tv;
    <span class="enscript-type">struct</span> tm tm;
    <span class="enscript-type">const</span> mDNSu32 index = mDNSPlatformInterfaceIndexfromInterfaceID(m, InterfaceID, mDNSfalse);
    <span class="enscript-type">char</span> if_name[IFNAMSIZ];     <span class="enscript-comment">// Older Linux distributions don't define IF_NAMESIZE
</span>    if_indextoname(index, if_name);
    gettimeofday(&amp;tv, NULL);
    localtime_r((time_t*)&amp;tv.tv_sec, &amp;tm);
    mprintf(<span class="enscript-string">&quot;\n%d:%02d:%02d.%06d Interface %d/%s\n&quot;</span>, tm.tm_hour, tm.tm_min, tm.tm_sec, tv.tv_usec, index, if_name);

    mprintf(<span class="enscript-string">&quot;%#-16a %s             Q:%3d  Ans:%3d  Auth:%3d  Add:%3d  Size:%5d bytes&quot;</span>,
            srcaddr, ptype, msg-&gt;h.numQuestions, msg-&gt;h.numAnswers, msg-&gt;h.numAuthorities, msg-&gt;h.numAdditionals, length);

    <span class="enscript-keyword">if</span> (msg-&gt;h.id.NotAnInteger) mprintf(<span class="enscript-string">&quot;  ID:%u&quot;</span>, mDNSVal16(msg-&gt;h.id));

    <span class="enscript-keyword">if</span> (!mDNSAddrIsDNSMulticast(dstaddr)) mprintf(<span class="enscript-string">&quot;   To: %#a&quot;</span>, dstaddr);

    <span class="enscript-keyword">if</span> (msg-&gt;h.flags.b[0] &amp; kDNSFlag0_TC)
    {
        <span class="enscript-keyword">if</span> (msg-&gt;h.flags.b[0] &amp; kDNSFlag0_QR_Response) mprintf(<span class="enscript-string">&quot;   Truncated&quot;</span>);
        <span class="enscript-keyword">else</span> mprintf(<span class="enscript-string">&quot;   Truncated (KA list continues in next packet)&quot;</span>);
    }

    mprintf(<span class="enscript-string">&quot;\n&quot;</span>);

    <span class="enscript-keyword">if</span> (length &lt; <span class="enscript-keyword">sizeof</span>(DNSMessageHeader) + NormalMaxDNSMessageData - 192)
        <span class="enscript-keyword">if</span> (msg-&gt;h.flags.b[0] &amp; kDNSFlag0_TC)
            mprintf(<span class="enscript-string">&quot;%#-16a **** WARNING: Packet suspiciously small. Payload size (excluding IP and UDP headers)\n&quot;</span>
                    <span class="enscript-string">&quot;%#-16a **** should usually be closer to %d bytes before truncation becomes necessary.\n&quot;</span>,
                    srcaddr, srcaddr, <span class="enscript-keyword">sizeof</span>(DNSMessageHeader) + NormalMaxDNSMessageData);
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">DisplaySizeCheck</span>(<span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end, <span class="enscript-type">const</span> mDNSAddr *srcaddr, <span class="enscript-type">int</span> num_opts)
{
    <span class="enscript-type">const</span> <span class="enscript-type">unsigned</span> length = end - (mDNSu8 *)msg;
    <span class="enscript-type">const</span> <span class="enscript-type">int</span> num_records = msg-&gt;h.numAnswers + msg-&gt;h.numAuthorities + msg-&gt;h.numAdditionals - num_opts;

    <span class="enscript-keyword">if</span> (length &gt; <span class="enscript-keyword">sizeof</span>(DNSMessageHeader) + NormalMaxDNSMessageData)
        <span class="enscript-keyword">if</span> (num_records &gt; 1)
            mprintf(<span class="enscript-string">&quot;%#-16a **** ERROR: Oversized packet with %d records.\n&quot;</span>
                    <span class="enscript-string">&quot;%#-16a **** Many network devices cannot receive packets larger than %d bytes.\n&quot;</span>
                    <span class="enscript-string">&quot;%#-16a **** To minimize interoperability failures, oversized packets MUST be limited to a single resource record.\n&quot;</span>,
                    srcaddr, num_records, srcaddr, 40 + 8 + <span class="enscript-keyword">sizeof</span>(DNSMessageHeader) + NormalMaxDNSMessageData, srcaddr);
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">DisplayResourceRecord</span>(<span class="enscript-type">const</span> mDNSAddr *<span class="enscript-type">const</span> srcaddr, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *<span class="enscript-type">const</span> op, <span class="enscript-type">const</span> ResourceRecord *<span class="enscript-type">const</span> pktrr)
{
    <span class="enscript-type">static</span> <span class="enscript-type">const</span> <span class="enscript-type">char</span> hexchars[16] = <span class="enscript-string">&quot;0123456789ABCDEF&quot;</span>;
    #define MaxWidth 132
    <span class="enscript-type">char</span> buffer[MaxWidth+8];
    <span class="enscript-type">char</span> *p = buffer;

    RDataBody *rd = &amp;pktrr-&gt;rdata-&gt;u;
    mDNSu8 *rdend = (mDNSu8 *)rd + pktrr-&gt;rdlength;
    <span class="enscript-type">int</span> n = mprintf(<span class="enscript-string">&quot;%#-16a %-5s %-5s%5lu %##s -&gt; &quot;</span>, srcaddr, op, DNSTypeName(pktrr-&gt;rrtype), pktrr-&gt;rroriginalttl, pktrr-&gt;name-&gt;c);

    <span class="enscript-keyword">if</span> (pktrr-&gt;RecordType == kDNSRecordTypePacketNegative) { mprintf(<span class="enscript-string">&quot;**** ERROR: FAILED TO READ RDATA ****\n&quot;</span>); <span class="enscript-keyword">return</span>; }

    <span class="enscript-comment">// The kDNSType_OPT case below just calls GetRRDisplayString_rdb
</span>    <span class="enscript-comment">// Perhaps more (or all?) of the cases should do that?
</span>    <span class="enscript-keyword">switch</span>(pktrr-&gt;rrtype)
    {
    <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSType_A</span>:    mprintf(<span class="enscript-string">&quot;%.4a&quot;</span>, &amp;rd-&gt;ipv4); <span class="enscript-keyword">break</span>;
    <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSType_PTR</span>:  mprintf(<span class="enscript-string">&quot;%##.*s&quot;</span>, MaxWidth - n, rd-&gt;name.c); <span class="enscript-keyword">break</span>;
    <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSType_HINFO</span>:    <span class="enscript-comment">// same as kDNSType_TXT below
</span>    <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSType_TXT</span>:  {
        mDNSu8 *t = rd-&gt;txt.c;
        <span class="enscript-keyword">while</span> (t &lt; rdend &amp;&amp; t[0] &amp;&amp; p &lt; buffer+MaxWidth)
        {
            <span class="enscript-type">int</span> i;
            <span class="enscript-keyword">for</span> (i=1; i&lt;=t[0] &amp;&amp; p &lt; buffer+MaxWidth; i++)
            {
                <span class="enscript-keyword">if</span> (t[i] == <span class="enscript-string">'\\'</span>) *p++ = <span class="enscript-string">'\\'</span>;
                <span class="enscript-keyword">if</span> (t[i] &gt;= <span class="enscript-string">' '</span>) *p++ = t[i];
                <span class="enscript-keyword">else</span>
                {
                    *p++ = <span class="enscript-string">'\\'</span>;
                    *p++ = <span class="enscript-string">'0'</span>;
                    *p++ = <span class="enscript-string">'x'</span>;
                    *p++ = hexchars[t[i] &gt;&gt; 4];
                    *p++ = hexchars[t[i] &amp; 0xF];
                }
            }
            t += 1+t[0];
            <span class="enscript-keyword">if</span> (t &lt; rdend &amp;&amp; t[0]) { *p++ = <span class="enscript-string">'\\'</span>; *p++ = <span class="enscript-string">' '</span>; }
        }
        *p++ = 0;
        mprintf(<span class="enscript-string">&quot;%.*s&quot;</span>, MaxWidth - n, buffer);
    } <span class="enscript-keyword">break</span>;
    <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSType_AAAA</span>: mprintf(<span class="enscript-string">&quot;%.16a&quot;</span>, &amp;rd-&gt;ipv6); <span class="enscript-keyword">break</span>;
    <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSType_SRV</span>:  mprintf(<span class="enscript-string">&quot;%##s:%d&quot;</span>, rd-&gt;srv.target.c, mDNSVal16(rd-&gt;srv.port)); <span class="enscript-keyword">break</span>;
    <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSType_OPT</span>:  {
        <span class="enscript-type">char</span> b[MaxMsg];
        <span class="enscript-comment">// Quick hack: we don't want the prefix that GetRRDisplayString_rdb puts at the start of its
</span>        <span class="enscript-comment">// string, because it duplicates the name and rrtype we already display, so we compute the
</span>        <span class="enscript-comment">// length of that prefix and strip that many bytes off the beginning of the string we display.
</span>        mDNSu32 striplen = mDNS_snprintf(b, MaxMsg-1, <span class="enscript-string">&quot;%4d %##s %s &quot;</span>, pktrr-&gt;rdlength, pktrr-&gt;name-&gt;c, DNSTypeName(pktrr-&gt;rrtype));
        GetRRDisplayString_rdb(pktrr, &amp;pktrr-&gt;rdata-&gt;u, b);
        mprintf(<span class="enscript-string">&quot;%.*s&quot;</span>, MaxWidth - n, b + striplen);
    } <span class="enscript-keyword">break</span>;
    <span class="enscript-keyword">case</span> <span class="enscript-reference">kDNSType_NSEC</span>: {
        <span class="enscript-type">char</span> b[MaxMsg];
        <span class="enscript-comment">// See the quick hack above
</span>        mDNSu32 striplen = mDNS_snprintf(b, MaxMsg-1, <span class="enscript-string">&quot;%4d %##s %s &quot;</span>, pktrr-&gt;rdlength, pktrr-&gt;name-&gt;c, DNSTypeName(pktrr-&gt;rrtype));
        GetRRDisplayString_rdb(pktrr, &amp;pktrr-&gt;rdata-&gt;u, b);
        mprintf(<span class="enscript-string">&quot;%s&quot;</span>, b+striplen);
    } <span class="enscript-keyword">break</span>;
    <span class="enscript-reference">default</span>:            {
        mDNSu8 *s = rd-&gt;data;
        <span class="enscript-keyword">while</span> (s &lt; rdend &amp;&amp; p &lt; buffer+MaxWidth)
        {
            <span class="enscript-keyword">if</span> (*s == <span class="enscript-string">'\\'</span>) *p++ = <span class="enscript-string">'\\'</span>;
            <span class="enscript-keyword">if</span> (*s &gt;= <span class="enscript-string">' '</span>) *p++ = *s;
            <span class="enscript-keyword">else</span>
            {
                *p++ = <span class="enscript-string">'\\'</span>;
                *p++ = <span class="enscript-string">'0'</span>;
                *p++ = <span class="enscript-string">'x'</span>;
                *p++ = hexchars[*s &gt;&gt; 4];
                *p++ = hexchars[*s &amp; 0xF];
            }
            s++;
        }
        *p++ = 0;
        mprintf(<span class="enscript-string">&quot;%.*s&quot;</span>, MaxWidth - n, buffer);
    } <span class="enscript-keyword">break</span>;
    }

    mprintf(<span class="enscript-string">&quot;\n&quot;</span>);
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">HexDump</span>(<span class="enscript-type">const</span> mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end)
{
    <span class="enscript-keyword">while</span> (ptr &lt; end)
    {
        <span class="enscript-type">int</span> i;
        <span class="enscript-keyword">for</span> (i=0; i&lt;16; i++)
            <span class="enscript-keyword">if</span> (&amp;ptr[i] &lt; end) mprintf(<span class="enscript-string">&quot;%02X &quot;</span>, ptr[i]);
            <span class="enscript-keyword">else</span> mprintf(<span class="enscript-string">&quot;   &quot;</span>);
        <span class="enscript-keyword">for</span> (i=0; i&lt;16; i++)
            <span class="enscript-keyword">if</span> (&amp;ptr[i] &lt; end) mprintf(<span class="enscript-string">&quot;%c&quot;</span>, ptr[i] &lt;= <span class="enscript-string">' '</span> || ptr[i] &gt;= 126 ? <span class="enscript-string">'.'</span> : ptr[i]);
        ptr += 16;
        mprintf(<span class="enscript-string">&quot;\n&quot;</span>);
    }
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">DisplayError</span>(<span class="enscript-type">const</span> mDNSAddr *srcaddr, <span class="enscript-type">const</span> mDNSu8 *ptr, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end, <span class="enscript-type">char</span> *msg)
{
    mprintf(<span class="enscript-string">&quot;%#-16a **** ERROR: FAILED TO READ %s ****\n&quot;</span>, srcaddr, msg);
    HexDump(ptr, end);
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">DisplayQuery</span>(mDNS *<span class="enscript-type">const</span> m, <span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end,
                            <span class="enscript-type">const</span> mDNSAddr *srcaddr, mDNSIPPort srcport, <span class="enscript-type">const</span> mDNSAddr *dstaddr, <span class="enscript-type">const</span> mDNSInterfaceID InterfaceID)
{
    <span class="enscript-type">int</span> i;
    <span class="enscript-type">int</span> num_opts = 0;
    <span class="enscript-type">const</span> mDNSu8 *ptr = msg-&gt;data;
    <span class="enscript-type">const</span> mDNSu8 *auth = LocateAuthorities(msg, end);
    mDNSBool MQ = (srcport.NotAnInteger == MulticastDNSPort.NotAnInteger);
    HostEntry *entry = GotPacketFromHost(srcaddr, MQ ? HostPkt_Q : HostPkt_L, msg-&gt;h.id);
    LargeCacheRecord pkt;

    DisplayPacketHeader(m, msg, end, srcaddr, srcport, dstaddr, InterfaceID);
    <span class="enscript-keyword">if</span> (msg-&gt;h.id.NotAnInteger != 0xFFFF)
    {
        <span class="enscript-keyword">if</span> (MQ) NumPktQ++; <span class="enscript-keyword">else</span> NumPktL++;
    }

    <span class="enscript-keyword">for</span> (i=0; i&lt;msg-&gt;h.numQuestions; i++)
    {
        DNSQuestion q;
        mDNSu8 *p2 = (mDNSu8 *)getQuestion(msg, ptr, end, InterfaceID, &amp;q);
        mDNSu16 ucbit = q.qclass &amp; kDNSQClass_UnicastResponse;
        q.qclass &amp;= ~kDNSQClass_UnicastResponse;
        <span class="enscript-keyword">if</span> (!p2) { DisplayError(srcaddr, ptr, end, <span class="enscript-string">&quot;QUESTION&quot;</span>); <span class="enscript-keyword">return</span>; }
        ptr = p2;
        p2 = (mDNSu8 *)FindUpdate(m, msg, auth, end, &amp;q, &amp;pkt);
        <span class="enscript-keyword">if</span> (p2)
        {
            NumProbes++;
            DisplayResourceRecord(srcaddr, ucbit ? <span class="enscript-string">&quot;(PU)&quot;</span> : <span class="enscript-string">&quot;(PM)&quot;</span>, &amp;pkt.r.resrec);
            recordstat(entry, &amp;q.qname, OP_probe, q.qtype);
            p2 = (mDNSu8 *)skipDomainName(msg, p2, end);
            <span class="enscript-comment">// Having displayed this update record, clear type and class so we don't display the same one again.
</span>            p2[0] = p2[1] = p2[2] = p2[3] = 0;
        }
        <span class="enscript-keyword">else</span>
        {
            <span class="enscript-type">const</span> <span class="enscript-type">char</span> *ptype = ucbit ? <span class="enscript-string">&quot;(QU)&quot;</span> : <span class="enscript-string">&quot;(QM)&quot;</span>;
            <span class="enscript-keyword">if</span> (srcport.NotAnInteger == MulticastDNSPort.NotAnInteger) NumQuestions++;
            <span class="enscript-keyword">else</span> { NumLegacy++; ptype = <span class="enscript-string">&quot;(LQ)&quot;</span>; }
            mprintf(<span class="enscript-string">&quot;%#-16a %-5s %-5s      %##s\n&quot;</span>, srcaddr, ptype, DNSTypeName(q.qtype), q.qname.c);
            <span class="enscript-keyword">if</span> (msg-&gt;h.id.NotAnInteger != 0xFFFF) recordstat(entry, &amp;q.qname, OP_query, q.qtype);
        }
    }

    <span class="enscript-keyword">for</span> (i=0; i&lt;msg-&gt;h.numAnswers; i++)
    {
        <span class="enscript-type">const</span> mDNSu8 *ep = ptr;
        ptr = GetLargeResourceRecord(m, msg, ptr, end, InterfaceID, kDNSRecordTypePacketAns, &amp;pkt);
        <span class="enscript-keyword">if</span> (!ptr) { DisplayError(srcaddr, ep, end, <span class="enscript-string">&quot;KNOWN ANSWER&quot;</span>); <span class="enscript-keyword">return</span>; }
        DisplayResourceRecord(srcaddr, <span class="enscript-string">&quot;(KA)&quot;</span>, &amp;pkt.r.resrec);
        <span class="enscript-keyword">if</span> (pkt.r.resrec.rrtype == kDNSType_OPT)
            { num_opts++; mprintf(<span class="enscript-string">&quot;%#-16a **** ERROR: OPT RECORD IN ANSWER SECTION ****\n&quot;</span>, srcaddr); }

        <span class="enscript-comment">// In the case of queries with long multi-packet KA lists, we count each subsequent KA packet
</span>        <span class="enscript-comment">// the same as a single query, to more accurately reflect the burden on the network
</span>        <span class="enscript-comment">// (A query with a six-packet KA list is *at least* six times the burden on the network as a single-packet query.)
</span>        <span class="enscript-keyword">if</span> (msg-&gt;h.numQuestions == 0 &amp;&amp; i == 0)
            recordstat(entry, pkt.r.resrec.name, OP_query, pkt.r.resrec.rrtype);
    }

    <span class="enscript-keyword">for</span> (i=0; i&lt;msg-&gt;h.numAuthorities; i++)
    {
        <span class="enscript-type">const</span> mDNSu8 *ep = ptr;
        ptr = GetLargeResourceRecord(m, msg, ptr, end, InterfaceID, kDNSRecordTypePacketAuth, &amp;pkt);
        <span class="enscript-keyword">if</span> (!ptr) { DisplayError(srcaddr, ep, end, <span class="enscript-string">&quot;AUTHORITY&quot;</span>); <span class="enscript-keyword">return</span>; }
        <span class="enscript-comment">// After we display an Update record with its matching question (above) we zero out its type and class
</span>        <span class="enscript-comment">// If any remain that haven't been zero'd out, display them here
</span>        <span class="enscript-keyword">if</span> (pkt.r.resrec.rrtype || pkt.r.resrec.rrclass) DisplayResourceRecord(srcaddr, <span class="enscript-string">&quot;(AU)&quot;</span>, &amp;pkt.r.resrec);
        <span class="enscript-keyword">if</span> (pkt.r.resrec.rrtype == kDNSType_OPT)
            { num_opts++; mprintf(<span class="enscript-string">&quot;%#-16a **** ERROR: OPT RECORD IN AUTHORITY SECTION ****\n&quot;</span>, srcaddr); }
    }

    <span class="enscript-keyword">for</span> (i=0; i&lt;msg-&gt;h.numAdditionals; i++)
    {
        <span class="enscript-type">const</span> mDNSu8 *ep = ptr;
        ptr = GetLargeResourceRecord(m, msg, ptr, end, InterfaceID, kDNSRecordTypePacketAdd, &amp;pkt);
        <span class="enscript-keyword">if</span> (!ptr) { DisplayError(srcaddr, ep, end, <span class="enscript-string">&quot;ADDITIONAL&quot;</span>); <span class="enscript-keyword">return</span>; }
        DisplayResourceRecord(srcaddr, pkt.r.resrec.rrtype == kDNSType_OPT ? <span class="enscript-string">&quot;(OP)&quot;</span> : <span class="enscript-string">&quot;(AD)&quot;</span>, &amp;pkt.r.resrec);
        <span class="enscript-keyword">if</span> (pkt.r.resrec.rrtype == kDNSType_OPT) num_opts++;
    }

    DisplaySizeCheck(msg, end, srcaddr, num_opts);

    <span class="enscript-comment">// We don't hexdump the DNSMessageHeader here because those six fields (id, flags, numQuestions, numAnswers, numAuthorities, numAdditionals)
</span>    <span class="enscript-comment">// have already been swapped to host byte order and displayed, so including them in the hexdump is confusing
</span>    <span class="enscript-keyword">if</span> (num_opts &gt; 1) { mprintf(<span class="enscript-string">&quot;%#-16a **** ERROR: MULTIPLE OPT RECORDS ****\n&quot;</span>, srcaddr); HexDump(msg-&gt;data, end); }

    <span class="enscript-keyword">if</span> (entry) AnalyseHost(m, entry, InterfaceID);
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">DisplayResponse</span>(mDNS *<span class="enscript-type">const</span> m, <span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *end,
                               <span class="enscript-type">const</span> mDNSAddr *srcaddr, mDNSIPPort srcport, <span class="enscript-type">const</span> mDNSAddr *dstaddr, <span class="enscript-type">const</span> mDNSInterfaceID InterfaceID)
{
    <span class="enscript-type">int</span> i;
    <span class="enscript-type">int</span> num_opts = 0;
    <span class="enscript-type">const</span> mDNSu8 *ptr = msg-&gt;data;
    HostEntry *entry = GotPacketFromHost(srcaddr, HostPkt_R, msg-&gt;h.id);
    LargeCacheRecord pkt;

    DisplayPacketHeader(m, msg, end, srcaddr, srcport, dstaddr, InterfaceID);
    <span class="enscript-keyword">if</span> (msg-&gt;h.id.NotAnInteger != 0xFFFF) NumPktR++;

    <span class="enscript-keyword">for</span> (i=0; i&lt;msg-&gt;h.numQuestions; i++)
    {
        DNSQuestion q;
        <span class="enscript-type">const</span> mDNSu8 *ep = ptr;
        ptr = getQuestion(msg, ptr, end, InterfaceID, &amp;q);
        <span class="enscript-keyword">if</span> (!ptr) { DisplayError(srcaddr, ep, end, <span class="enscript-string">&quot;QUESTION&quot;</span>); <span class="enscript-keyword">return</span>; }
        <span class="enscript-keyword">if</span> (mDNSAddrIsDNSMulticast(dstaddr))
            mprintf(<span class="enscript-string">&quot;%#-16a (?)   **** ERROR: SHOULD NOT HAVE Q IN mDNS RESPONSE **** %-5s %##s\n&quot;</span>, srcaddr, DNSTypeName(q.qtype), q.qname.c);
        <span class="enscript-keyword">else</span>
            mprintf(<span class="enscript-string">&quot;%#-16a (Q)   %-5s      %##s\n&quot;</span>, srcaddr, DNSTypeName(q.qtype), q.qname.c);
    }

    <span class="enscript-keyword">for</span> (i=0; i&lt;msg-&gt;h.numAnswers; i++)
    {
        <span class="enscript-type">const</span> mDNSu8 *ep = ptr;
        ptr = GetLargeResourceRecord(m, msg, ptr, end, InterfaceID, kDNSRecordTypePacketAns, &amp;pkt);
        <span class="enscript-keyword">if</span> (!ptr) { DisplayError(srcaddr, ep, end, <span class="enscript-string">&quot;ANSWER&quot;</span>); <span class="enscript-keyword">return</span>; }
        <span class="enscript-keyword">if</span> (pkt.r.resrec.rroriginalttl)
        {
            NumAnswers++;
            DisplayResourceRecord(srcaddr, (pkt.r.resrec.RecordType &amp; kDNSRecordTypePacketUniqueMask) ? <span class="enscript-string">&quot;(AN)&quot;</span> : <span class="enscript-string">&quot;(AN+)&quot;</span>, &amp;pkt.r.resrec);
            <span class="enscript-keyword">if</span> (msg-&gt;h.id.NotAnInteger != 0xFFFF) recordstat(entry, pkt.r.resrec.name, OP_answer, pkt.r.resrec.rrtype);
            <span class="enscript-keyword">if</span> (entry) RecordHostInfo(entry, &amp;pkt.r.resrec);
        }
        <span class="enscript-keyword">else</span>
        {
            NumGoodbyes++;
            DisplayResourceRecord(srcaddr, <span class="enscript-string">&quot;(DE)&quot;</span>, &amp;pkt.r.resrec);
            recordstat(entry, pkt.r.resrec.name, OP_goodbye, pkt.r.resrec.rrtype);
        }
        <span class="enscript-keyword">if</span> (pkt.r.resrec.rrtype == kDNSType_OPT)
            { num_opts++; mprintf(<span class="enscript-string">&quot;%#-16a **** ERROR: OPT RECORD IN ANSWER SECTION ****\n&quot;</span>, srcaddr); }
    }

    <span class="enscript-keyword">for</span> (i=0; i&lt;msg-&gt;h.numAuthorities; i++)
    {
        <span class="enscript-type">const</span> mDNSu8 *ep = ptr;
        ptr = GetLargeResourceRecord(m, msg, ptr, end, InterfaceID, kDNSRecordTypePacketAuth, &amp;pkt);
        <span class="enscript-keyword">if</span> (!ptr) { DisplayError(srcaddr, ep, end, <span class="enscript-string">&quot;AUTHORITY&quot;</span>); <span class="enscript-keyword">return</span>; }
        DisplayResourceRecord(srcaddr, <span class="enscript-string">&quot;(AU)&quot;</span>, &amp;pkt.r.resrec);
        <span class="enscript-keyword">if</span> (pkt.r.resrec.rrtype == kDNSType_OPT)
            { num_opts++; mprintf(<span class="enscript-string">&quot;%#-16a **** ERROR: OPT RECORD IN AUTHORITY SECTION ****\n&quot;</span>, srcaddr); }
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (pkt.r.resrec.rrtype != kDNSType_NSEC3)
            mprintf(<span class="enscript-string">&quot;%#-16a (?)  **** ERROR: SHOULD NOT HAVE AUTHORITY IN mDNS RESPONSE **** %-5s %##s\n&quot;</span>,
                srcaddr, DNSTypeName(pkt.r.resrec.rrtype), pkt.r.resrec.name-&gt;c);
    }

    <span class="enscript-keyword">for</span> (i=0; i&lt;msg-&gt;h.numAdditionals; i++)
    {
        <span class="enscript-type">const</span> mDNSu8 *ep = ptr;
        ptr = GetLargeResourceRecord(m, msg, ptr, end, InterfaceID, kDNSRecordTypePacketAdd, &amp;pkt);
        <span class="enscript-keyword">if</span> (!ptr) { DisplayError(srcaddr, ep, end, <span class="enscript-string">&quot;ADDITIONAL&quot;</span>); <span class="enscript-keyword">return</span>; }
        NumAdditionals++;
        <span class="enscript-keyword">if</span> (pkt.r.resrec.rrtype == kDNSType_OPT) num_opts++;
        DisplayResourceRecord(srcaddr,
                              pkt.r.resrec.rrtype == kDNSType_OPT ? <span class="enscript-string">&quot;(OP)&quot;</span> : (pkt.r.resrec.RecordType &amp; kDNSRecordTypePacketUniqueMask) ? <span class="enscript-string">&quot;(AD)&quot;</span> : <span class="enscript-string">&quot;(AD+)&quot;</span>,
                              &amp;pkt.r.resrec);
        <span class="enscript-keyword">if</span> (entry) RecordHostInfo(entry, &amp;pkt.r.resrec);
    }

    DisplaySizeCheck(msg, end, srcaddr, num_opts);

    <span class="enscript-comment">// We don't hexdump the DNSMessageHeader here because those six fields (id, flags, numQuestions, numAnswers, numAuthorities, numAdditionals)
</span>    <span class="enscript-comment">// have already been swapped to host byte order and displayed, so including them in the hexdump is confusing
</span>    <span class="enscript-keyword">if</span> (num_opts &gt; 1) { mprintf(<span class="enscript-string">&quot;%#-16a **** ERROR: MULTIPLE OPT RECORDS ****\n&quot;</span>, srcaddr); HexDump(msg-&gt;data, end); }

    <span class="enscript-keyword">if</span> (entry) AnalyseHost(m, entry, InterfaceID);
}

mDNSlocal <span class="enscript-type">void</span> <span class="enscript-function-name">ProcessUnicastResponse</span>(mDNS *<span class="enscript-type">const</span> m, <span class="enscript-type">const</span> DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *end, <span class="enscript-type">const</span> mDNSAddr *srcaddr, <span class="enscript-type">const</span> mDNSInterfaceID InterfaceID)
{
    <span class="enscript-type">int</span> i;
    <span class="enscript-type">const</span> mDNSu8 *ptr = LocateAnswers(msg, end);
    HostEntry *entry = GotPacketFromHost(srcaddr, HostPkt_R, msg-&gt;h.id);
    <span class="enscript-comment">//mprintf(&quot;%#a R\n&quot;, srcaddr);
</span>
    <span class="enscript-keyword">for</span> (i=0; i&lt;msg-&gt;h.numAnswers + msg-&gt;h.numAuthorities + msg-&gt;h.numAdditionals; i++)
    {
        LargeCacheRecord pkt;
        ptr = GetLargeResourceRecord(m, msg, ptr, end, InterfaceID, kDNSRecordTypePacketAns, &amp;pkt);
        <span class="enscript-keyword">if</span> (ptr &amp;&amp; pkt.r.resrec.rroriginalttl &amp;&amp; entry) RecordHostInfo(entry, &amp;pkt.r.resrec);
    }
}

mDNSlocal mDNSBool <span class="enscript-function-name">AddressMatchesFilterList</span>(<span class="enscript-type">const</span> mDNSAddr *srcaddr)
{
    FilterList *f;
    <span class="enscript-keyword">if</span> (!Filters) <span class="enscript-keyword">return</span>(srcaddr-&gt;type == AddressType);
    <span class="enscript-keyword">for</span> (f=Filters; f; f=f-&gt;next) <span class="enscript-keyword">if</span> (mDNSSameAddress(srcaddr, &amp;f-&gt;FilterAddr)) <span class="enscript-keyword">return</span>(mDNStrue);
    <span class="enscript-keyword">return</span>(mDNSfalse);
}

mDNSexport <span class="enscript-type">void</span> <span class="enscript-function-name">mDNSCoreReceive</span>(mDNS *<span class="enscript-type">const</span> m, DNSMessage *<span class="enscript-type">const</span> msg, <span class="enscript-type">const</span> mDNSu8 *<span class="enscript-type">const</span> end,
                                <span class="enscript-type">const</span> mDNSAddr *srcaddr, mDNSIPPort srcport, <span class="enscript-type">const</span> mDNSAddr *dstaddr, mDNSIPPort dstport, <span class="enscript-type">const</span> mDNSInterfaceID InterfaceID)
{
    <span class="enscript-type">const</span> mDNSu8 StdQ = kDNSFlag0_QR_Query    | kDNSFlag0_OP_StdQuery;
    <span class="enscript-type">const</span> mDNSu8 StdR = kDNSFlag0_QR_Response | kDNSFlag0_OP_StdQuery;
    <span class="enscript-type">const</span> mDNSu8 QR_OP = (mDNSu8)(msg-&gt;h.flags.b[0] &amp; kDNSFlag0_QROP_Mask);
    mDNSu8 *ptr = (mDNSu8 *)&amp;msg-&gt;h.numQuestions;
    <span class="enscript-type">int</span> goodinterface = (FilterInterface == 0);

    (<span class="enscript-type">void</span>)dstaddr;  <span class="enscript-comment">// Unused
</span>    (<span class="enscript-type">void</span>)dstport;  <span class="enscript-comment">// Unused
</span>
    <span class="enscript-comment">// Read the integer parts which are in IETF byte-order (MSB first, LSB second)
</span>    msg-&gt;h.numQuestions   = (mDNSu16)((mDNSu16)ptr[0] &lt;&lt;  8 | ptr[1]);
    msg-&gt;h.numAnswers     = (mDNSu16)((mDNSu16)ptr[2] &lt;&lt;  8 | ptr[3]);
    msg-&gt;h.numAuthorities = (mDNSu16)((mDNSu16)ptr[4] &lt;&lt;  8 | ptr[5]);
    msg-&gt;h.numAdditionals = (mDNSu16)((mDNSu16)ptr[6] &lt;&lt;  8 | ptr[7]);

    <span class="enscript-comment">// For now we're only interested in monitoring IPv4 traffic.
</span>    <span class="enscript-comment">// All IPv6 packets should just be duplicates of the v4 packets.
</span>    <span class="enscript-keyword">if</span> (!goodinterface) goodinterface = (FilterInterface == (<span class="enscript-type">int</span>)mDNSPlatformInterfaceIndexfromInterfaceID(m, InterfaceID, mDNSfalse));
    <span class="enscript-keyword">if</span> (goodinterface &amp;&amp; AddressMatchesFilterList(srcaddr))
    {
        mDNS_Lock(m);
        <span class="enscript-keyword">if</span> (!mDNSAddrIsDNSMulticast(dstaddr))
        {
            <span class="enscript-keyword">if</span>      (QR_OP == StdQ) mprintf(<span class="enscript-string">&quot;Unicast query from %#a\n&quot;</span>, srcaddr);
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (QR_OP == StdR) ProcessUnicastResponse(m, msg, end, srcaddr,                   InterfaceID);
        }
        <span class="enscript-keyword">else</span>
        {
            <span class="enscript-keyword">if</span>      (QR_OP == StdQ) DisplayQuery          (m, msg, end, srcaddr, srcport, dstaddr, InterfaceID);
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (QR_OP == StdR) DisplayResponse       (m, msg, end, srcaddr, srcport, dstaddr, InterfaceID);
            <span class="enscript-keyword">else</span>
            {
                debugf(<span class="enscript-string">&quot;Unknown DNS packet type %02X%02X (ignored)&quot;</span>, msg-&gt;h.flags.b[0], msg-&gt;h.flags.b[1]);
                GotPacketFromHost(srcaddr, HostPkt_B, msg-&gt;h.id);
                NumPktB++;
            }
        }
        mDNS_Unlock(m);
    }
}

mDNSlocal mStatus <span class="enscript-function-name">mDNSNetMonitor</span>(<span class="enscript-type">void</span>)
{
    <span class="enscript-type">struct</span> tm tm;
    <span class="enscript-type">int</span> h, m, s, mul, div, TotPkt;
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">WIN32</span>)
    sigset_t signals;
#<span class="enscript-reference">endif</span>

    mStatus status = mDNS_Init(&amp;mDNSStorage, &amp;PlatformStorage,
                               mDNS_Init_NoCache, mDNS_Init_ZeroCacheSize,
                               mDNS_Init_DontAdvertiseLocalAddresses,
                               mDNS_Init_NoInitCallback, mDNS_Init_NoInitCallbackContext);
    <span class="enscript-keyword">if</span> (status) <span class="enscript-keyword">return</span>(status);

    gettimeofday(&amp;tv_start, NULL);

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name"> WIN32 </span>)
    status = SetupInterfaceList(&amp;mDNSStorage);
    <span class="enscript-keyword">if</span> (status) <span class="enscript-keyword">return</span>(status);
    gStopEvent = CreateEvent(NULL, FALSE, FALSE, NULL);
    <span class="enscript-keyword">if</span> (gStopEvent == INVALID_HANDLE_VALUE) <span class="enscript-keyword">return</span> mStatus_UnknownErr;
    mDNSPollRegisterEvent( gStopEvent, StopNotification, NULL );
    <span class="enscript-keyword">if</span> (!SetConsoleCtrlHandler(ConsoleControlHandler, TRUE)) <span class="enscript-keyword">return</span> mStatus_UnknownErr;
    gRunning = mDNStrue; <span class="enscript-keyword">while</span> (gRunning) mDNSPoll( INFINITE );
    <span class="enscript-keyword">if</span> (!SetConsoleCtrlHandler(ConsoleControlHandler, FALSE)) <span class="enscript-keyword">return</span> mStatus_UnknownErr;
    CloseHandle(gStopEvent);
#<span class="enscript-reference">else</span>
    mDNSPosixListenForSignalInEventLoop(SIGINT);
    mDNSPosixListenForSignalInEventLoop(SIGTERM);

    <span class="enscript-keyword">do</span>
    {
        <span class="enscript-type">struct</span> timeval timeout = { FutureTime, 0 };     <span class="enscript-comment">// wait until SIGINT or SIGTERM
</span>        mDNSBool gotSomething;
        mDNSPosixRunEventLoopOnce(&amp;mDNSStorage, &amp;timeout, &amp;signals, &amp;gotSomething);
    }
    <span class="enscript-keyword">while</span> ( !( sigismember( &amp;signals, SIGINT) || sigismember( &amp;signals, SIGTERM)));
#<span class="enscript-reference">endif</span>

    <span class="enscript-comment">// Now display final summary
</span>    TotPkt = NumPktQ + NumPktL + NumPktR;
    gettimeofday(&amp;tv_end, NULL);
    tv_interval = tv_end;
    <span class="enscript-keyword">if</span> (tv_start.tv_usec &gt; tv_interval.tv_usec)
    { tv_interval.tv_usec += 1000000; tv_interval.tv_sec--; }
    tv_interval.tv_sec  -= tv_start.tv_sec;
    tv_interval.tv_usec -= tv_start.tv_usec;
    h = (tv_interval.tv_sec / 3600);
    m = (tv_interval.tv_sec % 3600) / 60;
    s = (tv_interval.tv_sec % 60);
    <span class="enscript-keyword">if</span> (tv_interval.tv_sec &gt; 10)
    {
        mul = 60;
        div = tv_interval.tv_sec;
    }
    <span class="enscript-keyword">else</span>
    {
        mul = 60000;
        div = tv_interval.tv_sec * 1000 + tv_interval.tv_usec / 1000;
        <span class="enscript-keyword">if</span> (div == 0) div=1;
    }

    mprintf(<span class="enscript-string">&quot;\n\n&quot;</span>);
    localtime_r((time_t*)&amp;tv_start.tv_sec, &amp;tm);
    mprintf(<span class="enscript-string">&quot;Started      %3d:%02d:%02d.%06d\n&quot;</span>, tm.tm_hour, tm.tm_min, tm.tm_sec, tv_start.tv_usec);
    localtime_r((time_t*)&amp;tv_end.tv_sec, &amp;tm);
    mprintf(<span class="enscript-string">&quot;End          %3d:%02d:%02d.%06d\n&quot;</span>, tm.tm_hour, tm.tm_min, tm.tm_sec, tv_end.tv_usec);
    mprintf(<span class="enscript-string">&quot;Captured for %3d:%02d:%02d.%06d\n&quot;</span>, h, m, s, tv_interval.tv_usec);
    <span class="enscript-keyword">if</span> (!Filters)
    {
        mprintf(<span class="enscript-string">&quot;Unique source addresses seen on network:&quot;</span>);
        <span class="enscript-keyword">if</span> (IPv4HostList.num) mprintf(<span class="enscript-string">&quot; %ld (IPv4)&quot;</span>, IPv4HostList.num);
        <span class="enscript-keyword">if</span> (IPv6HostList.num) mprintf(<span class="enscript-string">&quot; %ld (IPv6)&quot;</span>, IPv6HostList.num);
        <span class="enscript-keyword">if</span> (!IPv4HostList.num &amp;&amp; !IPv6HostList.num) mprintf(<span class="enscript-string">&quot; None&quot;</span>);
        mprintf(<span class="enscript-string">&quot;\n&quot;</span>);
    }
    mprintf(<span class="enscript-string">&quot;\n&quot;</span>);
    mprintf(<span class="enscript-string">&quot;Modern Query        Packets:      %7d   (avg%5d/min)\n&quot;</span>, NumPktQ,        NumPktQ        * mul / div);
    mprintf(<span class="enscript-string">&quot;Legacy Query        Packets:      %7d   (avg%5d/min)\n&quot;</span>, NumPktL,        NumPktL        * mul / div);
    mprintf(<span class="enscript-string">&quot;Multicast Response  Packets:      %7d   (avg%5d/min)\n&quot;</span>, NumPktR,        NumPktR        * mul / div);
    mprintf(<span class="enscript-string">&quot;Total     Multicast Packets:      %7d   (avg%5d/min)\n&quot;</span>, TotPkt,         TotPkt         * mul / div);
    mprintf(<span class="enscript-string">&quot;\n&quot;</span>);
    mprintf(<span class="enscript-string">&quot;Total New Service Probes:         %7d   (avg%5d/min)\n&quot;</span>, NumProbes,      NumProbes      * mul / div);
    mprintf(<span class="enscript-string">&quot;Total Goodbye Announcements:      %7d   (avg%5d/min)\n&quot;</span>, NumGoodbyes,    NumGoodbyes    * mul / div);
    mprintf(<span class="enscript-string">&quot;Total Query Questions:            %7d   (avg%5d/min)\n&quot;</span>, NumQuestions,   NumQuestions   * mul / div);
    mprintf(<span class="enscript-string">&quot;Total Queries from Legacy Clients:%7d   (avg%5d/min)\n&quot;</span>, NumLegacy,      NumLegacy      * mul / div);
    mprintf(<span class="enscript-string">&quot;Total Answers/Announcements:      %7d   (avg%5d/min)\n&quot;</span>, NumAnswers,     NumAnswers     * mul / div);
    mprintf(<span class="enscript-string">&quot;Total Additional Records:         %7d   (avg%5d/min)\n&quot;</span>, NumAdditionals, NumAdditionals * mul / div);
    mprintf(<span class="enscript-string">&quot;\n&quot;</span>);
    printstats(kReportTopServices);

    <span class="enscript-keyword">if</span> (!ExactlyOneFilter)
    {
        ShowSortedHostList(&amp;IPv4HostList, kReportTopHosts);
        ShowSortedHostList(&amp;IPv6HostList, kReportTopHosts);
    }

    mDNS_Close(&amp;mDNSStorage);
    <span class="enscript-keyword">return</span>(0);
}

mDNSexport <span class="enscript-type">int</span> <span class="enscript-function-name">main</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> **argv)
{
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *progname = strrchr(argv[0], <span class="enscript-string">'/'</span>) ? strrchr(argv[0], <span class="enscript-string">'/'</span>) + 1 : argv[0];
    <span class="enscript-type">int</span> i;
    mStatus status;

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">WIN32</span>)
    HeapSetInformation(NULL, HeapEnableTerminationOnCorruption, NULL, 0);
#<span class="enscript-reference">endif</span>

    setlinebuf(stdout);             <span class="enscript-comment">// Want to see lines as they appear, not block buffered
</span>
    <span class="enscript-keyword">for</span> (i=1; i&lt;argc; i++)
    {
		<span class="enscript-keyword">if</span> (i+1 &lt; argc &amp;&amp; !strcmp(argv[i], <span class="enscript-string">&quot;-i&quot;</span>))
        {
			FilterInterface = if_nametoindex(argv[i+1]);
			<span class="enscript-keyword">if</span> (!FilterInterface) FilterInterface = atoi(argv[i+1]);
			<span class="enscript-keyword">if</span> (!FilterInterface) {
				fprintf(stderr, <span class="enscript-string">&quot;Unknown interface %s\n&quot;</span>, argv[i+1]);
				<span class="enscript-keyword">goto</span> <span class="enscript-reference">usage</span>;
			}
            printf(<span class="enscript-string">&quot;Monitoring interface %d/%s\n&quot;</span>, FilterInterface, argv[i+1]);
			i += 1;
        }
        <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!strcmp(argv[i], <span class="enscript-string">&quot;-6&quot;</span>))
        {
            AddressType = mDNSAddrType_IPv6;
            printf(<span class="enscript-string">&quot;Monitoring IPv6 traffic\n&quot;</span>);
        }
        <span class="enscript-keyword">else</span>
        {
            <span class="enscript-type">struct</span> in_addr s4;
            <span class="enscript-type">struct</span> in6_addr s6;
            FilterList *f;
            mDNSAddr a;
            a.type = mDNSAddrType_IPv4;

            <span class="enscript-keyword">if</span> (inet_pton(AF_INET, argv[i], &amp;s4) == 1)
                a.ip.v4.NotAnInteger = s4.s_addr;
            <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (inet_pton(AF_INET6, argv[i], &amp;s6) == 1)
            {
                a.type = mDNSAddrType_IPv6;
                mDNSPlatformMemCopy(&amp;a.ip.v6, &amp;s6, <span class="enscript-keyword">sizeof</span>(a.ip.v6));
            }
            <span class="enscript-keyword">else</span>
            {
                <span class="enscript-type">struct</span> hostent *h = gethostbyname(argv[i]);
                <span class="enscript-keyword">if</span> (h) a.ip.v4.NotAnInteger = *(<span class="enscript-type">long</span>*)h-&gt;h_addr;
                <span class="enscript-keyword">else</span> <span class="enscript-keyword">goto</span> <span class="enscript-reference">usage</span>;
            }

            f = malloc(<span class="enscript-keyword">sizeof</span>(*f));
            f-&gt;FilterAddr = a;
            f-&gt;next = Filters;
            Filters = f;
        }
    }

    status = mDNSNetMonitor();
    <span class="enscript-keyword">if</span> (status) { fprintf(stderr, <span class="enscript-string">&quot;%s: mDNSNetMonitor failed %d\n&quot;</span>, progname, (<span class="enscript-type">int</span>)status); <span class="enscript-keyword">return</span>(status); }
    <span class="enscript-keyword">return</span>(0);

<span class="enscript-reference">usage</span>:
    fprintf(stderr, <span class="enscript-string">&quot;\nmDNS traffic monitor\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;Usage: %s [-i index] [-6] [host]\n&quot;</span>, progname);
    fprintf(stderr, <span class="enscript-string">&quot;Optional [-i index] parameter displays only packets from that interface index\n&quot;</span>);
	fprintf(stderr, <span class="enscript-string">&quot;Optional [-6] parameter displays only ipv6 packets (defaults to only ipv4 packets)\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;Optional [host] parameter displays only packets from that host\n&quot;</span>);

    fprintf(stderr, <span class="enscript-string">&quot;\nPer-packet header output:\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;-Q-            Multicast Query from mDNS client that accepts multicast responses\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;-R-            Multicast Response packet containing answers/announcements\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;-LQ-           Multicast Query from legacy client that does *not* listen for multicast responses\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;Q/Ans/Auth/Add Number of questions, answers, authority records and additional records in packet\n&quot;</span>);

    fprintf(stderr, <span class="enscript-string">&quot;\nPer-record display:\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;(PM)           Probe Question (new service starting), requesting multicast response\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;(PU)           Probe Question (new service starting), requesting unicast response\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;(DE)           Deletion/Goodbye (service going away)\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;(LQ)           Legacy Query Question\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;(QM)           Query Question, requesting multicast response\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;(QU)           Query Question, requesting unicast response\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;(KA)           Known Answer (information querier already knows)\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;(AN)           Unique Answer to question (or periodic announcment) (entire RR Set)\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;(AN+)          Answer to question (or periodic announcment) (add to existing RR Set members)\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;(AD)           Unique Additional Record Set (entire RR Set)\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;(AD+)          Additional records (add to existing RR Set members)\n&quot;</span>);

    fprintf(stderr, <span class="enscript-string">&quot;\nFinal summary, sorted by service type:\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;Probe          Probes for this service type starting up\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;Goodbye        Goodbye (deletion) packets for this service type shutting down\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;BrowseQ        Browse questions from clients browsing to find a list of instances of this service\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;BrowseA        Browse answers/announcments advertising instances of this service\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;ResolveQ       Resolve questions from clients actively connecting to an instance of this service\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;ResolveA       Resolve answers/announcments giving connection information for an instance of this service\n&quot;</span>);
    fprintf(stderr, <span class="enscript-string">&quot;\n&quot;</span>);
    <span class="enscript-keyword">return</span>(-1);
}
</pre>
<hr />
</body></html>