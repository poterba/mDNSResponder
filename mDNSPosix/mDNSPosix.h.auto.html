<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>mDNSPosix.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">mDNSPosix.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="mDNSPosix.h">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/* -*- Mode: C; tab-width: 4; c-file-style: &quot;bsd&quot;; c-basic-offset: 4; fill-column: 108; indent-tabs-mode: nil; -*-
 *
 * Copyright (c) 2002-2004 Apple Computer, Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__mDNSPlatformPosix_h</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">__mDNSPlatformPosix_h</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;signal.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/time.h&gt;</span>

#<span class="enscript-reference">ifdef</span>  <span class="enscript-variable-name">__cplusplus</span>
<span class="enscript-type">extern</span> <span class="enscript-string">&quot;C&quot;</span> {
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">// PosixNetworkInterface is a record extension of the core NetworkInterfaceInfo
</span><span class="enscript-comment">// type that supports extra fields needed by the Posix platform.
</span><span class="enscript-comment">//
</span><span class="enscript-comment">// IMPORTANT: coreIntf must be the first field in the structure because
</span><span class="enscript-comment">// we cast between pointers to the two different types regularly.
</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> PosixNetworkInterface PosixNetworkInterface;

<span class="enscript-type">struct</span> PosixNetworkInterface
{
    NetworkInterfaceInfo coreIntf;      <span class="enscript-comment">// MUST be the first element in this structure
</span>    mDNSs32 LastSeen;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *            intfName;
    PosixNetworkInterface * aliasIntf;
    <span class="enscript-type">int</span> index;
    <span class="enscript-type">int</span> multicastSocket4;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_IPV6</span>
    <span class="enscript-type">int</span> multicastSocket6;
#<span class="enscript-reference">endif</span>
};

<span class="enscript-comment">// This is a global because debugf_() needs to be able to check its value
</span><span class="enscript-type">extern</span> <span class="enscript-type">int</span> gMDNSPlatformPosixVerboseLevel;

<span class="enscript-type">struct</span> mDNS_PlatformSupport_struct
{
    <span class="enscript-type">int</span> unicastSocket4;
#<span class="enscript-reference">if</span> <span class="enscript-variable-name">HAVE_IPV6</span>
    <span class="enscript-type">int</span> unicastSocket6;
#<span class="enscript-reference">endif</span>
};

<span class="enscript-comment">// We keep a list of client-supplied event sources in PosixEventSource records
</span><span class="enscript-comment">// Add a file descriptor to the set that mDNSPosixRunEventLoopOnce() listens to.
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PosixEventFlag_OnList</span>   1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PosixEventFlag_Read</span>     2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">PosixEventFlag_Write</span>    4
    
<span class="enscript-type">typedef</span> <span class="enscript-function-name">void</span> (*mDNSPosixEventCallback)(<span class="enscript-type">int</span> fd, <span class="enscript-type">void</span> *context);
<span class="enscript-type">struct</span> PosixEventSource
{
    <span class="enscript-type">struct</span> PosixEventSource *next;
    mDNSPosixEventCallback readCallback;
    mDNSPosixEventCallback writeCallback;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *readTaskName;
    <span class="enscript-type">const</span> <span class="enscript-type">char</span> *writeTaskName;
    <span class="enscript-type">void</span> *readContext;
    <span class="enscript-type">void</span> *writeContext;
    <span class="enscript-type">int</span> fd;
    <span class="enscript-type">unsigned</span> flags;
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> PosixEventSource PosixEventSource;
    
<span class="enscript-type">struct</span> TCPSocket_struct
{
    mDNSIPPort port;            <span class="enscript-comment">// MUST BE FIRST FIELD -- mDNSCore expects every TCPSocket_struct to begin with mDNSIPPort
</span>    TCPSocketFlags flags;       <span class="enscript-comment">// MUST BE SECOND FIELD -- mDNSCore expects every TCPSocket_struct have TCPSocketFlags flags after mDNSIPPort
</span>    TCPConnectionCallback callback;
    PosixEventSource events;
    <span class="enscript-comment">// SSL context goes here.
</span>    domainname *hostname;
    mDNSAddr remoteAddress;
    mDNSIPPort remotePort;
    <span class="enscript-type">void</span> *context;
    mDNSBool setup;
    mDNSBool connected;
    mStatus err;
};

<span class="enscript-type">struct</span> TCPListener_struct
{
    TCPAcceptedCallback callback;
    PosixEventSource events;
    <span class="enscript-type">void</span> *context;
    mDNSAddr_Type addressType;
    TCPSocketFlags socketFlags;
};
    
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">uDNS_SERVERS_FILE</span> <span class="enscript-string">&quot;/etc/resolv.conf&quot;</span>
<span class="enscript-type">extern</span> <span class="enscript-type">int</span> <span class="enscript-function-name">ParseDNSServers</span>(mDNS *m, <span class="enscript-type">const</span> <span class="enscript-type">char</span> *filePath);
<span class="enscript-type">extern</span> mStatus <span class="enscript-function-name">mDNSPlatformPosixRefreshInterfaceList</span>(mDNS *<span class="enscript-type">const</span> m);
<span class="enscript-comment">// See comment in implementation.
</span>
<span class="enscript-comment">// Get the next upcoming mDNS (or DNS) event time as a posix timeval that can be passed to select.
</span><span class="enscript-comment">// This will only update timeout if the next mDNS event is sooner than the value that was passed.
</span><span class="enscript-comment">// Therefore, use { FutureTime, 0 } as an initializer if no other timer events are being managed.
</span><span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mDNSPosixGetNextDNSEventTime</span>(mDNS *m, <span class="enscript-type">struct</span> timeval *timeout);

<span class="enscript-comment">// Returns all the FDs that the posix I/O event system expects to be passed to select.
</span><span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mDNSPosixGetFDSetForSelect</span>(mDNS *m, <span class="enscript-type">int</span> *nfds, fd_set *readfds, fd_set *writefds);

<span class="enscript-comment">// Call mDNSPosixGetFDSet before calling select(), to update the parameters
</span><span class="enscript-comment">// as may be necessary to meet the needs of the mDNSCore code.
</span><span class="enscript-comment">// The timeout pointer MUST NOT be NULL.
</span><span class="enscript-comment">// Set timeout-&gt;tv_sec to FutureTime if you want to have effectively no timeout
</span><span class="enscript-comment">// After calling mDNSPosixGetFDSet(), call select(nfds, &amp;readfds, NULL, NULL, &amp;timeout); as usual
</span><span class="enscript-comment">// After select() returns, call mDNSPosixProcessFDSet() to let mDNSCore do its work
</span><span class="enscript-comment">// mDNSPosixGetFDSet simply calls mDNSPosixGetNextDNSEventTime and then mDNSPosixGetFDSetForSelect.
</span><span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mDNSPosixGetFDSet</span>(mDNS *m, <span class="enscript-type">int</span> *nfds, fd_set *readfds, fd_set *writefds, <span class="enscript-type">struct</span> timeval *timeout);


<span class="enscript-type">extern</span> <span class="enscript-type">void</span> <span class="enscript-function-name">mDNSPosixProcessFDSet</span>(mDNS *<span class="enscript-type">const</span> m, fd_set *readfds, fd_set *writefds);

<span class="enscript-type">extern</span> mStatus <span class="enscript-function-name">mDNSPosixAddFDToEventLoop</span>( <span class="enscript-type">int</span> fd, mDNSPosixEventCallback callback, <span class="enscript-type">void</span> *context);
<span class="enscript-type">extern</span> mStatus <span class="enscript-function-name">mDNSPosixRemoveFDFromEventLoop</span>( <span class="enscript-type">int</span> fd);
<span class="enscript-type">extern</span> mStatus <span class="enscript-function-name">mDNSPosixListenForSignalInEventLoop</span>( <span class="enscript-type">int</span> signum);
<span class="enscript-type">extern</span> mStatus <span class="enscript-function-name">mDNSPosixIgnoreSignalInEventLoop</span>( <span class="enscript-type">int</span> signum);
<span class="enscript-type">extern</span> mStatus <span class="enscript-function-name">mDNSPosixRunEventLoopOnce</span>( mDNS *m, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> timeval *pTimeout, sigset_t *pSignalsReceived, mDNSBool *pDataDispatched);

<span class="enscript-type">extern</span> mStatus <span class="enscript-function-name">mDNSPosixListenForSignalInEventLoop</span>( <span class="enscript-type">int</span> signum);
<span class="enscript-type">extern</span> mStatus <span class="enscript-function-name">mDNSPosixIgnoreSignalInEventLoop</span>( <span class="enscript-type">int</span> signum);
<span class="enscript-type">extern</span> mStatus <span class="enscript-function-name">mDNSPosixRunEventLoopOnce</span>( mDNS *m, <span class="enscript-type">const</span> <span class="enscript-type">struct</span> timeval *pTimeout, sigset_t *pSignalsReceived, mDNSBool *pDataDispatched);

#<span class="enscript-reference">ifdef</span>  <span class="enscript-variable-name">__cplusplus</span>
}
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">endif</span>
</pre>
<hr />
</body></html>